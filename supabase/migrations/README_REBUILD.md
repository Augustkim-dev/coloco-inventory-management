# Database Rebuild Guide

## ğŸ“‹ ê°œìš”

`comprehensive_rebuild.sql` íŒŒì¼ì€ ì „ì²´ ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ê¹¨ë—í•˜ê²Œ ì¬êµ¬ì¶•í•˜ê¸° ìœ„í•œ ì¢…í•© SQL ìŠ¤í¬ë¦½íŠ¸ì…ë‹ˆë‹¤. ì´ íŒŒì¼ì€ ê¸°ì¡´ì˜ 17ê°œ ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼(001-017)ì„ í•˜ë‚˜ë¡œ í†µí•©í•˜ì—¬ ìš´ì˜ í™˜ê²½ ë°°í¬ë¥¼ ìœ„í•œ ê¹”ë”í•œ ì´ˆê¸° ìƒíƒœë¥¼ ì œê³µí•©ë‹ˆë‹¤.

---

## ğŸ¯ ì´ ìŠ¤í¬ë¦½íŠ¸ê°€ í•˜ëŠ” ì¼

### 1. **DROP (ì‚­ì œ)**
- ëª¨ë“  ê¸°ì¡´ í…Œì´ë¸” ì‚­ì œ (ì—­ìˆœìœ¼ë¡œ ì•ˆì „í•˜ê²Œ ì‚­ì œ)
- ëª¨ë“  í•¨ìˆ˜ ì‚­ì œ

### 2. **CREATE (ìƒì„±)**
- **11ê°œ í…Œì´ë¸”** ìƒì„±:
  - `users` - ì‚¬ìš©ì ê´€ë¦¬
  - `locations` - ì§€ì  ì •ë³´ (HQ + ë¸Œëœì¹˜)
  - `suppliers` - ê³µê¸‰ì—…ì²´
  - `products` - ì œí’ˆ ë§ˆìŠ¤í„°
  - `supplier_products` - ê³µê¸‰ì—…ì²´-ì œí’ˆ ê´€ê³„
  - `purchase_orders` - ë°œì£¼ì„œ
  - `purchase_order_items` - ë°œì£¼ ìƒì„¸
  - `stock_batches` - ì¬ê³  ë°°ì¹˜ (FIFO)
  - `pricing_configs` - ê°€ê²© ì„¤ì •
  - `sales` - íŒë§¤ ê¸°ë¡
  - `exchange_rates` - í™˜ìœ¨ ì •ë³´

- **2ê°œ í•¨ìˆ˜** ìƒì„±:
  - `update_updated_at_column()` - ìë™ íƒ€ì„ìŠ¤íƒ¬í”„ ì—…ë°ì´íŠ¸
  - `get_available_stock()` - ì¬ê³  ì¡°íšŒ

- **25ê°œ RLS ì •ì±…** ìƒì„±:
  - HQ_Admin vs Branch_Manager ê¶Œí•œ ë¶„ë¦¬
  - í…Œì´ë¸”ë³„ ì ‘ê·¼ ì œì–´

### 3. **INSERT (ì´ˆê¸° ë°ì´í„°)**
- **3ê°œ ì§€ì **: Korea HQ, Vietnam Branch, China Branch
- **2ê°œ í™˜ìœ¨**: KRWâ†’VND (18.0), KRWâ†’CNY (0.0053)

---

## ğŸš€ ì‹¤í–‰ ë°©ë²•

### **ë°©ë²• 1: Supabase Dashboard (ê¶Œì¥)**

1. Supabase í”„ë¡œì íŠ¸ ëŒ€ì‹œë³´ë“œ ì ‘ì†
2. ì¢Œì¸¡ ë©”ë‰´ì—ì„œ **SQL Editor** í´ë¦­
3. **New Query** ë²„íŠ¼ í´ë¦­
4. `comprehensive_rebuild.sql` íŒŒì¼ ë‚´ìš©ì„ ë³µì‚¬í•˜ì—¬ ë¶™ì—¬ë„£ê¸°
5. **Run** ë²„íŠ¼ í´ë¦­í•˜ì—¬ ì‹¤í–‰

### **ë°©ë²• 2: Supabase CLI**

```bash
# Supabaseì— ë¡œê·¸ì¸
supabase login

# í”„ë¡œì íŠ¸ ì—°ê²°
supabase link --project-ref your-project-ref

# SQL íŒŒì¼ ì‹¤í–‰
supabase db execute -f supabase/migrations/comprehensive_rebuild.sql
```

### **ë°©ë²• 3: psql ì»¤ë§¨ë“œ ë¼ì¸**

```bash
psql postgresql://[connection-string] < supabase/migrations/comprehensive_rebuild.sql
```

---

## âš ï¸ ì£¼ì˜ì‚¬í•­

### **ì‹¤í–‰ ì „ í•„ë…!**

1. **ë°ì´í„° ë°±ì—…**: ê¸°ì¡´ ë°ì´í„°ê°€ ìˆë‹¤ë©´ **ë°˜ë“œì‹œ ë°±ì—…**í•˜ì„¸ìš”.
   - ì´ ìŠ¤í¬ë¦½íŠ¸ëŠ” `DROP TABLE IF EXISTS ... CASCADE`ë¥¼ ì‚¬ìš©í•˜ì—¬ **ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œ**í•©ë‹ˆë‹¤.

2. **í…ŒìŠ¤íŠ¸ í™˜ê²½ ìš°ì„ **: í”„ë¡œë•ì…˜ í™˜ê²½ì— ì ìš©í•˜ê¸° ì „ì— ë°˜ë“œì‹œ í…ŒìŠ¤íŠ¸ í™˜ê²½ì—ì„œ ë¨¼ì € ì‹¤í–‰í•˜ì„¸ìš”.

3. **RLS ì •ì±… í™•ì¸**: ì‹¤í–‰ í›„ RLS ì •ì±…ì´ ì œëŒ€ë¡œ ì ìš©ë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.

4. **ì²« ì‚¬ìš©ì ìƒì„±**: ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ í›„ ì²« HQ_Admin ì‚¬ìš©ìë¥¼ ìˆ˜ë™ìœ¼ë¡œ ìƒì„±í•´ì•¼ í•©ë‹ˆë‹¤.

---

## ğŸ” ì‹¤í–‰ í›„ ê²€ì¦

### 1. **í…Œì´ë¸” í™•ì¸**

```sql
-- ìƒì„±ëœ í…Œì´ë¸” ê°œìˆ˜ í™•ì¸ (11ê°œì—¬ì•¼ í•¨)
SELECT COUNT(*) as total_tables
FROM information_schema.tables
WHERE table_schema = 'public';
```

### 2. **RLS ì •ì±… í™•ì¸**

```sql
-- í…Œì´ë¸”ë³„ RLS ì •ì±… ê°œìˆ˜ í™•ì¸ (ì´ 25ê°œ)
SELECT tablename, COUNT(*) as policy_count
FROM pg_policies
WHERE schemaname = 'public'
GROUP BY tablename
ORDER BY tablename;
```

### 3. **ì´ˆê¸° ë°ì´í„° í™•ì¸**

```sql
-- Locations ë°ì´í„° í™•ì¸ (3ê°œ)
SELECT * FROM public.locations ORDER BY display_order;

-- Exchange rates ë°ì´í„° í™•ì¸ (2ê°œ)
SELECT * FROM public.exchange_rates ORDER BY from_currency;
```

### 4. **í•¨ìˆ˜ í™•ì¸**

```sql
-- ìƒì„±ëœ í•¨ìˆ˜ í™•ì¸ (2ê°œ)
SELECT routine_name
FROM information_schema.routines
WHERE routine_schema = 'public'
ORDER BY routine_name;
```

---

## ğŸ“ ë‹¤ìŒ ë‹¨ê³„

### 1. **ì²« ê´€ë¦¬ì ì‚¬ìš©ì ìƒì„±**

Supabase Authì—ì„œ ì‚¬ìš©ì ìƒì„± í›„ `public.users` í…Œì´ë¸”ì— ë ˆì½”ë“œ ì¶”ê°€:

```sql
-- ì˜ˆì‹œ (UUIDëŠ” Supabase Authì—ì„œ ìƒì„±ëœ ì‹¤ì œ ID ì‚¬ìš©)
INSERT INTO public.users (id, email, name, role, location_id, preferred_language)
SELECT
  '00000000-0000-0000-0000-000000000000', -- auth.usersì˜ ì‹¤ì œ UUIDë¡œ êµì²´
  'admin@example.com',
  'Admin User',
  'HQ_Admin',
  (SELECT id FROM public.locations WHERE location_type = 'HQ'),
  'ko';
```

### 2. **ê¸°íƒ€ ë§ˆìŠ¤í„° ë°ì´í„° ì…ë ¥**

- Suppliers (ê³µê¸‰ì—…ì²´)
- Products (ì œí’ˆ)
- Supplier-Product ê´€ê³„ ì„¤ì •

### 3. **ì• í”Œë¦¬ì¼€ì´ì…˜ ì—°ë™ í…ŒìŠ¤íŠ¸**

---

## ğŸ“‚ íŒŒì¼ êµ¬ì¡°

```
supabase/
â”œâ”€â”€ migrations/
â”‚   â”œâ”€â”€ 001_create_users_table.sql          â† ê°œë³„ ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ë“¤
â”‚   â”œâ”€â”€ 002_create_locations_table.sql      â† (ì°¸ê³ ìš©ìœ¼ë¡œ ë³´ê´€)
â”‚   â”œâ”€â”€ ...
â”‚   â”œâ”€â”€ 017_add_user_language_preference.sql
â”‚   â”œâ”€â”€ comprehensive_rebuild.sql           â† â­ ì´ íŒŒì¼ ì‚¬ìš©
â”‚   â””â”€â”€ README_REBUILD.md                   â† ì´ ë¬¸ì„œ
â””â”€â”€ seed_data.sql                            â† í…ŒìŠ¤íŠ¸ ë°ì´í„° (ì„ íƒì‚¬í•­)
```

---

## ğŸ”„ ê¸°ì¡´ ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ê³¼ì˜ ê´€ê³„

### **ê°œë³„ ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ (001-017)**
- **ìš©ë„**: ê°œë°œ ê³¼ì • ì¤‘ ì ì§„ì  ìŠ¤í‚¤ë§ˆ ë³€ê²½
- **íŠ¹ì§•**: ê° ë³€ê²½ì‚¬í•­ì„ ë‹¨ê³„ë³„ë¡œ ì¶”ì 
- **ë³´ê´€**: Git íˆìŠ¤í† ë¦¬ìš©ìœ¼ë¡œ ë³´ê´€ ê¶Œì¥

### **comprehensive_rebuild.sql**
- **ìš©ë„**: ìš´ì˜ í™˜ê²½ ì´ˆê¸° êµ¬ì¶• ë˜ëŠ” ì™„ì „ ì¬êµ¬ì¶•
- **íŠ¹ì§•**: ëª¨ë“  ë³€ê²½ì‚¬í•­ì´ í†µí•©ëœ ìµœì¢… ìƒíƒœ
- **ì‚¬ìš© ì‹œê¸°**:
  - ìƒˆë¡œìš´ í”„ë¡œë•ì…˜ í™˜ê²½ êµ¬ì¶•
  - ê°œë°œ í™˜ê²½ ì™„ì „ ì´ˆê¸°í™”
  - í…ŒìŠ¤íŠ¸ í™˜ê²½ ë¦¬ì…‹

---

## ğŸ› ë¬¸ì œ í•´ê²°

### **ì˜¤ë¥˜: "relation already exists"**
- **ì›ì¸**: í…Œì´ë¸”ì´ ì´ë¯¸ ì¡´ì¬í•¨
- **í•´ê²°**: `DROP TABLE` êµ¬ë¬¸ì´ ì œëŒ€ë¡œ ì‹¤í–‰ë˜ì—ˆëŠ”ì§€ í™•ì¸

### **ì˜¤ë¥˜: "permission denied"**
- **ì›ì¸**: ì‹¤í–‰ ê¶Œí•œ ë¶€ì¡±
- **í•´ê²°**: ë°ì´í„°ë² ì´ìŠ¤ ì†Œìœ ì ê¶Œí•œìœ¼ë¡œ ì‹¤í–‰

### **ì˜¤ë¥˜: "foreign key constraint"**
- **ì›ì¸**: ì™¸ë˜í‚¤ ì œì•½ì¡°ê±´ ìœ„ë°˜
- **í•´ê²°**: ìŠ¤í¬ë¦½íŠ¸ ì „ì²´ë¥¼ í•œ ë²ˆì— ì‹¤í–‰ (ë¶€ë¶„ ì‹¤í–‰ ê¸ˆì§€)

---

## ğŸ“ ì§€ì›

ë¬¸ì œê°€ ë°œìƒí•˜ë©´:
1. ì‹¤í–‰ ë¡œê·¸ í™•ì¸
2. RLS ì •ì±… ìƒíƒœ í™•ì¸
3. Supabase í”„ë¡œì íŠ¸ ë¡œê·¸ í™•ì¸
4. ê°œë°œíŒ€ì— ë¬¸ì˜

---

## ğŸ“œ ë³€ê²½ ì´ë ¥

| ë‚ ì§œ | ë²„ì „ | ë³€ê²½ ë‚´ìš© |
|------|------|----------|
| 2025-10-31 | 1.0 | ì´ˆê¸° ë²„ì „ ìƒì„± (ë§ˆì´ê·¸ë ˆì´ì…˜ 001-017 í†µí•©) |

---

## âœ… ì²´í¬ë¦¬ìŠ¤íŠ¸

ì‹¤í–‰ ì „ í™•ì¸:
- [ ] ê¸°ì¡´ ë°ì´í„° ë°±ì—… ì™„ë£Œ
- [ ] í…ŒìŠ¤íŠ¸ í™˜ê²½ì—ì„œ ë¨¼ì € ì‹¤í–‰
- [ ] Supabase í”„ë¡œì íŠ¸ ì˜¬ë°”ë¥¸ì§€ í™•ì¸
- [ ] ì‹¤í–‰ ê¶Œí•œ í™•ì¸

ì‹¤í–‰ í›„ í™•ì¸:
- [ ] 11ê°œ í…Œì´ë¸” ìƒì„± í™•ì¸
- [ ] 25ê°œ RLS ì •ì±… í™•ì¸
- [ ] 3ê°œ locations ë°ì´í„° í™•ì¸
- [ ] 2ê°œ exchange_rates ë°ì´í„° í™•ì¸
- [ ] ì²« HQ_Admin ì‚¬ìš©ì ìƒì„± ì™„ë£Œ
