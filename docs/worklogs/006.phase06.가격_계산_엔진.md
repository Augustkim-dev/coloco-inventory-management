# Phase 06: 가격 계산 엔진 - Work Log

**작업 일자**: 2025-10-30
**작업자**: Claude Code
**소요 시간**: 약 2시간
**목표**: 원가 기반 가격 자동 계산 엔진 구현 (핵심 비즈니스 로직)

---

## 1. 작업 개요

시스템의 핵심 기능인 **가격 계산 엔진**을 완전히 구현했습니다. 구매 단가, 이전 비용, 환율, 본사/지사 마진을 기반으로 최종 판매 가격을 자동으로 계산하며, 수동 조정도 가능합니다.

---

## 2. 구현된 기능

### 2.1 생성된 파일 목록 (총 7개)

#### 페이지 (3개)
1. **`app/(dashboard)/pricing/page.tsx`**
   - Pricing 목록 페이지
   - 모든 가격 설정 조회 및 표시
   - "Add Pricing" 버튼

2. **`app/(dashboard)/pricing/new/page.tsx`**
   - 가격 설정 생성 페이지
   - HQ, 지사, 제품 데이터 로드
   - PricingForm 렌더링

3. **`app/(dashboard)/pricing/[id]/edit/page.tsx`**
   - 가격 설정 수정 페이지
   - 기존 설정 불러오기
   - 제품/지사 선택 disabled

#### 컴포넌트 (4개)
4. **`components/pricing/pricing-form.tsx`** (핵심 컴포넌트)
   - 가격 계산 폼
   - 자동 구매단가 로드 (최근 PO에서)
   - 자동 환율 로드 (최신 환율에서)
   - **가격 계산 로직 구현**
   - 수동 조정 가능한 Final Price

5. **`components/pricing/pricing-list.tsx`**
   - 가격 설정 목록 테이블
   - 제품, 지사, 비용, 마진, 환율, 최종 가격 표시
   - Edit 버튼

6. **`components/exchange-rates/exchange-rate-selector.tsx`**
   - 환율 선택 컴포넌트
   - API 호출하여 최신 환율 자동 로드
   - 수동 입력 가능

7. **`components/ui/alert.tsx`**
   - shadcn/ui Alert 컴포넌트 (에러 메시지 표시용)

#### 수정된 파일 (2개)
8. **`lib/constants.ts`**
   - Pricing 메뉴 항목 추가 (Calculator 아이콘)
   - Exchange Rates와 Sales 사이에 배치

9. **`lib/utils.ts`**
   - `formatCurrency` 함수에 null/undefined 체크 추가
   - 안전한 통화 포맷팅

---

## 3. 핵심 비즈니스 로직: 가격 계산 공식

### 3.1 계산 알고리즘

`components/pricing/pricing-form.tsx`의 `calculatePrice()` 함수:

```typescript
// STEP 1: 지사 원가 (Local Cost) 계산
const totalCostKRW = purchasePrice + transferCost
const localCost = totalCostKRW * exchangeRate

// STEP 2: 판매 가격 (Selling Price) 계산
const totalMargin = hqMargin + branchMargin
const marginFactor = 1 - totalMargin / 100
const sellingPrice = localCost / marginFactor

// STEP 3: 반올림된 최종 가격 제안
if (currency === 'CNY') {
  roundedPrice = Math.round(sellingPrice * 100) / 100  // 소수점 2자리
} else {
  roundedPrice = Math.round(sellingPrice / 100) * 100  // 100단위 반올림
}
```

### 3.2 검증 규칙

- **필수 필드**: 구매단가, 환율
- **마진 검증**: HQ 마진 + 지사 마진 < 100%
- **환율 검증**: 환율 > 0
- **UNIQUE 제약**: (product_id, to_location_id) 조합 중복 방지

### 3.3 계산 예시

#### 베트남 지사 (VND)
```
구매단가: 5,000 KRW
이전비용: 500 KRW
환율: 1 KRW = 18 VND
HQ 마진: 10%
지사 마진: 30%

→ 지사 원가 = (5,000 + 500) × 18 = 99,000 VND
→ 판매 가격 = 99,000 ÷ (1 - 0.40) = 165,000 VND
→ 최종 가격 = 165,000 VND (100단위 반올림)
```

#### 중국 지사 (CNY)
```
구매단가: 5,000 KRW
이전비용: 500 KRW
환율: 1 KRW = 0.0053 CNY
HQ 마진: 10%
지사 마진: 25%

→ 지사 원가 = 5,500 × 0.0053 = 29.15 CNY
→ 판매 가격 = 29.15 ÷ (1 - 0.35) = 44.85 CNY
→ 최종 가격 = 44.85 CNY (소수점 2자리)
```

---

## 4. 주요 기능 구현 세부사항

### 4.1 자동 데이터 로드

#### 최근 PO 구매단가 자동 로드
```typescript
const fetchLatestPurchasePrice = async (productId: string) => {
  const { data } = await supabase
    .from('purchase_order_items')
    .select(`
      unit_price,
      purchase_orders!inner(status)
    `)
    .eq('product_id', productId)
    .eq('purchase_orders.status', 'Received')
    .order('created_at', { ascending: false })
    .limit(1)
    .single()

  if (data) {
    setFormData(prev => ({ ...prev, purchase_price: data.unit_price }))
  }
}
```

#### 최신 환율 자동 로드
ExchangeRateSelector 컴포넌트가 API 호출:
```typescript
GET /api/exchange-rates/latest?from=KRW&to=VND
```

### 4.2 가격 계산 버튼

- "Calculate Price" 버튼 클릭 시 공식 적용
- Calculated Price (자동 계산) 표시
- Final Price (수동 조정 가능) 표시
- Toast 알림으로 제안 가격 안내

### 4.3 저장 기능

- Create 모드: INSERT into pricing_configs
- Edit 모드: UPDATE pricing_configs
- 저장 후 `/pricing` 목록 페이지로 리다이렉트
- 중복 product-location 조합 시 DB 에러 반환

---

## 5. 트러블슈팅

### 5.1 Issue: `createServerClient is not a function`
**원인**: `lib/supabase/server.ts`의 함수명이 `createClient`인데 `createServerClient`로 import
**해결**: 모든 페이지에서 `createClient`로 수정하고 `await` 추가

### 5.2 Issue: `Cannot read properties of null (reading 'toLocaleString')`
**원인**: PricingList에서 `formatCurrency` 호출 시 amount 또는 currency가 null
**해결**: `formatCurrency` 함수에 null/undefined 체크 추가
```typescript
if (amount === null || amount === undefined || currency === null || currency === undefined) {
  return '-'
}
```

### 5.3 Issue: `Module not found: '@/components/ui/alert'`
**원인**: Alert 컴포넌트가 설치되지 않음
**해결**: `npx shadcn@latest add alert` 실행

---

## 6. 테스트 결과

### 6.1 완료된 테스트
- ✅ Pricing 메뉴가 사이드바에 표시됨 (Calculator 아이콘)
- ✅ Pricing 목록 페이지 정상 접근
- ✅ Add Pricing 버튼으로 생성 페이지 이동

### 6.2 수동 테스트 체크리스트 (사용자가 진행 예정)

**기본 기능:**
- [ ] 제품 선택 시 최근 PO 구매단가 자동 로드
- [ ] 지사 선택 시 최신 환율 자동 로드
- [ ] "Calculate Price" 버튼 클릭 시 정확한 계산
- [ ] Calculated Price와 Final Price 표시
- [ ] Final Price 수동 조정 가능

**검증:**
- [ ] 마진 합계 100% 이상 시 에러 메시지 표시
- [ ] VND 가격 계산 정확성 (예시: 165,000 VND)
- [ ] CNY 가격 계산 정확성 (예시: 44.85 CNY)

**CRUD 기능:**
- [ ] 가격 설정 저장 성공
- [ ] 저장 후 목록 페이지로 리다이렉트 및 새 항목 표시
- [ ] 중복 제품-지사 조합 저장 시 에러 처리
- [ ] Edit 버튼으로 수정 페이지 이동
- [ ] Edit 모드에서 제품/지사 선택 disabled

**데이터:**
- [ ] Seed data 15개 항목이 목록에 정상 표시

---

## 7. 데이터베이스 상태

### Seed Data 확인
`supabase/seed_data.sql`에 15개의 pricing_configs 레코드 존재:
- 베트남 지사: 10개 제품
- 중국 지사: 5개 제품

RLS 정책으로 HQ_Admin만 접근 가능.

---

## 8. 커밋 정보

**Commit Hash**: `7a2d5a6`
**Commit Message**: "Add: Phase 06 - Pricing Calculation Engine Implementation"

**변경 사항**:
- 9 files changed, 1090 insertions(+), 1 deletion(-)
- 7개 파일 생성
- 2개 파일 수정

**Push 완료**: ✅ `origin/master`

---

## 9. 다음 단계 (Phase 07 준비)

### 9.1 Phase 07: 판매 입력 (Sales Entry)

Phase 07에서는 Pricing 기능을 활용하여:
- 지사 관리자가 일일 판매 입력
- `pricing_configs.final_price` 자동 불러오기
- FIFO 방식으로 재고 차감
- 판매 기록 저장

### 9.2 테스트 데이터 준비
- Seed data의 15개 가격 설정을 활용하여 판매 입력 테스트

---

## 10. 학습 사항 및 개선점

### 10.1 학습 사항
- Next.js 14 App Router의 Server Component 패턴
- Supabase client의 올바른 사용법 (`createClient` with `await`)
- 복잡한 비즈니스 로직을 클라이언트 컴포넌트에서 구현
- 자동 데이터 로드와 수동 조정의 균형

### 10.2 개선 가능 사항
- **가격 이력 관리**: 현재는 가격 변경 시 이력이 남지 않음 (Post-MVP)
- **일괄 가격 조정**: 여러 제품의 마진을 한 번에 조정하는 기능 (Post-MVP)
- **가격 시뮬레이터**: 다양한 마진/환율 시나리오를 비교하는 도구 (Post-MVP)
- **승인 워크플로우**: 가격 변경에 대한 승인 프로세스 (Post-MVP)

---

## 11. 결론

✅ **Phase 06 가격 계산 엔진이 성공적으로 구현되었습니다.**

**핵심 성과:**
- 원가 기반 가격 자동 계산 로직 완성
- 사용자 친화적인 UI/UX (자동 로드 + 수동 조정)
- 데이터 무결성 보장 (검증 규칙 + UNIQUE 제약)
- 확장 가능한 아키텍처

이제 시스템은 다음 단계인 **판매 입력(Phase 07)**을 위한 준비가 완료되었습니다. 가격 설정 데이터를 기반으로 지사의 일일 판매를 기록하고 재고를 자동으로 차감할 수 있습니다.

---

**작업 완료 시각**: 2025-10-30
**다음 Phase 시작 가능**: ✅ Ready
