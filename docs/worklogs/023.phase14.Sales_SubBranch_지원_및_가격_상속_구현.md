# 023. Phase 14: Sales Sub-Branch 지원 및 가격 상속 구현

## 작업 개요

Branch Manager가 자신의 Branch뿐만 아니라 하위 Sub-Branch의 판매도 관리할 수 있도록 Sales 기능을 확장하고, Sub-Branch에 가격 설정이 없을 경우 부모 Branch의 가격을 자동으로 상속받도록 구현.

## 완료된 작업

### Phase 2: Sales 페이지 Sub-Branch 지원

#### 1. Sales 페이지 - Sub-Branch 판매 조회
**파일:** `app/(dashboard)/sales/page.tsx`

- Branch Manager가 자신의 Location + 하위 Sub-Branch 판매 내역 조회 가능
- `getDescendants()` 함수를 사용하여 계층 구조 탐색
- 재고 데이터도 동일하게 Sub-Branch 포함 조회

```typescript
// Sub-Branch 포함 판매 조회
const descendants = getDescendants(profile.location_id, locations)
const allLocationIds = [profile.location_id, ...descendants.map(d => d.id)]
query = query.in('location_id', allLocationIds)
```

#### 2. Sales API - Sub-Branch 판매 등록 허용
**파일:** `app/api/sales/route.ts`

- Branch Manager가 자신의 Branch + 하위 Sub-Branch에 판매 등록 가능
- 권한 검증 로직에 `getDescendants()` 적용

```typescript
if (profile?.role === 'Branch_Manager') {
  const descendants = getDescendants(profile.location_id, locations)
  const allowedIds = [profile.location_id, ...descendants.map(d => d.id)]
  if (!allowedIds.includes(location_id)) {
    return NextResponse.json({ error: 'Access denied' }, { status: 403 })
  }
}
```

#### 3. Quick Sale 인라인 판매 기능
**새 파일:** `components/sales/quick-sale-table.tsx`, `components/sales/quick-sale-row.tsx`

- 판매 목록에서 직접 수량 입력 → Sell 버튼 → 즉시 판매 등록
- Location별 Accordion으로 구분
- 재고 수량, 단가, 총액 실시간 표시

#### 4. Sale Form Location 선택
**파일:** `components/sales/sale-form.tsx`

- 다중 Location 선택 가능 (자신의 Branch + Sub-Branch)
- Location 변경 시 제품/가격 초기화
- 제품 드롭다운에 재고 수량 표시

#### 5. Sales List UI 개편
**파일:** `components/sales/sales-list.tsx`

- 상단: Quick Sale 섹션 (Branch Manager만)
- 하단: Recent Sales 섹션 (날짜별 그룹화)
- Accordion으로 Location별 구분

#### 6. RLS 정책 추가
**파일:** `supabase/migrations/029_allow_branch_manager_subbranch_sales.sql`

- Branch Manager가 Sub-Branch 판매 INSERT/SELECT 허용

---

### Phase 3: Sub-Branch 가격 상속 기능

#### 문제 상황
- HQ Admin 가격 설정 페이지에서 `location_type = 'Branch'`만 조회
- Sub-Branch는 pricing_configs에 데이터 없음
- Branch Manager가 Sub-Branch에서 판매 시 "No pricing configuration" 에러 발생

#### 해결 방안
Sub-Branch에 직접 가격이 없을 경우 부모 Branch의 가격을 자동으로 사용

#### 구현 내용

**1. quick-sale-row.tsx 수정**

```typescript
interface PriceInfo {
  price: number
  inherited: boolean
  parentLocationName?: string
}

// 가격 조회 with 부모 상속
const fetchPriceWithInheritance = async () => {
  // 1. 해당 Location의 직접 가격 조회
  const { data: directPrice } = await supabase
    .from('pricing_configs')
    .select('final_price')
    .eq('product_id', stock.product_id)
    .eq('to_location_id', location.id)
    .maybeSingle()

  if (directPrice) {
    setPriceInfo({ price: directPrice.final_price, inherited: false })
    return
  }

  // 2. 부모 Location 조회
  const { data: locationData } = await supabase
    .from('locations')
    .select('parent_id')
    .eq('id', location.id)
    .single()

  if (!locationData?.parent_id) {
    setPriceInfo(null)
    return
  }

  // 3. 부모 Location 정보 조회
  const { data: parentLocation } = await supabase
    .from('locations')
    .select('id, name')
    .eq('id', locationData.parent_id)
    .single()

  // 4. 부모 가격 조회
  const { data: parentPrice } = await supabase
    .from('pricing_configs')
    .select('final_price')
    .eq('product_id', stock.product_id)
    .eq('to_location_id', locationData.parent_id)
    .maybeSingle()

  if (parentPrice) {
    setPriceInfo({
      price: parentPrice.final_price,
      inherited: true,
      parentLocationName: parentLocation?.name || 'Parent'
    })
  } else {
    setPriceInfo(null)
  }
}
```

**UI 표시:**
```tsx
{priceInfo.inherited && (
  <span className="text-xs text-orange-600 font-medium">(상속)</span>
)}
{priceInfo.inherited && priceInfo.parentLocationName && (
  <div className="text-xs text-muted-foreground">
    ↳ {priceInfo.parentLocationName}
  </div>
)}
```

**2. sale-form.tsx 수정**

동일한 가격 상속 로직 적용:

```typescript
interface PricingInfo {
  unit_price: number
  available_stock: number
  inherited: boolean
  parentLocationName?: string
}
```

가격 표시 UI에 상속 여부 표시:
```tsx
{pricing.inherited && (
  <span className="text-xs text-orange-600 font-medium ml-1">(상속)</span>
)}
{pricing.inherited && pricing.parentLocationName && (
  <div className="text-xs text-muted-foreground">
    ↳ {pricing.parentLocationName}
  </div>
)}
```

---

## 수정된 파일 목록

| 파일 | 변경 내용 |
|------|----------|
| `app/(dashboard)/sales/page.tsx` | Sub-Branch 판매/재고 조회, 데이터 전달 |
| `app/(dashboard)/sales/new/page.tsx` | Sub-Branch 포함 Location 선택 |
| `app/api/sales/route.ts` | Sub-Branch 판매 등록 권한 허용 |
| `components/sales/sale-form.tsx` | Location 선택, 가격 상속 로직 |
| `components/sales/sales-list.tsx` | Quick Sale + Recent Sales 구조 개편 |
| `components/sales/quick-sale-table.tsx` (신규) | 인라인 판매 테이블 |
| `components/sales/quick-sale-row.tsx` (신규) | 개별 행 + 가격 상속 로직 |
| `supabase/migrations/029_*.sql` | Sales RLS 정책 업데이트 |

---

## 커밋 이력

1. **76e694f** - Feat: 판매 폼에 Location 선택 기능 추가 (Sub-Branch 지원)
2. **0825b96** - Feat: 판매 폼 제품 드롭다운에 재고 수량 표시
3. **f49a5e2** - Feat: Sub-Branch 가격 상속 기능 구현

---

## 사용자 시나리오

### Branch Manager (Vietnam) 판매 흐름

1. `/sales` 접속
2. **Quick Sale 섹션:**
   - Vietnam (Branch) - 직접 가격 표시
   - Ho Chi Minh (SubBranch) - "165,000 VND (상속) ↳ Vietnam"
   - Vung Tau (SubBranch) - 동일하게 부모 가격 상속
3. 수량 입력 → Sell → 판매 등록 → 목록 자동 갱신
4. **Recent Sales 섹션:**
   - 모든 Sub-Branch 판매 내역 포함 표시

---

## 향후 계획 (Phase 4)

### 카테고리 기반 가격 템플릿 시스템

현재 개별 제품-Location 가격 설정은 시간이 오래 걸리는 문제가 있음.
Phase 4에서 다음 기능 구현 예정:

1. **pricing_templates 테이블** - 카테고리별 마진 템플릿
2. **일괄 적용 API** - 템플릿 선택 → 해당 카테고리 제품 전체 가격 설정
3. **템플릿 관리 UI** - `/pricing/templates` 페이지

상세 계획은 `docs/plans/bubbly-singing-graham.md` 참조.

---

## 기술적 고려사항

1. **성능:** 가격 조회 시 최대 4번의 DB 쿼리 (직접 → 부모 Location → 부모 정보 → 부모 가격)
   - 향후 최적화: 단일 쿼리로 JOIN 처리 가능

2. **일관성:** 부모 가격 변경 시 Sub-Branch는 자동으로 새 가격 반영
   - 별도 데이터 동기화 불필요

3. **확장성:** 다단계 상속 가능 (HQ → Branch → SubBranch)
   - 현재는 1단계 상속만 구현
