# 034. Phase 21: 가격표 인쇄 기능 개선

## 작업 일자
2024-12-17

## 작업 내용

### 개요
가격표 인쇄 시 별도 페이지에서 다단 레이아웃으로 깔끔하게 출력되도록 개선

### 문제점 (개선 전)
- 현재 페이지에서 `window.print()` 호출 시 스크롤 발생
- 11pt 폰트로 인해 많은 데이터 시 페이지 넘침
- 단일 컬럼으로 공간 비효율적
- PDF 다운로드 기능 없음

### 주요 기능

1. **별도 인쇄 페이지**
   - `/print/pricing?locationId=xxx` 경로로 새 창에서 열림
   - 인쇄 전용 최적화된 레이아웃
   - 팝업 차단 시 안내 메시지 표시

2. **자동 레이아웃 조절**
   - 데이터 양에 따라 폰트 크기와 단 수 자동 조절
   - ~20개: 9pt, 2단
   - 21~40개: 8pt, 2단
   - 41~60개: 8pt, 3단
   - 60개+: 7pt, 3단

3. **다단 레이아웃**
   - CSS columns 활용
   - 2단/3단 자동 선택
   - 컬럼 간 구분선 표시

4. **PDF 다운로드**
   - html2pdf.js 라이브러리 사용
   - 원클릭 PDF 저장
   - A4 사이즈 최적화

5. **인쇄 버튼 그룹**
   - 인쇄 버튼: 브라우저 인쇄 다이얼로그
   - PDF 다운로드 버튼: 직접 PDF 파일 저장
   - 닫기 버튼: 창 닫기

## 생성된 파일

### 새 파일
1. `app/print/pricing/page.tsx` - 인쇄 전용 페이지 (서버 컴포넌트, 대시보드 레이아웃 밖)
2. `app/print/layout.tsx` - 인쇄 전용 레이아웃 (사이드바/헤더 없음)
3. `components/pricing/price-list-view/print-view.tsx` - 인쇄 뷰 컴포넌트 (클라이언트)

### 수정된 파일
1. `app/globals.css` - 다단 레이아웃 및 인쇄 스타일 추가
2. `components/pricing/price-list-view/price-list-export.tsx` - 인쇄 버튼 동작 수정 (새 창 열기)
3. `components/pricing/price-list-view/price-list-tabs.tsx` - locationId prop 전달
4. `lib/utils.ts` - formatCurrency에 non-breaking space 추가 (줄바꿈 방지)

### 삭제된 파일
1. `app/(dashboard)/pricing/list/print/page.tsx` - 대시보드 레이아웃 상속 문제로 삭제

### 패키지 추가
- `html2pdf.js` - PDF 생성 라이브러리

## 기술적 세부사항

### 자동 레이아웃 계산
```typescript
function getLayoutConfig(itemCount: number) {
  if (itemCount <= 20) return { fontSize: 'print-font-9pt', columns: 'print-columns-2' }
  if (itemCount <= 40) return { fontSize: 'print-font-8pt', columns: 'print-columns-2' }
  if (itemCount <= 60) return { fontSize: 'print-font-8pt', columns: 'print-columns-3' }
  return { fontSize: 'print-font-7pt', columns: 'print-columns-3' }
}
```

### PDF 생성
```typescript
const html2pdf = (await import('html2pdf.js')).default

const opt = {
  margin: 10,
  filename: `PriceList_${locationName}_${date}.pdf`,
  image: { type: 'jpeg', quality: 0.98 },
  html2canvas: { scale: 2, useCORS: true },
  jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
}

html2pdf().set(opt).from(contentRef.current).save()
```

### CSS 다단 레이아웃
```css
.print-columns-2 { column-count: 2; }
.print-columns-3 { column-count: 3; }

.print-table-compact {
  break-inside: avoid-column;
  font-size: 8pt;
}
```

## 데이터 흐름

```
[PriceListExport 인쇄 버튼 클릭]
      ↓
[window.open('/print/pricing?locationId=xxx')]
      ↓
[PrintPage 서버 컴포넌트 (app/print/pricing/page.tsx)]
  ├─ locationId로 pricing_configs 조회
  └─ parent 가격 계산
      ↓
[PrintView 클라이언트 컴포넌트]
  ├─ 데이터 양에 따른 레이아웃 계산
  ├─ 다단 테이블 렌더링
  └─ 인쇄/PDF/닫기 버튼
      ↓
[사용자 선택: 인쇄 or PDF 저장]
```

## 레이아웃 구조 변경

### 문제점 1 (초기 구현)
- 인쇄 페이지가 `app/(dashboard)/pricing/list/print/page.tsx`에 위치
- 대시보드 레이아웃을 상속받아 사이드바와 헤더가 함께 표시됨
- CSS는 적용되었으나 불필요한 UI 요소가 인쇄물에 포함

### 해결책 1
- 인쇄 페이지를 `app/print/pricing/page.tsx`로 이동 (대시보드 라우트 그룹 밖)
- `app/print/layout.tsx`에 별도 레이아웃 생성 (사이드바/헤더 없음)
- 깔끔한 인쇄 전용 페이지 구현

### 문제점 2 (Hydration 에러)
- `app/print/layout.tsx`에서 `<html>`과 `<body>` 태그를 중복 렌더링
- Next.js App Router에서는 루트 레이아웃만 이 태그들을 가져야 함
- 중첩된 레이아웃에서 사용 시 Hydration 에러 발생:
  ```
  Error: Hydration failed because the initial UI does not match what was rendered on the server.
  Warning: In HTML, <html> cannot be a child of <body>.
  Warning: You are mounting a new html component when a previous one has not first unmounted.
  ```

### 해결책 2
- `app/print/layout.tsx`에서 `<html>`과 `<body>` 태그 제거
- Fragment(`<>{children}</>`)만 반환하도록 수정

```typescript
// 수정 전 (에러 발생)
export default function PrintLayout({ children }: { children: React.ReactNode }) {
  return (
    <html lang="ko">
      <body className="bg-white">
        {children}
      </body>
    </html>
  )
}

// 수정 후 (정상 동작)
export default function PrintLayout({ children }: { children: React.ReactNode }) {
  return <>{children}</>
}
```

## 테스트 결과
- TypeScript 타입 체크: 통과
- Next.js 빌드: 성공
- 새 페이지 `/print/pricing` 추가 확인
- Hydration 에러 해결 확인

## 접근 방법
1. `/pricing/list` 페이지에서 탭 선택
2. "인쇄" 버튼 클릭
3. 새 창에서 인쇄 전용 페이지 열림 (`/print/pricing?locationId=xxx`)
4. "인쇄" 또는 "PDF 다운로드" 선택

## 관련 계획 문서
- `C:\Users\user\.claude\plans\iterative-toasting-glade.md`
