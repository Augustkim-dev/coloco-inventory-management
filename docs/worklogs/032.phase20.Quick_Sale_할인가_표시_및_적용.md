# 032. Quick Sale 페이지 할인가 표시 및 적용

## 작업 일자
2025-12-08

## 작업 개요
Branch Manager가 Quick Sale 페이지에서 판매 시 pricing_configs에 설정된 할인율(discount_percent)과 할인가(discounted_price)가 표시되지 않고 적용되지 않는 문제 수정

## 문제점

### 기존 상태
- Quick Sale 페이지에서 `final_price`만 조회하여 표시
- 판매 기록 시 할인 적용 안 된 `final_price`로 저장
- pricing_configs에 설정된 `discount_percent`, `discounted_price` 무시됨

### 영향
- Branch Manager가 할인 정보를 확인할 수 없음
- 할인가로 판매해야 하는데 원가로 기록됨
- 매출 데이터 부정확

## 수정 내용

### 1. PriceInfo 인터페이스 확장
**파일:** `components/sales/quick-sale-row.tsx`

```typescript
// Before
interface PriceInfo {
  price: number
  inherited: boolean
  parentLocationName?: string
}

// After
interface PriceInfo {
  consumerPrice: number      // final_price (할인 전 가격)
  discountPercent: number    // discount_percent (0-100)
  salePrice: number          // discounted_price 또는 final_price (실제 판매가)
  inherited: boolean
  parentLocationName?: string
}
```

### 2. 데이터베이스 쿼리 수정
직접 가격 및 상속 가격 조회 시 할인 필드 추가:
```typescript
.select('final_price, discount_percent, discounted_price')
```

### 3. 가격 상태 설정 로직
```typescript
const discountPercent = directPrice.discount_percent ?? 0
const salePrice = directPrice.discounted_price ?? directPrice.final_price

setPriceInfo({
  consumerPrice: directPrice.final_price,
  discountPercent: discountPercent,
  salePrice: salePrice,
  inherited: false,
})
```

### 4. 판매 시 할인가 사용
```typescript
unit_price: priceInfo.salePrice,  // discounted_price 사용
```

### 5. UI 가격 표시 업데이트
할인이 있을 때:
- 취소선 처리된 원래 가격 (consumerPrice)
- 녹색으로 표시된 할인가 (salePrice)
- 할인율 배지 (-X%)

```tsx
{priceInfo.discountPercent > 0 ? (
  <>
    <div className="text-xs text-muted-foreground line-through">
      {formatCurrency(priceInfo.consumerPrice, currency)}
    </div>
    <div className="flex items-center justify-end gap-1">
      <span className="font-semibold text-green-600">
        {formatCurrency(priceInfo.salePrice, currency)}
      </span>
      <span className="text-xs bg-green-100 text-green-700 px-1 rounded">
        -{priceInfo.discountPercent}%
      </span>
    </div>
  </>
) : (
  <div>{formatCurrency(priceInfo.salePrice, currency)}</div>
)}
```

### 6. 토스트 메시지 업데이트
```typescript
description: priceInfo.discountPercent > 0
  ? `Total: ${formatCurrency(total, currency)} (${priceInfo.discountPercent}% 할인 적용)`
  : `Total: ${formatCurrency(total, currency)}`
```

### 7. 테이블 헤더 변경
**파일:** `components/sales/quick-sale-table.tsx`
- "Unit Price" → "Sale Price"

## 수정된 파일
| 파일 | 변경 내용 |
|------|----------|
| `components/sales/quick-sale-row.tsx` | 인터페이스, 쿼리, 로직, UI 전면 수정 |
| `components/sales/quick-sale-table.tsx` | 테이블 헤더 라벨 변경 |

## UI 변경 예시

| 할인 없음 | 할인 있음 (20%) |
|-----------|-----------------|
| 165,000 VND | ~~165,000 VND~~ |
| | **132,000 VND** -20% |

## 엣지 케이스 처리
| 케이스 | 처리 방법 |
|--------|----------|
| `discount_percent = 0` 또는 `null` | `salePrice = consumerPrice`, 할인 UI 숨김 |
| `discounted_price = null` | `salePrice = final_price` 사용 |
| 상속 + 할인 | 두 표시 모두 노출 |

## 테스트 체크리스트
- [x] 할인 없는 제품 판매 - 단일 가격 표시
- [x] 할인 있는 제품 판매 - 취소선 + 할인가 표시
- [x] 상속 가격 + 할인 - 상속 표시 + 할인 표시
- [x] 총액 계산 정확성 확인
- [x] 토스트 메시지 할인 정보 표시
- [x] TypeScript 빌드 성공

## 커밋 정보
- 커밋 해시: `7bb6899`
- 메시지: `Feat: Quick Sale 페이지에서 할인가 표시 및 적용`

## 관련 이슈
- Phase 20: Sub Branch 마진 및 할인 기능의 후속 작업
- pricing_configs 테이블의 discount_percent, discounted_price 필드 활용
