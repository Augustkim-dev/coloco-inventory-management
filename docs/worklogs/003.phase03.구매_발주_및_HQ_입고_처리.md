# Phase 03 Worklog: êµ¬ë§¤ ë°œì£¼ ë° HQ ì…ê³  ì²˜ë¦¬

**ì‘ì—… ì¼ì**: 2025-10-29
**ì‘ì—…ì**: ê°œë°œíŒ€
**ëª©í‘œ**: ê³µì¥ ë°œì£¼ â†’ HQ ì…ê³  â†’ ì¬ê³  ìë™ ì¦ê°€ ì›Œí¬í”Œë¡œìš° êµ¬í˜„
**ìƒíƒœ**: âœ… ì™„ë£Œ

---

## ì‘ì—… ê°œìš”

Phase 03ì—ì„œëŠ” êµ¬ë§¤ ë°œì£¼(Purchase Order) ì „ì²´ ì›Œí¬í”Œë¡œìš°ë¥¼ êµ¬í˜„í–ˆìŠµë‹ˆë‹¤. PO ìƒì„±, ìŠ¹ì¸, HQ ì…ê³  ì²˜ë¦¬ë¥¼ í†µí•´ ì¬ê³ ê°€ ìë™ìœ¼ë¡œ ì¦ê°€í•˜ëŠ” ì™„ì „í•œ í”„ë¡œì„¸ìŠ¤ë¥¼ ì™„ì„±í–ˆìŠµë‹ˆë‹¤.

---

## êµ¬í˜„ëœ ê¸°ëŠ¥

### 1. êµ¬ë§¤ ë°œì£¼(PO) ìƒì„± ê¸°ëŠ¥

#### 1.1 PO ëª©ë¡ í˜ì´ì§€
**íŒŒì¼**: `app/(dashboard)/purchase-orders/page.tsx`

**êµ¬í˜„ ë‚´ìš©**:
- PO ì „ì²´ ëª©ë¡ ì¡°íšŒ (ê³µê¸‰ì—…ì²´ ì •ë³´ í¬í•¨)
- PO ì•„ì´í…œ ìƒì„¸ ì •ë³´ í¬í•¨ (ì œí’ˆëª…, SKU)
- ìƒì„±ì¼ì ê¸°ì¤€ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬
- HQ Admin ê¶Œí•œ ì²´í¬
- "Create PO" ë²„íŠ¼ìœ¼ë¡œ ì‹ ê·œ ìƒì„± í˜ì´ì§€ ì´ë™

**ì¿¼ë¦¬ ìµœì í™”**:
```typescript
.select(`
  *,
  supplier:suppliers(name),
  items:purchase_order_items(
    id, qty, unit_price, total_price,
    product:products(name, sku)
  )
`)
```

#### 1.2 PO ëª©ë¡ ì»´í¬ë„ŒíŠ¸
**íŒŒì¼**: `components/purchase-orders/po-list.tsx`

**êµ¬í˜„ ë‚´ìš©**:
- í…Œì´ë¸” í˜•ì‹ìœ¼ë¡œ PO í‘œì‹œ
- ì»¬ëŸ¼: PO No., Supplier, Order Date, Status, Total Amount, Actions
- ìƒíƒœë³„ ë°°ì§€ í‘œì‹œ:
  - **Draft**: íšŒìƒ‰ (secondary)
  - **Approved**: íŒŒë€ìƒ‰ (default)
  - **Received**: ì´ˆë¡ìƒ‰ (outline)
- ìƒíƒœë³„ ì•¡ì…˜ ë²„íŠ¼:
  - ëª¨ë“  PO: ğŸ‘ï¸ View Details
  - Draft PO: âœ… Approve
  - Approved PO: ğŸ“¦ Receive
- Empty state ì²˜ë¦¬ (PO ì—†ì„ ë•Œ)

**íƒ€ì… ì•ˆì „ì„±**:
```typescript
interface PurchaseOrder {
  currency: Currency  // 'KRW' | 'VND' | 'CNY'
  status: 'Draft' | 'Approved' | 'Received'
}
```

#### 1.3 PO ìƒì„± í˜ì´ì§€
**íŒŒì¼**: `app/(dashboard)/purchase-orders/new/page.tsx`

**êµ¬í˜„ ë‚´ìš©**:
- ê³µê¸‰ì—…ì²´ ëª©ë¡ ì¡°íšŒ (ì´ë¦„ ìˆœ ì •ë ¬)
- ì œí’ˆ ëª©ë¡ ì¡°íšŒ (SKU ìˆœ ì •ë ¬)
- POForm ì»´í¬ë„ŒíŠ¸ì— ë°ì´í„° ì „ë‹¬

#### 1.4 PO ìƒì„± í¼
**íŒŒì¼**: `components/purchase-orders/po-form.tsx`

**êµ¬í˜„ ë‚´ìš©**:
- **PO í—¤ë” ì •ë³´**:
  - PO ë²ˆí˜¸ (ìë™ ìƒì„±: `PO-{timestamp}`)
  - ì£¼ë¬¸ ë‚ ì§œ (ê¸°ë³¸ê°’: ì˜¤ëŠ˜)
  - ê³µê¸‰ì—…ì²´ ì„ íƒ (ë“œë¡­ë‹¤ìš´)
  - ë¹„ê³  (ì˜µì…˜)

- **ë™ì  ì•„ì´í…œ ê´€ë¦¬**:
  - ì œí’ˆ ì„ íƒ (SKU, ì´ë¦„, ë‹¨ìœ„ í‘œì‹œ)
  - ìˆ˜ëŸ‰ ì…ë ¥
  - ë‹¨ê°€ ì…ë ¥ (KRW)
  - ìë™ ê³„ì‚°: ìˆ˜ëŸ‰ Ã— ë‹¨ê°€ = ì´ì•¡
  - "Add Item" ë²„íŠ¼ìœ¼ë¡œ í–‰ ì¶”ê°€
  - ğŸ—‘ï¸ ì‚­ì œ ë²„íŠ¼ìœ¼ë¡œ í–‰ ì œê±° (ìµœì†Œ 1ê°œ ìœ ì§€)

- **ì‹¤ì‹œê°„ ì´ì•¡ ê³„ì‚°**:
  ```typescript
  const calculateTotal = () => {
    return items.reduce((sum, item) => sum + item.qty * item.unit_price, 0)
  }
  ```

- **ìœ íš¨ì„± ê²€ì‚¬**:
  - ê³µê¸‰ì—…ì²´ í•„ìˆ˜ ì„ íƒ
  - ëª¨ë“  ì•„ì´í…œ ì •ë³´ í•„ìˆ˜ ì…ë ¥
  - ìˆ˜ëŸ‰ > 0, ë‹¨ê°€ â‰¥ 0

- **ë°ì´í„°ë² ì´ìŠ¤ ì €ì¥**:
  1. `purchase_orders` í…Œì´ë¸”ì— PO í—¤ë” ì‚½ì…
  2. `purchase_order_items` í…Œì´ë¸”ì— ì•„ì´í…œ ì‚½ì…
  3. ìƒíƒœ: Draft
  4. í†µí™”: KRW (ê³ ì •)
  5. created_by: í˜„ì¬ ì‚¬ìš©ì ID

---

### 2. PO ìŠ¹ì¸ ê¸°ëŠ¥

#### 2.1 ìŠ¹ì¸ API
**íŒŒì¼**: `app/api/purchase-orders/[id]/approve/route.ts`

**êµ¬í˜„ ë‚´ìš©**:
- POST ìš”ì²­ ì²˜ë¦¬
- ì¸ì¦ í™•ì¸ (JWT)
- **ìƒíƒœ ì „ì´ ê²€ì¦**: Draft â†’ Approvedë§Œ í—ˆìš©
- ì—…ë°ì´íŠ¸ í•„ë“œ:
  - `status`: 'Approved'
  - `approved_by`: í˜„ì¬ ì‚¬ìš©ì ID
  - `approved_at`: í˜„ì¬ íƒ€ì„ìŠ¤íƒ¬í”„

**ë³´ì•ˆ**:
```typescript
.eq('id', params.id)
.eq('status', 'Draft')  // Draft ìƒíƒœë§Œ ìŠ¹ì¸ ê°€ëŠ¥
```

#### 2.2 ìŠ¹ì¸ í˜ì´ì§€
**íŒŒì¼**: `app/(dashboard)/purchase-orders/[id]/approve/page.tsx`

**êµ¬í˜„ ë‚´ìš©**:
- í´ë¼ì´ì–¸íŠ¸ ì»´í¬ë„ŒíŠ¸
- ìŠ¹ì¸ í™•ì¸ ë©”ì‹œì§€ í‘œì‹œ
- "Approve PO" ë²„íŠ¼ìœ¼ë¡œ API í˜¸ì¶œ
- ì„±ê³µ ì‹œ PO ëª©ë¡ìœ¼ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
- Toast ì•Œë¦¼ (ì„±ê³µ/ì‹¤íŒ¨)

---

### 3. HQ ì…ê³  ì²˜ë¦¬ ê¸°ëŠ¥

#### 3.1 ì…ê³  ì²˜ë¦¬ í˜ì´ì§€
**íŒŒì¼**: `app/(dashboard)/purchase-orders/[id]/receive/page.tsx`

**êµ¬í˜„ ë‚´ìš©**:
- **Approved ìƒíƒœ POë§Œ ì¡°íšŒ**:
  ```typescript
  .eq('status', 'Approved')
  ```
- PO ë° ì•„ì´í…œ ìƒì„¸ ì •ë³´ ì¡°íšŒ
- ì œí’ˆ ì •ë³´ í¬í•¨ (shelf_life_days í•„ìˆ˜)
- HQ ì§€ì‚¬ ID ì¡°íšŒ (location_type = 'HQ')
- ReceiveFormì— ë°ì´í„° ì „ë‹¬

#### 3.2 ì…ê³  ì²˜ë¦¬ í¼
**íŒŒì¼**: `components/purchase-orders/receive-form.tsx`

**êµ¬í˜„ ë‚´ìš©**:
- **ì œí’ˆë³„ ë°°ì¹˜ ì •ë³´ ì…ë ¥**:
  - ì£¼ë¬¸ ìˆ˜ëŸ‰ (ì½ê¸° ì „ìš©)
  - **ì…ê³  ìˆ˜ëŸ‰** (ìˆ˜ì • ê°€ëŠ¥, ê¸°ë³¸ê°’: ì£¼ë¬¸ ìˆ˜ëŸ‰)
  - **ë°°ì¹˜ ë²ˆí˜¸** (ìë™ ìƒì„±: `BATCH-{timestamp}-{random}`)
  - **ì œì¡°ì¼ì** (ê¸°ë³¸ê°’: ì˜¤ëŠ˜)
  - **ìœ í†µê¸°í•œ** (ìë™ ê³„ì‚°, ì½ê¸° ì „ìš©)
  - **í’ˆì§ˆ ìƒíƒœ** (OK / Damaged / Quarantine)

- **ìœ í†µê¸°í•œ ìë™ ê³„ì‚°**:
  ```typescript
  const calculateExpiryDate = (manufacturedDate: string, shelfLifeDays: number) => {
    const date = new Date(manufacturedDate)
    date.setDate(date.getDate() + shelfLifeDays)
    return date.toISOString().split('T')[0]
  }
  ```

- **ì¹´ë“œ ë ˆì´ì•„ì›ƒ**:
  - ì œí’ˆë³„ ê°œë³„ ì¹´ë“œë¡œ êµ¬ë¶„
  - SKU, ì œí’ˆëª…, ë‹¨ìœ„ í‘œì‹œ
  - 3ì—´ ê·¸ë¦¬ë“œ ë ˆì´ì•„ì›ƒ

- **ìœ íš¨ì„± ê²€ì‚¬**:
  - ì…ê³  ìˆ˜ëŸ‰ > 0
  - ë°°ì¹˜ ë²ˆí˜¸ í•„ìˆ˜
  - ì œì¡°ì¼ì í•„ìˆ˜

#### 3.3 ì…ê³  ì²˜ë¦¬ API
**íŒŒì¼**: `app/api/purchase-orders/[id]/receive/route.ts`

**êµ¬í˜„ ë‚´ìš©**:
- POST ìš”ì²­ ì²˜ë¦¬
- ì…ê³  ì•„ì´í…œ ë°°ì—´ ìˆ˜ì‹ 

**ì²˜ë¦¬ ë¡œì§** (2ë‹¨ê³„):
1. **stock_batches ë ˆì½”ë“œ ìƒì„±**:
   ```typescript
   await supabase.from('stock_batches').insert(items)
   ```
   - ê° ì•„ì´í…œë³„ë¡œ stock_batch ìƒì„±
   - í•„ë“œ: product_id, location_id(HQ), batch_no, qty_on_hand, unit_cost, manufactured_date, expiry_date, quality_status

2. **PO ìƒíƒœ ì—…ë°ì´íŠ¸**:
   ```typescript
   await supabase
     .from('purchase_orders')
     .update({
       status: 'Received',
       received_at: new Date().toISOString()
     })
     .eq('id', params.id)
   ```

**ì¬ê³  ì¦ê°€ ë©”ì»¤ë‹ˆì¦˜**:
- stock_batchesì— ìƒˆ ë ˆì½”ë“œ ì‚½ì… â†’ HQ ì¬ê³  ìë™ ì¦ê°€
- qty_on_hand í•„ë“œì— ì…ê³  ìˆ˜ëŸ‰ ì €ì¥
- ë°°ì¹˜ë³„, ì œí’ˆë³„, ìœ„ì¹˜ë³„ ì¬ê³  ì¶”ì 

---

## ë°ì´í„° íë¦„

### PO ìƒì„± â†’ ìŠ¹ì¸ â†’ ì…ê³  ì „ì²´ í”„ë¡œì„¸ìŠ¤

```
1. PO ìƒì„± (Draft)
   â†“
   purchase_orders í…Œì´ë¸”ì— PO ìƒì„±
   purchase_order_items í…Œì´ë¸”ì— ì•„ì´í…œ ìƒì„±
   status = 'Draft'

2. PO ìŠ¹ì¸ (Draft â†’ Approved)
   â†“
   purchase_orders.status = 'Approved'
   purchase_orders.approved_by = user_id
   purchase_orders.approved_at = timestamp

3. HQ ì…ê³  (Approved â†’ Received)
   â†“
   stock_batches í…Œì´ë¸”ì— ë°°ì¹˜ë³„ ì¬ê³  ìƒì„±
   purchase_orders.status = 'Received'
   purchase_orders.received_at = timestamp
   â†“
   HQ ì¬ê³  ì¦ê°€ ì™„ë£Œ!
```

---

## í•µì‹¬ êµ¬í˜„ íŠ¹ì§•

### 1. íƒ€ì… ì•ˆì „ì„±
- TypeScript strict mode í™œìš©
- Currency íƒ€ì… ì •ì˜ (KRW, VND, CNY)
- PO ìƒíƒœ íƒ€ì… ì •ì˜ (Draft, Approved, Received)
- í’ˆì§ˆ ìƒíƒœ íƒ€ì… ì •ì˜ (OK, Damaged, Quarantine)

### 2. ë°ì´í„° ë¬´ê²°ì„±
- ìƒíƒœ ì „ì´ ê²€ì¦ (Draftë§Œ ìŠ¹ì¸ ê°€ëŠ¥, Approvedë§Œ ì…ê³  ê°€ëŠ¥)
- ì™¸ë˜ í‚¤ ì œì•½ í™œìš©
- íŠ¸ëœì­ì…˜ ìˆœì„œ ë³´ì¥ (stock_batches â†’ PO ìƒíƒœ ì—…ë°ì´íŠ¸)

### 3. ì‚¬ìš©ì ê²½í—˜
- ì‹¤ì‹œê°„ ê³„ì‚° (ì´ì•¡, ìœ í†µê¸°í•œ)
- ë™ì  í¼ (ì•„ì´í…œ ì¶”ê°€/ì‚­ì œ)
- ëª…í™•í•œ ìƒíƒœ í‘œì‹œ (ë°°ì§€)
- Toast ì•Œë¦¼
- Empty state ì²˜ë¦¬

### 4. ê¶Œí•œ ê´€ë¦¬
- ëª¨ë“  PO í˜ì´ì§€ì—ì„œ HQ Admin ê¶Œí•œ ì²´í¬
- ì¸ì¦ë˜ì§€ ì•Šì€ ì‚¬ìš©ì â†’ /login ë¦¬ë‹¤ì´ë ‰íŠ¸
- ê¶Œí•œ ì—†ëŠ” ì‚¬ìš©ì â†’ /dashboard ë¦¬ë‹¤ì´ë ‰íŠ¸

---

## ìƒì„±ëœ íŒŒì¼ ëª©ë¡

### Pages (6ê°œ)
1. `app/(dashboard)/purchase-orders/page.tsx` - PO ëª©ë¡
2. `app/(dashboard)/purchase-orders/new/page.tsx` - PO ìƒì„±
3. `app/(dashboard)/purchase-orders/[id]/approve/page.tsx` - PO ìŠ¹ì¸
4. `app/(dashboard)/purchase-orders/[id]/receive/page.tsx` - HQ ì…ê³ 

### Components (3ê°œ)
5. `components/purchase-orders/po-list.tsx` - PO í…Œì´ë¸”
6. `components/purchase-orders/po-form.tsx` - PO ìƒì„± í¼
7. `components/purchase-orders/receive-form.tsx` - ì…ê³  ì²˜ë¦¬ í¼

### API Routes (2ê°œ)
8. `app/api/purchase-orders/[id]/approve/route.ts` - ìŠ¹ì¸ API
9. `app/api/purchase-orders/[id]/receive/route.ts` - ì…ê³  API

---

## í…ŒìŠ¤íŠ¸ ê²°ê³¼

### âœ… ë¹Œë“œ ì„±ê³µ
```
Route (app)                              Size     First Load JS
â”œ Æ’ /purchase-orders                     3.08 kB         106 kB
â”œ Æ’ /purchase-orders/[id]/approve        2.34 kB        98.3 kB
â”œ Æ’ /purchase-orders/[id]/receive        7.92 kB         131 kB
â”œ Æ’ /purchase-orders/new                 4.66 kB         180 kB
```

### âœ… TypeScript íƒ€ì… ì²´í¬ í†µê³¼
- Currency íƒ€ì… ì˜¤ë¥˜ ìˆ˜ì • ì™„ë£Œ
- ëª¨ë“  ì»´í¬ë„ŒíŠ¸ íƒ€ì… ì•ˆì „ì„± í™•ë³´

### âœ… ê¸°ëŠ¥ ê²€ì¦ (ì˜ˆìƒ)
1. PO ìƒì„± â†’ Draft ìƒíƒœë¡œ ì €ì¥ë¨
2. Draft PO ìŠ¹ì¸ â†’ Approved ìƒíƒœë¡œ ë³€ê²½
3. Approved PO ì…ê³  â†’ stock_batches ìƒì„±, Received ìƒíƒœë¡œ ë³€ê²½
4. HQ ì¬ê³  ì¦ê°€ í™•ì¸ ê°€ëŠ¥

---

## ì£¼ìš” ì˜ì‚¬ê²°ì •

### 1. ë°°ì¹˜ ë²ˆí˜¸ ìë™ ìƒì„±
- í˜•ì‹: `BATCH-{timestamp}-{random5char}`
- ì´ìœ : ì¤‘ë³µ ë°©ì§€, ì¶”ì  ê°€ëŠ¥ì„±

### 2. í†µí™” ê³ ì • (KRW)
- MVPì—ì„œëŠ” HQ(í•œêµ­) ë°œì£¼ë§Œ ì§€ì›
- ì¶”í›„ ë‹¤ì¤‘ í†µí™” ì§€ì› í™•ì¥ ê°€ëŠ¥

### 3. ìœ í†µê¸°í•œ ìë™ ê³„ì‚°
- ì œì¡°ì¼ + shelf_life_days
- ì‚¬ìš©ìê°€ ìˆ˜ë™ìœ¼ë¡œ ë³€ê²½ ë¶ˆê°€ (ë°ì´í„° ì¼ê´€ì„±)

### 4. ìƒíƒœ ì „ì´ ì—„ê²© ê²€ì¦
- Draft â†’ Approved â†’ Received ìˆœì„œ ê°•ì œ
- ë°ì´í„°ë² ì´ìŠ¤ ì¿¼ë¦¬ì—ì„œ ìƒíƒœ ì²´í¬ (.eq('status', 'Draft'))

### 5. ì¬ê³  ìë™ ì¦ê°€
- stock_batches ì‚½ì…ìœ¼ë¡œ ì¬ê³  ì¦ê°€
- ë³„ë„ì˜ ì¬ê³  ì—…ë°ì´íŠ¸ ë¡œì§ ë¶ˆí•„ìš”

---

## ë‹¤ìŒ Phase ì¤€ë¹„ì‚¬í•­

### Phase 04: ì¬ê³  ê´€ë¦¬ ë° HQ â†’ ì§€ì‚¬ ì´ì „
- HQ ì¬ê³  ì¡°íšŒ UI
- FIFO ë¡œì§ êµ¬í˜„ (ê°€ì¥ ë¹ ë¥¸ ìœ í†µê¸°í•œë¶€í„° ì¶œê³ )
- ì§€ì‚¬ ì´ì „ ì›Œí¬í”Œë¡œìš°
- ì¬ê³  ì´ë™ íˆìŠ¤í† ë¦¬

### Phase 05: í™˜ìœ¨ ê´€ë¦¬
- í™˜ìœ¨ CRUD
- í™˜ìœ¨ íˆìŠ¤í† ë¦¬
- í†µí™” ë³€í™˜ ìœ í‹¸ë¦¬í‹°

### Phase 06: ê°€ê²© ê³„ì‚° ì—”ì§„
- ê°€ê²© ì„¤ì • UI
- ê°€ê²© ê³„ì‚° ê³µì‹ ì ìš©
- ë§ˆì§„ ê³„ì‚°

---

## ê°œì„  ê°€ëŠ¥ ì‚¬í•­ (Post-MVP)

1. **PO ìƒì„¸ ì¡°íšŒ í˜ì´ì§€** (`/purchase-orders/[id]`)
   - í˜„ì¬ëŠ” ìŠ¹ì¸/ì…ê³  í˜ì´ì§€ë§Œ ì¡´ì¬
   - ìƒì„¸ ì •ë³´ í‘œì‹œ í˜ì´ì§€ ì¶”ê°€

2. **PO ìˆ˜ì • ê¸°ëŠ¥**
   - Draft ìƒíƒœ PO ìˆ˜ì • í—ˆìš©

3. **ë¶€ë¶„ ì…ê³  ì²˜ë¦¬**
   - í˜„ì¬ëŠ” ì „ì²´ ì…ê³ ë§Œ ì§€ì›
   - ì•„ì´í…œë³„ ë¶€ë¶„ ì…ê³  ì§€ì›

4. **ì…ê³  íˆìŠ¤í† ë¦¬**
   - ì…ê³  ì¼ì, ë‹´ë‹¹ì ê¸°ë¡
   - ìˆ˜ëŸ‰ ë³€ê²½ ì´ë ¥

5. **ë°°ì¹˜ ë²ˆí˜¸ ì¤‘ë³µ ì²´í¬**
   - ë™ì¼ ì œí’ˆ + ë™ì¼ ë°°ì¹˜ ë²ˆí˜¸ ê²€ì¦

6. **Excel ë‚´ë³´ë‚´ê¸°**
   - PO ëª©ë¡ Excel ë‹¤ìš´ë¡œë“œ

---

## ë°°ìš´ ì 

### 1. Next.js 14 App Router íŒ¨í„´
- Server Componentì—ì„œ `await createClient()` ì‚¬ìš©
- Client Componentì—ì„œ `createClient()` (ë™ê¸°) ì‚¬ìš©
- paramsëŠ” async ì²˜ë¦¬ í•„ìš”

### 2. ë™ì  í¼ ê´€ë¦¬
- useState ë°°ì—´ë¡œ ì•„ì´í…œ ê´€ë¦¬
- ì¸ë±ìŠ¤ ê¸°ë°˜ ì—…ë°ì´íŠ¸
- ìµœì†Œ 1ê°œ ì•„ì´í…œ ìœ ì§€

### 3. íƒ€ì… ì•ˆì „ì„± ì¤‘ìš”ì„±
- Currency íƒ€ì… ëª…ì‹œë¡œ ë²„ê·¸ ì‚¬ì „ ë°©ì§€
- ì»´íŒŒì¼ íƒ€ì„ì— ì˜¤ë¥˜ ê°ì§€

### 4. ì‚¬ìš©ì í”¼ë“œë°±
- Toast ì•Œë¦¼ìœ¼ë¡œ ì•¡ì…˜ ê²°ê³¼ ëª…í™•íˆ ì „ë‹¬
- ë¡œë”© ìƒíƒœ í‘œì‹œ (ë²„íŠ¼ disabled)

---

## ì‘ì—… í†µê³„

- **ì‘ì—… ì‹œê°„**: ì•½ 4ì‹œê°„
- **ìƒì„±ëœ íŒŒì¼**: 9ê°œ
- **ì½”ë“œ ë¼ì¸ ìˆ˜**: ì•½ 1,100ì¤„
- **TypeScript íƒ€ì… ì •ì˜**: 3ê°œ ì¸í„°í˜ì´ìŠ¤

---

## íŠ¸ëŸ¬ë¸”ìŠˆíŒ… ë° ë²„ê·¸ ìˆ˜ì •

### ì´ìŠˆ #1: ë¡œê·¸ì¸ í›„ ë¦¬ë‹¤ì´ë ‰ì…˜ ë¬¸ì œ

**ì¦ìƒ**:
- ë¡œê·¸ì¸ ì„±ê³µ í›„ dashboardë¡œ ì´ë™í–ˆë‹¤ê°€ ì¦‰ì‹œ login í˜ì´ì§€ë¡œ ëŒì•„ì˜´
- ë„¤íŠ¸ì›Œí¬ íƒ­ì—ì„œ `localhost` 307 ë¦¬ë‹¤ì´ë ‰íŠ¸ í™•ì¸

**ì›ì¸ ë¶„ì„**:
1. **í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œ ë¡œê·¸ì¸ ë°©ì‹ì˜ ì¿ í‚¤ ì„¤ì • ë¬¸ì œ**
   - `router.push()`ì™€ `router.refresh()` ì—°ì† í˜¸ì¶œ ì‹œ ì¿ í‚¤ê°€ ì œëŒ€ë¡œ ì „íŒŒë˜ì§€ ì•ŠìŒ
   - ë¯¸ë“¤ì›¨ì–´ê°€ ì¸ì¦ ì¿ í‚¤ë¥¼ ê°ì§€í•˜ì§€ ëª»í•¨

2. **Supabase RLS (Row Level Security) ë¬´í•œ ì¬ê·€ ë¬¸ì œ**
   - `users` í…Œì´ë¸” ì¡°íšŒ ì‹œ `Error code: 42P17` ë°œìƒ
   - ì—ëŸ¬ ë©”ì‹œì§€: `infinite recursion detected in policy for relation "users"`
   - RLS ì •ì±…ì—ì„œ `users` í…Œì´ë¸”ì„ ì°¸ì¡°í•˜ëŠ” ê³¼ì •ì—ì„œ ë¬´í•œ ë£¨í”„ ë°œìƒ

**í•´ê²° ê³¼ì •**:

#### 1ë‹¨ê³„: ë£¨íŠ¸ í˜ì´ì§€ ì¸ì¦ ì²´í¬ êµ¬í˜„

**íŒŒì¼**: `app/page.tsx`

```typescript
// Before: ë¬´ì¡°ê±´ /loginìœ¼ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
export default function Home() {
  redirect("/login")
}

// After: ì¸ì¦ ìƒíƒœ í™•ì¸ í›„ ë¶„ê¸°
export default async function Home() {
  const supabase = await createClient()
  const { data: { user } } = await supabase.auth.getUser()

  if (user) {
    redirect('/dashboard')  // ì¸ì¦ë¨
  } else {
    redirect('/login')      // ì¸ì¦ ì•ˆ ë¨
  }
}
```

#### 2ë‹¨ê³„: Server Action ê¸°ë°˜ ë¡œê·¸ì¸ êµ¬í˜„

**ìƒˆ íŒŒì¼**: `app/(auth)/login/actions.ts`

```typescript
'use server'

import { revalidatePath } from 'next/cache'
import { redirect } from 'next/navigation'
import { createClient } from '@/lib/supabase/server'

export async function login(formData: FormData) {
  const supabase = await createClient()

  const { error } = await supabase.auth.signInWithPassword({
    email: formData.get('email') as string,
    password: formData.get('password') as string,
  })

  if (error) {
    return { error: error.message }
  }

  revalidatePath('/', 'layout')  // ì¸ì¦ ìƒíƒœ ì¦‰ì‹œ ì—…ë°ì´íŠ¸
  redirect('/dashboard')         // ì„œë²„ì—ì„œ ì•ˆì „í•˜ê²Œ ë¦¬ë‹¤ì´ë ‰íŠ¸
}
```

**ìˆ˜ì •**: `app/(auth)/login/page.tsx`

```typescript
// Before: í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œ
const supabase = createClient()
await supabase.auth.signInWithPassword(...)
router.push("/dashboard")
router.refresh()

// After: ì„œë²„ ì•¡ì…˜ ì‚¬ìš©
const formData = new FormData(e.currentTarget)
const result = await login(formData)
```

**ì¥ì **:
- ì„œë²„ì—ì„œ ì¿ í‚¤ ì„¤ì • â†’ ì˜¬ë°”ë¥¸ ì¿ í‚¤ ì „íŒŒ
- `revalidatePath()`ë¡œ ì „ì²´ ë ˆì´ì•„ì›ƒ ì¬ê²€ì¦
- ì„œë²„ì—ì„œ `redirect()` í˜¸ì¶œ â†’ ë¯¸ë“¤ì›¨ì–´ ì •ìƒ ì‘ë™
- ë³´ì•ˆ ê°•í™” (ì¸ì¦ ë¡œì§ì´ ì„œë²„ì—ì„œë§Œ ì‹¤í–‰)

#### 3ë‹¨ê³„: RLS ì •ì±… ë¬´í•œ ì¬ê·€ ë¬¸ì œ í•´ê²°

**ë¬¸ì œê°€ ëœ ì •ì±…** (`001_create_users_table.sql`):

```sql
CREATE POLICY "HQ_Admin can view all users"
  ON public.users
  FOR SELECT
  USING (
    EXISTS (
      SELECT 1 FROM public.users  -- âš ï¸ ë¬´í•œ ì¬ê·€ ë°œìƒ!
      WHERE id = auth.uid() AND role = 'HQ_Admin'
    )
  );
```

**ë””ë²„ê¹… ë¡œê·¸**:
```
[DASHBOARD LAYOUT] User ID: 8920275e-fba1-497f-9b60-ac03cd8f94f7
[DASHBOARD LAYOUT] User data: null
[DASHBOARD LAYOUT] Error: {
  code: '42P17',
  message: 'infinite recursion detected in policy for relation "users"'
}
```

**í•´ê²° ë°©ë²•**: Supabase SQL Editorì—ì„œ ì‹¤í–‰

```sql
-- 1. ë¬¸ì œ ìˆëŠ” ì •ì±…ë“¤ ì‚­ì œ
DROP POLICY IF EXISTS "Users can view own profile" ON public.users;
DROP POLICY IF EXISTS "Enable read access for authenticated users" ON public.users;
DROP POLICY IF EXISTS "Enable update for users based on id" ON public.users;
DROP POLICY IF EXISTS "HQ_Admin can view all users" ON public.users;
DROP POLICY IF EXISTS "HQ_Admin can insert users" ON public.users;
DROP POLICY IF EXISTS "HQ_Admin can update users" ON public.users;

-- 2. ê°„ë‹¨í•˜ê³  ì•ˆì „í•œ ì •ì±… ìƒì„±
CREATE POLICY "users_select_own"
  ON public.users
  FOR SELECT
  TO authenticated
  USING (auth.uid() = id);

CREATE POLICY "users_update_own"
  ON public.users
  FOR UPDATE
  TO authenticated
  USING (auth.uid() = id);
```

**ë˜ëŠ” ê°œë°œ ì¤‘ ì„ì‹œ í•´ê²°**:
```sql
ALTER TABLE public.users DISABLE ROW LEVEL SECURITY;
```

#### 4ë‹¨ê³„: ì‚¬ìš©ì ë°ì´í„° ê²€ì¦

**í™•ì¸ ì‚¬í•­**:
- Userì˜ `location_id` ì„¤ì • í™•ì¸
- HQ Locationê³¼ ì—°ê²° í•„ìš”

```sql
-- HQ Location ID í™•ì¸
SELECT id, name, location_type
FROM locations
WHERE location_type = 'HQ';

-- Userì— HQ Location ì—°ê²°
UPDATE users
SET location_id = (
  SELECT id
  FROM locations
  WHERE location_type = 'HQ'
  LIMIT 1
)
WHERE email = 'aaa@aaa.com';
```

**ê²€ì¦ ê²°ê³¼**:
```json
{
  "id": "8920275e-fba1-497f-9b60-ac03cd8f94f7",
  "email": "aaa@aaa.com",
  "role": "HQ_Admin",
  "location_id": "db405b21-7a67-4cb0-b9fa-035c65f0d399"  // âœ…
}
```

### ìµœì¢… í•´ê²° ê²°ê³¼

âœ… **ë¡œê·¸ì¸ ì„±ê³µ**
```
[LOGIN] Attempting login for: aaa@aaa.com
[LOGIN] Success! User ID: 8920275e-fba1-497f-9b60-ac03cd8f94f7
[LOGIN] Session: exists
```

âœ… **ë¯¸ë“¤ì›¨ì–´ ì •ìƒ ì‘ë™**
```
[MIDDLEWARE] Path: /dashboard
[MIDDLEWARE] User: aaa@aaa.com
```

âœ… **Dashboard ì •ìƒ ë¡œë“œ**
- ë¡œê·¸ì¸ â†’ Dashboard ì´ë™
- Purchase Orders ë©”ë‰´ í‘œì‹œ
- PO ìƒì„±/ìŠ¹ì¸/ì…ê³  ê¸°ëŠ¥ ì‚¬ìš© ê°€ëŠ¥

### ì¶”ê°€ ì»¤ë°‹

1. **c3c70cf**: Fix: ë£¨íŠ¸ í˜ì´ì§€ ì¸ì¦ ì²´í¬ ë° ìë™ ë¦¬ë‹¤ì´ë ‰ì…˜ êµ¬í˜„
2. **b13c67a**: Fix: ë¡œê·¸ì¸ í›„ ë¦¬ë‹¤ì´ë ‰ì…˜ ë¬¸ì œ í•´ê²°
3. **da0b65a**: Fix: Server Actionì„ ì‚¬ìš©í•œ ë¡œê·¸ì¸ êµ¬í˜„

---

## ê²°ë¡ 

Phase 03ì„ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤. êµ¬ë§¤ ë°œì£¼ë¶€í„° HQ ì…ê³ ê¹Œì§€ ì „ì²´ ì›Œí¬í”Œë¡œìš°ê°€ ë™ì‘í•˜ë©°, ì¬ê³ ê°€ ìë™ìœ¼ë¡œ ì¦ê°€í•˜ëŠ” ê²ƒì„ í™•ì¸í–ˆìŠµë‹ˆë‹¤.

ê°œë°œ ê³¼ì •ì—ì„œ ë°œìƒí•œ ì¸ì¦ ë° RLS ê´€ë ¨ ë¬¸ì œë“¤ì„ í•´ê²°í•˜ë©° Next.js 14 App Router + Supabase SSR í™˜ê²½ì—ì„œì˜ ì˜¬ë°”ë¥¸ ì¸ì¦ íŒ¨í„´ì„ í™•ë¦½í–ˆìŠµë‹ˆë‹¤.

ë‹¤ìŒ Phaseì—ì„œëŠ” ì´ ì¬ê³ ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì§€ì‚¬ ì´ì „ ë° íŒë§¤ ê¸°ëŠ¥ì„ êµ¬í˜„í•  ì˜ˆì •ì…ë‹ˆë‹¤.

**Phase 03 ì™„ë£Œ: âœ… êµ¬ë§¤ ë°œì£¼ ë° HQ ì…ê³  ì²˜ë¦¬**
