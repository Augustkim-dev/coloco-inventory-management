# Phase 16: 제품 기본 구매가격 필드 추가

## 작업 일자
2024-12-04

## 작업 개요
Products 테이블에 기본 구매가격(default_purchase_price) 필드를 추가하여, 템플릿 적용 시 PO 없이도 가격 설정이 가능하도록 개선

## 배경
- 기존에는 템플릿 적용 시 구매가격을 PO(Purchase Order)에서만 가져옴
- PO가 없는 제품은 템플릿 적용 시 "skip" 처리됨
- 신규 제품 등록 후 PO 없이는 가격 설정 불가

## 개선 효과
- 제품 등록 시 기본 구매가격 설정 가능
- 템플릿 적용 시 PO 없어도 기본 구매가격 사용
- 가격 설정 프로세스 단순화: **제품 등록 → 템플릿 적용 → 완료**

---

## 구현 내용

### 1. 데이터베이스 마이그레이션

**파일**: `supabase/migrations/031_add_product_default_purchase_price.sql`

```sql
ALTER TABLE public.products
ADD COLUMN IF NOT EXISTS default_purchase_price DECIMAL(12, 2) DEFAULT NULL;

COMMENT ON COLUMN public.products.default_purchase_price IS
  'Default purchase price in KRW. Used when no PO price is available for pricing template application.';

CREATE INDEX IF NOT EXISTS idx_products_default_purchase_price
  ON public.products(default_purchase_price)
  WHERE default_purchase_price IS NOT NULL;
```

### 2. 타입 정의 업데이트

**파일**: `types/index.ts`

- `ProductWithPurchasePrice` 인터페이스 추가 (DB 타입 재생성 전까지 사용)
- 기존 `SupplierProduct` 인터페이스 문법 오류 수정

```typescript
// Extended Product type with default_purchase_price
export interface ProductWithPurchasePrice extends Product {
  default_purchase_price: number | null
}
```

### 3. Product Form 수정

**파일**: `components/products/product-form.tsx`

변경사항:
- `default_purchase_price` 필드를 form state에 추가
- KRW 단위 구매가격 입력 필드 추가
- 안내 문구: "Used for pricing template when no PO exists"

```tsx
<div>
  <Label htmlFor="default_purchase_price">
    Default Purchase Price (KRW)
  </Label>
  <Input
    id="default_purchase_price"
    type="number"
    min="0"
    step="100"
    value={formData.default_purchase_price || ''}
    onChange={(e) =>
      setFormData({
        ...formData,
        default_purchase_price: e.target.value ? parseFloat(e.target.value) : null,
      })
    }
    placeholder="e.g., 5000"
  />
  <p className="text-xs text-gray-500 mt-1">
    Used for pricing template when no PO exists
  </p>
</div>
```

### 4. Products List 테이블 컬럼 추가

**파일**: `components/products/products-list.tsx`

변경사항:
- "Purchase Price" 컬럼 헤더 추가
- 구매가격 표시 셀 추가 (KRW 포맷팅)
- colspan 6 → 7로 변경

```tsx
<TableHead className="text-right">Purchase Price</TableHead>

<TableCell className="text-right">
  {(product as any).default_purchase_price
    ? `${(product as any).default_purchase_price.toLocaleString()} KRW`
    : '-'}
</TableCell>
```

### 5. 템플릿 적용 API 수정

**파일**: `app/api/pricing/templates/apply/route.ts`

변경사항:
- Product 쿼리에 `default_purchase_price` 필드 포함
- PO 가격 맵 생성 후 fallback 로직 추가

**가격 우선순위:**
1. PO에서 가져온 가격 (기존 로직)
2. 제품의 `default_purchase_price` (신규 추가)
3. 가격 없음 → skip

```typescript
// Product 쿼리 수정
let productQuery = supabase
  .from('products')
  .select('id, sku, name, category, default_purchase_price')

// PO 가격 맵 생성 후 fallback 로직 추가
products.forEach(product => {
  if (!purchasePriceMap[product.id] && product.default_purchase_price) {
    purchasePriceMap[product.id] = product.default_purchase_price
  }
})
```

---

## 생성된 파일 목록

| 파일 | 설명 |
|------|------|
| `supabase/migrations/031_add_product_default_purchase_price.sql` | DB 마이그레이션 (수동 실행 필요) |
| `docs/plans/025.phase16.제품_기본_구매가격_필드_추가.md` | 계획 문서 |
| `docs/worklogs/025.phase16.제품_기본_구매가격_필드_추가.md` | 작업 로그 |

## 수정된 파일 목록

| 파일 | 변경 내용 |
|------|----------|
| `types/index.ts` | `ProductWithPurchasePrice` 추가, `SupplierProduct` 문법 오류 수정 |
| `components/products/product-form.tsx` | 구매가격 입력 필드 추가 |
| `components/products/products-list.tsx` | Purchase Price 컬럼 추가 |
| `app/api/pricing/templates/apply/route.ts` | default_purchase_price fallback 로직 추가 |

---

## 사용 시나리오

### Before (기존)
1. 제품 등록 (구매가격 없음)
2. PO 생성 → 수령 (구매가격 확정)
3. 템플릿 적용 → 가격 설정 완료

### After (개선 후)
1. 제품 등록 + **기본 구매가격 입력**
2. 템플릿 적용 → **바로 가격 설정 완료**
3. (선택) PO 생성 시 실제 구매가로 덮어쓰기

---

## 주의사항

1. **DB 마이그레이션 필요**: `031_add_product_default_purchase_price.sql` 수동 실행 필요
2. **기존 데이터 호환성**: `default_purchase_price`는 nullable이므로 기존 제품에 영향 없음
3. **PO 가격 우선**: PO에서 받은 가격이 있으면 `default_purchase_price`보다 우선 적용

## 빌드 결과
- TypeScript 타입 체크: 성공
- Next.js 빌드: 성공 (ESLint 경고만 존재, 에러 없음)
