# 033. Phase 21: 가격표 보기 페이지 구현 완료

## 작업 일자
2024-12-17

## 작업 내용

### 개요
Sub Branch별 가격표를 탭으로 조회하고 인쇄/엑셀 다운로드 기능을 제공하는 새 페이지 구현 완료

### 주요 기능
1. **탭 기반 지점별 가격표 조회**
   - Branch + SubBranch 탭 표시
   - 탭별 제품 수 배지 표시
   - 계층 구조 반영 (SubBranch는 └ 아이콘으로 표시)

2. **가격표 테이블**
   - 제품명, 제품코드, 구매단가, 지부마진, 소비자가, 할인 최종가
   - **구매단가**: Parent location의 `discounted_price` (SubBranch는 Branch에서 구매하는 가격)
   - **지부마진**: 헤더에 퍼센트(%), 셀에 금액으로 표시 (할인최종가 - 구매단가)
   - 할인 적용 시 녹색 강조 및 할인율 표시
   - 빈 데이터 시 안내 메시지 표시

3. **인쇄 기능**
   - 브라우저 인쇄 다이얼로그 호출
   - 인쇄 전용 스타일 (헤더, 테이블 스타일링)
   - 불필요한 UI 요소 자동 숨김

4. **엑셀 다운로드 기능**
   - xlsx 라이브러리 사용
   - 컬럼 너비 자동 조절
   - 파일명: `PriceList_{지점명}_{날짜}.xlsx`

5. **권한 기반 접근 제어**
   - HQ_Admin: 모든 Branch + SubBranch 조회 가능
   - Branch_Manager: 자신의 Branch + 하위 SubBranch만 조회 가능
   - HQ는 가격표에서 제외 (판매 지점만 표시)

## 생성된 파일

### 새 파일
1. `app/(dashboard)/pricing/list/page.tsx` - 메인 페이지 (서버 컴포넌트)
2. `components/pricing/price-list-view/price-list-tabs.tsx` - 탭 UI 컴포넌트
3. `components/pricing/price-list-view/price-list-table.tsx` - 가격표 테이블 컴포넌트
4. `components/pricing/price-list-view/price-list-export.tsx` - 인쇄/엑셀 버튼 컴포넌트
5. `lib/excel-export.ts` - 엑셀 내보내기 유틸리티

### 수정된 파일
1. `app/globals.css` - 인쇄용 CSS 스타일 추가
2. `app/(dashboard)/pricing/page.tsx` - "가격표 보기" 버튼 추가
3. `package.json` - xlsx 라이브러리 의존성 추가

## 기술적 세부사항

### Supabase 데이터 처리
- Supabase 쿼리에서 `!inner` 조인 사용 시 배열로 반환되는 문제 처리
- `getToLocation()`, `getProduct()` 헬퍼 함수로 배열/객체 정규화
- `toPriceListItemWithParentPrice()` 함수로 raw 데이터를 컴포넌트용 타입으로 변환

### Parent 가격 조회 로직
- 전체 `pricing_configs` 데이터를 조회하여 parent location의 가격 참조
- `getParentPrice()` 함수: product_id와 parent_location_id로 parent의 discounted_price 조회
- Branch: HQ의 discounted_price가 구매단가
- SubBranch: Branch의 discounted_price가 구매단가

### 지부마진 계산
```typescript
const marginAmount = discountedPrice - parentPrice
// 헤더: "지부마진 ({marginPercent}%)"
// 셀: formatCurrency(marginAmount, currency)
```

### 인쇄 스타일
```css
@media print {
  .no-print { display: none !important; }
  .print-only { display: block !important; }
  .price-list-print { width: 100%; font-size: 11pt; }
}
```

### 엑셀 내보내기
```typescript
import * as XLSX from 'xlsx'
// 워크시트 생성, 컬럼 너비 설정, 파일 다운로드
```

## 접근 방법
- `/pricing` 페이지에서 "가격표 보기" 버튼 클릭
- 직접 URL: `/pricing/list`

## 테스트 결과
- TypeScript 타입 체크: 통과
- Next.js 빌드: 성공
- 모든 기존 페이지 빌드 정상

## 관련 계획 문서
- `docs/plans/029.phase21.가격표_보기_페이지_구현.md`
