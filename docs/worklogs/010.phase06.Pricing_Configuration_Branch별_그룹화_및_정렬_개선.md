# 010.phase06. Pricing Configuration Branch별 그룹화 및 정렬 개선

**작업일**: 2025-10-31
**Phase**: Phase 06 - Pricing Calculation Engine
**관련 Commit**:
- `ccf846c` - Fix: Pricing Configuration 화면 Branch별 그룹화 및 Accordion 적용
- `9eb85e2` - Fix: Pricing Configuration Branch 순서를 display_order 기준으로 정렬

---

## 작업 개요

Pricing Configuration 페이지의 사용성을 개선하기 위해 다음 두 가지 기능을 구현했습니다:
1. **Branch별 그룹화 및 Accordion 적용**: 제품들을 Branch별로 묶고 접기/펼치기 기능 추가
2. **Reorder Location 설정 반영**: Branch 순서를 `display_order` 기준으로 정렬

---

## 1차 작업: Branch별 그룹화 및 Accordion 적용

### 문제점
- 모든 pricing configuration이 추가된 순서(`updated_at`)대로 하나의 테이블에 섞여서 표시
- Vietnam Branch와 China Branch 제품들이 구분 없이 나열되어 찾기 어려움
- 제품이 많아질수록 스크롤이 길어져 불편

### 해결 방법

#### 1. Accordion 컴포넌트 도입
- shadcn/ui의 `Accordion` 컴포넌트 사용
- `type="multiple"` 설정으로 여러 Branch를 동시에 펼칠 수 있도록 구성

#### 2. Branch별 데이터 그룹화 로직 구현
**파일**: `components/pricing/pricing-list.tsx`

```typescript
const groupedByBranch = useMemo(() => {
  const groups: { [key: string]: GroupedPricing } = {}

  pricingConfigs.forEach((config) => {
    const key = `${config.to_location.name}-${config.to_location.country_code}`
    if (!groups[key]) {
      groups[key] = {
        branchName: config.to_location.name,
        countryCode: config.to_location.country_code,
        currency: config.currency,
        configs: [],
      }
    }
    groups[key].configs.push(config)
  })

  return Object.values(groups).sort((a, b) =>
    a.branchName.localeCompare(b.branchName) // 알파벳순 정렬
  )
}, [pricingConfigs])
```

#### 3. Branch 헤더 디자인
각 Accordion 섹션의 헤더에 다음 정보 표시:
- **Branch 이름** (큰 폰트로 강조)
- **국가 코드 뱃지** (예: VN, CN)
- **통화 뱃지** (예: VND, CNY)
- **제품 개수** (예: "5 products")
- **ChevronDown 아이콘** (접기/펼치기 상태 표시)

#### 4. 테이블 구조 최적화
- **"Destination" 컬럼 제거**: Branch별로 구분되어 있어 불필요
- 7개 컬럼으로 간소화:
  - Product
  - Purchase Price
  - Transfer Cost
  - Margins (HQ + Branch)
  - Exchange Rate
  - Final Price
  - Actions

### 변경된 파일
- `components/pricing/pricing-list.tsx` - 전면 리팩토링

### 주요 기능
✅ Branch별로 명확하게 구분
✅ 필요한 Branch만 펼쳐서 볼 수 있음
✅ 여러 Branch를 동시에 열어둘 수 있음
✅ 각 Branch의 제품 개수가 한눈에 보임

---

## 2차 작업: Reorder Location 설정 반영

### 문제점
- 1차 작업에서 Branch가 **알파벳순(localeCompare)**으로 정렬되어 표시
- 사용자가 Locations 페이지에서 설정한 **Reorder Location** 순서를 따르지 않음
- `display_order` 기능이 이미 구현되어 있지만 Pricing Configuration 페이지에서는 사용하지 않음

### 해결 방법

#### 1. `display_order` 필드 가져오기
**파일**: `app/(dashboard)/pricing/page.tsx`

```typescript
// 기존
to_location:locations!pricing_configs_to_location_id_fkey(name, country_code, currency)

// 변경 후
to_location:locations!pricing_configs_to_location_id_fkey(name, country_code, currency, display_order)
```

#### 2. TypeScript 인터페이스 업데이트
**파일**: `components/pricing/pricing-list.tsx`

```typescript
interface PricingConfig {
  // ...
  to_location: {
    name: string
    country_code: string
    currency: string
    display_order: number  // 추가
  }
}

interface GroupedPricing {
  branchName: string
  countryCode: string
  currency: string
  displayOrder: number  // 추가
  configs: PricingConfig[]
}
```

#### 3. 정렬 로직 변경
**파일**: `components/pricing/pricing-list.tsx`

```typescript
// 기존: 알파벳순 정렬
return Object.values(groups).sort((a, b) =>
  a.branchName.localeCompare(b.branchName)
)

// 변경 후: display_order 기준 정렬
return Object.values(groups).sort((a, b) =>
  a.displayOrder - b.displayOrder
)
```

### 변경된 파일
- `app/(dashboard)/pricing/page.tsx` - Query에 `display_order` 추가
- `components/pricing/pricing-list.tsx` - 정렬 로직 수정

### 정렬 순서 예시
**Reorder Location 설정**:
1. Korea HQ (display_order: 1)
2. Vietnam Branch (display_order: 2)
3. China Branch (display_order: 3)

**Pricing Configuration 화면 표시 순서**:
1. Korea HQ (첫 번째)
2. Vietnam Branch (두 번째)
3. China Branch (세 번째)

---

## 기술 상세

### 사용된 컴포넌트
- **Accordion** (`@radix-ui/react-accordion` via shadcn/ui)
  - `type="multiple"`: 여러 섹션 동시 펼치기 가능
  - `AccordionItem`, `AccordionTrigger`, `AccordionContent`
- **Badge** - 국가 코드, 통화, 제품 개수 표시
- **Table** - 각 Branch 내부의 제품 목록

### 데이터 흐름
1. **Server Component** (`page.tsx`):
   - Supabase에서 pricing configs + locations(display_order 포함) 가져오기

2. **Client Component** (`pricing-list.tsx`):
   - `useMemo`로 Branch별 그룹화
   - `display_order` 기준으로 정렬
   - Accordion UI로 렌더링

### 성능 최적화
- `useMemo` 훅 사용으로 불필요한 재계산 방지
- `pricingConfigs` 배열이 변경될 때만 그룹화 재실행

---

## Reorder Location 기능과의 통합

### 기존 display_order 구현 현황
**Database**: `locations` 테이블에 `display_order` 컬럼 존재
**Migration**: `013_add_locations_display_order.sql`

### display_order를 사용하는 페이지
1. ✅ **Locations 페이지** - Location 목록 표시
2. ✅ **Inventory Kanban View** - 컬럼 순서
3. ✅ **Pricing Configuration 페이지** (이번 작업으로 추가)

### display_order를 사용하지 않는 페이지
- ❌ **Transfer 페이지** - 알파벳순 정렬
- ❌ **Pricing 생성/수정 페이지** - 알파벳순 정렬

**향후 개선 가능**:
Transfer 및 Pricing 생성 페이지에서도 `display_order`를 적용하여 일관된 Location 순서 제공 가능

---

## 테스트 시나리오

### 1. Branch 그룹화 확인
- [ ] Pricing Configuration 페이지 접속
- [ ] Branch별로 섹션이 구분되어 있는지 확인
- [ ] 각 Branch 헤더에 이름, 국가 코드, 통화, 제품 개수가 표시되는지 확인

### 2. Accordion 동작 확인
- [ ] Branch 이름을 클릭하면 섹션이 펼쳐지는지 확인
- [ ] 다시 클릭하면 접히는지 확인
- [ ] 여러 Branch를 동시에 펼칠 수 있는지 확인
- [ ] ChevronDown 아이콘이 회전하는지 확인

### 3. 정렬 순서 확인
- [ ] Locations 페이지에서 현재 Reorder 설정 확인
- [ ] Pricing Configuration 페이지에서 같은 순서로 Branch가 표시되는지 확인
- [ ] Reorder Location에서 순서를 변경한 후 Pricing Configuration 페이지 새로고침
- [ ] 변경된 순서가 반영되는지 확인

### 4. 데이터 표시 확인
- [ ] 각 제품의 정보(SKU, 이름, 가격 등)가 정확히 표시되는지 확인
- [ ] "Destination" 컬럼이 제거되었는지 확인
- [ ] Edit 버튼이 정상 작동하는지 확인

---

## 사용자 경험 개선

### Before (기존)
```
┌─────────────────────────────────────────────┐
│ Product      | Destination    | Price | ... │
├─────────────────────────────────────────────┤
│ Serum A      | Vietnam Branch | ...   | ... │
│ Cream B      | China Branch   | ...   | ... │
│ Cleanser C   | Vietnam Branch | ...   | ... │
│ Lotion D     | Vietnam Branch | ...   | ... │
│ Toner E      | China Branch   | ...   | ... │
└─────────────────────────────────────────────┘
```
- ❌ Branch들이 섞여 있음
- ❌ 스크롤이 길어짐
- ❌ 특정 Branch 제품 찾기 어려움

### After (개선 후)
```
┌─────────────────────────────────────────────┐
│ [−] Korea HQ [KR] [KRW] - 2 products        │
├─────────────────────────────────────────────┤
│ Product   | Price  | ... │
│ Product A | ...    | ... │
│ Product B | ...    | ... │
└─────────────────────────────────────────────┘

┌─────────────────────────────────────────────┐
│ [+] Vietnam Branch [VN] [VND] - 3 products  │
└─────────────────────────────────────────────┘

┌─────────────────────────────────────────────┐
│ [+] China Branch [CN] [CNY] - 2 products    │
└─────────────────────────────────────────────┘
```
- ✅ Branch별로 명확히 구분
- ✅ 필요한 Branch만 펼쳐서 볼 수 있음
- ✅ Reorder Location 설정 순서대로 표시
- ✅ 제품 개수가 한눈에 보임

---

## 향후 개선 가능 사항

1. **Branch별 통계 추가**
   - 각 Branch 헤더에 평균 마진율, 총 제품 수 등 표시

2. **Branch별 검색/필터**
   - 특정 Branch 내에서만 제품 검색 기능

3. **일관된 정렬 적용**
   - Transfer, Pricing 생성/수정 페이지에도 `display_order` 적용

4. **Default Open 상태 설정**
   - 사용자가 자주 보는 Branch를 기본으로 펼쳐두기

5. **Branch별 Export**
   - Branch별로 CSV/Excel 내보내기 기능

---

## 참고 자료

- **Reorder Location 구현 문서**:
  - `docs/worklogs/004-2.phase04.Location_순서_변경_기능_구현.md`
- **Database Migration**:
  - `supabase/migrations/013_add_locations_display_order.sql`
- **shadcn/ui Accordion**:
  - https://ui.shadcn.com/docs/components/accordion

---

## 결론

이번 작업으로 Pricing Configuration 페이지의 사용성이 크게 개선되었습니다:
1. ✅ Branch별 구분으로 정보 찾기가 쉬워짐
2. ✅ Accordion으로 화면이 깔끔해짐
3. ✅ Reorder Location 설정과 일관된 순서 적용
4. ✅ 확장 가능한 구조로 향후 Branch가 추가되어도 자동 대응

사용자는 이제 원하는 Branch만 펼쳐서 빠르게 pricing configuration을 확인하고 관리할 수 있으며, Locations 페이지에서 설정한 순서대로 일관되게 표시됩니다.
