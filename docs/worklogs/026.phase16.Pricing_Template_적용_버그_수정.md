# Phase 16: Pricing Template 적용 버그 수정

## 작업 일자
2024-12-04

## 작업 개요
Pricing Template 적용 시 pricing_configs 레코드가 생성되지 않고, 생성된 config가 목록에 표시되지 않는 버그 수정

## 문제 현상

### 1. 템플릿 적용 후 pricing_configs 레코드 미생성
- 템플릿 적용 시 preview에서는 32개 품목 표시
- Apply 클릭 후 성공 메시지 표시
- 실제 DB에는 `configs_created: 0, configs_updated: 0` 기록
- `/pricing` 페이지에서 템플릿으로 생성된 config 미표시

### 2. Sub-branch가 목록에 표시되지 않음
- Vietnam Main Branch만 표시되고 Sub Branch들은 미표시
- 원인: 템플릿 적용 실패로 Sub-branch용 config가 생성되지 않았기 때문

---

## 원인 분석

### 핵심 버그: 테이블에 없는 컬럼 insert 시도

**`pricing_configs` 테이블 스키마** (008_create_pricing_configs_table.sql):
```sql
CREATE TABLE public.pricing_configs (
  id UUID PRIMARY KEY,
  product_id UUID NOT NULL,
  from_location_id UUID NOT NULL,
  to_location_id UUID NOT NULL,
  purchase_price DECIMAL(12, 2) NOT NULL,
  transfer_cost DECIMAL(12, 2) NOT NULL DEFAULT 0,
  hq_margin_percent DECIMAL(5, 2) NOT NULL DEFAULT 0,
  branch_margin_percent DECIMAL(5, 2) NOT NULL DEFAULT 0,
  exchange_rate DECIMAL(10, 4) NOT NULL,
  calculated_price DECIMAL(12, 2),
  final_price DECIMAL(12, 2) NOT NULL,
  currency TEXT NOT NULL,
  -- local_cost 컬럼 없음!
);
```

**API 코드에서 시도한 insert**:
```typescript
.insert({
  product_id: item.product_id,
  from_location_id: hqLocation.id,
  to_location_id: item.location_id,
  ...
  local_cost: (item.purchase_price + item.transfer_cost) * exchangeRate,  // ❌ 존재하지 않는 컬럼
  ...
})
```

**결과**:
- 모든 insert/update가 DB 에러로 실패 (silent failure)
- 에러가 있으면 count가 증가하지 않아서 `configs_created: 0`

### 추가 버그: 필수 필드 누락

초기 코드에서 `from_location_id`와 `currency` 필드도 누락되어 있었음

---

## 수정 내용

### 1. 캐시 무효화 추가 (커밋: 9ff109c)

**파일**: `app/api/pricing/templates/apply/route.ts`

```typescript
import { revalidatePath } from 'next/cache'

// 템플릿 적용 성공 후
revalidatePath('/pricing', 'page')
revalidatePath('/pricing/templates', 'page')
```

**파일**: `components/pricing/apply-template-dialog.tsx`

```typescript
// Refresh first to ensure cache is invalidated, then close dialog
router.refresh()
onOpenChange(false)
```

### 2. 필수 필드 추가 (커밋: 6bda8e8)

**파일**: `app/api/pricing/templates/apply/route.ts`

```typescript
// HQ location 조회 추가
const { data: hqLocation } = await supabase
  .from('locations')
  .select('id')
  .eq('location_type', 'HQ')
  .eq('is_active', true)
  .single()

// insert에 from_location_id, currency 추가
.insert({
  product_id: item.product_id,
  from_location_id: hqLocation.id,  // ✅ 추가
  to_location_id: item.location_id,
  ...
  currency: targetLocation?.currency || template.target_currency,  // ✅ 추가
})
```

### 3. 존재하지 않는 local_cost 컬럼 제거 (커밋: 0d1fa86)

**파일**: `app/api/pricing/templates/apply/route.ts`

**Before**:
```typescript
.insert({
  ...
  local_cost: (item.purchase_price + item.transfer_cost) * exchangeRate,
  ...
})

.update({
  ...
  local_cost: (item.purchase_price + item.transfer_cost) * exchangeRate,
  ...
})
```

**After**:
```typescript
.insert({
  product_id: item.product_id,
  from_location_id: hqLocation.id,
  to_location_id: item.location_id,
  purchase_price: item.purchase_price,
  transfer_cost: item.transfer_cost,
  exchange_rate: exchangeRate,
  hq_margin_percent: template.hq_margin_percent,
  branch_margin_percent: template.branch_margin_percent,
  calculated_price: item.final_price,
  final_price: item.final_price,
  currency: targetLocation?.currency || template.target_currency,
  // local_cost 제거됨
})
```

### 4. 에러 로깅 추가 (커밋: 0d1fa86)

```typescript
if (error) {
  console.error('Failed to insert pricing config:', error.message, {
    productId: item.product_id,
    locationId: item.location_id
  })
} else {
  createdCount++
}
```

---

## 수정된 파일 목록

| 파일 | 변경 내용 |
|------|----------|
| `app/api/pricing/templates/apply/route.ts` | local_cost 제거, from_location_id/currency 추가, revalidatePath 추가, 에러 로깅 추가 |
| `components/pricing/apply-template-dialog.tsx` | router.refresh() 호출 순서 변경 |

---

## 커밋 내역

| 커밋 | 설명 |
|------|------|
| `9ff109c` | Fix: 템플릿 적용 후 pricing 목록에 새 설정이 표시되지 않는 버그 수정 |
| `6bda8e8` | Fix: 템플릿으로 생성된 pricing config가 목록에 표시되지 않는 버그 수정 |
| `0d1fa86` | Fix: pricing_configs 테이블에 없는 local_cost 컬럼 제거 |

---

## 테스트 절차

1. `/pricing/templates` 페이지에서 템플릿 선택
2. Apply Template 다이얼로그에서 locations 선택
3. Preview Changes 클릭하여 preview 확인
4. Apply 버튼 클릭
5. `/pricing` 페이지에서 새로 생성된 config들 확인
6. Vietnam Main Branch뿐만 아니라 Sub Branch들도 표시되는지 확인

---

## 교훈

1. **DB 스키마와 코드 동기화 중요성**: 코드에서 insert하는 필드가 실제 테이블에 존재하는지 확인 필요
2. **Silent Failure 방지**: 에러 발생 시 로깅을 추가하여 문제 원인 추적 가능하도록
3. **필수 필드 확인**: NOT NULL 제약조건이 있는 필드는 반드시 값 전달 필요
