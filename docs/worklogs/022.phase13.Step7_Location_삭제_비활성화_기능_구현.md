# 022. Phase 13 Step 7 - Location 삭제/비활성화 기능 구현

## 작업 일자
2025-11-19

## 작업 개요
HQ Admin 전용 Location 삭제 기능 구현. 관련 데이터 존재 여부에 따라 완전 삭제 또는 비활성화 처리.

## 구현 내용

### 1. DELETE API 수정 (`app/api/locations/[id]/route.ts`)

#### 비즈니스 로직
- HQ Admin만 삭제 가능
- 자식 Location이 있으면 삭제 불가 (먼저 자식 삭제 필요)
- 관련 데이터 존재 시 비활성화 (`is_active = false`)
- 관련 데이터 없으면 완전 삭제 (hard delete)

#### 의존성 체크 테이블
- `stock_batches` - 해당 위치의 재고
- `sales` - 해당 위치의 판매 기록
- `pricing_configs` - 출발지/도착지로 설정된 가격 설정
- `stock_transfer_requests` - 출발지/도착지로 설정된 이전 요청
- `users` - 해당 위치에 할당된 사용자

#### API 응답
```typescript
// 비활성화된 경우
{
  success: true,
  action: 'deactivated',
  message: 'Location has related data and was deactivated instead of deleted.',
  dependencies: {
    stock_batches: 10,
    sales: 25,
    users: 3
  }
}

// 완전 삭제된 경우
{
  success: true,
  action: 'deleted',
  message: 'Location permanently deleted.'
}
```

### 2. 삭제 확인 다이얼로그 (`components/locations/delete-location-dialog.tsx`)

#### 기능
- Alert Dialog를 사용한 삭제 확인 UI
- 삭제/비활성화 결과에 따른 토스트 메시지 표시
- 비활성화 시 의존성 목록 표시
- 삭제 진행 중 버튼 비활성화

### 3. Tree View 수정 (`components/locations/locations-tree-view.tsx`)

#### 추가된 기능
- HQ Admin에게만 삭제 버튼 표시
- 각 노드에 삭제 다이얼로그 상태 관리
- 빨간색 휴지통 아이콘 버튼

### 4. List View 수정 (`components/locations/locations-list.tsx`)

#### 추가된 기능
- Status 컬럼 추가 (Active/Inactive 배지 표시)
- HQ Admin에게만 삭제 버튼 표시
- 공유 삭제 다이얼로그 사용 (상태 최적화)

### 5. shadcn/ui Alert Dialog 컴포넌트 설치

```bash
npx shadcn@latest add alert-dialog --yes --overwrite
```

## 수정된 파일 목록

### API 및 백엔드
1. `app/api/locations/[id]/route.ts` - DELETE 핸들러 완전 재작성 (의존성 체크 및 조건부 삭제/비활성화)
2. `app/api/locations/route.ts` - POST에 display_order 자동 생성 로직 추가
3. `app/api/locations/[id]/children/route.ts` - children API에 is_active 필터 추가

### 페이지 컴포넌트
4. `app/(dashboard)/locations/page.tsx` - Branch Manager용 HQ 포함 쿼리 수정
5. `app/(dashboard)/locations/[id]/edit/page.tsx` - Branch Manager 접근 권한 추가 및 검증 로직

### UI 컴포넌트
6. `components/locations/delete-location-dialog.tsx` - 신규 생성 (삭제 확인 다이얼로그)
7. `components/locations/locations-tree-view.tsx` - 삭제 버튼 및 다이얼로그 추가
8. `components/locations/locations-list.tsx` - Status 컬럼 및 삭제 버튼 추가
9. `components/ui/alert-dialog.tsx` - shadcn/ui 컴포넌트 추가
10. `components/ui/button.tsx` - shadcn 업데이트로 인한 변경

## 권한 정리

| 기능 | HQ Admin | Branch Manager |
|------|----------|----------------|
| Location 조회 | 전체 | 본인 브랜치 + 서브브랜치 + HQ |
| Location 생성 | 전체 타입 | SubBranch만 (본인 브랜치 하위) |
| Location 수정 | 전체 | 본인 브랜치 + 서브브랜치 |
| Location 삭제 | 전체 | 불가 |

## 사용자 경험

### HQ Admin
1. 삭제 버튼 클릭 시 확인 다이얼로그 표시
2. 다이얼로그에서 비활성화 안내 문구 확인
3. "Delete" 버튼 클릭으로 삭제 진행
4. 결과에 따른 토스트 메시지 확인
   - 비활성화: 의존성 목록과 함께 안내
   - 삭제: 완전 삭제 완료 안내

### Branch Manager
- 삭제 버튼이 표시되지 않음
- 비활성화된 Location은 조회되지 않음

## 테스트 시나리오

1. **의존성 있는 Location 삭제**
   - 예상: 비활성화 처리
   - 결과: `is_active = false`, 의존성 목록 반환

2. **의존성 없는 Location 삭제**
   - 예상: 완전 삭제
   - 결과: DB에서 레코드 제거

3. **자식 Location이 있는 경우**
   - 예상: 에러 반환
   - 결과: "Cannot delete location with children" 에러

4. **Branch Manager 삭제 시도**
   - 예상: 에러 반환
   - 결과: 403 Forbidden

## 빌드 결과
- 빌드 성공
- ESLint 경고만 존재 (기존 useEffect 의존성 관련)
- 에러 없음

## 참고 사항

- 비활성화된 Location의 데이터는 보존됨
- HQ Admin은 비활성화된 Location을 리스트에서 확인 가능 (Inactive 배지 표시)
- 재활성화 기능은 Edit 페이지에서 `is_active` 필드를 통해 가능
- Tree View에서도 비활성화 상태 배지 표시됨

## 관련 코드 상세

### DELETE API 핵심 로직 (`app/api/locations/[id]/route.ts`)

```typescript
// 의존성 체크
const dependencies: Record<string, number> = {}

// Check stock_batches
const { count: stockCount } = await supabase
  .from('stock_batches')
  .select('id', { count: 'exact', head: true })
  .eq('location_id', params.id)
if (stockCount && stockCount > 0) dependencies.stock_batches = stockCount

// ... similar checks for sales, pricing_configs, transfer_requests, users

const hasRelatedData = Object.keys(dependencies).length > 0

if (hasRelatedData) {
  // Deactivate instead of delete
  await supabase
    .from('locations')
    .update({ is_active: false })
    .eq('id', params.id)

  return NextResponse.json({
    success: true,
    action: 'deactivated',
    dependencies,
  })
} else {
  // Hard delete
  await supabase.from('locations').delete().eq('id', params.id)
  return NextResponse.json({
    success: true,
    action: 'deleted',
  })
}
```

### Children API 필터링 (`app/api/locations/[id]/children/route.ts`)

```typescript
// 비활성화된 location은 children 목록에서 제외
const { data: children, error } = await supabase
  .from('locations')
  .select('*')
  .eq('parent_id', locationId)
  .eq('is_active', true)  // 추가된 필터
  .order('display_order', { ascending: true })
```

### Branch Manager 쿼리 수정 (`app/(dashboard)/locations/page.tsx`)

```typescript
// Tree View가 정상 작동하려면 HQ(루트 노드)가 필요
if (branchLocation) {
  const conditions = [
    `id.eq.${userData.location_id}`,      // 본인 브랜치
    `parent_id.eq.${userData.location_id}` // 하위 서브브랜치
  ]

  // HQ도 포함 (tree structure를 위해)
  if (branchLocation.parent_id) {
    conditions.push(`id.eq.${branchLocation.parent_id}`)
  }

  locationsQuery = locationsQuery.or(conditions.join(','))
}
```

## 커밋 정보

- **Commit Hash**: c7220f0
- **Branch**: master
- **Message**: Feat: HQ Admin Location 삭제/비활성화 기능 구현
