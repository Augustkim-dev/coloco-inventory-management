# 009.phase06.가격_설정_환율_자동_입력_및_소수점_입력_개선

## 작업 일자
2025-10-31

## 작업 개요
Pricing 화면에서 Exchange Rate 자동 입력 기능 수정 및 소수점 입력 제한 문제 해결

## 문제 상황

### 1. Exchange Rate 자동 입력 실패
- **증상:** Pricing 설정 추가 시 Exchange Rate 필드가 비어있음
- **원인:** API 응답 속성명 불일치
  - API: `{ exchangeRate: data }` 반환
  - Component: `data.rate` 기대
- **영향:** 사용자가 이미 입력한 환율을 매번 수동으로 다시 입력해야 함

### 2. 소수점 입력 제한
- **증상:** CNY 환율인 0.0053 같은 작은 소수점 값 입력 불가
- **원인:** `step="0.0001"` 제약으로 인한 브라우저 입력 제한 가능성
- **영향:** 중국 지사 가격 설정 시 정확한 환율 입력 불가

## 해결 방법

### 1. API 응답 구조 수정

**파일:** `app/api/exchange-rates/latest/route.ts`

```typescript
// 수정 전 (Line 42)
return NextResponse.json({ exchangeRate: data })

// 수정 후
return NextResponse.json({ rate: data.rate })
```

**효과:**
- Exchange Rate Selector 컴포넌트가 기대하는 응답 형식과 일치
- 최신 환율 자동 로드 기능 정상 작동

### 2. Exchange Rate Selector 입력 개선

**파일:** `components/exchange-rates/exchange-rate-selector.tsx`

```typescript
// 수정 전 (Line 80-90)
<Input
  id="exchange_rate"
  type="number"
  step="0.0001"
  min="0"
  value={value || ''}
  onChange={(e) => onChange(parseFloat(e.target.value) || 0)}
  required
  disabled={loading}
  className="flex-1"
/>

// 수정 후
<Input
  id="exchange_rate"
  type="number"
  step="any"
  min="0"
  value={value || ''}
  onChange={(e) => {
    const inputValue = e.target.value
    // Allow empty input
    if (inputValue === '') {
      onChange(0)
      return
    }
    // Parse with full precision
    const numValue = parseFloat(inputValue)
    if (!isNaN(numValue) && numValue >= 0) {
      onChange(numValue)
    }
  }}
  required
  disabled={loading}
  className="flex-1"
  placeholder="0.0000"
/>
```

**개선 사항:**
- `step="any"` 변경으로 모든 소수점 값 입력 허용
- 입력값 검증 로직 강화 (빈 값, NaN, 음수 처리)
- placeholder 추가로 사용자 가이드 개선

### 3. Exchange Rate Form 입력 개선

**파일:** `components/exchange-rates/exchange-rate-form.tsx`

```typescript
// 수정 전 (Line 169-180)
<Input
  id="rate"
  type="number"
  step="0.0001"
  min="0"
  placeholder="0.0000"
  value={formData.rate}
  onChange={(e) =>
    setFormData({ ...formData, rate: e.target.value })
  }
  required
  className="flex-1"
/>

// 수정 후
<Input
  id="rate"
  type="number"
  step="any"
  min="0"
  placeholder="0.0000"
  value={formData.rate}
  onChange={(e) =>
    setFormData({ ...formData, rate: e.target.value })
  }
  required
  className="flex-1"
/>
```

**개선 사항:**
- `step="any"` 변경으로 0.0053 같은 작은 소수점 값 입력 가능

## 수정된 파일 목록

1. `app/api/exchange-rates/latest/route.ts` - API 응답 구조 수정
2. `components/exchange-rates/exchange-rate-selector.tsx` - 소수점 입력 개선 및 검증 로직 강화
3. `components/exchange-rates/exchange-rate-form.tsx` - 소수점 입력 개선

## 작업 결과

### 개선된 사용자 워크플로우

1. **Exchange Rates 메뉴에서 환율 등록**
   - KRW → VND: 18.0000
   - KRW → CNY: 0.0053

2. **Pricing 설정 추가**
   - 제품 선택
   - 목적지 지사 선택 (예: China Branch)
   - **Exchange Rate 필드에 0.0053 자동 입력됨** ✅
   - "Latest: 1 KRW = 0.0053 CNY" 안내 표시 ✅

3. **수동 조정 가능**
   - 자동 입력된 값을 사용자가 필요시 수정 가능
   - 모든 소수점 자릿수 지원 ✅

### 지원되는 환율 범위

- **VND (큰 값):** 18.0000, 18.5000 등
- **CNY (작은 값):** 0.0053, 0.0054 등
- **모든 소수점 자릿수:** step="any"로 제한 없음

## 기술적 세부사항

### API 응답 형식
```json
{
  "rate": 0.0053
}
```

### 데이터베이스 스키마 (변경 없음)
```sql
-- exchange_rates 테이블
rate DECIMAL(10, 4) NOT NULL CHECK (rate > 0)

-- pricing_configs 테이블
exchange_rate DECIMAL(10, 4) NOT NULL CHECK (exchange_rate > 0)
```

- **Precision:** 10 digits total
- **Scale:** 4 decimal places
- 0.0053부터 999999.9999까지 저장 가능

### JavaScript 정밀도
- `parseFloat()` 사용으로 JavaScript Number 정밀도 범위 내에서 처리
- 소수점 4자리 환율 값은 정밀도 손실 없음

## 테스트 시나리오

### 테스트 케이스 1: CNY 환율 자동 입력
1. Exchange Rates에서 KRW → CNY = 0.0053 입력
2. Pricing에서 "Add Pricing" 클릭
3. Product 선택, China Branch 선택
4. **예상 결과:** Exchange Rate 필드에 0.0053 자동 입력됨

### 테스트 케이스 2: VND 환율 자동 입력
1. Exchange Rates에서 KRW → VND = 18.0000 입력
2. Pricing에서 "Add Pricing" 클릭
3. Product 선택, Vietnam Branch 선택
4. **예상 결과:** Exchange Rate 필드에 18.0000 자동 입력됨

### 테스트 케이스 3: 수동 조정
1. 자동 입력된 환율 확인
2. 필드를 클릭하여 값 수정 (예: 0.0053 → 0.0055)
3. **예상 결과:** 수정된 값으로 가격 계산 가능

### 테스트 케이스 4: 환율 미등록 상태
1. Exchange Rates에 해당 통화쌍 미등록
2. Pricing에서 해당 지사 선택
3. **예상 결과:** 에러 메시지 표시 "No exchange rate found for KRW → CNY. Please add one first."

## 관련 이슈 해결

### Issue #1: API 버그
- **문제:** 컴포넌트가 `data.rate`를 기대하지만 API가 `data.exchangeRate` 반환
- **해결:** API 응답을 `{ rate: data.rate }`로 통일

### Issue #2: 소수점 입력 제한
- **문제:** step="0.0001" 제약으로 인한 입력 제한 가능성
- **해결:** step="any"로 변경하여 모든 소수점 값 허용

### Issue #3: 입력 검증 부족
- **문제:** 빈 값, NaN, 음수 값 처리 미흡
- **해결:** onChange 핸들러에서 명시적 검증 로직 추가

## 향후 개선 사항

### 고려 사항
1. **환율 히스토리 표시**
   - 최근 3개 환율 변동 표시
   - 환율 변동 추이 그래프

2. **환율 자동 업데이트 API 연동 (Post-MVP)**
   - 외부 환율 API 연동
   - 자동 업데이트 스케줄링

3. **환율 검증 강화**
   - 이상치 탐지 (급격한 변동 경고)
   - 환율 범위 제한 (예: CNY 0.0001 ~ 0.01)

4. **다중 환율 지원 (Post-MVP)**
   - 현금 환율 vs 송금 환율
   - 매입 환율 vs 매도 환율

## 결론

모든 수정 사항이 성공적으로 완료되었으며, Pricing 설정 시 Exchange Rate가 자동으로 입력되고 모든 소수점 값을 정확하게 입력할 수 있게 되었습니다.

**핵심 개선:**
- ✅ Exchange Rate 자동 로드 기능 정상 작동
- ✅ CNY 0.0053 같은 작은 소수점 값 입력 가능
- ✅ 사용자 경험 개선 (자동 입력 + 수동 조정 가능)
- ✅ 입력 검증 로직 강화

**영향받는 기능:**
- Pricing Configuration (가격 설정)
- Exchange Rates Management (환율 관리)
- Sales Entry (환율 참조용)
