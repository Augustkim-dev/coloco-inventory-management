# Phase 17: Branch Manager 재고 관리 권한 강화

## 작업 일자
2025-12-04

## 작업 개요
Branch Manager가 Main Branch와 Sub-Branch 모두를 관리할 수 있도록 재고 이동 권한을 강화하고, Kanban View에서 데이터가 표시되지 않던 버그를 수정함.

## 발견된 문제점

### 1. Kanban View 데이터 미표시 (Critical Bug)
**원인:** `sortByHierarchyAndOrder()` 함수가 `parent_id === null`인 HQ부터 시작하는데, Branch Manager의 경우 필터링된 locations에 HQ가 없어서 빈 배열 반환

```typescript
// 기존 코드 - HQ가 없으면 빈 배열 반환
addChildren(null) // Start from root (HQ)
return result
```

### 2. Branch Manager 이동 제한
**문제:** Branch Manager는 자신의 main branch에서만 이동 시작 가능, Sub-branch에서의 이동 불가

```typescript
// 기존 코드
if (userRole === 'Branch_Manager' && sourceLocationId !== userLocationId) {
  toast.error('You can only transfer from your own location')
  return
}
```

### 3. 형제 Location 간 이동 불가
**문제:** `canTransferBetween()` 함수가 직접 parent-child만 허용하여 Naver → Coupang 같은 sibling 이동 불가

## 수정 내용

### 1. sortByHierarchyAndOrder() 함수 개선
**파일:** `lib/hierarchy-utils.ts`

필터링된 locations에서도 동작하도록 "orphan roots" 처리 추가:

```typescript
export function sortByHierarchyAndOrder(locations: Location[]): Location[] {
  if (locations.length === 0) return []

  // ... 기존 로직 ...

  // Start from root (HQ with parent_id = null)
  addChildren(null)

  // If result is empty (filtered view without root, e.g., Branch Manager view),
  // find "orphan roots" - locations whose parent is not in the filtered set
  if (result.length === 0) {
    const locationIds = new Set(locations.map(l => l.id))
    const orphanRoots = locations.filter(l =>
      !l.parent_id || !locationIds.has(l.parent_id)
    )

    // Sort orphan roots by display_order and process each
    orphanRoots.sort((a, b) => a.display_order - b.display_order)
    for (const root of orphanRoots) {
      if (!visited.has(root.id)) {
        visited.add(root.id)
        result.push(root)
        addChildren(root.id)
      }
    }
  }

  return result
}
```

### 2. canTransferBetween() 함수 - 형제 이동 허용
**파일:** `lib/hierarchy-utils.ts`

```typescript
export function canTransferBetween(
  fromId: string,
  toId: string,
  locations: Location[]
): { valid: boolean; reason?: string } {
  // ... 기존 parent-child 검증 ...

  // 3. Sibling transfer: same parent (sibling ↔ sibling)
  if (fromLocation.parent_id && fromLocation.parent_id === toLocation.parent_id) {
    return { valid: true }
  }

  return {
    valid: false,
    reason: 'Transfer only allowed between parent-child or sibling locations'
  }
}
```

### 3. Branch Manager Sub-Branch 이동 권한 확대
**파일:** `components/inventory/inventory-kanban.tsx`

```typescript
// Branch Manager는 자신의 Location 또는 하위 Sub-Branch에서만 이동 가능
if (userRole === 'Branch_Manager' && userLocationId) {
  const descendants = getDescendants(userLocationId, locations)
  const accessibleIds = [userLocationId, ...descendants.map(d => d.id)]
  if (!accessibleIds.includes(sourceLocationId)) {
    toast.error('You can only transfer from your branch or sub-branches')
    setActiveBatch(null)
    return
  }
}
```

### 4. HQ Admin 모든 이동 허용
**파일:** `components/inventory/inventory-kanban.tsx`

```typescript
// 계층적 이동 규칙 검증 (HQ Admin은 모든 이동 허용)
if (userRole !== 'HQ_Admin') {
  const transferValidation = canTransferBetween(
    sourceLocationId,
    targetLocationId,
    locations
  )

  if (!transferValidation.valid) {
    toast.error(transferValidation.reason || 'Invalid transfer')
    setActiveBatch(null)
    return
  }
}
```

## 수정된 파일 목록

| 파일 | 변경 내용 |
|------|----------|
| `lib/hierarchy-utils.ts` | `sortByHierarchyAndOrder()` - orphan roots 처리 추가 |
| `lib/hierarchy-utils.ts` | `canTransferBetween()` - sibling 이동 허용 |
| `components/inventory/inventory-kanban.tsx` | Branch Manager sub-branch 이동 권한 확대 |
| `components/inventory/inventory-kanban.tsx` | HQ Admin 모든 이동 허용 |

## 테스트 결과

### Kanban View 표시
- ✅ HQ Admin: 모든 location 표시
- ✅ Branch Manager (Korea): Korea + 5개 SubBranch 표시

### 이동 테스트 (Branch Manager)
| From | To | 결과 |
|------|-----|------|
| Korea | Naver | ✅ 허용 (parent → child) |
| Naver | Korea | ✅ 허용 (child → parent) |
| Naver | Coupang | ✅ 허용 (sibling) |
| Seoul | Busan | ✅ 허용 (sibling) |
| Korea | Vietnam | ❌ 차단 (다른 Branch) |

### 이동 테스트 (HQ Admin)
| From | To | 결과 |
|------|-----|------|
| HQ | Korea | ✅ 허용 |
| Korea | Vietnam | ✅ 허용 |
| Vietnam | China | ✅ 허용 |

## 커밋 정보
- **커밋 해시:** 93b6802
- **커밋 메시지:** Feat: Branch Manager의 Main/Sub-Branch 재고 관리 기능 강화

## 관련 이슈
- Branch Manager가 Sub-Branch 재고를 관리할 수 없는 문제
- Kanban View에서 Branch Manager 로그인 시 데이터 미표시 버그
- Sub-Branch 간 재고 이동 불가 문제
