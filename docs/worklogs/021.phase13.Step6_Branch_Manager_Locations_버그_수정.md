# 021. Phase 13 Step 6: Branch Manager Locations 버그 수정

**작업일**: 2025-11-19
**관련 Phase**: Phase 13 - 계층적 Sub-Branch 시스템 구현
**이전 작업**: [020.phase13.Step5_Branch_Manager_권한_추가.md](020.phase13.Step5_Branch_Manager_권한_추가.md)

## 작업 개요

Vietnam Manager로 로그인했을 때 발생하는 세 가지 버그를 수정했습니다:
1. Tree View에서 데이터가 표시되지 않음
2. Edit 버튼 클릭 시 Dashboard로 리다이렉트됨
3. Sub-Branch 추가 시 RLS 정책 에러 발생

## 해결한 문제들

### 문제 1: Tree View에서 아무것도 안 나옴

**증상**: List View에서는 데이터가 보이지만 Tree View에서는 아무것도 표시되지 않음

**원인 분석**:
- `buildLocationTree()` 함수는 `parent_id = null`인 HQ를 루트 노드로 트리를 구성
- Branch Manager 필터링 쿼리: `id.eq.${userLocationId},parent_id.eq.${userLocationId}`
- 이 쿼리는 HQ를 포함하지 않음
- HQ 없이는 트리 구조를 구성할 수 없어 빈 배열 반환

**해결 방법**:
- Branch Manager 쿼리에 HQ(부모 브랜치)도 포함하도록 수정
- Vietnam Branch의 parent_id를 조회하여 HQ ID를 가져옴

**수정 파일**: `app/(dashboard)/locations/page.tsx`

```typescript
// Before
locationsQuery = locationsQuery.or(
  `id.eq.${userData.location_id},parent_id.eq.${userData.location_id}`
)

// After
const conditions = [
  `id.eq.${userData.location_id}`,
  `parent_id.eq.${userData.location_id}`
]

// Include HQ (parent of their branch) for tree view to work
if (branchLocation.parent_id) {
  conditions.push(`id.eq.${branchLocation.parent_id}`)
}

locationsQuery = locationsQuery.or(conditions.join(','))
```

---

### 문제 2: Edit 버튼 클릭 시 Dashboard로 리다이렉트

**증상**: List View에서 Edit 버튼을 클릭하면 편집 페이지 대신 Dashboard로 이동

**원인 분석**:
- Edit 페이지(`/locations/[id]/edit`)에서 HQ_Admin만 허용하는 role 체크
- Branch_Manager는 조건에 맞지 않아 `/dashboard`로 리다이렉트

```typescript
// 기존 코드
if (userData?.role !== 'HQ_Admin') {
  redirect('/dashboard')
}
```

**해결 방법**:
- Branch_Manager도 접근 허용
- Branch Manager가 자신의 branch 또는 하위 sub-branch만 편집할 수 있도록 추가 검증

**수정 파일**: `app/(dashboard)/locations/[id]/edit/page.tsx`

```typescript
// Only HQ Admin and Branch Manager can access
if (userData?.role !== 'HQ_Admin' && userData?.role !== 'Branch_Manager') {
  redirect('/dashboard')
}

// ... fetch location ...

// Branch Manager can only edit their own branch or sub-branches under it
if (userData?.role === 'Branch_Manager') {
  const isOwnBranch = location.id === userData.location_id
  const isSubBranch = location.parent_id === userData.location_id && location.location_type === 'SubBranch'

  if (!isOwnBranch && !isSubBranch) {
    redirect('/dashboard')
  }
}
```

---

### 문제 3: Sub-Branch 추가 시 RLS 정책 에러 (42501)

**증상**: Add Sub-Branch 버튼으로 새 sub-branch 생성 시 에러 발생
```
Error creating location: {
  code: '42501',
  details: null,
  hint: null,
  message: 'new row violates row-level security policy for table "locations"'
}
```

**원인 분석**:
- `locations` 테이블의 RLS 정책에 Branch Manager용 INSERT/UPDATE/DELETE 정책이 없음
- 기존 정책:
  - `"Authenticated users can view locations"` - SELECT
  - `"HQ Admin can modify locations"` - ALL (INSERT, UPDATE, DELETE, SELECT) but HQ_Admin only

**해결 방법**:
새 마이그레이션 파일을 생성하여 Branch Manager용 RLS 정책 추가

**생성 파일**: `supabase/migrations/027_add_branch_manager_location_policies.sql`

```sql
-- Branch Manager INSERT policy
-- Allows Branch Managers to create SubBranches under their own branch
CREATE POLICY "Branch Manager can create sub-branches"
  ON public.locations
  FOR INSERT
  WITH CHECK (
    public.get_user_role_from_jwt() = 'Branch_Manager'
    AND location_type = 'SubBranch'
    AND parent_id = (
      SELECT location_id FROM public.users
      WHERE id = auth.uid()
    )
  );

-- Branch Manager UPDATE policy
-- Allows Branch Managers to update their own branch or sub-branches under it
CREATE POLICY "Branch Manager can update own locations"
  ON public.locations
  FOR UPDATE
  USING (
    public.get_user_role_from_jwt() = 'Branch_Manager'
    AND (
      id = (SELECT location_id FROM public.users WHERE id = auth.uid())
      OR (
        parent_id = (SELECT location_id FROM public.users WHERE id = auth.uid())
        AND location_type = 'SubBranch'
      )
    )
  )
  WITH CHECK (
    public.get_user_role_from_jwt() = 'Branch_Manager'
    AND (
      id = (SELECT location_id FROM public.users WHERE id = auth.uid())
      OR (
        parent_id = (SELECT location_id FROM public.users WHERE id = auth.uid())
        AND location_type = 'SubBranch'
      )
    )
  );

-- Branch Manager DELETE policy
-- Allows Branch Managers to delete sub-branches under their own branch
CREATE POLICY "Branch Manager can delete sub-branches"
  ON public.locations
  FOR DELETE
  USING (
    public.get_user_role_from_jwt() = 'Branch_Manager'
    AND parent_id = (SELECT location_id FROM public.users WHERE id = auth.uid())
    AND location_type = 'SubBranch'
  );
```

## 변경된 파일 목록

### 코드 수정
1. **`app/(dashboard)/locations/page.tsx`**
   - Branch Manager 쿼리에 HQ 포함하도록 수정
   - Tree View가 정상 작동하기 위한 루트 노드 확보

2. **`app/(dashboard)/locations/[id]/edit/page.tsx`**
   - Branch_Manager 접근 허용
   - 자신의 branch/sub-branch만 편집 가능하도록 검증 추가

### 새 파일 생성
3. **`supabase/migrations/027_add_branch_manager_location_policies.sql`**
   - Branch Manager용 INSERT 정책
   - Branch Manager용 UPDATE 정책
   - Branch Manager용 DELETE 정책

## RLS 정책 적용 방법

이 마이그레이션은 Supabase에 직접 적용해야 합니다:

1. **Supabase Dashboard**에 로그인
2. **SQL Editor**로 이동
3. `supabase/migrations/027_add_branch_manager_location_policies.sql` 파일 내용을 복사
4. SQL Editor에 붙여넣기하고 실행

## RLS 정책 요약

### locations 테이블 최종 정책

| 정책명 | 대상 | 작업 | 조건 |
|--------|------|------|------|
| Authenticated users can view locations | 모든 인증 사용자 | SELECT | 인증된 사용자 |
| HQ Admin can modify locations | HQ_Admin | ALL | role = 'HQ_Admin' |
| **Branch Manager can create sub-branches** | Branch_Manager | INSERT | SubBranch만, 자신의 branch 하위 |
| **Branch Manager can update own locations** | Branch_Manager | UPDATE | 자신의 branch 또는 하위 sub-branch |
| **Branch Manager can delete sub-branches** | Branch_Manager | DELETE | 하위 sub-branch만 |

## 테스트 시나리오

### Vietnam Manager 테스트

**사전 조건**:
- Vietnam Manager 계정의 `location_id`가 Vietnam Branch ID로 설정되어 있어야 함
- RLS 정책이 Supabase에 적용되어 있어야 함

#### Tree View 테스트
- [ ] `/locations` 페이지 접근 시 Tree View에 데이터 표시됨
- [ ] Korea HQ가 루트 노드로 표시됨
- [ ] Vietnam Branch가 HQ 하위에 표시됨
- [ ] Ho Chi Minh, Vung Tau, Hanoi가 Vietnam 하위에 표시됨

#### Edit 기능 테스트
- [ ] Vietnam Branch의 Edit 버튼 클릭 → 편집 페이지로 이동
- [ ] Ho Chi Minh의 Edit 버튼 클릭 → 편집 페이지로 이동
- [ ] Korea HQ에는 Edit 버튼이 표시되지 않음
- [ ] 편집 후 저장 성공

#### Add Sub-Branch 테스트
- [ ] Add Sub-Branch 버튼 클릭 → 생성 페이지로 이동
- [ ] Location Type이 'SubBranch'로 고정됨
- [ ] Parent Location이 Vietnam으로 고정됨
- [ ] 새 sub-branch 생성 성공 (RLS 에러 없음)

## 이전 수정사항 참조

이 작업 이전에 진행된 관련 수정사항:

1. **`parent_location_id` → `parent_id` 변경** (Commit: 8bb284f)
   - DB 스키마와 코드 일치시킴
   - 11개 파일 수정

2. **Branch_Manager에게 Locations 메뉴 접근 권한 추가** (Commit: 8328a5d)
   - `lib/constants.ts`의 navItems 수정

3. **Branch Manager 권한 추가 - Sub-Branch 관리 기능 구현** (Commit: db0718f)
   - API 엔드포인트 권한 검증
   - UI 컴포넌트 권한 제어

## 커밋 정보

- **Commit Hash**: `e87b0c3`
- **Commit Message**: "Fix: Branch Manager locations 관리 문제 3가지 해결"
- **변경 파일 수**: 3개
- **새 파일**: 1개 (마이그레이션)

## 다음 단계

1. **Supabase에 RLS 정책 적용** - 027 마이그레이션 실행
2. **Vietnam Manager로 전체 기능 테스트**
3. **China Manager 계정 생성 및 테스트** (선택사항)
4. **Phase 13 완료 후 Phase 14 계획**

## 참고 문서

- [020.phase13.Step5_Branch_Manager_권한_추가.md](020.phase13.Step5_Branch_Manager_권한_추가.md)
- [019.phase13.Step4_Location_생성_및_수정_UI_구현.md](019.phase13.Step4_Location_생성_및_수정_UI_구현.md)
- [supabase/migrations/027_add_branch_manager_location_policies.sql](../../supabase/migrations/027_add_branch_manager_location_policies.sql)
