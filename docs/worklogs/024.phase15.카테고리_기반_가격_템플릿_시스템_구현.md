# Phase 15: 카테고리 기반 가격 템플릿 시스템 구현

## 작업 일자
2024-12-03

## 작업 개요
HQ Admin이 가격 템플릿을 생성하고 여러 제품/Location에 일괄 적용할 수 있는 시스템 구현

## 구현 내용

### 1. 데이터베이스 마이그레이션

**파일**: `supabase/migrations/030_create_pricing_templates.sql`

#### pricing_templates 테이블
| 컬럼 | 타입 | 설명 |
|------|------|------|
| id | UUID | Primary Key |
| name | TEXT | 템플릿 이름 |
| description | TEXT | 설명 (optional) |
| category | TEXT | 적용 카테고리 (null = 전체) |
| target_currency | TEXT | 대상 통화 (VND, CNY) |
| hq_margin_percent | DECIMAL(5,2) | HQ 마진 % |
| branch_margin_percent | DECIMAL(5,2) | Branch 마진 % |
| default_transfer_cost | DECIMAL(12,2) | 기본 이송비 (KRW) |
| is_active | BOOLEAN | 활성화 여부 |
| created_by | UUID | 생성자 |
| created_at | TIMESTAMPTZ | 생성일 |
| updated_at | TIMESTAMPTZ | 수정일 |

#### pricing_template_applications 테이블
템플릿 적용 이력 추적용 테이블

#### calculate_template_price 함수
```sql
-- 가격 계산 공식
local_cost = (purchase_price + transfer_cost) × exchange_rate
final_price = local_cost / (1 - (hq_margin + branch_margin) / 100)

-- 통화별 반올림
VND: 1000 단위
CNY: 소수점 2자리
KRW: 100 단위
```

### 2. TypeScript 타입 정의

**파일**: `types/index.ts`

```typescript
export interface PricingTemplate {
  id: string
  name: string
  description: string | null
  category: string | null
  target_currency: Currency
  hq_margin_percent: number
  branch_margin_percent: number
  default_transfer_cost: number
  is_active: boolean
  created_by: string | null
  created_at: string
  updated_at: string
}

export type PricingTemplateInsert = Omit<PricingTemplate, 'id' | 'is_active' | 'created_by' | 'created_at' | 'updated_at'>

export interface TemplateApplyRequest {
  template_id: string
  target_location_ids: string[]
  product_filter?: {
    category?: string
    product_ids?: string[]
  }
  exchange_rate_id?: string
  action: 'preview' | 'apply'
}

export interface TemplateApplyPreviewItem {
  product_id: string
  product_sku: string
  product_name: string
  product_category: string | null
  location_id: string
  location_name: string
  purchase_price: number
  transfer_cost: number
  exchange_rate: number
  calculated_price: number
  final_price: number
  current_price: number | null
  status: 'new' | 'update' | 'skip'
  skip_reason?: string
}
```

### 3. API 엔드포인트

#### GET /api/pricing/templates
- 모든 템플릿 목록 조회
- 마지막 적용 정보 포함 (last_applied_at, last_applied_products)

#### POST /api/pricing/templates
- 새 템플릿 생성
- Validation: name 필수, 마진 합계 < 100%

#### GET /api/pricing/templates/[id]
- 단일 템플릿 조회
- 적용 이력 포함

#### PUT /api/pricing/templates/[id]
- 템플릿 수정

#### DELETE /api/pricing/templates/[id]
- 템플릿 삭제 (soft delete: is_active = false)

#### POST /api/pricing/templates/apply
- 템플릿 일괄 적용
- `action: 'preview'` - 미리보기 (변경사항 확인)
- `action: 'apply'` - 실제 적용 (pricing_configs 생성/수정)

### 4. 컴포넌트

#### template-form.tsx
- 템플릿 생성/수정 폼
- 가격 계산 공식 미리보기
- 마진 합계 실시간 검증

#### template-card.tsx
- 템플릿 카드 UI
- 마진 정보, 적용 이력 표시
- Edit, Apply, Delete 액션

#### apply-template-dialog.tsx
- 템플릿 적용 다이얼로그
- Location 선택 (체크박스)
- 환율 선택
- Preview 테이블 (제품별 가격 변경 내역)
- Status 배지: New(초록), Update(파랑), Skip(회색)

### 5. 페이지

#### /pricing/templates
- 템플릿 목록 페이지
- 카드 그리드 레이아웃

#### /pricing/templates/new
- 템플릿 생성 페이지

#### /pricing/templates/[id]/edit
- 템플릿 수정 페이지

### 6. UI 컴포넌트 추가
shadcn/ui 컴포넌트 설치:
- checkbox
- scroll-area
- dropdown-menu

## 버그 수정

### Select 컴포넌트 빈 문자열 에러
- **문제**: Radix UI Select.Item은 `value=""`를 허용하지 않음
- **해결**: "All categories" 옵션을 `value="all"`로 변경하고 변환 로직 추가

```tsx
// Before
<SelectItem value="">All categories</SelectItem>

// After
<Select
  value={formData.category || 'all'}
  onValueChange={(value) => setFormData({
    ...formData,
    category: value === 'all' ? '' : value
  })}
>
  <SelectItem value="all">All categories</SelectItem>
```

## 생성된 파일 목록

| 파일 | 설명 |
|------|------|
| supabase/migrations/030_create_pricing_templates.sql | DB 마이그레이션 |
| app/api/pricing/templates/route.ts | 템플릿 CRUD API |
| app/api/pricing/templates/[id]/route.ts | 단일 템플릿 API |
| app/api/pricing/templates/apply/route.ts | 템플릿 적용 API |
| app/(dashboard)/pricing/templates/page.tsx | 목록 페이지 |
| app/(dashboard)/pricing/templates/new/page.tsx | 생성 페이지 |
| app/(dashboard)/pricing/templates/[id]/edit/page.tsx | 수정 페이지 |
| components/pricing/template-form.tsx | 폼 컴포넌트 |
| components/pricing/template-card.tsx | 카드 컴포넌트 |
| components/pricing/apply-template-dialog.tsx | 적용 다이얼로그 |
| components/ui/checkbox.tsx | shadcn 체크박스 |
| components/ui/scroll-area.tsx | shadcn 스크롤 영역 |
| components/ui/dropdown-menu.tsx | shadcn 드롭다운 |

## 수정된 파일

| 파일 | 변경 내용 |
|------|----------|
| types/index.ts | PricingTemplate 관련 타입 추가 |
| app/(dashboard)/pricing/page.tsx | Templates 버튼 추가 |

## 사용 방법

### 1. 템플릿 생성
1. `/pricing` → **Templates** 버튼 클릭
2. **Create Template** 클릭
3. 템플릿 정보 입력:
   - Name: 템플릿 이름
   - Category: 적용할 카테고리 (선택)
   - Target Currency: VND 또는 CNY
   - HQ Margin: 본사 마진 %
   - Branch Margin: 지사 마진 %
   - Transfer Cost: 기본 이송비 (KRW)
4. **Create Template** 클릭

### 2. 템플릿 적용
1. 템플릿 카드에서 **Apply Template** 클릭
2. 적용할 Location 선택 (체크박스)
3. 환율 선택
4. **Preview Changes** 클릭하여 미리보기
5. 확인 후 **Apply** 클릭

### 3. 가격 계산 예시
```
템플릿 설정:
- HQ Margin: 10%
- Branch Margin: 30%
- Transfer Cost: 500 KRW

제품:
- Purchase Price: 5,000 KRW
- Exchange Rate: 1 KRW = 18.5 VND

계산:
1. Local Cost = (5,000 + 500) × 18.5 = 101,750 VND
2. Final Price = 101,750 / (1 - 0.40) = 169,583.33 VND
3. Rounded = 170,000 VND (1000 단위 반올림)
```

## 커밋 내역

1. `2f251f7` - Feat: Phase 4 - 카테고리 기반 가격 템플릿 시스템 구현
2. `de58f74` - Fix: Select 컴포넌트 빈 문자열 value 에러 수정

## 다음 단계 (향후 개선사항)

1. 템플릿 복제 기능
2. 템플릿 버전 관리
3. 적용 이력 상세 조회
4. 대량 적용 시 진행률 표시
5. 적용 취소(롤백) 기능
