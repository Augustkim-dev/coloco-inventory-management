# 020. Phase 13 Step 5: Branch Manager 권한 추가

**작업일**: 2025-11-18
**관련 Phase**: Phase 13 - 계층적 Sub-Branch 시스템 구현
**이전 작업**: [019.phase13.Step4_Location_생성_및_수정_UI_구현.md](019.phase13.Step4_Location_생성_및_수정_UI_구현.md)

## 작업 개요

Branch Manager가 자신이 속한 Branch의 Sub-Branch를 조회, 생성, 수정, 삭제할 수 있도록 권한 시스템을 구현했습니다. 기존에는 HQ_Admin만 모든 location을 관리할 수 있었지만, 이제 Branch Manager도 자신의 관할 범위 내에서 제한적으로 location을 관리할 수 있습니다.

## 구현된 권한 정책

### 역할별 권한 매트릭스

| 역할 | 조회 범위 | 생성 | 수정 | 삭제 |
|------|----------|------|------|------|
| **HQ_Admin** | 모든 location | HQ, Branch, SubBranch 모두 가능 | 모든 location 수정 가능 | 모든 location 삭제 가능 |
| **Branch_Manager** | 자신의 branch + 하위 sub-branch만 | SubBranch만 가능 (자신의 branch 하위에만) | 자신의 branch + 하위 sub-branch만 | 하위 sub-branch만 (자신의 branch는 삭제 불가) |

### Branch Manager 권한 상세

1. **조회 권한**
   - 자신이 속한 branch (location_id와 일치)
   - 자신의 branch 하위에 있는 모든 sub-branch (parent_location_id가 자신의 location_id와 일치)

2. **생성 권한**
   - SubBranch 타입만 생성 가능 (HQ, Branch 타입은 생성 불가)
   - parent_location_id가 반드시 자신의 location_id여야 함

3. **수정 권한**
   - 자신의 branch 수정 가능
   - 자신의 branch 하위 sub-branch 수정 가능
   - 다른 branch나 HQ는 수정 불가

4. **삭제 권한**
   - 자신의 branch는 삭제할 수 없음 (관리자만 가능)
   - 자신의 branch 하위 sub-branch만 삭제 가능
   - 삭제 시 해당 location에 하위 location이 없어야 함 (cascading 방지)

## 변경된 파일

### 1. 페이지 레벨 권한 제어

#### `app/(dashboard)/locations/page.tsx`
```typescript
// Before: HQ_Admin만 접근 가능
if (userData?.role !== 'HQ_Admin') {
  redirect('/dashboard')
}

// After: Branch_Manager도 접근 가능
if (userData?.role !== 'HQ_Admin' && userData?.role !== 'Branch_Manager') {
  redirect('/dashboard')
}

// Branch Manager 필터링 추가
if (userData?.role === 'Branch_Manager' && userData?.location_id) {
  locationsQuery = locationsQuery.or(
    `id.eq.${userData.location_id},parent_location_id.eq.${userData.location_id}`
  )
}
```

**변경 사항**:
- Branch_Manager에게 페이지 접근 허용
- Branch Manager는 자신의 branch + 하위 sub-branch만 조회
- 버튼 텍스트 조건부 표시: "Add Sub-Branch" (Branch Manager) vs "Add Location" (HQ Admin)
- userRole과 userLocationId를 LocationsViewClient에 전달

#### `app/(dashboard)/locations/new/page.tsx`
```typescript
// HQ Admin and Branch Manager can create locations
if (userData?.role !== 'HQ_Admin' && userData?.role !== 'Branch_Manager') {
  redirect('/dashboard')
}
```

**변경 사항**:
- Branch_Manager도 새 location 생성 페이지 접근 가능
- 제목과 설명을 역할에 따라 동적으로 표시
  - HQ Admin: "Add New Location" / "Create a new headquarters, branch, or sub-branch location"
  - Branch Manager: "Add New Sub-Branch" / "Create a new sub-branch under your branch"

### 2. API 엔드포인트 권한 검증

#### `app/api/locations/route.ts` (POST - 생성)
```typescript
// Branch Manager can only create SubBranch under their own branch
if (userData?.role === 'Branch_Manager') {
  if (location_type !== 'SubBranch') {
    return NextResponse.json(
      { error: 'Branch Manager can only create Sub-Branches' },
      { status: 403 }
    )
  }
  if (parent_location_id !== userData.location_id) {
    return NextResponse.json(
      { error: 'Branch Manager can only create Sub-Branches under their own branch' },
      { status: 403 }
    )
  }
}
```

**검증 로직**:
1. Branch Manager는 location_type이 'SubBranch'인 경우에만 생성 가능
2. parent_location_id가 자신의 location_id와 일치해야 함

#### `app/api/locations/[id]/route.ts` (PATCH - 수정)
```typescript
// Branch Manager can only edit their own branch or sub-branches under it
if (userData?.role === 'Branch_Manager') {
  const { data: location } = await supabase
    .from('locations')
    .select('*')
    .eq('id', params.id)
    .single()

  if (!location) {
    return NextResponse.json({ error: 'Location not found' }, { status: 404 })
  }

  const isOwnBranch = location.id === userData.location_id
  const isSubBranch =
    location.parent_location_id === userData.location_id &&
    location.location_type === 'SubBranch'

  if (!isOwnBranch && !isSubBranch) {
    return NextResponse.json(
      { error: 'Branch Manager can only edit their own branch or sub-branches under it' },
      { status: 403 }
    )
  }
}
```

**검증 로직**:
1. 수정하려는 location을 먼저 조회
2. 자신의 branch인지 확인 (location.id === userData.location_id)
3. 자신의 branch 하위 sub-branch인지 확인
   - parent_location_id === userData.location_id
   - location_type === 'SubBranch'
4. 둘 중 하나도 해당하지 않으면 403 Forbidden

#### `app/api/locations/[id]/route.ts` (DELETE - 삭제)
```typescript
// Branch Manager can only delete sub-branches under their branch
if (userData?.role === 'Branch_Manager') {
  const { data: location } = await supabase
    .from('locations')
    .select('*')
    .eq('id', params.id)
    .single()

  if (!location) {
    return NextResponse.json({ error: 'Location not found' }, { status: 404 })
  }

  // Branch Manager cannot delete their own branch, only sub-branches
  if (location.id === userData.location_id) {
    return NextResponse.json(
      { error: 'Branch Manager cannot delete their own branch' },
      { status: 403 }
    )
  }

  // Can only delete sub-branches under their branch
  if (
    location.parent_location_id !== userData.location_id ||
    location.location_type !== 'SubBranch'
  ) {
    return NextResponse.json(
      { error: 'Branch Manager can only delete sub-branches under their own branch' },
      { status: 403 }
    )
  }
}

// Check if location has children (공통 로직)
const { data: children } = await supabase
  .from('locations')
  .select('id')
  .eq('parent_location_id', params.id)
  .limit(1)

if (children && children.length > 0) {
  return NextResponse.json(
    { error: 'Cannot delete location with children. Delete children first.' },
    { status: 400 }
  )
}
```

**검증 로직**:
1. 자신의 branch는 삭제할 수 없음 (location.id === userData.location_id)
2. parent_location_id가 자신의 location_id와 일치해야 함
3. location_type이 'SubBranch'여야 함
4. 하위 location이 없어야 함 (cascading 방지)

### 3. UI 컴포넌트 권한 제어

#### `components/locations/location-create-form.tsx`
```typescript
export function LocationCreateForm({
  userRole,
  userLocationId
}: LocationCreateFormProps) {
  const isBranchManager = userRole === 'Branch_Manager'

  const [formData, setFormData] = useState({
    name: '',
    location_type: isBranchManager ? 'SubBranch' : '',  // Branch Manager는 SubBranch 고정
    country_code: '',
    currency: '',
    parent_location_id: isBranchManager && userLocationId ? userLocationId : '',  // 자동 설정
    address: '',
    contact_person: '',
    phone: '',
    is_active: true,
  })

  // Location Type 선택 필드 - Branch Manager는 숨김
  {!isBranchManager && (
    <div className="space-y-2">
      <Label>Location Type</Label>
      <Select
        value={formData.location_type}
        onValueChange={(value) => setFormData({ ...formData, location_type: value })}
      >
        <SelectTrigger>
          <SelectValue placeholder="Select type" />
        </SelectTrigger>
        <SelectContent>
          <SelectItem value="HQ">HQ</SelectItem>
          <SelectItem value="Branch">Branch</SelectItem>
          <SelectItem value="SubBranch">SubBranch</SelectItem>
        </SelectContent>
      </Select>
    </div>
  )}
}
```

**주요 변경**:
- `userRole`과 `userLocationId` props 추가
- Branch Manager인 경우:
  - location_type이 'SubBranch'로 고정
  - parent_location_id가 자신의 location_id로 자동 설정
  - Location Type 선택 필드 숨김 (변경 불가)
  - Parent Location 필드도 disabled 처리 (읽기 전용)

#### `components/locations/locations-list.tsx`
```typescript
// Helper function to check if user can edit a location
function canEditLocation(
  location: Location,
  userRole?: string,
  userLocationId?: string | null
): boolean {
  // HQ Admin can edit all locations
  if (userRole === 'HQ_Admin') {
    return true
  }

  // Branch Manager can edit:
  // 1. Their own branch (if location_id matches)
  // 2. Sub-branches under their branch (parent_location_id matches their branch)
  if (userRole === 'Branch_Manager' && userLocationId) {
    // Can edit their own branch
    if (location.id === userLocationId) {
      return true
    }
    // Can edit sub-branches under their branch
    if (location.parent_location_id === userLocationId && location.location_type === 'SubBranch') {
      return true
    }
  }

  return false
}

// Edit 버튼 조건부 렌더링
<TableCell className="text-right">
  {canEditLocation(location, userRole, userLocationId) && (
    <Link href={`/locations/${location.id}/edit`}>
      <Button variant="ghost" size="sm">
        <Edit className="h-4 w-4" />
      </Button>
    </Link>
  )}
</TableCell>
```

**주요 변경**:
- `canEditLocation()` 헬퍼 함수 추가
- HQ Admin: 모든 location의 Edit 버튼 표시
- Branch Manager: 자신의 branch와 하위 sub-branch의 Edit 버튼만 표시
- 권한이 없는 location은 Edit 버튼 자체를 숨김

#### `components/locations/locations-tree-view.tsx`
```typescript
// locations-list.tsx와 동일한 canEditLocation() 함수 적용

function canEditLocation(
  node: LocationTreeNode,
  userRole?: string,
  userLocationId?: string | null
): boolean {
  if (userRole === 'HQ_Admin') {
    return true
  }

  if (userRole === 'Branch_Manager' && userLocationId) {
    if (node.id === userLocationId) {
      return true
    }
    if (node.parent_location_id === userLocationId && node.location_type === 'SubBranch') {
      return true
    }
  }

  return false
}

// Edit 버튼 조건부 렌더링
{canEditLocation(node, userRole, userLocationId) && (
  <Link href={`/locations/${node.id}/edit`}>
    <Button variant="ghost" size="sm">
      <Edit className="h-4 w-4" />
    </Button>
  </Link>
)}
```

**주요 변경**:
- Tree view에도 동일한 권한 제어 로직 적용
- LocationTreeNode 타입에도 canEditLocation() 함수 적용
- List view와 Tree view의 권한 정책 일관성 유지

#### `components/locations/locations-view-client.tsx`
```typescript
export function LocationsViewClient({
  locations,
  userRole = 'Branch_Manager',
  userLocationId = null,
}: LocationsViewClientProps) {
  return (
    <Tabs defaultValue="tree" className="space-y-4">
      {/* ... */}
      <TabsContent value="tree" className="space-y-4">
        <LocationsTreeView
          locations={locations}
          userRole={userRole}
          userLocationId={userLocationId}
        />
      </TabsContent>

      <TabsContent value="list" className="space-y-4">
        <LocationsList
          locations={locations}
          userRole={userRole}
          userLocationId={userLocationId}
        />
      </TabsContent>
    </Tabs>
  )
}
```

**주요 변경**:
- `userRole`, `userLocationId` props 추가
- Tree view와 List view 모두에 props 전달
- 두 뷰 모두 동일한 권한 정책 적용

## 권한 검증 흐름

### 1. 페이지 접근 시
```
User Request
  ↓
Server Component (page.tsx)
  ↓
Check Authentication (supabase.auth.getUser())
  ↓
Check Role (HQ_Admin or Branch_Manager?)
  ↓
If Branch_Manager: Filter locations by location_id
  ↓
Pass userRole & userLocationId to Client Components
```

### 2. API 요청 시
```
Client Request (POST/PATCH/DELETE)
  ↓
API Route Handler
  ↓
Check Authentication
  ↓
Get User Role & Location ID
  ↓
If Branch_Manager: Validate permissions
  - POST: Check location_type === 'SubBranch' AND parent_location_id === userLocationId
  - PATCH: Check isOwnBranch OR isSubBranch
  - DELETE: Check NOT isOwnBranch AND isSubBranch
  ↓
Perform Database Operation
  ↓
Return Response
```

### 3. UI 렌더링 시
```
Client Component Render
  ↓
Receive userRole & userLocationId props
  ↓
For each location/node:
  - Call canEditLocation(location, userRole, userLocationId)
  - If true: Show Edit button
  - If false: Hide Edit button
  ↓
For create form:
  - If Branch_Manager: Fix location_type to 'SubBranch'
  - If Branch_Manager: Set parent_location_id to userLocationId
  - If Branch_Manager: Hide/disable type selector
```

## 보안 고려사항

### 다중 레벨 방어 (Defense in Depth)
1. **UI Level**: Edit 버튼 숨김으로 사용자 경험 개선 및 1차 방어
2. **API Level**: 서버 사이드 검증으로 우회 시도 차단
3. **Database Level**: RLS (Row Level Security) 정책으로 최종 방어 (향후 구현 권장)

### 중요 원칙
- **클라이언트 검증은 보안이 아닌 UX**: UI 레벨의 권한 체크는 편의성을 위한 것
- **서버 검증이 실제 보안**: API 엔드포인트의 검증이 실제 보안 경계
- **Never Trust Client**: 클라이언트에서 보낸 모든 데이터는 서버에서 재검증

### API 엔드포인트 보안 체크리스트
- ✅ Authentication 확인 (supabase.auth.getUser())
- ✅ Role 확인 (HQ_Admin or Branch_Manager)
- ✅ Resource ownership 확인 (location_id 매칭)
- ✅ 명시적 에러 메시지 (권한 없음 vs 리소스 없음 구분)
- ✅ 403 Forbidden vs 404 Not Found 적절히 사용

## 테스트 시나리오

### Branch Manager 권한 테스트

#### 조회 테스트
- [ ] Branch Manager 로그인 시 `/locations` 페이지 접근 가능
- [ ] 자신의 branch만 표시됨
- [ ] 자신의 branch 하위 sub-branch들만 표시됨
- [ ] 다른 branch나 HQ는 표시되지 않음
- [ ] Tree view와 List view 모두 동일한 결과

#### 생성 테스트
- [ ] "Add Sub-Branch" 버튼 클릭 가능
- [ ] Location Type이 'SubBranch'로 고정됨
- [ ] Parent Location이 자신의 branch로 고정됨
- [ ] SubBranch 생성 성공
- [ ] HQ나 Branch 타입 생성 시도 시 403 에러

#### 수정 테스트
- [ ] 자신의 branch에 Edit 버튼 표시
- [ ] 하위 sub-branch에 Edit 버튼 표시
- [ ] 다른 branch/HQ에는 Edit 버튼 없음
- [ ] 자신의 branch 수정 성공
- [ ] 하위 sub-branch 수정 성공
- [ ] 다른 location 수정 시도 시 403 에러

#### 삭제 테스트
- [ ] 자신의 branch 삭제 시도 시 403 에러
- [ ] 하위 sub-branch 삭제 성공
- [ ] 하위에 또 다른 location이 있는 sub-branch 삭제 시 400 에러
- [ ] 다른 branch의 sub-branch 삭제 시도 시 403 에러

### HQ Admin 권한 테스트
- [ ] 모든 location 조회 가능
- [ ] HQ, Branch, SubBranch 모두 생성 가능
- [ ] 모든 location에 Edit 버튼 표시
- [ ] 모든 location 수정 가능
- [ ] 하위가 없는 모든 location 삭제 가능

## 향후 개선 사항

### 1. Database RLS (Row Level Security) 추가
현재는 API 레벨에서만 권한을 체크하지만, Supabase RLS 정책을 추가하여 데이터베이스 레벨에서도 보호할 것을 권장합니다.

```sql
-- Branch Manager는 자신의 branch와 하위 sub-branch만 조회
CREATE POLICY "branch_manager_select_policy" ON locations
  FOR SELECT
  USING (
    auth.uid() IN (
      SELECT id FROM users WHERE role = 'HQ_Admin'
    )
    OR
    (
      auth.uid() IN (
        SELECT id FROM users WHERE role = 'Branch_Manager'
      )
      AND
      (
        id = (SELECT location_id FROM users WHERE id = auth.uid())
        OR
        parent_location_id = (SELECT location_id FROM users WHERE id = auth.uid())
      )
    )
  );
```

### 2. 계층 구조 깊이 제한
현재는 Branch → SubBranch 2단계만 지원하지만, 향후 SubBranch → Sub-SubBranch 등 더 깊은 계층이 필요할 경우:
- `path` 컬럼을 활용한 재귀 쿼리
- WITH RECURSIVE를 사용한 ancestor/descendant 조회
- Branch Manager의 관할 범위를 "자신의 branch 하위 모든 계층"으로 확장

### 3. Audit Log 추가
location 생성/수정/삭제 시 누가 언제 무엇을 변경했는지 기록:
```typescript
await supabase.from('audit_logs').insert({
  user_id: user.id,
  action: 'DELETE_LOCATION',
  resource_type: 'locations',
  resource_id: params.id,
  metadata: { location_name: location.name, location_type: location.location_type },
})
```

### 4. 역할 세분화
현재는 Branch_Manager가 모든 Branch에 대해 동일한 권한을 가지지만, 향후:
- SubBranch_Manager 역할 추가 (SubBranch만 관리)
- Regional_Manager 역할 추가 (여러 Branch 통합 관리)
- 역할별 권한 매트릭스 테이블 관리

## 커밋 정보

- **Commit Hash**: `db0718f`
- **Commit Message**: "Feat: Branch Manager 권한 추가 - Sub-Branch 관리 기능 구현"
- **변경 파일 수**: 8개
- **라인 변경**: +321 / -80

### 변경된 파일 목록
1. `app/(dashboard)/locations/new/page.tsx`
2. `app/(dashboard)/locations/page.tsx`
3. `app/api/locations/[id]/route.ts`
4. `app/api/locations/route.ts`
5. `components/locations/location-create-form.tsx`
6. `components/locations/locations-list.tsx`
7. `components/locations/locations-tree-view.tsx`
8. `components/locations/locations-view-client.tsx`

## 다음 단계

Phase 13의 Sub-Branch 시스템 구현이 완료되었습니다. 다음 Phase에서는:
1. Transfer Request 시스템에 계층적 권한 적용
2. Inventory 조회 시 계층 구조 기반 필터링
3. Dashboard에 계층별 재고 현황 표시
4. 계층 구조 기반 리포팅 기능 강화

## 참고 문서

- [019.phase13.Step4_Location_생성_및_수정_UI_구현.md](019.phase13.Step4_Location_생성_및_수정_UI_구현.md)
- [018.phase13.Step3_프론트엔드_UI_구현.md](018.phase13.Step3_프론트엔드_UI_구현.md)
- [016.phase13.Step1_데이터베이스_스키마_계층_구조_지원_추가.md](016.phase13.Step1_데이터베이스_스키마_계층_구조_지원_추가.md)
