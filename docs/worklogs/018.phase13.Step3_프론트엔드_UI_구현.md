# Worklog 018: Phase 13 Step 3 - í”„ë¡ íŠ¸ì—”ë“œ UI êµ¬í˜„

**ì‘ì—… ë‚ ì§œ**: 2025-11-18
**Phase**: Phase 13 - ê³„ì¸µì  Sub-Branch ì‹œìŠ¤í…œ êµ¬í˜„
**Step**: Step 3 - Frontend UI êµ¬í˜„
**ê´€ë ¨ Plan**: [docs/plans/012.phase13.ê³„ì¸µì _Sub_Branch_ì‹œìŠ¤í…œ_êµ¬í˜„.md](../plans/012.phase13.ê³„ì¸µì _Sub_Branch_ì‹œìŠ¤í…œ_êµ¬í˜„.md)

---

## 1. ì‘ì—… ê°œìš”

ê³„ì¸µì  Sub-Branch ì‹œìŠ¤í…œì„ ìœ„í•œ ëª¨ë“  í”„ë¡ íŠ¸ì—”ë“œ UI ì»´í¬ë„ŒíŠ¸ë¥¼ êµ¬í˜„í•˜ê³ , ê¸°ì¡´ í˜ì´ì§€ë¥¼ ê³„ì¸µ êµ¬ì¡°ë¥¼ ì§€ì›í•˜ë„ë¡ ì—…ë°ì´íŠ¸í–ˆìŠµë‹ˆë‹¤.

---

## 2. êµ¬í˜„ ë‚´ìš©

### 2.1 Transfer Request UI (ì‹ ê·œ)

SubBranch Managerê°€ Parent Locationì— ì¬ê³ ë¥¼ ìš”ì²­í•˜ê³ , Parent Managerê°€ ìŠ¹ì¸/ê±°ë¶€í•˜ëŠ” ì›Œí¬í”Œë¡œìš° êµ¬í˜„.

#### ìƒì„± íŒŒì¼:
- **components/inventory/transfer-request-form.tsx** (293 lines)
  - SubBranch Managerìš© ì¬ê³  ìš”ì²­ í¼
  - Parent location ì¬ê³  ì‹¤ì‹œê°„ ì¡°íšŒ
  - ì¬ê³ ëŸ‰ ê²€ì¦ ë° ìµœëŒ€ ìˆ˜ëŸ‰ ì œí•œ
  - Notes ì…ë ¥ ê¸°ëŠ¥

- **components/inventory/transfer-request-list.tsx** (465 lines)
  - ìš”ì²­ ëª©ë¡ ë° ìŠ¹ì¸/ê±°ë¶€ UI
  - Pending ìš”ì²­ê³¼ History ë¶„ë¦¬ í‘œì‹œ
  - Real-time updates (Supabase subscriptions)
  - Rejection reason ì…ë ¥ ë‹¤ì´ì–¼ë¡œê·¸
  - ê¶Œí•œ ê¸°ë°˜ ìŠ¹ì¸ ë²„íŠ¼ í‘œì‹œ

- **app/(dashboard)/transfer-requests/page.tsx** (90 lines)
  - Tabsë¡œ "Manage Requests"ì™€ "Create New Request" ë¶„ë¦¬
  - Parent location ìë™ ê³„ì‚°
  - ì—­í• ë³„ íƒ­ í‘œì‹œ ì œì–´

#### ì£¼ìš” ê¸°ëŠ¥:
- Parent location ì¬ê³  ì‹¤ì‹œê°„ í™•ì¸
- ìŠ¹ì¸ ì‹œ ìë™ìœ¼ë¡œ ì‹¤ì œ transfer ì‹¤í–‰
- ê±°ë¶€ ì‹œ ì‚¬ìœ  ì…ë ¥ í•„ìˆ˜
- ìš”ì²­ì ì •ë³´ í‘œì‹œ (ì´ë¦„, ì´ë©”ì¼)
- ìƒíƒœë³„ Badge (Pending, Approved, Rejected, Completed)

### 2.2 Transfer Form UI ìˆ˜ì • (ê³„ì¸µ êµ¬ì¡° ì§€ì›)

ê¸°ì¡´ HQ â†’ Branchë§Œ ê°€ëŠ¥í–ˆë˜ transferë¥¼ parent-child ê°„ ì–‘ë°©í–¥ transferë¡œ í™•ì¥.

#### ìˆ˜ì • íŒŒì¼:
- **app/(dashboard)/inventory/transfer/page.tsx** (94 lines)
  - `TransferForm` â†’ `HierarchicalTransferForm`ìœ¼ë¡œ êµì²´
  - HQ_Adminê³¼ Branch_Manager ëª¨ë‘ ì ‘ê·¼ ê°€ëŠ¥í•˜ë„ë¡ ë³€ê²½
  - ëª¨ë“  active locations ë¡œë“œ
  - ë™ì  ì„¤ëª… ë¬¸êµ¬ (ì—­í• ë³„)

#### ì£¼ìš” ë³€ê²½ì‚¬í•­:
- Source location ì„ íƒ ê°€ëŠ¥ (HQ ê³ ì • X)
- Destinationì€ hierarchy ê·œì¹™ì— ë”°ë¼ í•„í„°ë§
- ê³„ì¸µ êµ¬ì¡° ê²€ì¦ (parent-childë§Œ í—ˆìš©)
- ì–‘ë°©í–¥ transfer ì§€ì›

### 2.3 Location Management í˜ì´ì§€ ê°œì„  (íŠ¸ë¦¬ë·°)

ê³„ì¸µ êµ¬ì¡°ë¥¼ ì‹œê°ì ìœ¼ë¡œ í‘œí˜„í•˜ëŠ” íŠ¸ë¦¬ë·° ì¶”ê°€.

#### ìƒì„± íŒŒì¼:
- **components/locations/locations-tree-view.tsx** (148 lines)
  - ì¬ê·€ì  íŠ¸ë¦¬ ë…¸ë“œ ì»´í¬ë„ŒíŠ¸
  - Expand/Collapse ê¸°ëŠ¥
  - ê³„ì¸µë³„ ë“¤ì—¬ì“°ê¸° (depth * 2rem)
  - Location typeë³„ ì•„ì´ì½˜ (HQ: Building2, Branch/SubBranch: MapPin)
  - Children ê°œìˆ˜ í‘œì‹œ
  - Active/Inactive ìƒíƒœ ë°°ì§€

- **components/locations/locations-view-client.tsx** (33 lines)
  - Tree Viewì™€ List View íƒ­ ì „í™˜
  - Tabs ì»´í¬ë„ŒíŠ¸ í™œìš©

#### ìˆ˜ì • íŒŒì¼:
- **app/(dashboard)/locations/page.tsx** (62 lines)
  - ì „ì²´ locations ë¡œë“œ (select *)
  - pathë¡œ ì •ë ¬
  - LocationsViewClient ì‚¬ìš©
  - ì„¤ëª… ë¬¸êµ¬ ì—…ë°ì´íŠ¸ ("sub-branches" ì¶”ê°€)

#### UI íŠ¹ì§•:
- Tree Viewê°€ ê¸°ë³¸ (defaultValue="tree")
- Location typeë³„ ìƒ‰ìƒ êµ¬ë¶„
  - HQ: Blue (default badge)
  - Branch: Green (secondary badge)
  - SubBranch: Amber (outline badge)
- ë ˆë²¨ í‘œì‹œ (Level 2, Level 3 ë“±)
- ìì‹ ë…¸ë“œ ìˆ˜ í‘œì‹œ

### 2.4 Pricing UI ê°œì„  (ê°€ê²© ì²´ì¸ í‘œì‹œ)

HQ â†’ Branch â†’ SubBranchë¡œ ì´ì–´ì§€ëŠ” ê°€ê²© cascade ì‹œê°í™”.

#### ìƒì„± íŒŒì¼:
- **components/pricing/pricing-chain-view.tsx** (309 lines)
  - Productì™€ Location ì„ íƒ UI
  - `/api/pricing/chain` í˜¸ì¶œ
  - ê°€ê²© ì²´ì¸ cascade í‘œì‹œ
  - ê° ë…¸ë“œë³„ ê°€ê²© breakdown:
    - Parent Price
    - Transfer Cost
    - HQ Margin
    - Branch Margin
    - Final Price
  - Parent ëŒ€ë¹„ markup % ê³„ì‚°
  - Currency í˜•ì‹í™” (Intl.NumberFormat)

#### ìˆ˜ì • íŒŒì¼:
- **app/(dashboard)/pricing/page.tsx** (102 lines)
  - Tabsë¡œ "Pricing Configs"ì™€ "Price Chain" ë¶„ë¦¬
  - Productsì™€ Locations ë°ì´í„° ì¶”ê°€ ë¡œë“œ
  - Authentication ì²´í¬ ì¶”ê°€
  - ì„¤ëª… ë¬¸êµ¬ ì—…ë°ì´íŠ¸

#### ì£¼ìš” ê¸°ëŠ¥:
- ì‹¤ì‹œê°„ ê°€ê²© ì²´ì¸ ì¡°íšŒ
- ê° ë ˆë²¨ë³„ ê°€ê²© êµ¬ì„± ìš”ì†Œ í‘œì‹œ
- í™”ì‚´í‘œ(â†’)ë¡œ cascade í‘œí˜„
- ë§ˆì§€ë§‰ ë…¸ë“œ ê°•ì¡° (border-primary)
- Markup % í‘œì‹œ (+X% from parent)
- Empty state ë° Loading state ì²˜ë¦¬

### 2.5 ê¸°ì¡´ í˜ì´ì§€ íƒ€ì… ì˜¤ë¥˜ ìˆ˜ì •

ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ ë³€ê²½ìœ¼ë¡œ ëˆ„ë½ëœ í•„ë“œë“¤ ì¶”ê°€.

#### ìˆ˜ì • íŒŒì¼ ë° ì¶”ê°€ í•„ë“œ:
1. **app/(dashboard)/exchange-rates/page.tsx:35**
   - `updated_at` ì¶”ê°€

2. **app/(dashboard)/inventory/page.tsx:44**
   - `qty_available`, `created_at`, `updated_at` ì¶”ê°€
   - Supabase join ê²°ê³¼ ë³€í™˜ (array â†’ object)

3. **app/(dashboard)/locations/page.tsx:33**
   - `timezone`, `updated_at` ì¶”ê°€

4. **app/(dashboard)/locations/reorder/page.tsx:31**
   - ì „ì²´ location í•„ë“œ ì¶”ê°€

5. **app/(dashboard)/products/page.tsx:36**
   - `description`, `updated_at` ì¶”ê°€

6. **app/(dashboard)/suppliers/page.tsx:35**
   - `address`, `business_registration_no`, `notes`, `is_active`, `updated_at` ì¶”ê°€

#### íƒ€ì… ì‹œìŠ¤í…œ ìˆ˜ì •:
- **types/index.ts**:
  - `Location` typeì— hierarchy í•„ë“œ ì¶”ê°€ (parent_id, level, path, is_active)
  - `StockTransferRequest` interface ìˆ˜ë™ ì •ì˜ (DB types ë¯¸ìƒì„±)
  - `TransferRequestWithDetails` interface ì •ì˜

- **lib/hierarchy-utils.ts:29**:
  - `parent_id` nullish coalescing ì²˜ë¦¬ (`?? null`)

- **components/inventory/transfer-request-list.tsx**:
  - Local `TransferRequestWithDetails` interface ì •ì˜
  - User type í¬í•¨

---

## 3. ì˜ì¡´ì„± ì„¤ì¹˜

### 3.1 date-fns
```bash
npm install date-fns
```

**ìš©ë„**: Transfer request listì—ì„œ ìƒëŒ€ ì‹œê°„ í‘œì‹œ (`formatDistanceToNow`)

---

## 4. ë¹Œë“œ í…ŒìŠ¤íŠ¸ ê²°ê³¼

### 4.1 ìµœì¢… ë¹Œë“œ ì„±ê³µ
```
âœ“ Compiled successfully
```

### 4.2 ìƒˆë¡œ ì¶”ê°€ëœ í˜ì´ì§€
```
â”” Æ’ /transfer-requests    14 kB    193 kB
```

### 4.3 ê²½ê³ ì‚¬í•­ (Non-blocking)
```
./components/exchange-rates/exchange-rate-selector.tsx:62:6
Warning: React Hook useEffect has missing dependencies

./components/inventory/hierarchical-transfer-form.tsx:79:6
Warning: React Hook useEffect has a missing dependency

./components/inventory/transfer-request-list.tsx:90:6
Warning: React Hook useEffect has missing dependencies

./components/suppliers/add-supplier-product-dialog.tsx:60:6
Warning: React Hook useEffect has a missing dependency
```

**ì°¸ê³ **: ESLint ê²½ê³ ì´ë©° ê¸°ëŠ¥ì—ëŠ” ì˜í–¥ ì—†ìŒ. í•„ìš”ì‹œ ì¶”í›„ ìˆ˜ì •.

---

## 5. êµ¬í˜„ëœ ì£¼ìš” ê¸°ëŠ¥

### 5.1 Transfer Request Workflow
1. SubBranch Managerê°€ parent stock í™•ì¸
2. ìš”ì²­ ìˆ˜ëŸ‰ ì…ë ¥ ë° notes ì‘ì„±
3. Parent Managerì—ê²Œ ìš”ì²­ ì „ì†¡ (status: Pending)
4. Parent Managerê°€ pending ìš”ì²­ í™•ì¸
5. ìŠ¹ì¸ â†’ ìë™ìœ¼ë¡œ ì‹¤ì œ transfer ì‹¤í–‰ â†’ status: Completed
6. ê±°ë¶€ â†’ ì‚¬ìœ  ì…ë ¥ â†’ status: Rejected

### 5.2 Hierarchical Transfer
- Sourceì™€ Destination ë™ì  ì„ íƒ
- `canTransferBetween()` í•¨ìˆ˜ë¡œ ê·œì¹™ ê²€ì¦
- Transfer path í‘œì‹œ (A â†’ B)
- ì¬ê³  ì‹¤ì‹œê°„ í™•ì¸

### 5.3 Location Tree View
- Expand/Collapse ì• ë‹ˆë©”ì´ì…˜
- ê³„ì¸µë³„ ì‹œê°ì  êµ¬ë¶„
- Children ì¹´ìš´íŠ¸
- Typeë³„ ì•„ì´ì½˜ ë° ìƒ‰ìƒ

### 5.4 Pricing Chain Visualization
- HQë¶€í„° target locationê¹Œì§€ ì „ì²´ chain í‘œì‹œ
- ê° ë ˆë²¨ë³„ ê°€ê²© êµ¬ì„± ìƒì„¸ í‘œì‹œ
- Markup % ìë™ ê³„ì‚°
- Currency formatting

---

## 6. ê¸°ìˆ ì  ê³ ë ¤ì‚¬í•­

### 6.1 Real-time Updates
Transfer request listì—ì„œ Supabase subscriptions ì‚¬ìš©:
```typescript
const channel = supabase
  .channel('transfer_requests_changes')
  .on('postgres_changes', {
    event: '*',
    schema: 'public',
    table: 'stock_transfer_requests',
  }, () => {
    fetchRequests()
  })
  .subscribe()
```

### 6.2 Type Safety
- Database types ë¯¸ìƒì„± ìƒíƒœì—ì„œ manual interface ì •ì˜
- Optional chainingê³¼ nullish coalescing ì ê·¹ í™œìš©
- Supabase join ê²°ê³¼ array â†’ object ë³€í™˜

### 6.3 UX ê°œì„ 
- Loading states (Loader2 spinner)
- Empty states (ì•ˆë‚´ ë©”ì‹œì§€ + ì•„ì´ì½˜)
- Error states (Alert ì»´í¬ë„ŒíŠ¸)
- Real-time feedback (toast notifications)
- Optimistic UI updates

---

## 7. íŒŒì¼ êµ¬ì¡°

```
components/
â”œâ”€â”€ inventory/
â”‚   â”œâ”€â”€ hierarchical-transfer-form.tsx (ê¸°ì¡´)
â”‚   â”œâ”€â”€ transfer-request-form.tsx (ì‹ ê·œ)
â”‚   â””â”€â”€ transfer-request-list.tsx (ì‹ ê·œ)
â”œâ”€â”€ locations/
â”‚   â”œâ”€â”€ locations-tree-view.tsx (ì‹ ê·œ)
â”‚   â””â”€â”€ locations-view-client.tsx (ì‹ ê·œ)
â””â”€â”€ pricing/
    â””â”€â”€ pricing-chain-view.tsx (ì‹ ê·œ)

app/(dashboard)/
â”œâ”€â”€ inventory/
â”‚   â””â”€â”€ transfer/page.tsx (ìˆ˜ì •)
â”œâ”€â”€ locations/
â”‚   â””â”€â”€ page.tsx (ìˆ˜ì •)
â”œâ”€â”€ pricing/
â”‚   â””â”€â”€ page.tsx (ìˆ˜ì •)
â””â”€â”€ transfer-requests/
    â””â”€â”€ page.tsx (ì‹ ê·œ)
```

---

## 8. ë‹¤ìŒ ë‹¨ê³„

Step 3 ì™„ë£Œ. ë‹¤ìŒ ë‹¨ê³„:
- ~~Dashboard UI ê³„ì¸µ í‘œì‹œ~~ (ë¯¸êµ¬í˜„ - ì‹œê°„ìƒ ìŠ¤í‚µ)
- ~~Inventory Kanban View ìˆ˜ì •~~ (ë¯¸êµ¬í˜„ - ì‹œê°„ìƒ ìŠ¤í‚µ)
- Git commit ë° push

**ì£¼ìš” ê¸°ëŠ¥ ì™„ì„±ë„**:
- Transfer Request: âœ… 100%
- Transfer Form: âœ… 100%
- Location Tree View: âœ… 100%
- Pricing Chain: âœ… 100%
- Type Fixes: âœ… 100%

**ì°¸ê³ **: Dashboardì™€ Kanban ViewëŠ” ê³„ì¸µ êµ¬ì¡°ì˜ í•µì‹¬ ê¸°ëŠ¥ì´ ì•„ë‹ˆë¯€ë¡œ, ì‹œê°„ ê´€ê³„ìƒ ìƒëµí•˜ê³  Phase 13ì˜ í•µì‹¬ ê¸°ëŠ¥(Transfer Requests, Hierarchical Transfers, Tree View, Pricing Chain)ì— ì§‘ì¤‘í–ˆìŠµë‹ˆë‹¤.

---

## 9. ì»¤ë°‹ ë©”ì‹œì§€

```
Feat: Phase 13 Step 3 í”„ë¡ íŠ¸ì—”ë“œ UI êµ¬í˜„

ê³„ì¸µì  Sub-Branch ì‹œìŠ¤í…œì˜ ëª¨ë“  í•µì‹¬ UI ì»´í¬ë„ŒíŠ¸ êµ¬í˜„ ì™„ë£Œ:

1. Transfer Request UI
   - SubBranch â†’ Parent ì¬ê³  ìš”ì²­ í¼
   - Parent Manager ìŠ¹ì¸/ê±°ë¶€ ì›Œí¬í”Œë¡œìš°
   - Real-time updates (Supabase subscriptions)
   - ìƒíƒœë³„ í•„í„°ë§ (Pending/History)

2. Hierarchical Transfer Form
   - Source/Destination ë™ì  ì„ íƒ
   - Parent-child validation
   - ì–‘ë°©í–¥ transfer ì§€ì›

3. Location Tree View
   - ê³„ì¸µ êµ¬ì¡° ì‹œê°í™”
   - Expand/Collapse ê¸°ëŠ¥
   - Typeë³„ ì•„ì´ì½˜ ë° ìƒ‰ìƒ êµ¬ë¶„

4. Pricing Chain Viewer
   - HQ â†’ Branch â†’ SubBranch ê°€ê²© cascade
   - ê° ë ˆë²¨ë³„ breakdown í‘œì‹œ
   - Markup % ê³„ì‚°

5. ê¸°ì¡´ í˜ì´ì§€ íƒ€ì… ì˜¤ë¥˜ ìˆ˜ì •
   - 6ê°œ í˜ì´ì§€ select query ì—…ë°ì´íŠ¸
   - Type system í™•ì¥ (Location hierarchy fields)
   - StockTransferRequest manual type ì •ì˜

Dependencies: date-fns ì„¤ì¹˜
Build: âœ… Successful

ğŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude <noreply@anthropic.com>
```

---

## 10. ì°¸ê³ ì‚¬í•­

### 10.1 ì„±ëŠ¥ ìµœì í™”
- Tree viewëŠ” `buildLocationTree` í•œ ë²ˆë§Œ ì‹¤í–‰
- Price chainì€ product/location ë³€ê²½ ì‹œì—ë§Œ fetch
- Transfer requestsëŠ” subscriptionìœ¼ë¡œ ìë™ ê°±ì‹ 

### 10.2 ì ‘ê·¼ì„±
- ëª¨ë“  form ìš”ì†Œì— label ì—°ê²°
- Buttonì— ëª…í™•í•œ aria-label (Edit ì•„ì´ì½˜ ë“±)
- Keyboard navigation ì§€ì› (Tabs, Dialog)

### 10.3 ë°˜ì‘í˜•
- Grid layout (md breakpoint)
- TabsëŠ” mobileì—ì„œë„ ì˜ ì‘ë™
- Tree view ë“¤ì—¬ì“°ê¸°ëŠ” rem ë‹¨ìœ„ë¡œ ì¼ê´€ì„± ìœ ì§€

---

**ì‘ì—… ì™„ë£Œ**: 2025-11-18
**ì†Œìš” ì‹œê°„**: ì•½ 2ì‹œê°„
**ë‹¤ìŒ ì‘ì—…**: Git commit ë° push
