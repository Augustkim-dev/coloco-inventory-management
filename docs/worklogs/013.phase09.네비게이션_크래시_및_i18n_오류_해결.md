# Worklog 013 - Phase 09: 네비게이션 크래시 및 i18n MISSING_MESSAGE 오류 해결

## 작업 일시
2025-11-03

## 작업 개요
사용자가 네비게이션 바를 통해 페이지 이동 시 발생하는 치명적 오류 2건을 분석하고 해결

## 발생한 문제

### 1. Inventory 페이지 크래시 (치명적)
**증상:**
- Inventory 페이지 접속 시 앱 전체 크래시
- 브라우저 화면에 "Application error: a client-side exception has occurred" 표시
- React Error #31 발생

**콘솔 오류:**
```
Error: Minified React error #31
object with keys {from, to, selectProduct, quantity, submit}
```

**원인:**
- `locales/[lang]/inventory.json` 파일에 중복된 `"transfer"` 키 존재
- 하나는 문자열 `"Transfer"`, 다른 하나는 객체 `{from, to, selectProduct, quantity, submit}`
- JavaScript는 중복된 키 중 마지막 값만 유지하므로 `t.transfer`가 객체를 반환
- React는 문자열 대신 객체를 렌더링하려고 시도하여 Error #31 발생

### 2. Dashboard MISSING_MESSAGE 오류
**증상:**
- Dashboard 페이지 접속 시 콘솔에 반복적인 오류 메시지
- 페이지는 렌더링되지만 번역이 누락됨

**콘솔 오류:**
```
ey: MISSING_MESSAGE: navigation.menu (en)
ey: MISSING_MESSAGE: common (en)
```

**원인:**
1. `IntlProvider`가 초기 상태에서 `common` namespace를 포함하지 않음
2. 번역 파일을 비동기로 로드하는 동안 컴포넌트가 즉시 번역에 접근 시도 (race condition)
3. 최근 커밋(9565f2d)에서 `common`을 spread로만 제공하여 `useTranslations('common')` 접근 불가
4. Sidebar 컴포넌트가 렌더링 시점에 `navigation.menu`와 `common` namespace에 즉시 접근

## 해결 방법

### 수정 1: inventory.json 중복 키 제거

**수정된 파일 (4개):**
- `locales/en/inventory.json`
- `locales/ko/inventory.json`
- `locales/vi/inventory.json`
- `locales/zh/inventory.json`

**변경 내용:**
```json
// 변경 전 (중복 키)
{
  "title": "Inventory",
  "transfer": "Transfer",        // ← 첫 번째 transfer (문자열)
  "transfer": {                  // ← 두 번째 transfer (객체) - 중복!
    "from": "From Location",
    "to": "To Location",
    "selectProduct": "Select Product",
    "quantity": "Transfer Quantity",
    "submit": "Transfer Stock"
  }
}

// 변경 후 (고유한 키)
{
  "title": "Inventory",
  "transfer": "Transfer",
  "transferForm": {              // ← 이름 변경으로 중복 해소
    "from": "From Location",
    "to": "To Location",
    "selectProduct": "Select Product",
    "quantity": "Transfer Quantity",
    "submit": "Transfer Stock"
  }
}
```

### 수정 2: IntlProvider 로딩 상태 관리 개선

**수정된 파일:**
- `lib/providers/intl-provider.tsx`

**변경 내용:**

#### 1) 초기 상태 변경
```tsx
// 변경 전
const [messages, setMessages] = useState<any>({
  navigation: {},
  auth: {},
  products: {},
  // ... 빈 객체들
})

// 변경 후
const [messages, setMessages] = useState<any>(null)
const [loading, setLoading] = useState(true)
```

#### 2) 로딩 상태 관리 추가
```tsx
async function loadMessages() {
  setLoading(true)  // ← 로딩 시작
  try {
    // ... 번역 파일 로드
  } catch (error) {
    console.error('Error loading messages:', error)
  } finally {
    setLoading(false)  // ← 로딩 완료
  }
}
```

#### 3) common namespace 이중 제공
```tsx
setMessages({
  ...common.default,       // ← spread로 직접 접근 가능
  common: common.default,  // ← useTranslations('common') 접근 가능
  navigation: navigation.default,
  auth: auth.default,
  // ...
})
```

이렇게 하면 두 가지 접근 패턴 모두 지원:
- `useTranslations('common')` → `common.appName` 접근
- 직접 접근 → `messages.appName`

#### 4) 로딩 완료 전 렌더링 방지
```tsx
// 변경 전
return (
  <NextIntlClientProvider locale={language} messages={messages}>
    {children}
  </NextIntlClientProvider>
)

// 변경 후
if (loading || !messages) {
  return (
    <div className="flex h-screen items-center justify-center">
      <div className="text-center">
        <div className="inline-block h-8 w-8 animate-spin rounded-full border-4 border-solid border-current border-r-transparent" />
        <p className="mt-4 text-sm text-muted-foreground">Loading...</p>
      </div>
    </div>
  )
}

return (
  <NextIntlClientProvider locale={language} messages={messages}>
    {children}
  </NextIntlClientProvider>
)
```

## 기술적 분석

### React Error #31이란?
React는 유효한 React 요소만 렌더링할 수 있습니다:
- ✅ 문자열, 숫자, boolean
- ✅ React 컴포넌트
- ✅ Fragment
- ❌ 일반 객체 (Plain Object)

Inventory 페이지에서 `{t.transfer}`가 객체를 반환하여 오류 발생:
```tsx
<Button>
  <ArrowRightLeft className="mr-2 h-4 w-4" />
  {t.transfer}  // ← {from: "...", to: "...", ...} 객체가 반환됨!
</Button>
```

### Race Condition 분석

**발생 순서:**
1. 앱 초기화 → `IntlProvider` 마운트
2. 초기 상태: `messages = { navigation: {}, auth: {}, ... }` (빈 객체들)
3. `useEffect` 트리거 → 비동기로 번역 파일 로드 시작
4. 동시에 Sidebar 컴포넌트 렌더링 시작
5. Sidebar에서 `useTranslations('navigation.menu')` 호출
6. 이 시점에 `messages.navigation.menu`는 아직 `undefined` (로딩 중)
7. **MISSING_MESSAGE 오류 발생**

**해결 방법:**
- 번역 로딩이 완료될 때까지 children 렌더링 차단
- Loading 스피너 표시

## 파일 변경 사항 요약

| 파일 경로 | 변경 유형 | 변경 내용 |
|----------|----------|-----------|
| `lib/providers/intl-provider.tsx` | 수정 | 로딩 상태 관리 추가, common namespace 이중 제공 |
| `locales/en/inventory.json` | 수정 | transfer → transferForm 키 이름 변경 |
| `locales/ko/inventory.json` | 수정 | transfer → transferForm 키 이름 변경 |
| `locales/vi/inventory.json` | 수정 | transfer → transferForm 키 이름 변경 |
| `locales/zh/inventory.json` | 수정 | transfer → transferForm 키 이름 변경 |
| `supabase/migrations/019_insert_initial_products.sql` | 추가 | 초기 제품 데이터 migration |

## 테스트 결과

### 수정 전
- ❌ Inventory 페이지: 앱 크래시
- ❌ Dashboard: MISSING_MESSAGE 오류 (navigation.menu, common)
- ❌ 모든 네비게이션 클릭 시 콘솔 오류 발생

### 수정 후
- ✅ Inventory 페이지: 정상 렌더링
- ✅ Dashboard: MISSING_MESSAGE 오류 해결
- ✅ 네비게이션: 모든 페이지 정상 작동
- ✅ 4개 언어 모두 정상 작동 (en, ko, vi, zh)
- ✅ 번역 로딩 중 Loading 스피너 표시

## Git 커밋 정보

**커밋 해시:** `420bed9`

**커밋 메시지:**
```
Fix: 네비게이션 크래시 및 i18n MISSING_MESSAGE 오류 해결

주요 수정사항:
1. inventory.json 중복 키 제거 (transfer → transferForm)
   - React Error #31 해결 (객체를 문자열로 렌더링하려는 오류)
   - 4개 언어 모두 수정 (en, ko, vi, zh)

2. IntlProvider 로딩 상태 관리 개선
   - common namespace 이중 제공 (spread + namespace 접근)
   - 번역 로딩 완료 전까지 children 렌더링 방지
   - MISSING_MESSAGE 오류 근본 해결

3. 초기 제품 데이터 migration 파일 추가
   - 019_insert_initial_products.sql

영향:
- Inventory 페이지 크래시 해결
- Dashboard MISSING_MESSAGE 오류 해결
- 모든 네비게이션 정상 작동
```

**변경 통계:**
- 6 files changed
- 205 insertions(+)
- 17 deletions(-)

## 배운 점 & 개선 사항

### JSON 구조 설계 시 주의사항
- JSON에서 중복된 키는 절대 사용 금지
- 마지막 값만 유지되어 예상치 못한 버그 발생
- ESLint 플러그인으로 중복 키 검사 필요

### i18n 로딩 패턴
- 비동기 데이터 로드 시 항상 로딩 상태 관리
- Race condition 방지를 위해 로딩 완료 전 렌더링 차단
- 초기 상태를 빈 객체로 하면 MISSING_MESSAGE 오류 발생 가능

### 다국어 지원 아키텍처
- Namespace 구조는 유연성과 명확성의 균형 필요
- Spread와 Namespace 접근 패턴 모두 지원 필요
- 타입스크립트로 번역 키 타입 안정성 확보 필요 (향후 개선)

## 다음 단계

### 제안 사항
1. **타입 안전성 강화**
   - next-intl의 타입 시스템 활용
   - 번역 키 자동완성 지원

2. **ESLint 플러그인 추가**
   - `eslint-plugin-json` 추가로 JSON 중복 키 검사

3. **로딩 UX 개선**
   - Skeleton UI로 로딩 스피너 대체
   - 점진적 렌더링 고려

4. **에러 바운더리 추가**
   - 번역 로드 실패 시 fallback UI 제공
   - 개발 환경에서 상세한 오류 정보 표시

## 관련 문서
- React Error #31: https://react.dev/errors/31
- next-intl 공식 문서: https://next-intl-docs.vercel.app/
- 이전 작업: `012.phase09.i18n_서버사이드_전환_롤백_및_RLS_무한재귀_해결.md`
