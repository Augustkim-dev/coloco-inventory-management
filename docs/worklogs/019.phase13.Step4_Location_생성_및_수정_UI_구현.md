# 019. Phase 13 Step 4 - Location 생성 및 수정 UI 구현

## 작업 개요
- **날짜**: 2025-11-18
- **Phase**: Phase 13 - 계층적 Sub-Branch 시스템
- **Step**: Step 4 - Location CRUD UI 구현
- **목표**: Location 생성 및 전체 필드 수정 가능한 UI 구현

## 작업 배경

기존에는 Location 데이터를 DB에 직접 입력하고 조회만 가능했으며, 편집 페이지에서도 주소/연락처 정보만 수정 가능했습니다. 사용자가 UI를 통해 새로운 Main Branch나 Sub-Branch를 추가하고, 모든 필드를 수정할 수 있는 완전한 CRUD 기능이 필요했습니다.

## 구현 내용

### 1. API 엔드포인트 구현

#### `app/api/locations/route.ts` (신규 생성)
```typescript
POST /api/locations - 새 Location 생성
```

**주요 기능**:
- HQ_Admin 권한 검증
- 필수 필드 검증 (name, location_type, country_code, currency)
- Location Type 검증 (HQ, Branch, SubBranch)
- SubBranch는 반드시 parent_location_id 필요
- 성공 시 201 응답과 함께 생성된 location 반환

**검증 로직**:
- SubBranch 타입은 parent_location_id 필수
- location_type은 'HQ', 'Branch', 'SubBranch' 중 하나만 허용

#### `app/api/locations/[id]/route.ts` (신규 생성)
```typescript
PATCH /api/locations/[id] - Location 수정
DELETE /api/locations/[id] - Location 삭제
```

**PATCH 기능**:
- 제공된 필드만 업데이트 (partial update)
- HQ_Admin 권한 검증
- Location Type 변경 가능
- Parent Location 재할당 가능

**DELETE 기능**:
- 자식 Location이 있으면 삭제 불가 (400 에러 반환)
- HQ_Admin만 삭제 가능
- 삭제 전 children 체크

### 2. Location 생성 UI

#### `components/locations/location-create-form.tsx` (신규 생성)

**주요 기능**:
- Location Type 선택 (HQ, Branch, SubBranch)
- SubBranch 선택 시 Parent Location 드롭다운 자동 표시
- Country 선택 시 Currency 자동 설정
- 실시간 유효성 검증

**필드 구성**:
1. **필수 필드**:
   - Location Type (Select)
   - Parent Location (SubBranch인 경우만 표시)
   - Location Name (Text Input)
   - Country (Select: KR, VN, CN)
   - Currency (Auto-filled, Read-only)

2. **선택 필드**:
   - Address (Textarea)
   - Contact Person (Text Input)
   - Phone (Text Input)

**UX 개선사항**:
- Country 선택 시 자동으로 해당 국가의 통화 설정
  - KR → KRW
  - VN → VND
  - CN → CNY
- SubBranch 선택 시 부모 선택 필드 동적 표시
- 부모 선택 드롭다운에서 현재 location 제외 (자기 자신을 부모로 선택 방지)
- Alert 메시지로 SubBranch 요구사항 안내

#### `app/(dashboard)/locations/new/page.tsx` (신규 생성)

**권한 관리**:
- 인증되지 않은 사용자 → /login 리다이렉트
- HQ_Admin이 아닌 사용자 → /dashboard 리다이렉트
- HQ_Admin만 Location 생성 가능

### 3. Location 수정 UI 개선

#### `components/locations/location-form.tsx` (대폭 개선)

**변경 전**:
- Name, Type, Country, Currency: 읽기 전용 (disabled)
- Address, Contact Person, Phone만 수정 가능

**변경 후 (전체 필드 수정 가능)**:
1. **Location Type 변경 가능**
   - Select 컴포넌트로 변경
   - HQ ↔ Branch ↔ SubBranch 전환 가능

2. **Parent Location 재할당**
   - SubBranch 타입일 때만 표시
   - 다른 HQ 또는 Branch로 부모 변경 가능
   - 현재 location은 선택 목록에서 제외

3. **Location Name 수정 가능**
   - 이름 변경 기능 추가

4. **Country & Currency 변경 가능**
   - Country Select 컴포넌트
   - Currency는 Country 선택에 따라 자동 업데이트

5. **Status 관리 추가**
   - Active/Inactive 토글
   - Select 컴포넌트로 구현

**API 통합**:
- Supabase 직접 호출에서 `/api/locations/[id]` PATCH 엔드포인트 사용으로 변경
- 에러 핸들링 개선
- 필수 필드 검증 추가

### 4. 메인 페이지 업데이트

#### `app/(dashboard)/locations/page.tsx`

**UI 개선**:
- "Add Location" 버튼 추가 (Plus 아이콘 포함)
- 우측 상단에 버튼 그룹으로 재배치:
  - **Add Location**: Primary 버튼 (파란색)
  - **Reorder Locations**: Secondary 버튼 (테두리)

**버튼 스타일**:
```tsx
Add Location: bg-primary (강조)
Reorder: border + bg-background (보조)
```

## 파일 변경 사항

### 신규 파일 (4개)
1. `app/api/locations/route.ts` - POST 엔드포인트
2. `app/api/locations/[id]/route.ts` - PATCH, DELETE 엔드포인트
3. `components/locations/location-create-form.tsx` - 생성 폼 컴포넌트
4. `app/(dashboard)/locations/new/page.tsx` - 생성 페이지

### 수정 파일 (2개)
1. `components/locations/location-form.tsx` - 전체 필드 수정 가능하도록 개선
2. `app/(dashboard)/locations/page.tsx` - Add Location 버튼 추가

## 기술적 세부사항

### 1. 데이터 검증
- 클라이언트 측: React Hook Form 없이 기본 HTML5 검증 + 커스텀 검증
- 서버 측: API 엔드포인트에서 필수 필드 및 비즈니스 로직 검증

### 2. 권한 관리
모든 엔드포인트에서 2단계 검증:
```typescript
1. 인증 확인 (supabase.auth.getUser())
2. 역할 확인 (role === 'HQ_Admin')
```

### 3. 계층 구조 자동 관리
- DB 트리거가 자동으로 처리:
  - `level` 계산
  - `path` 생성
  - `display_order` 할당

### 4. 부모-자식 관계 제약
- SubBranch는 반드시 parent_location_id 필요
- 삭제 시 자식이 있으면 불가 (참조 무결성)
- 수정 시 자기 자신을 부모로 선택 불가

## 사용자 워크플로우

### Location 생성 플로우
```
1. /locations 페이지 접속
2. "Add Location" 버튼 클릭
3. Location Type 선택
   - SubBranch 선택 시: Parent Location 드롭다운 표시
4. Location Name 입력
5. Country 선택 → Currency 자동 설정
6. 선택사항: 주소, 담당자, 전화번호 입력
7. "Create Location" 클릭
8. 성공 시 /locations로 리다이렉트 및 목록에 표시
```

### Location 수정 플로우
```
1. Tree View 또는 List View에서 Edit 버튼 클릭
2. 모든 필드 수정 가능:
   - Location Type 변경
   - Parent Location 변경 (SubBranch인 경우)
   - Name, Country, Currency 변경
   - 연락처 정보 업데이트
   - Active/Inactive 상태 변경
3. "Save Changes" 클릭
4. 성공 시 /locations로 리다이렉트
```

## 예시 사용 시나리오

### 시나리오 1: Vietnam Branch에 Hanoi Sub-Branch 추가
```
1. "Add Location" 클릭
2. Location Type: SubBranch 선택
3. Parent Location: Vietnam Branch 선택
4. Name: "Hanoi Sub-Branch" 입력
5. Country: Vietnam (VN) 선택 → VND 자동 설정
6. Address: "123 Tran Hung Dao, Hoan Kiem, Hanoi" 입력 (선택)
7. Contact Person: "Nguyen Van A" 입력 (선택)
8. Phone: "+84-24-1234-5678" 입력 (선택)
9. "Create Location" 클릭
→ DB에 자동으로 level=3, path 생성됨
```

### 시나리오 2: 기존 Branch를 SubBranch로 변경
```
1. 기존 "Seoul Branch" 편집 페이지 접속
2. Location Type: Branch → SubBranch 변경
3. Parent Location: Korea HQ 선택 (새로 표시됨)
4. "Save Changes" 클릭
→ 트리거가 자동으로 level, path 재계산
```

## 데이터베이스 영향

### 트리거 자동 처리
생성/수정 시 다음 필드들이 자동 계산됨:
- `level`: 계층 깊이 (HQ=1, Branch=2, SubBranch=3)
- `path`: 경로 문자열 (예: "001.002.001")
- `display_order`: 같은 부모 내 정렬 순서
- `updated_at`: 현재 시각

### 제약 조건
- `parent_location_id`: FK constraint (locations.id 참조)
- SubBranch 삭제 시 자식 체크 (API에서 검증)

## 에러 처리

### API 에러 응답
```typescript
400 Bad Request:
  - 필수 필드 누락
  - 잘못된 location_type
  - SubBranch인데 parent_location_id 없음
  - 삭제 시 자식 존재

401 Unauthorized:
  - 인증되지 않은 사용자

403 Forbidden:
  - HQ_Admin이 아닌 사용자

404 Not Found:
  - 존재하지 않는 location ID

500 Internal Server Error:
  - DB 에러
  - 서버 에러
```

### 클라이언트 에러 처리
- Toast 알림으로 에러 메시지 표시
- 로딩 상태 관리 (버튼 disabled)
- 폼 검증 실패 시 에러 메시지

## 테스트 체크리스트

### 생성 기능
- [x] HQ 생성 가능
- [x] Branch 생성 가능
- [x] SubBranch 생성 가능 (부모 선택)
- [x] SubBranch 부모 없이 생성 시도 → 에러
- [x] 필수 필드 누락 시 → 에러
- [x] Country 변경 시 Currency 자동 업데이트
- [x] HQ_Admin이 아닌 사용자 → 권한 에러

### 수정 기능
- [x] Name 수정 가능
- [x] Location Type 변경 가능
- [x] Parent Location 변경 가능
- [x] Country & Currency 변경 가능
- [x] 연락처 정보 수정 가능
- [x] Active/Inactive 토글 가능
- [x] SubBranch에서 부모 제거 시도 → 에러

### 삭제 기능
- [x] 자식 없는 Location 삭제 가능
- [x] 자식 있는 Location 삭제 시도 → 에러

### UI/UX
- [x] Add Location 버튼 표시
- [x] SubBranch 선택 시 부모 선택 필드 표시
- [x] 성공 시 Toast 알림
- [x] 에러 시 Toast 알림
- [x] 로딩 중 버튼 disabled

## 향후 개선 사항

1. **Bulk Import**: Excel/CSV 파일로 여러 Location 일괄 등록
2. **Location 복제**: 기존 Location 설정을 복사하여 새 Location 생성
3. **변경 이력**: Location 정보 변경 이력 추적 (audit log)
4. **지도 통합**: 주소 입력 시 Google Maps 연동
5. **사진 업로드**: Location 사진/로고 업로드 기능
6. **재고 이전 제한**: Location 비활성화 시 재고 이전 차단

## 관련 파일

### API
- `app/api/locations/route.ts`
- `app/api/locations/[id]/route.ts`

### 컴포넌트
- `components/locations/location-create-form.tsx`
- `components/locations/location-form.tsx`
- `components/locations/locations-view-client.tsx`
- `components/locations/locations-tree-view.tsx`

### 페이지
- `app/(dashboard)/locations/page.tsx`
- `app/(dashboard)/locations/new/page.tsx`
- `app/(dashboard)/locations/[id]/edit/page.tsx`

## 커밋 메시지
```
Feat: Location 생성 및 전체 필드 수정 UI 구현

- POST /api/locations 엔드포인트 추가 (Location 생성)
- PATCH /api/locations/[id] 엔드포인트 추가 (Location 수정)
- DELETE /api/locations/[id] 엔드포인트 추가 (Location 삭제)
- Location 생성 폼 컴포넌트 및 페이지 구현
- Location 수정 폼 개선 (전체 필드 수정 가능)
- 메인 페이지에 Add Location 버튼 추가
- SubBranch 부모 선택 UI 구현
- Country 선택 시 Currency 자동 설정
- 권한 검증 및 에러 처리 추가

🤖 Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude <noreply@anthropic.com>
```

## 결론

Location CRUD 기능이 완전하게 구현되어 사용자가 UI를 통해 HQ, Branch, SubBranch를 자유롭게 생성 및 수정할 수 있게 되었습니다. DB 트리거와 연동하여 계층 구조가 자동으로 관리되며, 권한 검증과 데이터 검증이 API 레벨에서 안전하게 처리됩니다.
