# Phase 18: Dashboard 기간별 필터링 및 Location Sales 테이블

## 작업 일자
2025-12-04

## 작업 목표
- Admin: 전체 Branch/Sub-branch의 판매 현황 및 일/주/월 단위 Profit 확인
- Branch Manager: 자신의 Branch + Sub-branch 판매 현황 확인 (Branch Profit만 표시)
- 핵심 정보: 어느 Branch/Sub-branch에서 어떤 제품을 몇 개 팔아서 얼마의 이익이 났는지

## 주요 변경사항

### 1. 신규 파일 생성

#### 1.1 `lib/date-utils.ts`
- 기간 범위 계산 유틸리티
- 지원 기간: daily, weekly, monthly, last7days, last30days, custom
- `parsePeriodFromParams()`: URL 파라미터에서 기간 파싱
- `calculatePeriodRanges()`: 현재/이전 기간 날짜 범위 계산
- `calculatePercentageChange()`: 퍼센트 변화율 계산
- `validateDateRange()`: 커스텀 날짜 범위 유효성 검사 (최대 90일)

#### 1.2 `components/dashboard/dashboard-period-selector.tsx`
- URL 기반 기간 선택 컴포넌트
- Preset 버튼: Today, This Week, This Month, Last 7 Days, Last 30 Days
- Custom 날짜 선택: shadcn/ui Calendar + Popover 사용
- URL 파라미터로 상태 관리 (`?period=weekly` 또는 `?from=2025-12-01&to=2025-12-04`)

#### 1.3 `components/dashboard/dashboard-comparison-cards.tsx`
- 기간 비교 통계 카드
- Admin: Total Sales, HQ Profit, Branch Profit, Transactions, Units Sold (5개)
- Branch Manager: Total Sales, Branch Profit, Transactions (3개, HQ Profit 숨김)
- 전기 대비 % 변화 표시 (증가: 녹색, 감소: 빨간색)

#### 1.4 `components/dashboard/location-sales-table.tsx`
- 계층적 Location Sales 테이블
- Branch → SubBranch 드릴다운 구조
- 클릭 시 해당 Location의 제품별 판매 상세 표시
- Admin: HQ Profit 컬럼 표시
- Branch Manager: HQ Profit 컬럼 숨김
- Expand All / Collapse All 버튼

### 2. 기존 파일 수정

#### 2.1 `app/(dashboard)/dashboard/page.tsx`
- URL searchParams로 기간 필터링 (`period`, `from`, `to`)
- `getDescendants()` 사용하여 Branch_Manager의 SubBranch 포함 필터링
- pricing_configs 별도 조회 후 수동 매핑 (FK 관계 없음)
- 현재 기간 + 이전 기간 데이터 병렬 조회

```typescript
interface DashboardPageProps {
  searchParams: Promise<{
    period?: string
    from?: string
    to?: string
  }>
}
```

#### 2.2 `lib/dashboard-data.ts`
신규 함수 추가:
- `enrichSalesForDashboard()`: 원시 데이터를 DashboardSale 형태로 변환
- `calculatePeriodComparison()`: 기간 비교 통계 계산
- `aggregateSalesByLocation()`: Location별 판매 집계
- `getProductsInLocation()`: Location 내 제품별 상세
- `buildLocationSalesTree()`: 계층 구조 트리 빌드

#### 2.3 `types/index.ts`
신규 타입 추가:
- `PeriodComparisonStats`: 기간 비교 통계
- `LocationSalesDetail`: Location 판매 상세 (계층 포함)
- `ProductSalesInLocation`: Location 내 제품 판매
- `DashboardSale`: 대시보드용 판매 데이터 (profit 포함)

### 3. 삭제된 파일
- `components/dashboard/dashboard-charts-client.tsx`
- `components/dashboard/dashboard-filters.tsx`
- `components/dashboard/charts/branch-sales-chart.tsx`
- `components/dashboard/charts/profit-breakdown-chart.tsx`

### 4. 추가된 shadcn/ui 컴포넌트
- `components/ui/calendar.tsx`
- `components/ui/popover.tsx`
- `components/ui/collapsible.tsx`

## 버그 수정

### 1. pricing_configs 조인 문제
**문제**: `pricing_configs!inner` 조인이 작동하지 않음 (FK 관계 없음)
**해결**: pricing_configs를 별도 쿼리로 가져와서 `product_id + location_id`로 수동 매핑

```typescript
// pricing_configs 별도 조회
const { data: pricingConfigs } = await supabase
  .from('pricing_configs')
  .select('product_id, to_location_id, purchase_price, transfer_cost, hq_margin_percent, branch_margin_percent')

// Map으로 lookup 테이블 생성
const pricingConfigMap = new Map<string, Config>()
pricingConfigs?.forEach(config => {
  const key = `${config.product_id}:${config.to_location_id}`
  pricingConfigMap.set(key, { ... })
})
```

### 2. Profit 계산 0원 문제
**문제**: HQ Profit, Branch Profit이 모두 0 KRW로 표시됨

**원인 1**: DB 컬럼명 불일치
| DB 컬럼명 | 코드에서 사용 |
|-----------|--------------|
| `hq_margin_percent` | `hq_margin_pct` |
| `branch_margin_percent` | `branch_margin_pct` |

**원인 2**: `local_cost` 컬럼 없음
- DB에는 `purchase_price`, `transfer_cost` 존재
- 해결: `local_cost = purchase_price + transfer_cost`

**원인 3**: margin percent 형식 불일치
- DB: `10.00` (퍼센트 숫자)
- 코드: `0.10` (소수점)
- 해결: `/100`으로 변환

```typescript
// 수정된 코드
const hqMarginPct = (sale.pricing_config?.hq_margin_pct || 0) / 100
const branchMarginPct = (sale.pricing_config?.branch_margin_pct || 0) / 100
```

## Profit 분배 로직

```typescript
// 총 마진 = 판매가 - 원가
const totalMargin = totalAmount - totalCost

// 총 마진율 = HQ마진% + Branch마진%
const totalMarginPct = hqMarginPct + branchMarginPct

// 본사 이익 = 총 마진 * (본사 마진율 / 총 마진율)
const hqProfit = totalMargin * (hqMarginPct / totalMarginPct)

// 지부 이익 = 총 마진 * (지부 마진율 / 총 마진율)
const branchProfit = totalMargin * (branchMarginPct / totalMarginPct)
```

**예시**: HQ 10%, Branch 20%인 경우
- 총 마진율: 30%
- HQ 비율: 10/30 = 1/3 (33.3%)
- Branch 비율: 20/30 = 2/3 (66.7%)

## UI 레이아웃

### Admin 화면
```
┌─────────────────────────────────────────────────────────────────────┐
│  Dashboard                                                          │
│  [Today] [This Week] [This Month] [Last 7D] [Last 30D] [Custom]     │
│  Showing: Dec 1, 2025 - Dec 4, 2025                                 │
├─────────────────────────────────────────────────────────────────────┤
│  ┌────────────┐ ┌────────────┐ ┌────────────┐ ┌────────────┐        │
│  │Total Sales │ │ HQ Profit  │ │Branch Prof.│ │Transactions│        │
│  │₩7,433,364  │ │ ₩743,336   │ │ ₩1,486,672 │ │    9       │        │
│  │ +100% ↑    │ │ +100% ↑    │ │ +100% ↑    │ │ +100% ↑    │        │
│  └────────────┘ └────────────┘ └────────────┘ └────────────┘        │
├─────────────────────────────────────────────────────────────────────┤
│  Sales by Location                                    [Expand All]  │
│ ──────────────────────────────────────────────────────────────────  │
│  Location    │ Qty  │ Revenue (KRW) │ HQ Profit │ Branch  │ Margin  │
│ ──────────────────────────────────────────────────────────────────  │
│  ▼ Vietnam   │ 475  │ ₩5,052,289    │ ₩505,228  │₩1,010K  │ 30.0%   │
│     └─ ...   │      │               │           │         │         │
│  ▶ Vung Tau  │ 188  │ ₩2,381,076    │ ₩238,107  │ ₩476K   │ 30.0%   │
└─────────────────────────────────────────────────────────────────────┘
```

### Branch Manager 화면
- HQ Profit 컬럼 숨김
- 담당 Branch + SubBranch만 표시

## 커밋 내역

1. `1c12137` - Feat: Dashboard 개선 - 기간별 필터링 및 Location Sales 테이블
2. `198ae8d` - Fix: Dashboard pricing_config 조인 문제 수정
3. `8c81d2d` - Fix: Dashboard profit 계산 0원 문제 수정

## 관련 파일

### 신규 파일
- `lib/date-utils.ts`
- `components/dashboard/dashboard-period-selector.tsx`
- `components/dashboard/dashboard-comparison-cards.tsx`
- `components/dashboard/location-sales-table.tsx`
- `components/ui/calendar.tsx`
- `components/ui/popover.tsx`
- `components/ui/collapsible.tsx`

### 수정 파일
- `app/(dashboard)/dashboard/page.tsx`
- `lib/dashboard-data.ts`
- `types/index.ts`
- `package.json`

### 삭제 파일
- `components/dashboard/dashboard-charts-client.tsx`
- `components/dashboard/dashboard-filters.tsx`
- `components/dashboard/charts/branch-sales-chart.tsx`
- `components/dashboard/charts/profit-breakdown-chart.tsx`

## 테스트 결과
- Admin 로그인 시 전체 Location 판매 현황 표시 확인
- 기간 선택 시 데이터 정상 필터링 확인
- HQ Profit, Branch Profit 정상 계산 확인
- Location 클릭 시 제품별 상세 표시 확인
