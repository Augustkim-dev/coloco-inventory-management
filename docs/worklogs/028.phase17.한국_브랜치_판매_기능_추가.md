# Phase 17: 한국 브랜치 판매 기능 추가 - Worklog

## 작업 일자
2025-12-04

## 작업 개요
한국 HQ에서도 직접 판매할 수 있도록 Korea Branch와 5개 Sub-branch를 추가하고, 동일 통화 환율 처리 UI를 수정했습니다.

## 완료된 작업

### 1. 데이터베이스 마이그레이션 생성

**파일**: `supabase/migrations/032_add_korea_branch_hierarchy.sql`

추가된 데이터:
- KRW → KRW 환율 (rate = 1, 국내 판매용)
- Korea Branch (Level 2, HQ 하위)
- 5개 Sub-branch:
  - Naver (온라인 채널)
  - Coupang (온라인 채널)
  - Instagram (SNS 채널)
  - Seoul (오프라인 지역)
  - Busan (오프라인 지역)

Location ID 할당:
| ID | Name | Type |
|----|------|------|
| ...0010 | Korea | Branch |
| ...0011 | Naver | SubBranch |
| ...0012 | Coupang | SubBranch |
| ...0013 | Instagram | SubBranch |
| ...0014 | Seoul | SubBranch |
| ...0015 | Busan | SubBranch |

### 2. 동일 통화 환율 자동 처리

**파일**: `components/exchange-rates/exchange-rate-selector.tsx`

변경 내용:
- `useEffect` 내 `fetchLatestRate` 함수 시작 부분에 동일 통화 체크 로직 추가
- `fromCurrency === toCurrency`일 때 API 호출 없이 환율 1 자동 설정
- Korea Branch (KRW → KRW) 가격 설정 시 사용자 경험 개선

```tsx
// Handle same currency (e.g., KRW -> KRW for Korea Branch)
if (fromCurrency === toCurrency) {
  setLatestRate(1)
  if (!value || value === 0) {
    onChange(1)
  }
  setLoading(false)
  return
}
```

## 최종 Location 계층 구조

```
Korea HQ (Level 1, HQ)
├── Korea (Level 2, Branch)
│   ├── Naver (Level 3, SubBranch)
│   ├── Coupang (Level 3, SubBranch)
│   ├── Instagram (Level 3, SubBranch)
│   ├── Seoul (Level 3, SubBranch)
│   └── Busan (Level 3, SubBranch)
├── Vietnam (Level 2, Branch)
│   ├── Ho Chi Minh (SubBranch)
│   ├── Vung Tau (SubBranch)
│   └── Hanoi (SubBranch)
└── China (Level 2, Branch)
    ├── Wei Hai (SubBranch)
    └── Guangzhou (SubBranch)
```

## 운영 후속 작업 (수동)

마이그레이션 실행 후 다음 작업 필요:

1. **Korea Branch Manager 계정 생성**
   - Supabase Auth에서 새 사용자 생성
   - `users` 테이블에서 설정:
     - `location_id` = `00000000-0000-0000-0000-000000000010` (Korea Branch)
     - `role` = `Branch_Manager`

2. **제품별 Korea Branch 가격 설정**
   - Pricing 페이지에서 각 제품에 대해 Korea Branch용 가격 설정
   - `exchange_rate`: 1
   - `transfer_cost`: 0
   - `branch_margin`: 원하는 마진율

3. **HQ → Korea Branch 재고 이전**
   - Inventory 페이지에서 필요한 제품 재고를 Korea Branch로 이전

## 수정된 파일 목록

| 파일 | 변경 유형 |
|------|----------|
| `supabase/migrations/032_add_korea_branch_hierarchy.sql` | 신규 생성 |
| `supabase/migrations/033_fix_shanghai_location_data.sql` | 신규 생성 |
| `components/exchange-rates/exchange-rate-selector.tsx` | 수정 |
| `components/pricing/template-form.tsx` | 수정 |
| `components/inventory/location-accordion.tsx` | 수정 |
| `components/inventory/inventory-kanban.tsx` | 수정 |
| `components/pricing/pricing-list.tsx` | 수정 |
| `app/(dashboard)/pricing/page.tsx` | 수정 |
| `lib/hierarchy-utils.ts` | 수정 |
| `docs/plans/026.phase17.한국_브랜치_판매_기능_추가.md` | 신규 생성 |
| `docs/worklogs/028.phase17.한국_브랜치_판매_기능_추가.md` | 신규 생성 |

## 기술적 특이사항

1. **Pricing Template KRW 통화 지원 추가**
   - 기존에는 Template 생성 시 KRW가 필터링되어 선택 불가
   - Korea Branch 추가로 KRW 템플릿 필요
   - `components/pricing/template-form.tsx`에서 `.filter(c => c.value !== 'KRW')` 제거

2. **기존 시스템 호환성**
   - 모든 기존 기능(Transfer, Sales, Pricing)이 Korea Branch와 호환
   - 별도의 API 수정 없이 동작

3. **가격 상속**
   - Sub-branch(Naver, Coupang 등)는 Korea Branch의 가격을 자동 상속
   - 별도 가격 설정 시 개별 가격 사용 가능

4. **동일 통화 처리**
   - KRW → KRW 환율이 자동으로 1로 설정
   - API 호출 없이 클라이언트에서 처리하여 성능 향상

5. **Branch/SubBranch 계층 구조 UI 개선**
   - Inventory Kanban View와 Pricing Configuration에서 SubBranch 들여쓰기 적용
   - SubBranch에 └ 아이콘과 왼쪽 border 스타일 추가
   - 수정 파일:
     - `components/inventory/location-accordion.tsx`: SubBranch 들여쓰기
     - `components/pricing/pricing-list.tsx`: 계층 그룹화 UI
     - `app/(dashboard)/pricing/page.tsx`: 쿼리에 level, location_type, path 필드 추가

6. **Location 정렬 기준 수정 (display_order 반영)**
   - 문제: Locations 페이지에서 Reorder 기능으로 설정한 `display_order`가 Inventory/Pricing 페이지에서 반영되지 않음
   - 원인: 기존에는 `path` 알파벳순 정렬 사용 → 사용자 지정 순서 무시
   - 해결: `sortByHierarchyAndOrder()` 함수 추가하여 계층 구조 유지 + display_order 반영
   - 수정 파일:
     - `lib/hierarchy-utils.ts`: `sortByHierarchyAndOrder()` 함수 추가
     - `components/inventory/inventory-kanban.tsx`: 정렬 로직 변경
     - `components/pricing/pricing-list.tsx`: display_order 기준 정렬
     - `app/(dashboard)/pricing/page.tsx`: 쿼리에 parent_id 필드 추가

7. **ShangHai 데이터 수정**
   - 문제: ShangHai location의 `level=1`, `path=null`로 잘못 설정됨
   - 결과: path 정렬 시 ShangHai가 목록 최상단에 표시
   - 해결: 마이그레이션 파일 `033_fix_shanghai_location_data.sql` 생성
   - 수정 내용: `level=3`, `path='/HQ/China/ShangHai'`로 업데이트
