# 004-2. Phase 04 - Location 순서 변경 기능 구현

## 작업 일시
2025-01-XX

## 작업 목표
사용자가 Inventory Kanban View 및 기타 리스트에서 표시되는 Location의 순서를 커스터마이징할 수 있도록 드래그 앤 드롭 기반 순서 변경 기능 구현

## 작업 내용

### 1. 데이터베이스 스키마 변경

**파일**: `supabase/migrations/013_add_locations_display_order.sql`

- `locations` 테이블에 `display_order INTEGER NOT NULL` 컬럼 추가
- 초기 순서 설정:
  - Korea HQ: 1
  - Vietnam Branch: 2
  - China Branch: 3
- 성능을 위한 인덱스 추가: `idx_locations_display_order`
- 향후 추가되는 Branch는 자동으로 다음 번호 할당

### 2. TypeScript 타입 정의 업데이트

**파일**: `types/database.ts`

- `locations` 테이블 타입에 `display_order: number` 필드 추가
- Insert 타입에서는 optional로 설정 (`display_order?: number`)

### 3. 컴포넌트 구현

#### 3.1 SortableLocationItem 컴포넌트

**파일**: `components/locations/sortable-location-item.tsx`

**기능**:
- @dnd-kit의 `useSortable` 훅 사용
- 드래그 가능한 Location 카드 UI
- Grip 핸들 아이콘 표시
- 드래그 중 시각적 피드백 (opacity 변경)
- Location 정보 표시: 순서 번호, 이름, 타입, 국가 코드

**주요 구현**:
```typescript
const { attributes, listeners, setNodeRef, transform, transition, isDragging } = useSortable({ id: location.id })
```

#### 3.2 LocationsReorderClient 컴포넌트

**파일**: `components/locations/locations-reorder-client.tsx`

**기능**:
- DndContext를 사용한 드래그 앤 드롭 관리
- SortableContext로 vertical list sorting strategy 적용
- `handleDragEnd`: 드래그 종료 시 새로운 순서로 `display_order` 재계산
- `handleSave`: Supabase를 통해 모든 location의 `display_order` 업데이트
- Save/Cancel 버튼 제공

**주요 로직**:
```typescript
const handleDragEnd = (event: DragEndEvent) => {
  const newItems = arrayMove(items, oldIndex, newIndex)
  return newItems.map((item, index) => ({
    ...item,
    display_order: index + 1,
  }))
}
```

### 4. 페이지 구현

#### 4.1 Reorder 전용 페이지

**파일**: `app/(dashboard)/locations/reorder/page.tsx`

**기능**:
- Server Component로 구현
- HQ Admin 권한 체크 (다른 역할은 `/locations`로 리다이렉트)
- `display_order`로 정렬된 locations 데이터 fetch
- `LocationsReorderClient`에 데이터 전달

**권한 제어**:
```typescript
if (!profile || profile.role !== 'HQ_Admin') {
  redirect('/locations')
}
```

#### 4.2 Locations 리스트 페이지 수정

**파일**: `app/(dashboard)/locations/page.tsx`

**변경 사항**:
- 정렬 기준 변경: `location_type` → `display_order`
- "Reorder Locations" 버튼 추가 (HQ Admin만 표시)
- 버튼 클릭 시 `/locations/reorder` 페이지로 이동

**UI 개선**:
```typescript
<a href="/locations/reorder" className="inline-flex h-10 items-center justify-center rounded-md bg-primary...">
  Reorder Locations
</a>
```

#### 4.3 Inventory 페이지 수정

**파일**: `app/(dashboard)/inventory/page.tsx`

**변경 사항**:
- Kanban View에서 사용하는 locations 쿼리 정렬 기준 변경
- 기존: `order('location_type', { ascending: false })`
- 변경: `order('display_order', { ascending: true })`

### 5. 사용자 플로우

1. HQ Admin이 `/locations` 페이지 접속
2. "Reorder Locations" 버튼 클릭
3. `/locations/reorder` 페이지에서 드래그 앤 드롭으로 순서 변경
4. "Save Order" 버튼 클릭하여 저장
5. `/locations` 페이지로 리다이렉트
6. 변경된 순서가 모든 location 리스트에 반영 (Inventory Kanban View 포함)

## 기술 스택

- **Drag & Drop**: @dnd-kit/core, @dnd-kit/sortable (기존 Kanban View와 일관성)
- **UI Components**: shadcn/ui (Card, Badge, Button)
- **State Management**: React useState
- **Database**: Supabase PostgreSQL
- **Framework**: Next.js 14 App Router

## 구현 특징

### 1. 일관된 사용자 경험
- Inventory Kanban View와 동일한 @dnd-kit 라이브러리 사용
- 동일한 드래그 앤 드롭 인터랙션 패턴

### 2. 권한 기반 접근 제어
- HQ Admin만 순서 변경 가능
- Branch Manager는 Reorder 버튼 자체가 표시되지 않음
- 직접 URL 접근 시도 시 리다이렉트

### 3. 데이터 무결성
- `display_order`는 NOT NULL 제약 조건
- 초기값 자동 설정으로 기존 데이터 마이그레이션 안전
- 인덱스를 통한 정렬 성능 최적화

### 4. 확장성 고려
- 향후 새로운 Branch 추가 시 자동으로 다음 번호 할당
- 순서 번호는 1부터 시작하는 연속된 정수

## 테스트 시나리오

1. **순서 변경 테스트**
   - Korea HQ, Vietnam, China 순서를 Vietnam, Korea HQ, China로 변경
   - Save 후 `/locations`와 Inventory Kanban View 모두에서 변경된 순서 확인

2. **권한 테스트**
   - Branch Manager 계정으로 로그인
   - Reorder 버튼이 보이지 않는지 확인
   - 직접 `/locations/reorder` URL 접근 시 리다이렉트 확인

3. **드래그 앤 드롭 UX 테스트**
   - 드래그 중 시각적 피드백 확인
   - 순서 번호가 실시간으로 업데이트되는지 확인
   - Cancel 버튼 동작 확인

## 알려진 제약사항

1. **데이터베이스 마이그레이션 필요**
   - Remote Supabase 인스턴스 사용 중
   - Supabase Dashboard의 SQL Editor에서 수동 실행 필요
   - Migration 파일: `supabase/migrations/013_add_locations_display_order.sql`

2. **초기 순서 고정**
   - 마이그레이션 시 Korea HQ(1), Vietnam(2), China(3)로 고정
   - 사용자가 UI에서 변경 가능

## 향후 개선 사항

1. **Optimistic UI Update**
   - 저장 전 UI에서 먼저 순서 반영
   - 저장 실패 시 롤백

2. **드래그 제약 조건**
   - 예: HQ는 항상 첫 번째로 고정

3. **순서 변경 히스토리**
   - audit_logs 테이블에 순서 변경 이력 기록

## 관련 파일

### 생성된 파일
- `supabase/migrations/013_add_locations_display_order.sql`
- `components/locations/sortable-location-item.tsx`
- `components/locations/locations-reorder-client.tsx`
- `app/(dashboard)/locations/reorder/page.tsx`

### 수정된 파일
- `types/database.ts`
- `app/(dashboard)/locations/page.tsx`
- `app/(dashboard)/inventory/page.tsx`

## 빌드 상태

✅ TypeScript 컴파일 성공
✅ Next.js 개발 서버 정상 실행 (http://localhost:3000)
✅ 빌드 에러 없음

## 다음 단계

1. Supabase Dashboard에서 마이그레이션 SQL 실행
2. 브라우저에서 `/locations/reorder` 페이지 접속하여 기능 테스트
3. Inventory Kanban View에서 변경된 순서 확인
