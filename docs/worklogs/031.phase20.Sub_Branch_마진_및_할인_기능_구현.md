# Phase 20: Sub Branch 마진 및 할인 기능 구현 완료

## 작업 일시
2025-12-05

## 작업 개요
Pricing Configuration 시스템에 Sub Branch 마진과 할인율 기능을 추가하여 더 세분화된 가격 관리가 가능하도록 개선함.

## 구현 내용

### 1. 데이터베이스 마이그레이션
**파일**: `supabase/migrations/035_add_subbranch_margin_and_discount.sql`

- `pricing_configs` 테이블에 추가:
  - `sub_branch_margin_percent` (DECIMAL 5,2) - Sub Branch 마진
  - `discount_percent` (DECIMAL 5,2) - 할인율
  - `discounted_price` (DECIMAL 12,2) - 할인 적용 후 가격
  - 총 마진 제약 조건 (HQ + Branch + SubBranch < 100%)

- `pricing_templates` 테이블에 추가:
  - `sub_branch_margin_percent` (DECIMAL 5,2)
  - `discount_percent` (DECIMAL 5,2)

- `calculate_template_price_v2` 함수 추가

### 2. TypeScript 타입 수정
**파일**: `types/index.ts`

- `PricingTemplate`: sub_branch_margin_percent, discount_percent 추가
- `PricingTemplateInsert`: sub_branch_margin_percent, discount_percent 추가
- `PricingTemplateUpdate`: sub_branch_margin_percent, discount_percent 추가
- `TemplateApplyPreviewItem`: discount_percent, discounted_price, location_type 추가

### 3. 프론트엔드 컴포넌트 수정

#### pricing-form.tsx
- 2단계 Branch 선택 UI 구현 (Main Branch → Sub Branch)
- Sub Branch 마진 입력 필드 추가 (Sub Branch 선택 시에만 표시)
- Discount 섹션 추가
- 가격 계산 결과에 Consumer Price, Discounted Price 표시
- 새 가격 계산 공식 적용

#### template-form.tsx
- Sub Branch Margin 입력 필드 추가
- Discount 입력 필드 추가
- 총 마진 검증 로직 수정
- Formula Preview에 새 공식 반영

#### pricing-list.tsx
- Margins 컬럼에 SubBranch 마진 표시 (해당 시)
- Discount 컬럼 추가
- Consumer Price, Discounted Price 컬럼 분리
- 할인 적용 시 녹색 강조 표시

#### template-card.tsx
- SubBranch 마진 표시 추가
- Discount 배지 추가

#### apply-template-dialog.tsx
- Preview 테이블에 Consumer Price, Discounted Price 컬럼 추가
- Location Type 표시 추가

### 4. API 수정

#### /api/pricing/templates/route.ts
- POST: sub_branch_margin_percent, discount_percent 저장

#### /api/pricing/templates/[id]/route.ts
- PUT: sub_branch_margin_percent, discount_percent 검증 및 업데이트

#### /api/pricing/templates/apply/route.ts
- calculatePrice 함수 수정: Sub Branch 마진, 할인 지원
- Main Branch vs Sub Branch 구분하여 마진 적용
- discounted_price 계산 및 저장

## 새로운 가격 계산 공식

```
소비자가격 = (구매가 + 이송비) × 환율 ÷ (1 - (HQ마진 + Branch마진 + SubBranch마진) / 100)
할인판매가격 = 소비자가격 × (1 - 할인율 / 100)
```

**예시**:
- 구매가: 5,000 KRW, 이송비: 500 KRW, 환율: 18.5 VND/KRW
- HQ 마진: 10%, Branch 마진: 20%, SubBranch 마진: 10%, 할인율: 5%
- 소비자가격: (5,500) × 18.5 ÷ 0.60 = 169,583 → 170,000 VND
- 할인판매가격: 170,000 × 0.95 = 161,500 VND

## 주요 UI/UX 변경사항

1. **Add Pricing Config 페이지**:
   - 2단계 Branch 선택 (Main Branch 선택 → Sub Branch 선택)
   - Sub Branch 미선택 시 Main Branch에 직접 적용
   - Sub Branch 선택 시에만 Sub Branch Margin 필드 표시

2. **Pricing List 페이지**:
   - Branch/SubBranch 그룹별로 표시
   - Margins 컬럼: HQ, Branch, (SubBranch) 마진 배지
   - Discount 컬럼: 할인율 배지
   - Consumer Price: 소비자가격
   - Discounted Price: 할인판매가격 (할인 시 녹색 강조)

3. **Template 생성/편집**:
   - Sub Branch Margin 입력 가능
   - Discount 입력 가능
   - 템플릿 적용 시 Main Branch에는 SubBranch 마진 미적용

## 호환성 고려사항

- 기존 데이터: sub_branch_margin_percent=0, discount_percent=0으로 초기화
- discounted_price는 final_price와 동일하게 설정 (할인 없음 상태)
- API에서 ?? 연산자로 기존 데이터 호환성 유지

## 테스트 필요 사항

1. 새 pricing config 생성 (Main Branch 대상)
2. 새 pricing config 생성 (Sub Branch 대상)
3. 템플릿 생성 및 Main Branch에 적용
4. 템플릿 생성 및 Sub Branch에 적용
5. 기존 pricing config 편집 시 새 필드 표시 확인
6. Pricing List에서 마진/할인/가격 표시 확인

## 수정된 파일 목록

1. `supabase/migrations/035_add_subbranch_margin_and_discount.sql` (신규)
2. `types/index.ts`
3. `components/pricing/pricing-form.tsx`
4. `components/pricing/pricing-list.tsx`
5. `components/pricing/template-form.tsx`
6. `components/pricing/template-card.tsx`
7. `components/pricing/apply-template-dialog.tsx`
8. `app/api/pricing/templates/route.ts`
9. `app/api/pricing/templates/[id]/route.ts`
10. `app/api/pricing/templates/apply/route.ts`
11. `docs/plans/028.phase20.Sub_Branch_마진_및_할인_기능_추가.md` (신규)
