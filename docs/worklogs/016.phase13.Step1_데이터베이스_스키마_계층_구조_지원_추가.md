# Worklog 016: Phase 13 Step 1 - 데이터베이스 스키마 계층 구조 지원 추가

**작업 날짜:** 2025-11-18
**계획 문서:** [012.phase13.계층적_Sub_Branch_시스템_구현.md](../plans/012.phase13.계층적_Sub_Branch_시스템_구현.md)
**Phase:** Phase 13 - Step 1
**담당:** Claude Code

---

## 작업 개요

기존 2단계 구조(HQ → Branch)를 무제한 계층 구조로 확장하기 위해 데이터베이스 스키마를 변경하는 작업을 수행했습니다. 이번 Step 1에서는 모든 데이터베이스 레벨의 변경사항을 마이그레이션 파일로 작성하여 Supabase에서 실행할 수 있도록 준비했습니다.

---

## 작업 내용

### 1. Migration 023: Location Hierarchy 추가

**파일:** `supabase/migrations/023_add_location_hierarchy.sql`

#### 주요 변경사항:

**1.1 Locations 테이블 확장**
```sql
ALTER TABLE public.locations
  ADD COLUMN parent_id UUID REFERENCES public.locations(id) ON DELETE CASCADE,
  ADD COLUMN level INTEGER NOT NULL DEFAULT 1,
  ADD COLUMN path TEXT,
  ADD COLUMN is_active BOOLEAN DEFAULT true;
```

- **parent_id**: 상위 Location 참조 (HQ는 NULL)
- **level**: 계층 깊이 (1=HQ, 2=Branch, 3+=SubBranch)
- **path**: Materialized Path 패턴 (예: `/HQ/Vietnam/Ho_Chi_Minh`)
- **is_active**: Location 활성화 여부

**1.2 인덱스 추가**
- `idx_locations_parent_id`: parent_id로 자식 조회 최적화
- `idx_locations_level`: level별 필터링 최적화
- `idx_locations_path`: 경로 기반 검색 최적화 (LIKE 쿼리용)
- `idx_locations_active`: 활성화된 Location만 조회

**1.3 제약 조건 추가**
- `location_type` 제약에 'SubBranch' 타입 추가
- `check_hq_no_parent`: HQ는 반드시 parent_id가 NULL이고 level이 1
- `check_path_format`: path는 `/문자숫자_/` 형식만 허용

**1.4 헬퍼 함수 생성**

**`get_child_locations(parent_location_id UUID)`**
- 재귀 CTE로 특정 Location의 모든 하위 Location ID 반환
- Branch Manager가 관리하는 모든 SubBranch 조회에 사용

**`get_ancestor_locations(child_location_id UUID)`**
- 재귀 CTE로 특정 Location의 모든 상위 Location ID 반환
- Breadcrumb 표시나 권한 체크에 사용

**`can_transfer_between(from_location_id, to_location_id)`**
- 두 Location 간 재고 이동이 유효한지 검증
- 직접적인 Parent-Child 관계만 허용
- 형제 간, Skip-level 이동 차단

**1.5 RLS 정책 업데이트**

**stock_batches_select_hierarchy**
- HQ Admin: 모든 Location 재고 조회
- Branch Manager: 자신의 Location + 모든 하위 Location 재고 조회
- SubBranch Manager: 자신의 Location 재고만 조회

**sales_select_hierarchy**
- stock_batches와 동일한 계층적 권한 적용

**sales_insert_hierarchy**
- SubBranch Manager도 자신의 Location에 판매 입력 가능

---

### 2. Migration 024: Stock Transfer Requests 테이블 생성

**파일:** `supabase/migrations/024_create_stock_transfer_requests.sql`

#### 주요 내용:

**2.1 테이블 구조**
```sql
CREATE TABLE public.stock_transfer_requests (
  id UUID PRIMARY KEY,
  requested_by UUID,          -- 요청자
  from_location_id UUID,      -- 출발지
  to_location_id UUID,        -- 목적지
  product_id UUID,            -- 제품
  requested_qty INTEGER,      -- 요청 수량
  status TEXT,                -- Pending/Approved/Rejected/Completed
  notes TEXT,                 -- 요청 메모
  approved_by UUID,           -- 승인자
  approved_at TIMESTAMPTZ,    -- 승인 시각
  rejection_reason TEXT       -- 거부 사유
);
```

**2.2 Status 값**
- **Pending**: 승인 대기 중
- **Approved**: 승인됨 (아직 실제 이동 안됨)
- **Completed**: 실제 재고 이동 완료
- **Rejected**: 거부됨

**2.3 RLS 정책**
- **SELECT**: 요청자 본인 OR 관리하는 Location의 요청 조회
- **INSERT**: Branch/SubBranch Manager가 자신의 Location으로의 요청 생성
- **UPDATE**: Parent Location의 Manager가 승인/거부
- **DELETE**: 요청자 본인만 Pending 상태일 때 삭제 가능

**2.4 트리거**
- `update_transfer_request_updated_at`: updated_at 자동 갱신
- `validate_transfer_request`: 승인 시 재고 충분 여부 검증

---

### 3. Migration 025: Pricing Configs 확장

**파일:** `supabase/migrations/025_extend_pricing_configs.sql`

#### 주요 내용:

**3.1 새로운 컬럼 추가**
```sql
ALTER TABLE public.pricing_configs
  ADD COLUMN parent_price DECIMAL(12, 2),    -- 상위 Location 가격
  ADD COLUMN is_inherited BOOLEAN;           -- 상속 여부
```

**3.2 헬퍼 함수**

**`get_pricing_chain(product_id, location_id)`**
- HQ부터 해당 Location까지의 가격 체인 반환
- 예: HQ 5,000원 → Vietnam 90,000 VND → Ho Chi Minh 120,000 VND

**`calculate_price_from_parent(...)`**
- Parent 가격 기반으로 자동 계산
- 입력: parent_price, transfer_cost, exchange_rate, margins
- 출력: 계산된 최종 가격

**3.3 RLS 정책 업데이트**
- Branch Manager가 자신의 Location 및 하위 SubBranch의 가격 설정 가능

---

### 4. Migration 026: Hierarchical Locations Seed Data

**파일:** `supabase/migrations/026_seed_hierarchical_locations.sql`

#### 주요 내용:

**4.1 기존 데이터 삭제**
```sql
DELETE FROM public.sales;
DELETE FROM public.stock_batches;
DELETE FROM public.pricing_configs;
DELETE FROM public.purchase_order_items;
DELETE FROM public.purchase_orders;
DELETE FROM public.stock_transfer_requests;
DELETE FROM public.locations;
```

**WARNING**: 이 마이그레이션은 모든 기존 데이터를 삭제합니다!

**4.2 새로운 Location 구조**

```
HQ (Korea) - Level 1
├── Vietnam - Level 2
│   ├── Ho Chi Minh - Level 3
│   ├── Vung Tau - Level 3
│   └── Hanoi - Level 3
└── China - Level 2
    ├── Wei Hai - Level 3
    └── Guangzhou - Level 3
```

**4.3 Location ID 할당**
- HQ: `00000000-0000-0000-0000-000000000001`
- Vietnam: `00000000-0000-0000-0000-000000000002`
- China: `00000000-0000-0000-0000-000000000003`
- Ho Chi Minh: `00000000-0000-0000-0000-000000000004`
- Vung Tau: `00000000-0000-0000-0000-000000000005`
- Hanoi: `00000000-0000-0000-0000-000000000006`
- Wei Hai: `00000000-0000-0000-0000-000000000007`
- Guangzhou: `00000000-0000-0000-0000-000000000008`

**4.4 User Role 업데이트**
```sql
ALTER TABLE public.users
  ADD CONSTRAINT users_role_check
  CHECK (role IN ('HQ_Admin', 'Branch_Manager', 'SubBranch_Manager'));
```

**4.5 검증 로직**
- 생성된 Location 개수 출력
- 계층 구조 트리 형식으로 출력
- 성공 메시지 및 다음 단계 안내

---

## 생성된 파일 목록

1. `supabase/migrations/023_add_location_hierarchy.sql` - Location 계층 구조 지원
2. `supabase/migrations/024_create_stock_transfer_requests.sql` - 재고 이동 요청 시스템
3. `supabase/migrations/025_extend_pricing_configs.sql` - 계층적 가격 설정 지원
4. `supabase/migrations/026_seed_hierarchical_locations.sql` - 초기 계층 구조 데이터

---

## 실행 순서

Supabase SQL Editor에서 다음 순서로 실행하세요:

```bash
1. 023_add_location_hierarchy.sql       # 테이블 구조 변경
2. 024_create_stock_transfer_requests.sql  # 새 테이블 생성
3. 025_extend_pricing_configs.sql       # 가격 테이블 확장
4. 026_seed_hierarchical_locations.sql  # 데이터 초기화 (⚠️ 기존 데이터 삭제)
```

---

## 주요 설계 결정

### 1. Materialized Path 패턴 사용
- 재귀 쿼리 대신 path 컬럼으로 하위 노드 조회 최적화
- 예: `WHERE path LIKE '/HQ/Vietnam/%'`
- 트레이드오프: path 업데이트 필요 (Location 이동 시)

### 2. 직접적인 Parent-Child 관계만 허용
- HQ → SubBranch 직접 이동 차단
- SubBranch ↔ SubBranch 간 이동 차단
- 이유: Parent가 재고 분배 권한을 가지도록 비즈니스 로직 강제

### 3. Transfer Request 시스템
- SubBranch Manager는 이동 권한 없음
- 요청 → 승인 → 실행 워크플로우
- 추후 알림 시스템과 통합 가능

### 4. 계층적 RLS 정책
- 재귀 CTE 대신 헬퍼 함수 사용
- 성능: 함수 결과가 캐싱되어 반복 호출 시 효율적
- Branch Manager는 자동으로 모든 하위 SubBranch 접근 가능

---

## 알려진 제약사항

1. **Materialized Path 수동 관리**
   - Location의 parent 변경 시 path 수동 업데이트 필요
   - 추후 트리거로 자동화 가능

2. **RLS 성능**
   - 재귀 CTE는 쿼리마다 실행됨
   - 대량 데이터 시 성능 모니터링 필요
   - 캐싱 전략 고려 필요

3. **User 할당**
   - Seed 데이터에서 User 생성 부분은 주석 처리됨
   - Supabase Auth UI에서 먼저 사용자 생성 후 SQL로 location_id 할당 필요

4. **롤백 계획 없음**
   - 현재 마이그레이션에 DOWN 스크립트 미포함
   - 필요 시 수동으로 컬럼 제거 필요

---

## 다음 단계 (Step 2)

Step 1 완료 후 다음 작업:

1. **백엔드 API 개발** (Step 2)
   - Location Hierarchy API 구현
   - Transfer API 수정 (계층 검증)
   - Transfer Request API 구현
   - Pricing API 확장

2. **타입 정의 업데이트**
   - `types/index.ts`에 새로운 컬럼 반영
   - `LocationWithHierarchy` 타입 추가
   - `TransferRequest` 타입 추가

3. **유틸리티 함수 작성**
   - `lib/hierarchy-utils.ts` 생성
   - `buildLocationTree()`, `getAncestors()`, `canTransferBetween()` 구현

---

## 테스트 체크리스트

Supabase에서 마이그레이션 실행 후 확인:

- [ ] `locations` 테이블에 8개 Location 생성됨
- [ ] Vietnam에 3개 SubBranch, China에 2개 SubBranch 존재
- [ ] `get_child_locations('vietnam_id')` 함수 호출 시 3개 SubBranch 반환
- [ ] `can_transfer_between(hq_id, vietnam_id)` → true
- [ ] `can_transfer_between(hq_id, ho_chi_minh_id)` → false (Skip level)
- [ ] `stock_transfer_requests` 테이블 생성됨
- [ ] `pricing_configs`에 `parent_price`, `is_inherited` 컬럼 추가됨

---

## 참고 자료

- [PostgreSQL Recursive Queries](https://www.postgresql.org/docs/current/queries-with.html)
- [Materialized Path Pattern](https://www.slideshare.net/billkarwin/models-for-hierarchical-data)
- [계획 문서](../plans/012.phase13.계층적_Sub_Branch_시스템_구현.md)

---

## 결론

Step 1에서는 계층적 Sub-Branch 시스템을 지원하기 위한 모든 데이터베이스 스키마 변경을 완료했습니다.

**완료된 작업:**
- ✅ Locations 테이블 계층 구조 지원 추가
- ✅ Stock Transfer Requests 테이블 생성
- ✅ Pricing Configs 확장
- ✅ 초기 계층 구조 Seed 데이터 작성
- ✅ RLS 정책 업데이트
- ✅ 헬퍼 함수 구현

**다음 세션 목표:**
Step 2 - 백엔드 API 구현 및 비즈니스 로직 개발

---

**작성자:** Claude Code
**작성일:** 2025-11-18
