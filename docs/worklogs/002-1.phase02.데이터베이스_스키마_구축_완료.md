# 002-1.phase02.데이터베이스 스키마 구축 완료

**작업 일시**: 2025-10-28
**작업 단계**: Phase 02 - Step 1/3
**작업 상태**: ✅ 완료

---

## 작업 개요

Arno Cosmetics 재고 관리 시스템의 핵심 데이터베이스 스키마를 구축했습니다. 총 9개의 SQL 마이그레이션 파일을 생성하여 10개의 핵심 테이블(users는 Phase 01에서 완료)을 정의했습니다.

---

## 생성된 마이그레이션 파일

### 1. `002_create_locations_table.sql`
**테이블**: `locations`
**목적**: HQ와 지사 정보 관리

**주요 컬럼**:
- `id`, `name`, `location_type`, `country_code`, `currency`
- `address`, `contact_person`, `phone`

**RLS 정책**:
- 모든 인증된 사용자 조회 가능
- HQ Admin만 수정 가능

**초기 데이터**:
- Korea HQ (KR, KRW)
- Vietnam Branch (VN, VND)
- China Branch (CN, CNY)

**인덱스**:
- `idx_locations_type`
- `idx_locations_country`

---

### 2. `003_update_users_foreign_key.sql`
**작업**: users 테이블에 외래 키 추가

**변경 사항**:
```sql
ALTER TABLE public.users
  ADD CONSTRAINT fk_users_location
  FOREIGN KEY (location_id) REFERENCES public.locations(id) ON DELETE SET NULL;

CREATE INDEX idx_users_location ON public.users(location_id);
```

**주의**: 반드시 `002_create_locations_table.sql` 실행 후에 실행해야 함!

---

### 3. `004_create_suppliers_table.sql`
**테이블**: `suppliers`
**목적**: 공급업체(공장) 정보 관리

**주요 컬럼**:
- `id`, `name`, `contact_person`, `phone`, `email`
- `address`, `notes`

**RLS 정책**:
- 인증된 사용자 조회 가능
- HQ Admin만 수정 가능

**인덱스**:
- `idx_suppliers_name`

---

### 4. `005_create_products_table.sql`
**테이블**: `products`
**목적**: 제품 마스터 데이터

**주요 컬럼**:
- `id`, `sku` (UNIQUE), `name`
- `name_ko`, `name_vn`, `name_cn` (다국어 지원)
- `category`, `unit`, `shelf_life_days`
- `description`

**RLS 정책**:
- 인증된 사용자 조회 가능
- HQ Admin만 수정 가능

**인덱스**:
- `idx_products_sku`
- `idx_products_category`

---

### 5. `006_create_purchase_orders_tables.sql`
**테이블**: `purchase_orders`, `purchase_order_items`
**목적**: 구매 발주 관리

**purchase_orders 주요 컬럼**:
- `id`, `po_no` (UNIQUE), `supplier_id`, `order_date`
- `status` ('Draft', 'Approved', 'Received')
- `total_amount`, `currency`, `notes`
- `created_by`, `approved_by`, `approved_at`, `received_at`

**purchase_order_items 주요 컬럼**:
- `id`, `po_id`, `product_id`
- `qty`, `unit_price`, `total_price` (GENERATED)

**RLS 정책**:
- HQ Admin만 접근 가능 (조회, 수정)

**인덱스**:
- `idx_po_supplier`, `idx_po_status`, `idx_po_order_date`
- `idx_po_items_po_id`, `idx_po_items_product_id`

---

### 6. `007_create_stock_batches_table.sql`
**테이블**: `stock_batches` (핵심 재고 테이블)
**목적**: 배치별 재고 관리, FIFO 구현

**주요 컬럼**:
- `id`, `product_id`, `location_id`, `batch_no`
- `qty_on_hand`, `qty_reserved`, `qty_available` (GENERATED)
- `unit_cost`, `manufactured_date`, `expiry_date`
- `quality_status` ('OK', 'Damaged', 'Quarantine')

**제약 조건**:
- UNIQUE(product_id, location_id, batch_no)
- CHECK(expiry_date > manufactured_date)

**RLS 정책**:
- HQ Admin: 모든 재고 조회 가능
- Branch Manager: 자기 지사 재고만 조회
- HQ Admin만 수정 가능

**인덱스 (성능 최적화)**:
- `idx_stock_location_product` (지사별 제품 재고 조회)
- `idx_stock_expiry_date` (FIFO 정렬)
- `idx_stock_batch_no`
- `idx_stock_quality`

---

### 7. `008_create_pricing_configs_table.sql`
**테이블**: `pricing_configs`
**목적**: 제품별 지사별 가격 설정

**주요 컬럼**:
- `id`, `product_id`, `from_location_id`, `to_location_id`
- `purchase_price`, `transfer_cost` (KRW)
- `hq_margin_percent`, `branch_margin_percent`
- `exchange_rate`, `calculated_price`, `final_price`
- `currency`

**제약 조건**:
- UNIQUE(product_id, to_location_id)

**RLS 정책**:
- HQ Admin만 접근 가능

**인덱스**:
- `idx_pricing_product_location`

---

### 8. `009_create_sales_table.sql`
**테이블**: `sales`
**목적**: 판매 기록

**주요 컬럼**:
- `id`, `location_id`, `product_id`, `sale_date`
- `qty`, `unit_price`, `total_amount` (GENERATED)
- `currency`, `created_by`

**RLS 정책**:
- HQ Admin: 모든 판매 조회 가능
- Branch Manager: 자기 지사 판매만 조회
- Branch Manager: 자기 지사 판매 입력 가능
- HQ Admin: 모든 판매 수정 가능

**인덱스**:
- `idx_sales_location_date`
- `idx_sales_product`

---

### 9. `010_create_exchange_rates_table.sql`
**테이블**: `exchange_rates`
**목적**: 환율 정보 관리

**주요 컬럼**:
- `id`, `from_currency`, `to_currency`, `rate`
- `effective_date`, `created_by`

**제약 조건**:
- UNIQUE(from_currency, to_currency, effective_date)

**RLS 정책**:
- 인증된 사용자 조회 가능
- HQ Admin만 수정 가능

**초기 데이터**:
- KRW → VND: 18.0
- KRW → CNY: 0.0053

**인덱스**:
- `idx_exchange_rates_currencies`
- `idx_exchange_rates_date` (DESC)

---

## Supabase 실행 방법

### 1단계: Supabase Dashboard 접속

1. Supabase 프로젝트 로그인 (https://supabase.com)
2. 좌측 메뉴에서 **SQL Editor** 클릭
3. "New query" 버튼 클릭

### 2단계: 마이그레이션 순차 실행

**중요**: 반드시 아래 순서대로 실행하세요!

```
1. 002_create_locations_table.sql
2. 003_update_users_foreign_key.sql
3. 004_create_suppliers_table.sql
4. 005_create_products_table.sql
5. 006_create_purchase_orders_tables.sql
6. 007_create_stock_batches_table.sql
7. 008_create_pricing_configs_table.sql
8. 009_create_sales_table.sql
9. 010_create_exchange_rates_table.sql
```

**각 파일 실행 방법**:
1. 마이그레이션 파일을 텍스트 에디터로 열기
2. 전체 내용 복사 (Ctrl+A → Ctrl+C)
3. Supabase SQL Editor에 붙여넣기 (Ctrl+V)
4. "Run" 버튼 클릭
5. "Success" 메시지 확인 후 다음 파일로 진행

### 3단계: 검증

**테이블 생성 확인**:
```sql
SELECT table_name
FROM information_schema.tables
WHERE table_schema = 'public'
ORDER BY table_name;
```

**예상 결과**: 10개 테이블
- exchange_rates
- locations
- pricing_configs
- products
- purchase_order_items
- purchase_orders
- sales
- stock_batches
- suppliers
- users

**RLS 활성화 확인**:
```sql
SELECT tablename, rowsecurity
FROM pg_tables
WHERE schemaname = 'public';
```

**초기 데이터 확인**:
```sql
SELECT * FROM public.locations;
SELECT * FROM public.exchange_rates;
```

**예상 결과**:
- locations: 3개 행 (Korea HQ, Vietnam Branch, China Branch)
- exchange_rates: 2개 행 (KRW→VND, KRW→CNY)

---

## 데이터베이스 구조 요약

### 테이블 관계도

```
users
  ↓ (location_id)
locations ← (from/to_location_id) → pricing_configs
  ↓                                      ↓ (product_id)
stock_batches                         products
  ↓ (product_id, location_id)           ↓
sales                                 purchase_order_items
                                        ↓ (po_id)
                                      purchase_orders
                                        ↓ (supplier_id)
                                      suppliers
```

### 접근 권한 매트릭스

| 테이블 | HQ Admin | Branch Manager |
|--------|----------|----------------|
| locations | Read/Write | Read Only |
| suppliers | Read/Write | Read Only |
| products | Read/Write | Read Only |
| purchase_orders | Read/Write | No Access |
| purchase_order_items | Read/Write | No Access |
| stock_batches | Read/Write (all) | Read Only (own) |
| pricing_configs | Read/Write | No Access |
| sales | Read/Write (all) | Read/Write (own) |
| exchange_rates | Read/Write | Read Only |
| users | Read/Write | Read (own) |

---

## 성능 최적화

### 핵심 인덱스

**재고 조회 최적화**:
- `idx_stock_location_product` - 지사별 제품 재고 빠른 조회
- `idx_stock_expiry_date` - FIFO 정렬 (유통기한 순)

**판매 조회 최적화**:
- `idx_sales_location_date` - 지사별 날짜별 판매 집계

**발주 조회 최적화**:
- `idx_po_status` - 상태별 발주서 필터링
- `idx_po_order_date` - 날짜별 발주서 정렬

---

## 완료 체크리스트

### 파일 생성
- [x] `002_create_locations_table.sql` 생성
- [x] `003_update_users_foreign_key.sql` 생성
- [x] `004_create_suppliers_table.sql` 생성
- [x] `005_create_products_table.sql` 생성
- [x] `006_create_purchase_orders_tables.sql` 생성
- [x] `007_create_stock_batches_table.sql` 생성
- [x] `008_create_pricing_configs_table.sql` 생성
- [x] `009_create_sales_table.sql` 생성
- [x] `010_create_exchange_rates_table.sql` 생성

### Supabase 실행 (사용자가 직접 수행)
- [ ] 모든 마이그레이션 파일 순서대로 실행
- [ ] 테이블 생성 확인 (10개)
- [ ] RLS 활성화 확인
- [ ] 인덱스 생성 확인
- [ ] 초기 데이터 확인 (locations 3개, exchange_rates 2개)

### 검증 (실행 후)
- [ ] HQ Admin 계정으로 모든 테이블 조회 가능
- [ ] Branch Manager 계정으로 제한된 테이블만 조회 가능
- [ ] 외래 키 제약 조건 정상 작동
- [ ] updated_at 트리거 정상 작동

---

## 주의 사항

### 실행 순서 엄수
- **002** 번을 먼저 실행하지 않으면 **003** 번에서 외래 키 오류 발생
- locations 테이블이 생성된 후에 users 외래 키 추가 가능

### RLS 정책
- 모든 테이블에 RLS가 활성화되어 있음
- Supabase Dashboard에서 직접 쿼리 시 Service Role Key 사용 필요
- 애플리케이션에서는 사용자 인증 토큰으로 자동 필터링됨

### 초기 데이터
- locations 3개와 exchange_rates 2개가 자동 삽입됨
- 중복 실행 시 UNIQUE 제약 조건 위반 오류 발생 (무시해도 됨)

---

## 다음 단계

Step 1 완료 후 **002-2.phase02.UI_컴포넌트_및_타입_정의**로 진행합니다.

**필요 작업**:
1. Supabase에서 모든 마이그레이션 실행
2. 테이블 및 초기 데이터 확인
3. Step 2 진행 (shadcn/ui 컴포넌트 설치)

---

**작성자**: Claude Code
**작성일**: 2025-10-28
**다음 Step**: 002-2 (UI 컴포넌트 및 타입 정의)
