# 002-1.phase02.데이터베이스 스키마 구축

**작업 단계**: Phase 02 - Step 1/3
**예상 소요 시간**: 2-3시간
**담당자**: 개발팀
**목표**: 10개 핵심 테이블 생성, RLS 정책 설정, 초기 데이터 삽입

---

## 1. 개요

Arno Cosmetics 재고 관리 시스템의 핵심 데이터베이스 스키마를 구축합니다. 총 10개의 테이블을 생성하며, 각 테이블에 Row Level Security (RLS) 정책, 인덱스, 트리거를 설정합니다.

### 핵심 목표
- ✅ 9개 SQL 마이그레이션 파일 생성
- ✅ 10개 핵심 테이블 생성 (users는 Phase 01에서 완료)
- ✅ RLS 정책 설정 (역할 기반 접근 제어)
- ✅ 성능 최적화 인덱스 생성
- ✅ 초기 데이터 삽입 (locations 3개, exchange_rates 2개)

---

## 2. 테이블 생성 순서

**중요**: 외래 키 의존성 때문에 아래 순서대로 실행해야 합니다!

```
1. locations (먼저!)
2. users 외래 키 추가 (locations 참조)
3. suppliers
4. products
5. purchase_orders + purchase_order_items
6. stock_batches
7. pricing_configs
8. sales
9. exchange_rates
```

---

## 3. 마이그레이션 파일 목록

### 3.1 `002_create_locations_table.sql`

**테이블**: `locations`
**설명**: HQ와 지사 정보 (Korea HQ, Vietnam Branch, China Branch)

**컬럼:**
- `id` (UUID, PK)
- `name` (TEXT, NOT NULL) - 지사명
- `location_type` (TEXT, CHECK: 'HQ' | 'Branch')
- `country_code` (TEXT) - 'KR', 'VN', 'CN'
- `currency` (TEXT, CHECK: 'KRW' | 'VND' | 'CNY')
- `address` (TEXT)
- `contact_person` (TEXT)
- `phone` (TEXT)
- `created_at`, `updated_at` (TIMESTAMPTZ)

**RLS 정책:**
- 모든 인증된 사용자 조회 가능
- HQ Admin만 수정 가능

**인덱스:**
- `idx_locations_type` ON (location_type)
- `idx_locations_country` ON (country_code)

**초기 데이터:**
```sql
INSERT INTO public.locations (name, location_type, country_code, currency, address) VALUES
('Korea HQ', 'HQ', 'KR', 'KRW', 'Seoul, South Korea'),
('Vietnam Branch', 'Branch', 'VN', 'VND', 'Ho Chi Minh City, Vietnam'),
('China Branch', 'Branch', 'CN', 'CNY', 'Shanghai, China');
```

---

### 3.2 `003_update_users_foreign_key.sql`

**테이블**: `users` (Phase 01에서 생성됨)
**작업**: `location_id` 외래 키 제약 조건 추가

**SQL:**
```sql
ALTER TABLE public.users
  ADD CONSTRAINT fk_users_location
  FOREIGN KEY (location_id) REFERENCES public.locations(id) ON DELETE SET NULL;

CREATE INDEX idx_users_location ON public.users(location_id);
```

**주의**: 반드시 `002_create_locations_table.sql` 실행 후에 실행!

---

### 3.3 `004_create_suppliers_table.sql`

**테이블**: `suppliers`
**설명**: 공급업체(공장) 정보

**컬럼:**
- `id` (UUID, PK)
- `name` (TEXT, NOT NULL)
- `contact_person` (TEXT)
- `phone` (TEXT)
- `email` (TEXT)
- `address` (TEXT)
- `notes` (TEXT)
- `created_at`, `updated_at` (TIMESTAMPTZ)

**RLS 정책:**
- 인증된 사용자 조회 가능
- HQ Admin만 수정 가능

**인덱스:**
- `idx_suppliers_name` ON (name)

---

### 3.4 `005_create_products_table.sql`

**테이블**: `products`
**설명**: 제품 마스터 데이터

**컬럼:**
- `id` (UUID, PK)
- `sku` (TEXT, UNIQUE, NOT NULL) - 제품 코드
- `name` (TEXT, NOT NULL) - 기본 이름
- `name_ko` (TEXT) - 한국어 이름
- `name_vn` (TEXT) - 베트남어 이름
- `name_cn` (TEXT) - 중국어 이름
- `category` (TEXT) - 카테고리
- `unit` (TEXT, DEFAULT 'EA') - 'EA', 'BOX', 'PACK'
- `shelf_life_days` (INTEGER, DEFAULT 730) - 유통기한 (일)
- `description` (TEXT)
- `created_at`, `updated_at` (TIMESTAMPTZ)

**RLS 정책:**
- 인증된 사용자 조회 가능
- HQ Admin만 수정 가능

**인덱스:**
- `idx_products_sku` ON (sku)
- `idx_products_category` ON (category)

---

### 3.5 `006_create_purchase_orders_tables.sql`

**테이블 1**: `purchase_orders`
**설명**: 구매 발주서

**컬럼:**
- `id` (UUID, PK)
- `po_no` (TEXT, UNIQUE, NOT NULL) - 발주 번호
- `supplier_id` (UUID, FK → suppliers)
- `order_date` (DATE, DEFAULT CURRENT_DATE)
- `status` (TEXT, CHECK: 'Draft' | 'Approved' | 'Received')
- `total_amount` (DECIMAL(15,2))
- `currency` (TEXT, DEFAULT 'KRW')
- `notes` (TEXT)
- `created_by` (UUID, FK → users)
- `approved_by` (UUID, FK → users)
- `approved_at` (TIMESTAMPTZ)
- `received_at` (TIMESTAMPTZ)
- `created_at`, `updated_at` (TIMESTAMPTZ)

**테이블 2**: `purchase_order_items`
**설명**: 발주 상세 아이템

**컬럼:**
- `id` (UUID, PK)
- `po_id` (UUID, FK → purchase_orders, ON DELETE CASCADE)
- `product_id` (UUID, FK → products)
- `qty` (INTEGER, CHECK > 0)
- `unit_price` (DECIMAL(12,2), CHECK >= 0)
- `total_price` (DECIMAL(15,2), GENERATED ALWAYS AS qty * unit_price)
- `created_at`, `updated_at` (TIMESTAMPTZ)
- UNIQUE(po_id, product_id)

**RLS 정책:**
- HQ Admin만 접근 가능 (조회, 수정)

**인덱스:**
- `idx_po_supplier` ON purchase_orders(supplier_id)
- `idx_po_status` ON purchase_orders(status)
- `idx_po_order_date` ON purchase_orders(order_date)
- `idx_po_items_po_id` ON purchase_order_items(po_id)
- `idx_po_items_product_id` ON purchase_order_items(product_id)

---

### 3.6 `007_create_stock_batches_table.sql`

**테이블**: `stock_batches` (핵심 재고 테이블)
**설명**: 배치별 재고 관리 (FIFO 구현의 핵심)

**컬럼:**
- `id` (UUID, PK)
- `product_id` (UUID, FK → products)
- `location_id` (UUID, FK → locations)
- `batch_no` (TEXT, NOT NULL) - 배치 번호
- `qty_on_hand` (INTEGER, DEFAULT 0, CHECK >= 0) - 실제 재고
- `qty_reserved` (INTEGER, DEFAULT 0, CHECK >= 0) - 예약 재고
- `qty_available` (INTEGER, GENERATED ALWAYS AS qty_on_hand - qty_reserved) - 가용 재고
- `unit_cost` (DECIMAL(12,2), CHECK >= 0) - 단위 원가
- `manufactured_date` (DATE, NOT NULL) - 제조 일자
- `expiry_date` (DATE, NOT NULL) - 유통기한
- `quality_status` (TEXT, CHECK: 'OK' | 'Damaged' | 'Quarantine')
- `created_at`, `updated_at` (TIMESTAMPTZ)
- UNIQUE(product_id, location_id, batch_no)
- CHECK(expiry_date > manufactured_date)

**RLS 정책:**
- HQ Admin: 모든 재고 조회 가능
- Branch Manager: 자기 지사 재고만 조회
- HQ Admin만 수정 가능

**인덱스 (성능 최적화):**
- `idx_stock_location_product` ON (location_id, product_id)
- `idx_stock_expiry_date` ON (expiry_date) - FIFO 정렬용
- `idx_stock_batch_no` ON (batch_no)
- `idx_stock_quality` ON (quality_status)

---

### 3.7 `008_create_pricing_configs_table.sql`

**테이블**: `pricing_configs`
**설명**: 제품별 지사별 가격 설정

**컬럼:**
- `id` (UUID, PK)
- `product_id` (UUID, FK → products, ON DELETE CASCADE)
- `from_location_id` (UUID, FK → locations) - 항상 HQ
- `to_location_id` (UUID, FK → locations) - 목적지 지사
- `purchase_price` (DECIMAL(12,2), CHECK >= 0) - 구매 단가 (KRW)
- `transfer_cost` (DECIMAL(12,2), DEFAULT 0) - 이전 비용 (KRW)
- `hq_margin_percent` (DECIMAL(5,2), DEFAULT 0, CHECK 0-100) - 본사 마진 (%)
- `branch_margin_percent` (DECIMAL(5,2), DEFAULT 0, CHECK 0-100) - 지사 마진 (%)
- `exchange_rate` (DECIMAL(10,4), CHECK > 0) - 환율
- `calculated_price` (DECIMAL(12,2)) - 자동 계산된 가격
- `final_price` (DECIMAL(12,2), CHECK > 0) - 최종 판매가 (수동 조정 가능)
- `currency` (TEXT) - 'VND', 'CNY'
- `created_at`, `updated_at` (TIMESTAMPTZ)
- UNIQUE(product_id, to_location_id)

**RLS 정책:**
- HQ Admin만 접근 가능

**인덱스:**
- `idx_pricing_product_location` ON (product_id, to_location_id)

---

### 3.8 `009_create_sales_table.sql`

**테이블**: `sales`
**설명**: 판매 기록

**컬럼:**
- `id` (UUID, PK)
- `location_id` (UUID, FK → locations)
- `product_id` (UUID, FK → products)
- `sale_date` (DATE, DEFAULT CURRENT_DATE)
- `qty` (INTEGER, CHECK > 0)
- `unit_price` (DECIMAL(12,2), CHECK > 0)
- `total_amount` (DECIMAL(15,2), GENERATED ALWAYS AS qty * unit_price)
- `currency` (TEXT)
- `created_by` (UUID, FK → users)
- `created_at`, `updated_at` (TIMESTAMPTZ)

**RLS 정책:**
- HQ Admin: 모든 판매 조회 가능
- Branch Manager: 자기 지사 판매만 조회
- Branch Manager: 자기 지사 판매 입력 가능
- HQ Admin: 모든 판매 수정 가능

**인덱스:**
- `idx_sales_location_date` ON (location_id, sale_date)
- `idx_sales_product` ON (product_id)

---

### 3.9 `010_create_exchange_rates_table.sql`

**테이블**: `exchange_rates`
**설명**: 환율 정보

**컬럼:**
- `id` (UUID, PK)
- `from_currency` (TEXT, CHECK: 'KRW' | 'VND' | 'CNY')
- `to_currency` (TEXT, CHECK: 'KRW' | 'VND' | 'CNY')
- `rate` (DECIMAL(10,4), CHECK > 0)
- `effective_date` (DATE, DEFAULT CURRENT_DATE)
- `created_by` (UUID, FK → users)
- `created_at` (TIMESTAMPTZ)
- UNIQUE(from_currency, to_currency, effective_date)

**RLS 정책:**
- 인증된 사용자 조회 가능
- HQ Admin만 수정 가능

**인덱스:**
- `idx_exchange_rates_currencies` ON (from_currency, to_currency)
- `idx_exchange_rates_date` ON (effective_date DESC)

**초기 데이터:**
```sql
INSERT INTO public.exchange_rates (from_currency, to_currency, rate, effective_date) VALUES
('KRW', 'VND', 18.0, CURRENT_DATE),
('KRW', 'CNY', 0.0053, CURRENT_DATE);
```

---

## 4. 실행 방법

### 4.1 Supabase Dashboard에서 실행

1. Supabase 프로젝트 로그인
2. 좌측 메뉴 → **SQL Editor** 클릭
3. "New query" 클릭
4. 각 마이그레이션 파일 내용을 순서대로 복사하여 실행:
   - `002_create_locations_table.sql`
   - `003_update_users_foreign_key.sql`
   - `004_create_suppliers_table.sql`
   - `005_create_products_table.sql`
   - `006_create_purchase_orders_tables.sql`
   - `007_create_stock_batches_table.sql`
   - `008_create_pricing_configs_table.sql`
   - `009_create_sales_table.sql`
   - `010_create_exchange_rates_table.sql`
5. 각 스크립트 실행 후 "Success" 메시지 확인

### 4.2 검증 방법

**테이블 생성 확인:**
```sql
SELECT table_name
FROM information_schema.tables
WHERE table_schema = 'public'
ORDER BY table_name;
```

**RLS 활성화 확인:**
```sql
SELECT tablename, rowsecurity
FROM pg_tables
WHERE schemaname = 'public';
```

**초기 데이터 확인:**
```sql
SELECT * FROM public.locations;
SELECT * FROM public.exchange_rates;
```

---

## 5. 트리거 및 함수

### update_updated_at_column 함수

Phase 01에서 이미 생성되었으므로 재사용합니다.

```sql
-- 이미 존재하는 함수
CREATE OR REPLACE FUNCTION public.update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;
```

각 테이블에 트리거 생성:
```sql
CREATE TRIGGER {table_name}_updated_at
  BEFORE UPDATE ON public.{table_name}
  FOR EACH ROW
  EXECUTE FUNCTION public.update_updated_at_column();
```

---

## 6. RLS 정책 요약

### 접근 권한 매트릭스

| 테이블 | HQ Admin | Branch Manager |
|--------|----------|----------------|
| locations | Read/Write | Read Only |
| suppliers | Read/Write | Read Only |
| products | Read/Write | Read Only |
| purchase_orders | Read/Write | No Access |
| purchase_order_items | Read/Write | No Access |
| stock_batches | Read/Write (all) | Read Only (own location) |
| pricing_configs | Read/Write | No Access |
| sales | Read/Write (all) | Read/Write (own location) |
| exchange_rates | Read/Write | Read Only |
| users | Read/Write | Read (own profile) |

---

## 7. 성능 최적화

### 핵심 인덱스 (쿼리 최적화)

**재고 조회 성능:**
- `idx_stock_location_product` - 지사별 제품 재고 빠른 조회
- `idx_stock_expiry_date` - FIFO 정렬 (유통기한 순)

**판매 조회 성능:**
- `idx_sales_location_date` - 지사별 일자별 판매 집계

**발주 조회 성능:**
- `idx_po_status` - 상태별 발주서 필터링
- `idx_po_order_date` - 날짜별 발주서 정렬

---

## 8. 완료 체크리스트

### 마이그레이션 파일 생성
- [ ] `002_create_locations_table.sql` 생성
- [ ] `003_update_users_foreign_key.sql` 생성
- [ ] `004_create_suppliers_table.sql` 생성
- [ ] `005_create_products_table.sql` 생성
- [ ] `006_create_purchase_orders_tables.sql` 생성
- [ ] `007_create_stock_batches_table.sql` 생성
- [ ] `008_create_pricing_configs_table.sql` 생성
- [ ] `009_create_sales_table.sql` 생성
- [ ] `010_create_exchange_rates_table.sql` 생성

### Supabase 실행
- [ ] 모든 마이그레이션 파일 순서대로 실행
- [ ] 테이블 생성 확인 (10개)
- [ ] RLS 활성화 확인
- [ ] 인덱스 생성 확인
- [ ] 초기 데이터 확인 (locations 3개, exchange_rates 2개)

### 검증
- [ ] HQ Admin 계정으로 모든 테이블 조회 가능
- [ ] Branch Manager 계정으로 제한된 테이블만 조회 가능
- [ ] 외래 키 제약 조건 정상 작동
- [ ] updated_at 트리거 정상 작동

---

## 9. 다음 단계

Step 1 완료 후 **002-2.phase02.UI_컴포넌트_및_타입_정의.md**로 진행합니다.

---

**작성자**: Claude Code
**작성일**: 2025-10-28
**다음 Step**: 002-2 (UI 컴포넌트 및 타입 정의)
