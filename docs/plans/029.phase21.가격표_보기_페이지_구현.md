# 029. Phase 21: 가격표 보기 페이지 구현

## 개요
Sub Branch별 가격표를 탭으로 조회하고 인쇄/엑셀 다운로드 기능을 제공하는 새 페이지 구현

## 요구사항 요약
- **위치**: `/pricing/list` (새 페이지)
- **탭 구성**: Branch + SubBranch (예: Vietnam | Ho Chi Minh | Vung Tau | Hanoi)
- **테이블 컬럼**: 제품명, 제품코드, 구매단가(KRW), 지부마진(%), 소비자가, 할인 최종가
- **접근 권한**:
  - HQ_Admin: 모든 Branch + SubBranch
  - Branch_Manager: 자신의 Branch + 하위 SubBranch만
- **내보내기**: 선택된 탭만 인쇄/엑셀 다운로드

---

## 파일 구조

### 새로 생성할 파일
```
app/(dashboard)/pricing/list/
└── page.tsx                           # 메인 페이지 (서버 컴포넌트)

components/pricing/price-list-view/
├── price-list-tabs.tsx                # 탭 UI 컴포넌트
├── price-list-table.tsx               # 가격표 테이블
└── price-list-export.tsx              # 인쇄/엑셀 버튼

lib/
└── excel-export.ts                    # xlsx 유틸리티
```

### 수정할 파일
```
app/globals.css                        # 인쇄용 CSS 추가
app/(dashboard)/pricing/page.tsx       # "가격표 보기" 버튼 추가
package.json                           # xlsx 라이브러리 추가
```

---

## 구현 단계

### Step 1: 의존성 설치
```bash
npm install xlsx
```

### Step 2: 엑셀 내보내기 유틸리티 (`lib/excel-export.ts`)
```typescript
import * as XLSX from 'xlsx'

interface PriceListExportData {
  productName: string
  productCode: string
  purchasePrice: number
  branchMargin: number
  consumerPrice: number
  discountedPrice: number
}

export function exportPriceListToExcel(
  data: PriceListExportData[],
  locationName: string,
  currency: string
): void
```

### Step 3: 인쇄용 CSS (`globals.css` 수정)
```css
@media print {
  .no-print, header, nav, aside { display: none !important; }
  .price-list-print { width: 100%; font-size: 11pt; }
  .price-list-print th, .price-list-print td {
    padding: 6px; border: 1px solid #ddd;
  }
}
@media screen {
  .print-only { display: none; }
}
```

### Step 4: 가격표 테이블 컴포넌트 (`price-list-table.tsx`)
**Props:**
- `pricingConfigs`: 해당 탭의 가격 설정 배열
- `locationName`: 현재 탭 이름
- `currency`: 통화 코드

**테이블 컬럼:**
| 컬럼 | 필드 | 포맷 |
|------|------|------|
| 제품명 | `product.name` | 텍스트 |
| 제품코드 | `product.sku` | 텍스트 |
| 구매단가 | `purchase_price` | KRW (원) |
| 지부마진 | `sub_branch_margin_percent` | % |
| 소비자가 | `final_price` | 로컬 통화 |
| 할인 최종가 | `discounted_price` | 로컬 통화, 할인시 강조 |

### Step 5: 내보내기 컴포넌트 (`price-list-export.tsx`)
**버튼:**
- 인쇄 버튼: `window.print()` 호출
- 엑셀 버튼: `exportPriceListToExcel()` 호출
- 파일명: `PriceList_{LocationName}_{YYYY-MM-DD}.xlsx`

### Step 6: 탭 컴포넌트 (`price-list-tabs.tsx`)
**로직:**
1. `locations` 배열을 받아 탭 생성
2. `sortByHierarchyAndOrder()`로 정렬 (hierarchy-utils.ts 활용)
3. 선택된 탭에 해당하는 pricingConfigs 필터링
4. PriceListTable과 PriceListExport 렌더링

**탭 표시:**
- Branch: 일반 스타일
- SubBranch: 들여쓰기 또는 아이콘으로 구분

### Step 7: 메인 페이지 (`app/(dashboard)/pricing/list/page.tsx`)
**서버 컴포넌트 로직:**
```typescript
// 1. 인증 확인
const { data: { user } } = await supabase.auth.getUser()

// 2. 사용자 프로필 조회 (role, location_id)
const { data: profile } = await supabase
  .from('users')
  .select('role, location_id')
  .eq('id', user.id)
  .single()

// 3. 모든 locations 조회
const { data: locations } = await supabase
  .from('locations')
  .select('*')
  .eq('is_active', true)

// 4. 접근 가능한 locations 계산
const accessibleLocations = getAccessibleLocations(
  profile.location_id,
  profile.role,
  locations
)

// 5. pricing_configs 조회 (location 필터링)
const accessibleIds = accessibleLocations.map(l => l.id)
const { data: pricingConfigs } = await supabase
  .from('pricing_configs')
  .select(`
    id, purchase_price, sub_branch_margin_percent,
    final_price, discounted_price, discount_percent, currency,
    product:products!inner(sku, name),
    to_location:locations!pricing_configs_to_location_id_fkey(
      id, name, location_type, level, parent_id, currency, display_order
    )
  `)
  .in('to_location_id', accessibleIds)

// 6. 클라이언트 컴포넌트로 전달
return <PriceListTabs
  locations={accessibleLocations}
  pricingConfigs={pricingConfigs}
/>
```

### Step 8: 기존 페이지에 링크 추가
`app/(dashboard)/pricing/page.tsx`에 "가격표 보기" 버튼 추가:
```tsx
<Link href="/pricing/list">
  <Button variant="outline">
    <FileText className="mr-2 h-4 w-4" />
    가격표 보기
  </Button>
</Link>
```

---

## 핵심 참조 파일
- `lib/hierarchy-utils.ts` - `getAccessibleLocations()`, `sortByHierarchyAndOrder()`
- `components/pricing/pricing-list.tsx` - 테이블 구조 참고
- `app/(dashboard)/pricing/page.tsx` - 데이터 조회 패턴
- `lib/utils.ts` - `formatCurrency()`
- `components/ui/tabs.tsx` - 탭 컴포넌트

---

## 데이터 흐름
```
[Server: page.tsx]
├── Auth 확인
├── User profile (role, location_id) 조회
├── Locations 조회
├── getAccessibleLocations() 호출
├── pricing_configs 조회 (필터링)
└── PriceListTabs로 데이터 전달

[Client: PriceListTabs]
├── 탭 렌더링 (locations)
├── 탭 선택 시 해당 location의 configs 필터
├── PriceListTable 렌더링
└── PriceListExport 버튼 렌더링
    ├── Print: window.print()
    └── Excel: xlsx 라이브러리로 다운로드
```

---

## 엣지 케이스 처리
1. **가격 설정 없는 location**: 빈 상태 메시지 표시
2. **SubBranch 없는 Branch Manager**: 본인 Branch 탭만 표시
3. **discounted_price null**: `final_price`로 대체
4. **긴 제품명**: 테이블 셀 내 줄바꿈 처리
5. **인쇄 시 페이지 나눔**: 테이블 행 중간 잘림 방지 CSS
