# 004-1. Phase 04 Enhanced - ì¬ê³  ë“œë˜ê·¸ ì•¤ ë“œë¡­ UI êµ¬í˜„ ê³„íš

## ì‘ì—… ê°œìš”

**ëª©í‘œ:** ê¸°ì¡´ Transfer Stock í¼ ë°©ì‹ì€ ìœ ì§€í•˜ë©´ì„œ, ì„¸ë¡œ Accordion í˜•íƒœì˜ ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì¬ê³  ì´ë™ UI ì¶”ê°€

**ì‘ì—… ë²”ìœ„:**
- í˜„ì¬ `/inventory` í˜ì´ì§€ì— ìƒˆë¡œìš´ ë“œë˜ê·¸ ì•¤ ë“œë¡­ ë·° ì˜µì…˜ ì¶”ê°€
- Locationë³„ Accordion ì„¹ì…˜ (í¼ì¹˜ê¸°/ì ‘ê¸° ê°€ëŠ¥)
- ê°€ë¡œë¡œ ê¸´ Product Card ë””ìì¸ (ë°°ì¹˜ë³„ ìƒì„¸ ì •ë³´)
- Branch Headerë¡œ ë“œë˜ê·¸í•˜ì—¬ ì´ë™
- ê¸°ì¡´ Transfer Stock í˜ì´ì§€ëŠ” ê·¸ëŒ€ë¡œ ìœ ì§€ (ë‘ ê°€ì§€ ë°©ì‹ ë³‘í–‰)

---

## í˜„ì¬ ìƒí™© ë¶„ì„

### ê¸°ì¡´ UI Flow
1. `/inventory` - ì¬ê³  í˜„í™© í…Œì´ë¸” ë·° (Locationë³„ ê·¸ë£¹í™”)
2. "Transfer Stock" ë²„íŠ¼ í´ë¦­
3. `/inventory/transfer` - í¼ í˜ì´ì§€ë¡œ ì´ë™
4. ë“œë¡­ë‹¤ìš´ìœ¼ë¡œ ì„ íƒ + ìˆ˜ëŸ‰ ì…ë ¥
5. Submit

### ìƒˆë¡œìš´ ìš”êµ¬ì‚¬í•­
- âœ… ë” ì§ê´€ì ì¸ ì‹œê°ì  ì¸í„°í˜ì´ìŠ¤
- âœ… ì„¸ë¡œ Accordion ë ˆì´ì•„ì›ƒ (ê°€ë¡œ ì»¬ëŸ¼ ëŒ€ì‹ )
- âœ… ê°€ë¡œë¡œ ê¸´ Product Card (ë” ë§ì€ ì •ë³´ í‘œì‹œ)
- âœ… Branch Headerë¡œ ë“œë˜ê·¸ (ì ‘í˜€ìˆì–´ë„ ë“œë¡­ ê°€ëŠ¥)
- âœ… ë°°ì¹˜ë³„ ê°œë³„ ì¹´ë“œ í‘œì‹œ (Option A)
- âœ… HQ Adminì€ ì–‘ë°©í–¥ ì´ë™ ê°€ëŠ¥ (HQ â†” Branch)
- âœ… ë°˜ì‘í˜• ë””ìì¸ (Desktop/Tablet/Mobile)
- âœ… ê¸°ì¡´ í¼ ë°©ì‹ë„ ìœ ì§€

---

## ì œì•ˆí•˜ëŠ” UI ë””ìì¸

### í™”ë©´ ë ˆì´ì•„ì›ƒ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Inventory Management              [Table View] [Kanban View]    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

[Kanban View ì„ íƒ ì‹œ]

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ”½ Korea HQ (3 products, 350 units)              [Expanded] â–¼    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ğŸ“¦ Serum A (SA001)              Batch: B001   ğŸŸ¡ Exp: 2025-12-15 â”‚
â”‚  â”‚ 50 units â€¢ Mfg: 2024-06-15 â€¢ â‚©15,000/unit                 â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ğŸ“¦ Cream B (CB002)              Batch: B002   â¬œ Exp: 2026-02-01 â”‚
â”‚  â”‚ 200 units â€¢ Mfg: 2024-08-01 â€¢ â‚©25,000/unit                â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ğŸ“¦ Cleanser C (CL003)           Batch: B003   ğŸ”´ Exp: 2025-09-30 â”‚
â”‚  â”‚ 100 units â€¢ Mfg: 2024-03-30 â€¢ â‚©12,000/unit                â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â–¶ Vietnam Branch (2 products, 200 units)        [Collapsed] â–¶   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†‘
                    [ë“œë˜ê·¸í•´ì„œ ì—¬ê¸°ì— ë“œë¡­]

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â–¶ China Branch (1 product, 45 units)            [Collapsed] â–¶   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Product Card ìƒì„¸ ë””ìì¸

**Desktop/Tablet (ê°€ë¡œë¡œ ê¸´ í˜•íƒœ):**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ§´ Serum A (SA001)        Batch: B001        ğŸŸ¡ Exp: 2025-12-15  â”‚
â”‚ 150 units available â€¢ Mfg: 2024-06-15 â€¢ â‚©15,000/unit             â”‚
â”‚                                                    [Drag Handle]  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†‘ Grab cursor on hover
```

**Mobile (ì„¸ë¡œë¡œ ìŠ¤íƒ):**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ§´ Serum A (SA001)          â”‚
â”‚ Batch: B001                 â”‚
â”‚ ğŸŸ¡ Exp: 2025-12-15          â”‚
â”‚                             â”‚
â”‚ 150 units available         â”‚
â”‚ Mfg: 2024-06-15             â”‚
â”‚ â‚©15,000/unit                â”‚
â”‚                             â”‚
â”‚              [Drag Handle]  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ë°˜ì‘í˜• ë¸Œë ˆì´í¬í¬ì¸íŠ¸

| í™”ë©´ í¬ê¸° | ë ˆì´ì•„ì›ƒ | Card ìŠ¤íƒ€ì¼ |
|----------|---------|------------|
| Desktop (â‰¥1024px) | ë„“ì€ ê°€ë¡œ ì¹´ë“œ | í•œ ì¤„ì— ëª¨ë“  ì •ë³´ |
| Tablet (768-1023px) | ì¤‘ê°„ ê°€ë¡œ ì¹´ë“œ | 2ì¤„ë¡œ ì •ë³´ ë¶„í•  |
| Mobile (<768px) | ì„¸ë¡œ ìŠ¤íƒ ì¹´ë“œ | ê° ì •ë³´ ë³„ë„ ì¤„ |

**Tailwind CSS í´ë˜ìŠ¤ ì˜ˆì‹œ:**
```tsx
<div className="
  flex flex-col md:flex-row
  md:items-center md:justify-between
  gap-2 md:gap-4
  p-3 md:p-4
">
  {/* Content */}
</div>
```

---

## ê¸°ìˆ  ìŠ¤íƒ ì„ ì •

### 1. ë“œë˜ê·¸ ì•¤ ë“œë¡­ ë¼ì´ë¸ŒëŸ¬ë¦¬

**ì„ íƒ:** `@dnd-kit`

**ì´ìœ :**
- Next.js 14 + React í˜¸í™˜ì„± í™•ì‹¤
- TypeScript ë„¤ì´í‹°ë¸Œ ì§€ì›
- ì ‘ê·¼ì„±(a11y) ë‚´ì¥
- shadcn/uiì™€ ì˜ ì–´ìš¸ë¦¼
- í™œë°œí•œ ìœ ì§€ë³´ìˆ˜

### 2. Accordion ì»´í¬ë„ŒíŠ¸

**ì„ íƒ:** shadcn/ui `Accordion`

**ì´ë¯¸ í”„ë¡œì íŠ¸ì— ì„¤ì¹˜ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸ í•„ìš”**

ì„¤ì¹˜ ëª…ë ¹ì–´:
```bash
npx shadcn@latest add accordion
```

### 3. í•„ìš”í•œ íŒ¨í‚¤ì§€

```bash
npm install @dnd-kit/core @dnd-kit/sortable @dnd-kit/utilities
```

**íŒ¨í‚¤ì§€ ì„¤ëª…:**
- `@dnd-kit/core` - í•µì‹¬ ë“œë˜ê·¸ ì•¤ ë“œë¡­ ë¡œì§
- `@dnd-kit/sortable` - ì •ë ¬ìš© (ë¯¸ë˜ í™•ì¥ì„±)
- `@dnd-kit/utilities` - CSS Transform ìœ í‹¸ë¦¬í‹°

---

## êµ¬í˜„ ê³„íš

### Phase 1: UI ë·° ì „í™˜ ê¸°ëŠ¥ ì¶”ê°€

**íŒŒì¼:** `app/(dashboard)/inventory/page.tsx`

**ì‘ì—… ë‚´ìš©:**
1. Server Componentë¥¼ Client Componentë¡œ ë³€ê²½ (useState ì‚¬ìš© í•„ìš”)
2. ìƒë‹¨ì— ë·° ì „í™˜ ë²„íŠ¼ ì¶”ê°€ (Table View / Kanban View)
3. ìƒíƒœ ê´€ë¦¬ë¡œ í˜„ì¬ ë·° ëª¨ë“œ ì €ì¥
4. ì¡°ê±´ë¶€ ë Œë”ë§

```tsx
'use client'

import { useState } from 'react'
import { Button } from '@/components/ui/button'
import { InventoryList } from '@/components/inventory/inventory-list'
import { InventoryKanban } from '@/components/inventory/inventory-kanban'

export default function InventoryPage() {
  const [viewMode, setViewMode] = useState<'table' | 'kanban'>('table')

  // ë°ì´í„° í˜ì¹­ ë¡œì§ (useEffect + Supabase client)
  // ë˜ëŠ” Server Componentì—ì„œ ë°›ì€ props ì‚¬ìš©

  return (
    <div className="container mx-auto py-6">
      {/* í—¤ë” */}
      <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">
        <h1 className="text-2xl font-bold">Inventory Management</h1>

        {/* ë·° ì „í™˜ ë²„íŠ¼ - HQ Adminë§Œ í‘œì‹œ */}
        {profile.role === 'HQ_Admin' && (
          <div className="flex gap-2">
            <Button
              variant={viewMode === 'table' ? 'default' : 'outline'}
              onClick={() => setViewMode('table')}
            >
              Table View
            </Button>
            <Button
              variant={viewMode === 'kanban' ? 'default' : 'outline'}
              onClick={() => setViewMode('kanban')}
            >
              Kanban View
            </Button>
          </div>
        )}
      </div>

      {/* ì¡°ê±´ë¶€ ë Œë”ë§ */}
      {viewMode === 'table' ? (
        <InventoryList stockBatches={stockBatches} locations={locations} />
      ) : (
        <InventoryKanban
          stockBatches={stockBatches}
          locations={locations}
          userRole={profile.role}
        />
      )}
    </div>
  )
}
```

**ì¤‘ìš” ë³€ê²½:**
- Server Component â†’ Client Component ì „í™˜
- ë°ì´í„° í˜ì¹­ì„ í´ë¼ì´ì–¸íŠ¸ì—ì„œ ìˆ˜í–‰ (Supabase client ì‚¬ìš©)
- ë˜ëŠ” Server Action ì‚¬ìš© ê³ ë ¤

### Phase 2: ì¬ê³  ë°ì´í„° ë°°ì¹˜ë³„ ë¶„ë¦¬

**íŒŒì¼:** `lib/inventory-utils.ts` (ì‹ ê·œ ìƒì„±)

**ì‘ì—… ë‚´ìš©:**
ë°°ì¹˜ë³„ë¡œ ê°œë³„ ì¹´ë“œë¥¼ í‘œì‹œí•˜ê¸° ìœ„í•´ ë°ì´í„°ë¥¼ Locationë³„ë¡œë§Œ ê·¸ë£¹í™”

```typescript
import { StockBatch, Location } from '@/types'

// Locationë³„ë¡œ ê·¸ë£¹í™” (ë°°ì¹˜ëŠ” ê·¸ëŒ€ë¡œ ìœ ì§€)
export function groupBatchesByLocation(batches: StockBatch[]) {
  const grouped: Record<string, StockBatch[]> = {}

  batches.forEach((batch) => {
    const locId = batch.location_id
    if (!grouped[locId]) {
      grouped[locId] = []
    }
    grouped[locId].push(batch)
  })

  // ê° Location ë‚´ì—ì„œ FIFO ìˆœì„œë¡œ ì •ë ¬ (ë§Œë£Œì¼ ë¹ ë¥¸ ìˆœ)
  Object.keys(grouped).forEach((locId) => {
    grouped[locId].sort((a, b) =>
      new Date(a.expiry_date).getTime() - new Date(b.expiry_date).getTime()
    )
  })

  return grouped
}

// Locationë³„ ì´ ìˆ˜ëŸ‰ ê³„ì‚°
export function calculateLocationStats(batches: StockBatch[]) {
  return {
    totalUnits: batches.reduce((sum, b) => sum + b.qty_on_hand, 0),
    productCount: new Set(batches.map(b => b.product_id)).size,
  }
}

// ë§Œë£Œì¼ ê¸°ë°˜ Badge variant ê³„ì‚°
export function getExpiryBadgeVariant(expiryDate: string):
  'destructive' | 'warning' | 'secondary' | 'outline' {
  const today = new Date()
  const expiry = new Date(expiryDate)
  const daysUntilExpiry = Math.floor(
    (expiry.getTime() - today.getTime()) / (1000 * 60 * 60 * 24)
  )

  if (daysUntilExpiry < 0) return 'destructive' // ë§Œë£Œë¨
  if (daysUntilExpiry < 30) return 'destructive' // 30ì¼ ì´ë‚´
  if (daysUntilExpiry < 90) return 'warning' // 30-90ì¼ (ë…¸ë‘)
  if (daysUntilExpiry < 180) return 'secondary' // 90-180ì¼ (íšŒìƒ‰)
  return 'outline' // 180ì¼ ì´ìƒ
}

// ë§Œë£Œì¼ ì´ëª¨ì§€
export function getExpiryEmoji(expiryDate: string): string {
  const today = new Date()
  const expiry = new Date(expiryDate)
  const daysUntilExpiry = Math.floor(
    (expiry.getTime() - today.getTime()) / (1000 * 60 * 60 * 24)
  )

  if (daysUntilExpiry < 0) return 'ğŸ”´'
  if (daysUntilExpiry < 30) return 'ğŸ”´'
  if (daysUntilExpiry < 90) return 'ğŸŸ¡'
  if (daysUntilExpiry < 180) return 'âšª'
  return 'â¬œ'
}

// í†µí™” í¬ë§·íŒ…
export function formatCurrency(amount: number, currency: string): string {
  const locale =
    currency === 'KRW' ? 'ko-KR' :
    currency === 'VND' ? 'vi-VN' :
    'zh-CN'

  return new Intl.NumberFormat(locale, {
    style: 'currency',
    currency,
    minimumFractionDigits: currency === 'CNY' ? 2 : 0,
  }).format(amount)
}

// ë‚ ì§œ í¬ë§·íŒ…
export function formatDate(dateString: string): string {
  return new Date(dateString).toLocaleDateString('en-US', {
    year: 'numeric',
    month: '2-digit',
    day: '2-digit',
  })
}
```

### Phase 3: Kanban ë³´ë“œ ì»´í¬ë„ŒíŠ¸ ìƒì„±

**íŒŒì¼:** `components/inventory/inventory-kanban.tsx` (ì‹ ê·œ ìƒì„±)

**êµ¬ì¡°:**

```tsx
'use client'

import { useState } from 'react'
import { DndContext, DragEndEvent, DragStartEvent, DragOverlay } from '@dnd-kit/core'
import { Accordion } from '@/components/ui/accordion'
import { LocationAccordion } from './location-accordion'
import { BatchCard } from './batch-card'
import { TransferDialog } from './transfer-dialog'
import { groupBatchesByLocation } from '@/lib/inventory-utils'
import { toast } from 'sonner'

interface InventoryKanbanProps {
  stockBatches: StockBatch[]
  locations: Location[]
  userRole: string
}

export function InventoryKanban({
  stockBatches,
  locations,
  userRole
}: InventoryKanbanProps) {
  const [activeBatch, setActiveBatch] = useState<StockBatch | null>(null)
  const [showTransferDialog, setShowTransferDialog] = useState(false)
  const [transferData, setTransferData] = useState<TransferData | null>(null)

  // ë°ì´í„° ê·¸ë£¹í™” (Locationë³„)
  const groupedBatches = groupBatchesByLocation(stockBatches)

  // HQ Location ì°¾ê¸°
  const hqLocation = locations.find(l => l.location_type === 'HQ')

  const handleDragStart = (event: DragStartEvent) => {
    const { active } = event
    setActiveBatch(active.data.current?.batch)
  }

  const handleDragEnd = (event: DragEndEvent) => {
    const { active, over } = event

    if (!over) {
      setActiveBatch(null)
      return
    }

    // Sourceì™€ Target location ì¶”ì¶œ
    const sourceBatch = active.data.current?.batch as StockBatch
    const sourceLocationId = sourceBatch.location_id
    const targetLocationId = over.id.toString()

    // ê°™ì€ ìœ„ì¹˜ì— ë“œë¡­ - ì•„ë¬´ê²ƒë„ ì•ˆ í•¨
    if (sourceLocationId === targetLocationId) {
      setActiveBatch(null)
      return
    }

    // Location ì •ë³´ ê°€ì ¸ì˜¤ê¸°
    const sourceLocation = locations.find(l => l.id === sourceLocationId)
    const targetLocation = locations.find(l => l.id === targetLocationId)

    if (!sourceLocation || !targetLocation) {
      toast.error('Invalid location')
      setActiveBatch(null)
      return
    }

    // ê¶Œí•œ ì²´í¬ - HQ Adminë§Œ ì´ë™ ê°€ëŠ¥
    if (userRole !== 'HQ_Admin') {
      toast.error('Only HQ Admin can transfer stock')
      setActiveBatch(null)
      return
    }

    // HQ â†” Branch ì´ë™ë§Œ í—ˆìš© (ì–‘ë°©í–¥)
    const isValidTransfer =
      (sourceLocation.location_type === 'HQ' && targetLocation.location_type === 'Branch') ||
      (sourceLocation.location_type === 'Branch' && targetLocation.location_type === 'HQ')

    if (!isValidTransfer) {
      toast.error('Can only transfer between HQ and Branches')
      setActiveBatch(null)
      return
    }

    // Transfer ë‹¤ì´ì–¼ë¡œê·¸ í‘œì‹œ
    setTransferData({
      batch: sourceBatch,
      fromLocation: sourceLocation,
      toLocation: targetLocation,
      availableQty: sourceBatch.qty_on_hand, // í•´ë‹¹ ë°°ì¹˜ì˜ ìˆ˜ëŸ‰
    })
    setShowTransferDialog(true)
    setActiveBatch(null)
  }

  const handleTransferSuccess = () => {
    setShowTransferDialog(false)
    setTransferData(null)
    // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ìœ¼ë¡œ ë°ì´í„° ì—…ë°ì´íŠ¸
    window.location.reload()
  }

  return (
    <>
      <DndContext
        onDragStart={handleDragStart}
        onDragEnd={handleDragEnd}
      >
        {/* Accordion ì»¨í…Œì´ë„ˆ */}
        <Accordion
          type="multiple"
          defaultValue={hqLocation ? [hqLocation.id] : []}  // Korea HQë§Œ ê¸°ë³¸ í¼ì¹¨
          className="space-y-4"
        >
          {locations.map((location) => (
            <LocationAccordion
              key={location.id}
              location={location}
              batches={groupedBatches[location.id] || []}
              userRole={userRole}
            />
          ))}
        </Accordion>

        {/* ë“œë˜ê·¸ ì¤‘ ì˜¤ë²„ë ˆì´ */}
        <DragOverlay>
          {activeBatch ? (
            <BatchCard batch={activeBatch} isDragging />
          ) : null}
        </DragOverlay>
      </DndContext>

      {/* Transfer í™•ì¸ ë‹¤ì´ì–¼ë¡œê·¸ */}
      {showTransferDialog && transferData && (
        <TransferDialog
          open={showTransferDialog}
          onClose={() => setShowTransferDialog(false)}
          transferData={transferData}
          onSuccess={handleTransferSuccess}
        />
      )}
    </>
  )
}

// TransferData íƒ€ì…
interface TransferData {
  batch: StockBatch
  fromLocation: Location
  toLocation: Location
  availableQty: number
}
```

### Phase 4: Location Accordion ì»´í¬ë„ŒíŠ¸

**íŒŒì¼:** `components/inventory/location-accordion.tsx` (ì‹ ê·œ ìƒì„±)

```tsx
'use client'

import { useDroppable } from '@dnd-kit/core'
import {
  AccordionItem,
  AccordionTrigger,
  AccordionContent,
} from '@/components/ui/accordion'
import { Badge } from '@/components/ui/badge'
import { BatchCard } from './batch-card'
import { calculateLocationStats } from '@/lib/inventory-utils'
import { cn } from '@/lib/utils'

interface LocationAccordionProps {
  location: Location
  batches: StockBatch[]
  userRole: string
}

export function LocationAccordion({
  location,
  batches,
  userRole
}: LocationAccordionProps) {
  // AccordionTriggerë¥¼ Droppable ì˜ì—­ìœ¼ë¡œ ì„¤ì •
  const { setNodeRef, isOver } = useDroppable({
    id: location.id,
  })

  // Location í†µê³„
  const stats = calculateLocationStats(batches)

  return (
    <AccordionItem
      value={location.id}
      className={cn(
        'border rounded-lg',
        isOver && 'ring-2 ring-primary bg-accent/50'  // ë“œë¡­ ê°€ëŠ¥ ì‹œ í•˜ì´ë¼ì´íŠ¸
      )}
    >
      {/* Header - Droppable ì˜ì—­ */}
      <AccordionTrigger
        ref={setNodeRef}
        className={cn(
          'px-4 py-3 hover:no-underline',
          isOver && 'bg-accent'
        )}
      >
        <div className="flex items-center justify-between w-full pr-4">
          {/* Left: Location ì •ë³´ */}
          <div className="flex items-center gap-3">
            <span className="font-semibold text-lg">{location.name}</span>
            <Badge variant="outline" className="text-xs">
              {location.location_type}
            </Badge>
            <Badge variant="secondary" className="text-xs">
              {location.currency}
            </Badge>
          </div>

          {/* Right: í†µê³„ */}
          <div className="flex items-center gap-4 text-sm text-muted-foreground">
            <span>{stats.productCount} products</span>
            <span className="font-semibold text-foreground">
              {stats.totalUnits} units
            </span>
          </div>
        </div>
      </AccordionTrigger>

      {/* Content - Product Cards */}
      <AccordionContent className="px-4 pb-4 pt-2">
        {batches.length === 0 ? (
          <div className="text-center py-8 text-muted-foreground">
            No stock available
          </div>
        ) : (
          <div className="space-y-2">
            {batches.map((batch) => (
              <BatchCard
                key={batch.id}
                batch={batch}
                locationId={location.id}
                isDraggable={userRole === 'HQ_Admin'}
              />
            ))}
          </div>
        )}
      </AccordionContent>
    </AccordionItem>
  )
}
```

### Phase 5: Batch Card ì»´í¬ë„ŒíŠ¸

**íŒŒì¼:** `components/inventory/batch-card.tsx` (ì‹ ê·œ ìƒì„±)

**ê°€ë¡œë¡œ ê¸´ ì¹´ë“œ + ë°˜ì‘í˜•:**

```tsx
'use client'

import { useDraggable } from '@dnd-kit/core'
import { CSS } from '@dnd-kit/utilities'
import { Badge } from '@/components/ui/badge'
import { GripVertical } from 'lucide-react'
import {
  getExpiryBadgeVariant,
  getExpiryEmoji,
  formatCurrency,
  formatDate
} from '@/lib/inventory-utils'
import { cn } from '@/lib/utils'

interface BatchCardProps {
  batch: StockBatch
  locationId?: string
  isDraggable?: boolean
  isDragging?: boolean
}

export function BatchCard({
  batch,
  locationId,
  isDraggable = true,
  isDragging = false
}: BatchCardProps) {
  const { attributes, listeners, setNodeRef, transform } = useDraggable({
    id: `batch-${batch.id}`,
    data: { batch, locationId },
    disabled: !isDraggable,
  })

  const style = transform ? {
    transform: CSS.Translate.toString(transform),
  } : undefined

  // ë§Œë£Œì¼ ìƒ‰ìƒ ë° ì´ëª¨ì§€
  const expiryVariant = getExpiryBadgeVariant(batch.expiry_date)
  const expiryEmoji = getExpiryEmoji(batch.expiry_date)

  return (
    <div
      ref={setNodeRef}
      style={style}
      {...(isDraggable ? listeners : {})}
      {...(isDraggable ? attributes : {})}
      className={cn(
        'group relative',
        'bg-card border rounded-lg',
        'transition-all duration-200',
        isDraggable && 'cursor-grab active:cursor-grabbing hover:shadow-md hover:border-primary/50',
        isDragging && 'opacity-50 shadow-lg',
        !isDraggable && 'cursor-default'
      )}
    >
      {/* Card Content - ë°˜ì‘í˜• ë ˆì´ì•„ì›ƒ */}
      <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-2 md:gap-4 p-3 md:p-4">

        {/* Left Section: ì œí’ˆ ì •ë³´ */}
        <div className="flex items-start gap-3 flex-1 min-w-0">
          {/* Drag Handle - Desktopë§Œ í‘œì‹œ */}
          {isDraggable && (
            <GripVertical
              className="hidden md:block w-5 h-5 text-muted-foreground flex-shrink-0 mt-1"
            />
          )}

          {/* ì œí’ˆëª… + SKU */}
          <div className="flex-1 min-w-0">
            <div className="flex items-center gap-2 flex-wrap">
              <span className="font-medium truncate">
                {batch.product?.name || 'Unknown Product'}
              </span>
              <Badge variant="outline" className="text-xs flex-shrink-0">
                {batch.product?.sku}
              </Badge>
            </div>

            {/* ë°°ì¹˜ ë²ˆí˜¸ - Mobileì—ì„œëŠ” ì•„ë˜ë¡œ */}
            <div className="mt-1 text-sm text-muted-foreground">
              ğŸ“¦ Batch: <span className="font-mono">{batch.batch_no}</span>
            </div>
          </div>
        </div>

        {/* Middle Section: ìˆ˜ëŸ‰ ë° ë‚ ì§œ - ë°˜ì‘í˜• */}
        <div className="flex flex-col md:flex-row md:items-center gap-2 md:gap-6 text-sm">

          {/* ìˆ˜ëŸ‰ */}
          <div className="flex items-center gap-2">
            <span className="text-muted-foreground">Qty:</span>
            <span className="font-semibold text-base">{batch.qty_on_hand}</span>
            <span className="text-muted-foreground">{batch.product?.unit || 'units'}</span>
          </div>

          {/* ì œì¡°ì¼ì */}
          <div className="flex items-center gap-2">
            <span className="text-muted-foreground">Mfg:</span>
            <span className="font-mono text-xs">{formatDate(batch.manufactured_date)}</span>
          </div>

          {/* ë‹¨ê°€ */}
          <div className="flex items-center gap-2">
            <span className="text-muted-foreground">Cost:</span>
            <span className="font-semibold">
              {formatCurrency(batch.unit_cost, batch.location?.currency || 'KRW')}
            </span>
          </div>
        </div>

        {/* Right Section: ë§Œë£Œì¼ Badge */}
        <div className="flex items-center gap-2 flex-shrink-0">
          <span className="text-xl" aria-hidden="true">{expiryEmoji}</span>
          <div className="flex flex-col items-end">
            <span className="text-xs text-muted-foreground">Expiry</span>
            <Badge variant={expiryVariant} className="font-mono text-xs">
              {formatDate(batch.expiry_date)}
            </Badge>
          </div>
        </div>

        {/* Quality Status Badge (OKê°€ ì•„ë‹ ë•Œë§Œ) */}
        {batch.quality_status !== 'OK' && (
          <div className="absolute top-2 right-2 md:relative md:top-0 md:right-0">
            <Badge
              variant={batch.quality_status === 'Damaged' ? 'destructive' : 'secondary'}
              className="text-xs"
            >
              {batch.quality_status}
            </Badge>
          </div>
        )}
      </div>

      {/* Drag Indicator - ë“œë˜ê·¸ ì¤‘ í‘œì‹œ */}
      {isDraggable && (
        <div className="absolute inset-0 rounded-lg border-2 border-primary opacity-0 group-hover:opacity-100 pointer-events-none transition-opacity" />
      )}
    </div>
  )
}
```

**ë°˜ì‘í˜• ë¸Œë ˆì´í¬í¬ì¸íŠ¸ ì„¤ëª…:**

| í´ë˜ìŠ¤ | í™”ë©´ í¬ê¸° | íš¨ê³¼ |
|--------|----------|------|
| `flex-col md:flex-row` | <768px: ì„¸ë¡œ, â‰¥768px: ê°€ë¡œ | ë ˆì´ì•„ì›ƒ ë°©í–¥ ì „í™˜ |
| `gap-2 md:gap-4` | <768px: 8px, â‰¥768px: 16px | ê°„ê²© ì¡°ì • |
| `p-3 md:p-4` | <768px: 12px, â‰¥768px: 16px | íŒ¨ë”© ì¡°ì • |
| `hidden md:block` | <768px: ìˆ¨ê¹€, â‰¥768px: í‘œì‹œ | Drag handle ìˆ¨ê¹€ |

### Phase 6: Transfer í™•ì¸ ë‹¤ì´ì–¼ë¡œê·¸

**íŒŒì¼:** `components/inventory/transfer-dialog.tsx` (ì‹ ê·œ ìƒì„±)

```tsx
'use client'

import { useState } from 'react'
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogFooter,
  DialogDescription,
} from '@/components/ui/dialog'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { Label } from '@/components/ui/label'
import { Badge } from '@/components/ui/badge'
import { ArrowRight } from 'lucide-react'
import { toast } from 'sonner'
import { formatDate } from '@/lib/inventory-utils'

interface TransferDialogProps {
  open: boolean
  onClose: () => void
  onSuccess: () => void
  transferData: {
    batch: StockBatch
    fromLocation: Location
    toLocation: Location
    availableQty: number
  }
}

export function TransferDialog({
  open,
  onClose,
  onSuccess,
  transferData
}: TransferDialogProps) {
  const [quantity, setQuantity] = useState(transferData.availableQty.toString())
  const [isLoading, setIsLoading] = useState(false)

  const { batch, fromLocation, toLocation, availableQty } = transferData

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault()

    const qty = parseInt(quantity)

    // Validation
    if (isNaN(qty) || qty <= 0) {
      toast.error('Please enter a valid quantity')
      return
    }

    if (qty > availableQty) {
      toast.error(`Maximum available: ${availableQty} units`)
      return
    }

    setIsLoading(true)

    try {
      const response = await fetch('/api/inventory/transfer', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          from_location_id: fromLocation.id,
          to_location_id: toLocation.id,
          product_id: batch.product_id,
          qty,
        }),
      })

      const result = await response.json()

      if (!response.ok) {
        toast.error(result.error || 'Transfer failed')
        return
      }

      toast.success(result.message || 'Transfer completed successfully')
      onSuccess()
    } catch (error) {
      console.error('Transfer error:', error)
      toast.error('Network error. Please try again.')
    } finally {
      setIsLoading(false)
    }
  }

  return (
    <Dialog open={open} onOpenChange={onClose}>
      <DialogContent className="sm:max-w-md">
        <DialogHeader>
          <DialogTitle>Confirm Stock Transfer</DialogTitle>
          <DialogDescription>
            Review the transfer details and enter the quantity to move.
          </DialogDescription>
        </DialogHeader>

        <form onSubmit={handleSubmit}>
          <div className="space-y-4 py-4">

            {/* ì œí’ˆ ì •ë³´ */}
            <div className="p-3 bg-muted rounded-lg">
              <div className="flex items-center justify-between mb-1">
                <span className="font-medium">{batch.product?.name}</span>
                <Badge variant="outline">{batch.product?.sku}</Badge>
              </div>
              <div className="text-sm text-muted-foreground space-y-1">
                <div>Batch: {batch.batch_no}</div>
                <div>Expiry: {formatDate(batch.expiry_date)}</div>
              </div>
            </div>

            {/* From â†’ To */}
            <div className="flex items-center justify-between p-3 bg-accent/50 rounded-lg">
              <div className="flex-1">
                <div className="text-xs text-muted-foreground">From</div>
                <div className="font-medium">{fromLocation.name}</div>
                <Badge variant="outline" className="text-xs mt-1">
                  {fromLocation.location_type}
                </Badge>
              </div>

              <ArrowRight className="w-5 h-5 text-muted-foreground mx-4" />

              <div className="flex-1 text-right">
                <div className="text-xs text-muted-foreground">To</div>
                <div className="font-medium">{toLocation.name}</div>
                <Badge variant="outline" className="text-xs mt-1">
                  {toLocation.location_type}
                </Badge>
              </div>
            </div>

            {/* ê°€ìš© ìˆ˜ëŸ‰ */}
            <div className="p-3 border rounded-lg">
              <div className="text-sm text-muted-foreground">Available in this batch</div>
              <div className="text-2xl font-bold text-primary">
                {availableQty} <span className="text-base font-normal">{batch.product?.unit || 'units'}</span>
              </div>
            </div>

            {/* ìˆ˜ëŸ‰ ì…ë ¥ */}
            <div className="space-y-2">
              <Label htmlFor="quantity">Quantity to Transfer *</Label>
              <Input
                id="quantity"
                type="number"
                min="1"
                max={availableQty}
                value={quantity}
                onChange={(e) => setQuantity(e.target.value)}
                placeholder="Enter quantity"
                required
                autoFocus
              />
              <p className="text-xs text-muted-foreground">
                Max: {availableQty} units available
              </p>
            </div>
          </div>

          <DialogFooter className="gap-2">
            <Button
              type="button"
              variant="outline"
              onClick={onClose}
              disabled={isLoading}
            >
              Cancel
            </Button>
            <Button type="submit" disabled={isLoading}>
              {isLoading ? 'Transferring...' : 'Confirm Transfer'}
            </Button>
          </DialogFooter>
        </form>
      </DialogContent>
    </Dialog>
  )
}
```

### Phase 7: Badge Variant í™•ì¥

**íŒŒì¼:** `components/ui/badge.tsx` (ê¸°ì¡´ íŒŒì¼ ìˆ˜ì •)

shadcn/uiì˜ Badge ì»´í¬ë„ŒíŠ¸ì— `warning` variant ì¶”ê°€ í•„ìš”:

```tsx
const badgeVariants = cva(
  "inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2",
  {
    variants: {
      variant: {
        default: "border-transparent bg-primary text-primary-foreground hover:bg-primary/80",
        secondary: "border-transparent bg-secondary text-secondary-foreground hover:bg-secondary/80",
        destructive: "border-transparent bg-destructive text-destructive-foreground hover:bg-destructive/80",
        outline: "text-foreground",
        // ì¶”ê°€: warning variant
        warning: "border-transparent bg-yellow-500 text-white hover:bg-yellow-600",
      },
    },
    defaultVariants: {
      variant: "default",
    },
  }
)
```

---

## ê¶Œí•œ ì œì–´

### 1. UI ë ˆë²¨ ê¶Œí•œ ì²´í¬

**Kanban View ì ‘ê·¼:**
- HQ Adminë§Œ ë²„íŠ¼ í‘œì‹œ
- Branch ManagerëŠ” Table Viewë§Œ ì‚¬ìš©

```tsx
{profile.role === 'HQ_Admin' && (
  <Button variant={viewMode === 'kanban' ? 'default' : 'outline'}>
    Kanban View
  </Button>
)}
```

### 2. ë“œë˜ê·¸ ì œí•œ

**ì¡°ê±´:**
- HQ Adminë§Œ ë“œë˜ê·¸ ê°€ëŠ¥
- HQ â†” Branch ì–‘ë°©í–¥ ì´ë™ í—ˆìš©
- Branch â†” Branch ë¶ˆê°€
- HQ â†” HQ ë¶ˆê°€

**êµ¬í˜„:** `handleDragEnd` í•¨ìˆ˜ì—ì„œ validation

```tsx
// ê¶Œí•œ ì²´í¬
if (userRole !== 'HQ_Admin') {
  toast.error('Only HQ Admin can transfer stock')
  return
}

// Location íƒ€ì… ì²´í¬
const isValidTransfer =
  (sourceLocation.location_type === 'HQ' && targetLocation.location_type === 'Branch') ||
  (sourceLocation.location_type === 'Branch' && targetLocation.location_type === 'HQ')

if (!isValidTransfer) {
  toast.error('Can only transfer between HQ and Branches')
  return
}
```

### 3. API ë ˆë²¨ ê¶Œí•œ ì²´í¬

**íŒŒì¼:** `app/api/inventory/transfer/route.ts` (ê¸°ì¡´ íŒŒì¼ ìˆ˜ì • í•„ìš”)

í˜„ì¬ APIëŠ” HQ â†’ Branchë§Œ í—ˆìš©í•˜ëŠ”ë°, Branch â†’ HQë„ í—ˆìš©í•˜ë„ë¡ ìˆ˜ì •:

```typescript
// ê¸°ì¡´ ì²´í¬ ì œê±°/ìˆ˜ì •
// if (fromLocation.location_type !== 'HQ') { ... }

// ìƒˆë¡œìš´ ì²´í¬
const isValidTransfer =
  (fromLocation.location_type === 'HQ' && toLocation.location_type === 'Branch') ||
  (fromLocation.location_type === 'Branch' && toLocation.location_type === 'HQ')

if (!isValidTransfer) {
  return NextResponse.json(
    { error: 'Can only transfer between HQ and Branches' },
    { status: 400 }
  )
}
```

---

## ì‚¬ìš©ì ê²½í—˜ (UX) ê°œì„  ì‚¬í•­

### 1. ì‹œê°ì  í”¼ë“œë°±

| ìƒíƒœ | íš¨ê³¼ |
|------|------|
| Hover (ì¹´ë“œ) | `hover:shadow-md hover:border-primary/50` |
| Hover (Accordion Header) | `group-hover:opacity-100` (border í‘œì‹œ) |
| ë“œë˜ê·¸ ì‹œì‘ | ì¹´ë“œ íˆ¬ëª…ë„ 50%, ì»¤ì„œ `grabbing` |
| ë“œë¡­ ê°€ëŠ¥ ì˜ì—­ | Target Accordionì— `ring-2 ring-primary` + `bg-accent/50` |
| ë“œë˜ê·¸ ì¤‘ | DragOverlayë¡œ ì›ë³¸ ì¹´ë“œ í‘œì‹œ (ë°°ê²½ ë°˜íˆ¬ëª…) |
| ë“œë¡­ ì™„ë£Œ | Toast success + í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ |

### 2. ë§Œë£Œì¼ ìƒ‰ìƒ ì‹œìŠ¤í…œ

| ì¡°ê±´ | ìƒ‰ìƒ | Variant |
|------|------|---------|
| ë§Œë£Œë¨ | ğŸ”´ ë¹¨ê°• | `destructive` |
| < 30ì¼ | ğŸ”´ ë¹¨ê°• | `destructive` |
| 30-90ì¼ | ğŸŸ¡ ë…¸ë‘ | `warning` |
| 90-180ì¼ | âšª íšŒìƒ‰ | `secondary` |
| 180ì¼+ | â¬œ í°ìƒ‰ | `outline` |

### 3. ì—ëŸ¬ ì²˜ë¦¬

| ì‹œë‚˜ë¦¬ì˜¤ | ì²˜ë¦¬ ë°©ë²• |
|----------|-----------|
| ê°™ì€ ìœ„ì¹˜ì— ë“œë¡­ | ì¡°ìš©íˆ ë¬´ì‹œ (Toast ì—†ìŒ) |
| ê¶Œí•œ ì—†ìŒ | Toast error: "Only HQ Admin..." |
| ì˜ëª»ëœ ì´ë™ (Branch â†” Branch) | Toast error: "Can only transfer..." |
| API ì˜¤ë¥˜ | Toast error with message |
| ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ | Toast error: "Network error..." |

### 4. ë¡œë”© ìƒíƒœ

- Transfer ì§„í–‰ ì¤‘ â†’ Dialog ë²„íŠ¼ disabled + "Transferring..." í…ìŠ¤íŠ¸
- ì™„ë£Œ í›„ â†’ Toast success + `window.location.reload()`

### 5. ì ‘ê·¼ì„± (Accessibility)

- `@dnd-kit` ë‚´ì¥ í‚¤ë³´ë“œ ë„¤ë¹„ê²Œì´ì…˜
- ARIA labels ìë™ ì ìš©
- Screen reader ì§€ì›
- Focus ê´€ë¦¬ (Dialog ìë™ focus)

### 6. ëª¨ë°”ì¼ ìµœì í™”

**Touch ì´ë²¤íŠ¸:**
- `@dnd-kit`ê°€ ìë™ìœ¼ë¡œ í„°ì¹˜ ì´ë²¤íŠ¸ ì²˜ë¦¬
- ê¸¸ê²Œ ëˆŒëŸ¬ì„œ ë“œë˜ê·¸ ì‹œì‘

**ì„¸ë¡œ ë ˆì´ì•„ì›ƒ:**
- Accordionì´ ì„¸ë¡œë¡œ ìŠ¤íƒë˜ë¯€ë¡œ ëª¨ë°”ì¼ì— ì´ìƒì 
- ì¹´ë“œ ë‚´ë¶€ ì •ë³´ê°€ ì„¸ë¡œë¡œ ì¬ë°°ì¹˜

**Drag Handle:**
- Mobileì—ì„œëŠ” ìˆ¨ê¹€ (ì „ì²´ ì¹´ë“œê°€ í„°ì¹˜ ì˜ì—­)
- Desktopì—ì„œë§Œ GripVertical ì•„ì´ì½˜ í‘œì‹œ

---

## ë°ì´í„° íë¦„

```
1. Page Component (Client Component)
   â””â”€> Fetch stock_batches + locations from Supabase
   â””â”€> Pass to InventoryKanban

2. InventoryKanban
   â””â”€> Group batches by location_id
   â””â”€> Sort by expiry_date (FIFO)
   â””â”€> Pass to LocationAccordion

3. LocationAccordion
   â””â”€> Render Accordion with Droppable header
   â””â”€> Pass each batch to BatchCard

4. User drags BatchCard
   â””â”€> handleDragStart: Save activeBatch
   â””â”€> handleDragEnd:
       â”œâ”€> Validate locations (HQ â†” Branch)
       â”œâ”€> Validate permissions (HQ Admin)
       â””â”€> Show TransferDialog

5. User confirms in TransferDialog
   â””â”€> POST /api/inventory/transfer
       â”œâ”€> Validate again (API level)
       â”œâ”€> FIFO deduction (existing logic)
       â””â”€> Update stock_batches

6. Success
   â””â”€> Toast message
   â””â”€> window.location.reload()
   â””â”€> Updated data displayed
```

---

## API ìˆ˜ì • ì‚¬í•­

### ê¸°ì¡´ API í™•ì¥

**íŒŒì¼:** `app/api/inventory/transfer/route.ts`

**ìˆ˜ì • ë‚´ìš©:**

1. **Location íƒ€ì… ì²´í¬ ë³€ê²½** - Branch â†’ HQë„ í—ˆìš©

```typescript
// Before (ê¸°ì¡´)
if (fromLocation.location_type !== 'HQ') {
  return NextResponse.json(
    { error: 'Can only transfer from HQ' },
    { status: 400 }
  )
}

// After (ìˆ˜ì •)
const isValidTransfer =
  (fromLocation.location_type === 'HQ' && toLocation.location_type === 'Branch') ||
  (fromLocation.location_type === 'Branch' && toLocation.location_type === 'HQ')

if (!isValidTransfer) {
  return NextResponse.json(
    { error: 'Can only transfer between HQ and Branches (bidirectional)' },
    { status: 400 }
  )
}
```

2. **í†µí™” ì²˜ë¦¬** - Branch â†’ HQ ì´ë™ ì‹œ í†µí™” ì¬ê³„ì‚° í•„ìš” (ì„ íƒì )

í˜„ì¬ëŠ” `unit_cost`ë¥¼ ê·¸ëŒ€ë¡œ ë³µì‚¬í•˜ëŠ”ë°, Branchì—ì„œ HQë¡œ ëŒì•„ì˜¬ ë•Œ í†µí™”ê°€ ë‹¬ë¼ì„œ ë¬¸ì œê°€ ë  ìˆ˜ ìˆìŒ.

**Options:**
- **Option A:** ì›ë˜ ë¹„ìš© ê·¸ëŒ€ë¡œ ìœ ì§€ (ê°„ë‹¨)
- **Option B:** í˜„ì¬ í™˜ìœ¨ë¡œ ì¬ê³„ì‚° (ë³µì¡)

**MVPì—ì„œëŠ” Option A ì‚¬ìš©** (ë‚˜ì¤‘ì— ê°œì„ )

3. **ê¸°íƒ€ ë¡œì§ì€ ê·¸ëŒ€ë¡œ ìœ ì§€**
   - FIFO ìˆœì„œ ìœ ì§€
   - ë°°ì¹˜ ì •ë³´ ë³´ì¡´
   - Create or Update ë¡œì§

---

## í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤

### 1. ì •ìƒ ì‹œë‚˜ë¦¬ì˜¤ (HQ â†’ Branch)

| # | ì‘ì—… | ê¸°ëŒ€ ê²°ê³¼ |
|---|------|-----------|
| 1 | HQ Admin ë¡œê·¸ì¸ | Kanban View ë²„íŠ¼ í‘œì‹œ |
| 2 | Kanban View í´ë¦­ | Korea HQ í¼ì³ì§, VN/CN ì ‘í˜€ì§ |
| 3 | Serum A ì¹´ë“œ ë“œë˜ê·¸ ì‹œì‘ | ì¹´ë“œ íˆ¬ëª…ë„ 50%, DragOverlay í‘œì‹œ |
| 4 | Vietnam Branch í—¤ë”ë¡œ ë“œë˜ê·¸ | í—¤ë”ì— ring + bg-accent í‘œì‹œ |
| 5 | ë“œë¡­ | Transfer Dialog í‘œì‹œ |
| 6 | ìˆ˜ëŸ‰ 50 ì…ë ¥ í›„ Confirm | API í˜¸ì¶œ â†’ Success toast |
| 7 | í˜ì´ì§€ ë¦¬ë¡œë“œ | HQ ìˆ˜ëŸ‰ -50, VN ìˆ˜ëŸ‰ +50 |

### 2. ì •ìƒ ì‹œë‚˜ë¦¬ì˜¤ (Branch â†’ HQ)

| # | ì‘ì—… | ê¸°ëŒ€ ê²°ê³¼ |
|---|------|-----------|
| 1 | Vietnam Branch í¼ì¹˜ê¸° | VN ì œí’ˆ ì¹´ë“œë“¤ í‘œì‹œ |
| 2 | VNì˜ Cream B ì¹´ë“œ â†’ Korea HQ í—¤ë”ë¡œ ë“œë˜ê·¸ | í—ˆìš©ë¨ |
| 3 | ìˆ˜ëŸ‰ ì…ë ¥ í›„ Confirm | Transfer ì„±ê³µ |
| 4 | ì¬ê³  í™•ì¸ | VN ê°ì†Œ, HQ ì¦ê°€ |

### 3. ì—ëŸ¬ ì‹œë‚˜ë¦¬ì˜¤

| # | ì‘ì—… | ê¸°ëŒ€ ê²°ê³¼ |
|---|------|-----------|
| 1 | Branch Manager ë¡œê·¸ì¸ | Kanban View ë²„íŠ¼ ìˆ¨ê¹€ |
| 2 | VN ì¹´ë“œ â†’ CN í—¤ë”ë¡œ ë“œë˜ê·¸ | Error toast: "Only transfer between HQ and Branches" |
| 3 | ê°€ìš©ëŸ‰ ì´ˆê³¼ ì…ë ¥ | Error toast: "Maximum available: X" |
| 4 | ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ | Error toast: "Network error" |

### 4. FIFO ê²€ì¦ (ë°°ì¹˜ë³„ ì¹´ë“œ)

| ì´ˆê¸° ìƒíƒœ | ì‘ì—… | ê¸°ëŒ€ ê²°ê³¼ |
|----------|------|-----------|
| HQ:<br>- B001 ì¹´ë“œ: 50 units, Exp 2025-12<br>- B002 ì¹´ë“œ: 100 units, Exp 2026-03 | B001 ì¹´ë“œ ì „ì²´ (50 units) VNìœ¼ë¡œ ì´ë™ | VNì— B001 ì¹´ë“œ ìƒì„±: 50 units<br>HQì—ì„œ B001 ì¹´ë“œ ì‚¬ë¼ì§ |

### 5. ë°˜ì‘í˜• í…ŒìŠ¤íŠ¸

| í™”ë©´ í¬ê¸° | í™•ì¸ ì‚¬í•­ |
|----------|-----------|
| Desktop (1920px) | ê°€ë¡œ ê¸´ ì¹´ë“œ, ì •ë³´ í•œ ì¤„, Drag handle í‘œì‹œ |
| Tablet (768px) | ì¹´ë“œ ì •ë³´ 2ì¤„ë¡œ ë¶„í• , ì—¬ì „íˆ ê°€ë¡œ |
| Mobile (375px) | ì¹´ë“œ ì •ë³´ ì„¸ë¡œ ìŠ¤íƒ, Drag handle ìˆ¨ê¹€ |

### 6. Accordion ë™ì‘

| ì‘ì—… | ê¸°ëŒ€ ê²°ê³¼ |
|------|-----------|
| í˜ì´ì§€ ë¡œë“œ | Korea HQë§Œ í¼ì³ì§ |
| Vietnam í´ë¦­ | Vietnam í¼ì³ì§ |
| Korea í´ë¦­ | Korea ì ‘í˜ (ë‹¤ë¥¸ Accordionê³¼ ë…ë¦½) |
| ì—¬ëŸ¬ ê°œ ë™ì‹œ í¼ì¹˜ê¸° | `type="multiple"`ì´ë¯€ë¡œ ê°€ëŠ¥ |

---

## ë°°í¬ ë° ë¡¤ë°± ê³„íš

### ë°°í¬ ì „ ì²´í¬ë¦¬ìŠ¤íŠ¸

- [ ] `@dnd-kit` íŒ¨í‚¤ì§€ ì„¤ì¹˜ í™•ì¸
- [ ] shadcn/ui `accordion` ì»´í¬ë„ŒíŠ¸ ì„¤ì¹˜ í™•ì¸
- [ ] Badge `warning` variant ì¶”ê°€ í™•ì¸
- [ ] TypeScript ì»´íŒŒì¼ ì—ëŸ¬ ì—†ìŒ
- [ ] ê¸°ì¡´ Transfer Stock í˜ì´ì§€ ì •ìƒ ì‘ë™ í™•ì¸
- [ ] HQ Admin / Branch Manager ê°ê° í…ŒìŠ¤íŠ¸
- [ ] Desktop / Tablet / Mobile ë°˜ì‘í˜• í™•ì¸
- [ ] API ì–‘ë°©í–¥ ì´ë™ ìˆ˜ì • í™•ì¸

### ì„¤ì¹˜ ëª…ë ¹ì–´

```bash
# @dnd-kit íŒ¨í‚¤ì§€
npm install @dnd-kit/core @dnd-kit/sortable @dnd-kit/utilities

# shadcn/ui accordion (ë¯¸ì„¤ì¹˜ ì‹œ)
npx shadcn@latest add accordion

# sonner (Toast, ì´ë¯¸ ì„¤ì¹˜ë˜ì–´ ìˆì„ ê°€ëŠ¥ì„±)
npx shadcn@latest add sonner
```

### ë¡¤ë°± ë°©ë²•

**ë§Œì•½ ë¬¸ì œ ë°œìƒ ì‹œ:**
1. Kanban View ë²„íŠ¼ë§Œ ìˆ¨ê¹€ (ì¡°ê±´ë¶€ ë Œë”ë§)
2. ê¸°ì¡´ Table View + Transfer Stock í¼ì€ ì˜í–¥ ì—†ìŒ
3. APIëŠ” ê¸°ì¡´ ë¡œì§ë„ ìœ ì§€í•˜ë¯€ë¡œ ë¬¸ì œ ì—†ìŒ
4. ì ì§„ì  ë¡¤ë°± ê°€ëŠ¥

```tsx
// ê¸´ê¸‰ ë¡¤ë°± ì‹œ
const ENABLE_KANBAN = false  // feature flag

{profile.role === 'HQ_Admin' && ENABLE_KANBAN && (
  <Button>Kanban View</Button>
)}
```

---

## í–¥í›„ ê°œì„  ë°©í–¥ (Post-MVP)

### Phase 2 ê°œì„ ì‚¬í•­

1. **ë°°ì¹˜ ë‹¤ì¤‘ ì„ íƒ**
   - Shift + Clickìœ¼ë¡œ ì—¬ëŸ¬ ë°°ì¹˜ ì„ íƒ
   - í•œ ë²ˆì— ì—¬ëŸ¬ ë°°ì¹˜ ì´ë™

2. **ë¹ ë¥¸ ìˆ˜ëŸ‰ í”„ë¦¬ì…‹**
   - Dialogì— "Half", "All" ë²„íŠ¼ ì¶”ê°€
   - ìì£¼ ì‚¬ìš©í•˜ëŠ” ìˆ˜ëŸ‰ ì €ì¥

3. **ì´ë™ íˆìŠ¤í† ë¦¬ í‘œì‹œ**
   - ìµœê·¼ ì´ë™ ë‚´ì—­ íŒ¨ë„
   - Undo ê¸°ëŠ¥ (ì¼ì • ì‹œê°„ ë‚´)

4. **ì‹¤ì‹œê°„ ë™ê¸°í™”**
   - Supabase Realtime subscription
   - ë‹¤ë¥¸ ì‚¬ìš©ì ë³€ê²½ ì¦‰ì‹œ ë°˜ì˜
   - Optimistic UI ì—…ë°ì´íŠ¸

5. **í•„í„°ë§ & ê²€ìƒ‰**
   - ì œí’ˆëª… ê²€ìƒ‰
   - ë§Œë£Œì¼ ì„ë°• ì œí’ˆë§Œ í‘œì‹œ
   - ì¹´í…Œê³ ë¦¬ í•„í„°

6. **ë“œë˜ê·¸ ì• ë‹ˆë©”ì´ì…˜ ê°œì„ **
   - ë¶€ë“œëŸ¬ìš´ Snap íš¨ê³¼
   - Accordion ìë™ í¼ì¹˜ê¸° (ë“œë˜ê·¸ ì¤‘ í˜¸ë²„ ì‹œ)

7. **ë°°ì¹˜ ìƒì„¸ ì •ë³´ Popover**
   - ì¹´ë“œ í´ë¦­ ì‹œ ëª¨ë“  ë°°ì¹˜ ì •ë³´
   - Quality status ë³€ê²½ ê¸°ëŠ¥

8. **í†µí™” ìë™ ë³€í™˜**
   - Branch â†’ HQ ì´ë™ ì‹œ í™˜ìœ¨ ì ìš©
   - ì‹¤ì‹œê°„ í™˜ìœ¨ ì¡°íšŒ

9. **ëª¨ë°”ì¼ ì•± ìµœì í™”**
   - Bottom Sheet ìŠ¤íƒ€ì¼ Dialog
   - Swipe ì œìŠ¤ì²˜ ì§€ì›

---

## ì˜ˆìƒ ì‘ì—… ì‹œê°„

| Phase | ì‘ì—… ë‚´ìš© | ì˜ˆìƒ ì‹œê°„ |
|-------|----------|-----------|
| 1 | ë·° ì „í™˜ ê¸°ëŠ¥ + Client Component ë³€í™˜ | 1ì‹œê°„ |
| 2 | ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ì‘ì„± | 1ì‹œê°„ |
| 3 | Kanban ë³´ë“œ ì»´í¬ë„ŒíŠ¸ | 2ì‹œê°„ |
| 4 | Location Accordion ì»´í¬ë„ŒíŠ¸ | 1.5ì‹œê°„ |
| 5 | Batch Card ì»´í¬ë„ŒíŠ¸ (ë°˜ì‘í˜•) | 2.5ì‹œê°„ |
| 6 | Transfer Dialog | 1.5ì‹œê°„ |
| 7 | Badge variant ì¶”ê°€ | 30ë¶„ |
| 8 | API ì–‘ë°©í–¥ ì´ë™ ìˆ˜ì • | 1ì‹œê°„ |
| 9 | ê¶Œí•œ ì œì–´ ë° Validation | 1ì‹œê°„ |
| 10 | ìŠ¤íƒ€ì¼ë§ ë° UX ê°œì„  | 2ì‹œê°„ |
| 11 | ë°˜ì‘í˜• í…ŒìŠ¤íŠ¸ (Desktop/Tablet/Mobile) | 2ì‹œê°„ |
| 12 | í†µí•© í…ŒìŠ¤íŠ¸ ë° ë²„ê·¸ ìˆ˜ì • | 2ì‹œê°„ |

**ì´ ì˜ˆìƒ ì‹œê°„:** ì•½ 18ì‹œê°„ (2.5 ì‘ì—…ì¼)

---

## ìš”ì•½

### í•µì‹¬ ê¸°ëŠ¥

âœ… **ê¸°ì¡´ ë°©ì‹ ìœ ì§€:** Transfer Stock í¼ í˜ì´ì§€ ê·¸ëŒ€ë¡œ ì‚¬ìš© ê°€ëŠ¥
âœ… **ìƒˆë¡œìš´ ë°©ì‹ ì¶”ê°€:** ì„¸ë¡œ Accordion + ë“œë˜ê·¸ ì•¤ ë“œë¡­
âœ… **ë°°ì¹˜ë³„ ê°œë³„ ì¹´ë“œ:** ëª¨ë“  ë°°ì¹˜ ì •ë³´ ìƒì„¸ í‘œì‹œ
âœ… **ê°€ë¡œë¡œ ê¸´ ì¹´ë“œ ë””ìì¸:** í•œëˆˆì— ëª¨ë“  ì •ë³´ íŒŒì•…
âœ… **ë°˜ì‘í˜• ë””ìì¸:** Desktop/Tablet/Mobile ëª¨ë‘ ìµœì í™”
âœ… **ì ‘ì„ ìˆ˜ ìˆëŠ” ì„¹ì…˜:** ê¸´ ë¦¬ìŠ¤íŠ¸ë„ í¸í•˜ê²Œ ê´€ë¦¬
âœ… **Branch Headerë¡œ ë“œë¡­:** ì œí’ˆ ë¦¬ìŠ¤íŠ¸ê°€ ê¸¸ì–´ë„ ì‰½ê²Œ ì´ë™
âœ… **ì–‘ë°©í–¥ ì´ë™:** HQ â†” Branch ëª¨ë‘ ê°€ëŠ¥ (HQ Admin)
âœ… **ê¶Œí•œ ì œì–´:** HQ Adminë§Œ ì‚¬ìš© ê°€ëŠ¥
âœ… **FIFO ìœ ì§€:** ê¸°ì¡´ Transfer API ê·¸ëŒ€ë¡œ ì‚¬ìš©

### ì‚¬ìš©ì ì´ì 

**HQ Admin:**
- ë¹ ë¥¸ ì¬ê³  ì´ë™ (ë“œë˜ê·¸ ì•¤ ë“œë¡­)
- ì‹œê°ì  ì¬ê³  ê´€ë¦¬ (ìƒ‰ìƒ ì½”ë“œ)
- ì ‘ì„ ìˆ˜ ìˆëŠ” ì„¹ì…˜ìœ¼ë¡œ ê¸´ ë¦¬ìŠ¤íŠ¸ ê´€ë¦¬
- ì–‘ë°©í–¥ ì´ë™ìœ¼ë¡œ ìœ ì—°í•œ ì¬ê³  ì¡°ì •

**Branch Manager:**
- ê¸°ì¡´ Table Viewë¡œ ìì‹ ì˜ ì¬ê³  í™•ì¸ (ë³€ê²½ ì—†ìŒ)

**ë‘ ê°€ì§€ ë°©ì‹ ë³‘í–‰:**
- ê°„ë‹¨í•œ ì´ë™: ë“œë˜ê·¸ ì•¤ ë“œë¡­
- ë³µì¡í•œ ì‘ì—…: ê¸°ì¡´ í¼ ì‚¬ìš©

### ê¸°ìˆ ì  ì¥ì 

- `@dnd-kit` í˜„ëŒ€ì ì´ê³  ì•ˆì •ì 
- shadcn/ui Accordion ì¬ì‚¬ìš©
- ê¸°ì¡´ ì½”ë“œ ì¬ì‚¬ìš© (Transfer API, FIFO ë¡œì§)
- ë°˜ì‘í˜• ë””ìì¸ìœ¼ë¡œ ëª¨ë“  ë””ë°”ì´ìŠ¤ ì§€ì›
- ì ì§„ì  ê°œì„  ê°€ëŠ¥ (Phase 2 ê¸°ëŠ¥ ì¶”ê°€ ìš©ì´)
- ë¡¤ë°± ì•ˆì „ (ê¸°ì¡´ ê¸°ëŠ¥ì— ì˜í–¥ ì—†ìŒ)

### UI/UX ê°œì„ ì 

- ğŸ¨ **ì‹œê°ì :** ë§Œë£Œì¼ ìƒ‰ìƒ ì½”ë“œë¡œ ê¸´ê¸‰ë„ íŒŒì•…
- ğŸ“± **ë°˜ì‘í˜•:** ëª¨ë°”ì¼ì—ì„œë„ ì™„ë²½í•œ ì‚¬ìš©ì„±
- ğŸ”½ **Accordion:** í•„ìš”í•œ ì„¹ì…˜ë§Œ í¼ì³ì„œ ì§‘ì¤‘
- ğŸ¯ **ì§ê´€ì :** Branch í—¤ë”ë¡œ ë“œë˜ê·¸ë§Œ í•˜ë©´ ë
- âš¡ **ë¹ ë¦„:** í´ë¦­ 2ë²ˆìœ¼ë¡œ ì´ë™ ì™„ë£Œ
- â™¿ **ì ‘ê·¼ì„±:** í‚¤ë³´ë“œ ë„¤ë¹„ê²Œì´ì…˜, Screen reader ì§€ì›

---

## ë‹¤ìŒ ë‹¨ê³„

1. âœ… ê³„íšì„œ ê²€í†  ë° ìŠ¹ì¸
2. íŒ¨í‚¤ì§€ ì„¤ì¹˜ (`@dnd-kit`, `accordion`)
3. Phase 1~7 ìˆœì°¨ êµ¬í˜„
4. API ì–‘ë°©í–¥ ì´ë™ ìˆ˜ì •
5. HQ Admin ê³„ì •ìœ¼ë¡œ í†µí•© í…ŒìŠ¤íŠ¸
6. ë°˜ì‘í˜• í…ŒìŠ¤íŠ¸ (Desktop/Tablet/Mobile)
7. ë°°í¬ ë° ì‚¬ìš©ì í”¼ë“œë°± ìˆ˜ì§‘
8. Phase 2 ê°œì„ ì‚¬í•­ ê¸°íš

---

## ì°¸ê³  ìë£Œ

- [@dnd-kit ë¬¸ì„œ](https://docs.dndkit.com/)
- [shadcn/ui Accordion](https://ui.shadcn.com/docs/components/accordion)
- [Tailwind CSS ë°˜ì‘í˜• ë””ìì¸](https://tailwindcss.com/docs/responsive-design)
- [Supabase Client ì‚¬ìš©ë²•](https://supabase.com/docs/reference/javascript/introduction)
