# 004-1. Phase 04 Enhanced - 재고 드래그 앤 드롭 UI 구현 계획

## 작업 개요

**목표:** 기존 Transfer Stock 폼 방식은 유지하면서, 세로 Accordion 형태의 드래그 앤 드롭 재고 이동 UI 추가

**작업 범위:**
- 현재 `/inventory` 페이지에 새로운 드래그 앤 드롭 뷰 옵션 추가
- Location별 Accordion 섹션 (펼치기/접기 가능)
- 가로로 긴 Product Card 디자인 (배치별 상세 정보)
- Branch Header로 드래그하여 이동
- 기존 Transfer Stock 페이지는 그대로 유지 (두 가지 방식 병행)

---

## 현재 상황 분석

### 기존 UI Flow
1. `/inventory` - 재고 현황 테이블 뷰 (Location별 그룹화)
2. "Transfer Stock" 버튼 클릭
3. `/inventory/transfer` - 폼 페이지로 이동
4. 드롭다운으로 선택 + 수량 입력
5. Submit

### 새로운 요구사항
- ✅ 더 직관적인 시각적 인터페이스
- ✅ 세로 Accordion 레이아웃 (가로 컬럼 대신)
- ✅ 가로로 긴 Product Card (더 많은 정보 표시)
- ✅ Branch Header로 드래그 (접혀있어도 드롭 가능)
- ✅ 배치별 개별 카드 표시 (Option A)
- ✅ HQ Admin은 양방향 이동 가능 (HQ ↔ Branch)
- ✅ 반응형 디자인 (Desktop/Tablet/Mobile)
- ✅ 기존 폼 방식도 유지

---

## 제안하는 UI 디자인

### 화면 레이아웃

```
┌──────────────────────────────────────────────────────────────────┐
│  Inventory Management              [Table View] [Kanban View]    │
└──────────────────────────────────────────────────────────────────┘

[Kanban View 선택 시]

┌──────────────────────────────────────────────────────────────────┐
│ 🔽 Korea HQ (3 products, 350 units)              [Expanded] ▼    │
├──────────────────────────────────────────────────────────────────┤
│  ┌────────────────────────────────────────────────────────────┐  │
│  │ 📦 Serum A (SA001)              Batch: B001   🟡 Exp: 2025-12-15 │
│  │ 50 units • Mfg: 2024-06-15 • ₩15,000/unit                 │  │
│  └────────────────────────────────────────────────────────────┘  │
│                                                                    │
│  ┌────────────────────────────────────────────────────────────┐  │
│  │ 📦 Cream B (CB002)              Batch: B002   ⬜ Exp: 2026-02-01 │
│  │ 200 units • Mfg: 2024-08-01 • ₩25,000/unit                │  │
│  └────────────────────────────────────────────────────────────┘  │
│                                                                    │
│  ┌────────────────────────────────────────────────────────────┐  │
│  │ 📦 Cleanser C (CL003)           Batch: B003   🔴 Exp: 2025-09-30 │
│  │ 100 units • Mfg: 2024-03-30 • ₩12,000/unit                │  │
│  └────────────────────────────────────────────────────────────┘  │
└──────────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────────┐
│ ▶ Vietnam Branch (2 products, 200 units)        [Collapsed] ▶   │
└──────────────────────────────────────────────────────────────────┘
                              ↑
                    [드래그해서 여기에 드롭]

┌──────────────────────────────────────────────────────────────────┐
│ ▶ China Branch (1 product, 45 units)            [Collapsed] ▶   │
└──────────────────────────────────────────────────────────────────┘
```

### Product Card 상세 디자인

**Desktop/Tablet (가로로 긴 형태):**

```
┌──────────────────────────────────────────────────────────────────┐
│ 🧴 Serum A (SA001)        Batch: B001        🟡 Exp: 2025-12-15  │
│ 150 units available • Mfg: 2024-06-15 • ₩15,000/unit             │
│                                                    [Drag Handle]  │
└──────────────────────────────────────────────────────────────────┘
  ↑ Grab cursor on hover
```

**Mobile (세로로 스택):**

```
┌─────────────────────────────┐
│ 🧴 Serum A (SA001)          │
│ Batch: B001                 │
│ 🟡 Exp: 2025-12-15          │
│                             │
│ 150 units available         │
│ Mfg: 2024-06-15             │
│ ₩15,000/unit                │
│                             │
│              [Drag Handle]  │
└─────────────────────────────┘
```

### 반응형 브레이크포인트

| 화면 크기 | 레이아웃 | Card 스타일 |
|----------|---------|------------|
| Desktop (≥1024px) | 넓은 가로 카드 | 한 줄에 모든 정보 |
| Tablet (768-1023px) | 중간 가로 카드 | 2줄로 정보 분할 |
| Mobile (<768px) | 세로 스택 카드 | 각 정보 별도 줄 |

**Tailwind CSS 클래스 예시:**
```tsx
<div className="
  flex flex-col md:flex-row
  md:items-center md:justify-between
  gap-2 md:gap-4
  p-3 md:p-4
">
  {/* Content */}
</div>
```

---

## 기술 스택 선정

### 1. 드래그 앤 드롭 라이브러리

**선택:** `@dnd-kit`

**이유:**
- Next.js 14 + React 호환성 확실
- TypeScript 네이티브 지원
- 접근성(a11y) 내장
- shadcn/ui와 잘 어울림
- 활발한 유지보수

### 2. Accordion 컴포넌트

**선택:** shadcn/ui `Accordion`

**이미 프로젝트에 설치되어 있는지 확인 필요**

설치 명령어:
```bash
npx shadcn@latest add accordion
```

### 3. 필요한 패키지

```bash
npm install @dnd-kit/core @dnd-kit/sortable @dnd-kit/utilities
```

**패키지 설명:**
- `@dnd-kit/core` - 핵심 드래그 앤 드롭 로직
- `@dnd-kit/sortable` - 정렬용 (미래 확장성)
- `@dnd-kit/utilities` - CSS Transform 유틸리티

---

## 구현 계획

### Phase 1: UI 뷰 전환 기능 추가

**파일:** `app/(dashboard)/inventory/page.tsx`

**작업 내용:**
1. Server Component를 Client Component로 변경 (useState 사용 필요)
2. 상단에 뷰 전환 버튼 추가 (Table View / Kanban View)
3. 상태 관리로 현재 뷰 모드 저장
4. 조건부 렌더링

```tsx
'use client'

import { useState } from 'react'
import { Button } from '@/components/ui/button'
import { InventoryList } from '@/components/inventory/inventory-list'
import { InventoryKanban } from '@/components/inventory/inventory-kanban'

export default function InventoryPage() {
  const [viewMode, setViewMode] = useState<'table' | 'kanban'>('table')

  // 데이터 페칭 로직 (useEffect + Supabase client)
  // 또는 Server Component에서 받은 props 사용

  return (
    <div className="container mx-auto py-6">
      {/* 헤더 */}
      <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">
        <h1 className="text-2xl font-bold">Inventory Management</h1>

        {/* 뷰 전환 버튼 - HQ Admin만 표시 */}
        {profile.role === 'HQ_Admin' && (
          <div className="flex gap-2">
            <Button
              variant={viewMode === 'table' ? 'default' : 'outline'}
              onClick={() => setViewMode('table')}
            >
              Table View
            </Button>
            <Button
              variant={viewMode === 'kanban' ? 'default' : 'outline'}
              onClick={() => setViewMode('kanban')}
            >
              Kanban View
            </Button>
          </div>
        )}
      </div>

      {/* 조건부 렌더링 */}
      {viewMode === 'table' ? (
        <InventoryList stockBatches={stockBatches} locations={locations} />
      ) : (
        <InventoryKanban
          stockBatches={stockBatches}
          locations={locations}
          userRole={profile.role}
        />
      )}
    </div>
  )
}
```

**중요 변경:**
- Server Component → Client Component 전환
- 데이터 페칭을 클라이언트에서 수행 (Supabase client 사용)
- 또는 Server Action 사용 고려

### Phase 2: 재고 데이터 배치별 분리

**파일:** `lib/inventory-utils.ts` (신규 생성)

**작업 내용:**
배치별로 개별 카드를 표시하기 위해 데이터를 Location별로만 그룹화

```typescript
import { StockBatch, Location } from '@/types'

// Location별로 그룹화 (배치는 그대로 유지)
export function groupBatchesByLocation(batches: StockBatch[]) {
  const grouped: Record<string, StockBatch[]> = {}

  batches.forEach((batch) => {
    const locId = batch.location_id
    if (!grouped[locId]) {
      grouped[locId] = []
    }
    grouped[locId].push(batch)
  })

  // 각 Location 내에서 FIFO 순서로 정렬 (만료일 빠른 순)
  Object.keys(grouped).forEach((locId) => {
    grouped[locId].sort((a, b) =>
      new Date(a.expiry_date).getTime() - new Date(b.expiry_date).getTime()
    )
  })

  return grouped
}

// Location별 총 수량 계산
export function calculateLocationStats(batches: StockBatch[]) {
  return {
    totalUnits: batches.reduce((sum, b) => sum + b.qty_on_hand, 0),
    productCount: new Set(batches.map(b => b.product_id)).size,
  }
}

// 만료일 기반 Badge variant 계산
export function getExpiryBadgeVariant(expiryDate: string):
  'destructive' | 'warning' | 'secondary' | 'outline' {
  const today = new Date()
  const expiry = new Date(expiryDate)
  const daysUntilExpiry = Math.floor(
    (expiry.getTime() - today.getTime()) / (1000 * 60 * 60 * 24)
  )

  if (daysUntilExpiry < 0) return 'destructive' // 만료됨
  if (daysUntilExpiry < 30) return 'destructive' // 30일 이내
  if (daysUntilExpiry < 90) return 'warning' // 30-90일 (노랑)
  if (daysUntilExpiry < 180) return 'secondary' // 90-180일 (회색)
  return 'outline' // 180일 이상
}

// 만료일 이모지
export function getExpiryEmoji(expiryDate: string): string {
  const today = new Date()
  const expiry = new Date(expiryDate)
  const daysUntilExpiry = Math.floor(
    (expiry.getTime() - today.getTime()) / (1000 * 60 * 60 * 24)
  )

  if (daysUntilExpiry < 0) return '🔴'
  if (daysUntilExpiry < 30) return '🔴'
  if (daysUntilExpiry < 90) return '🟡'
  if (daysUntilExpiry < 180) return '⚪'
  return '⬜'
}

// 통화 포맷팅
export function formatCurrency(amount: number, currency: string): string {
  const locale =
    currency === 'KRW' ? 'ko-KR' :
    currency === 'VND' ? 'vi-VN' :
    'zh-CN'

  return new Intl.NumberFormat(locale, {
    style: 'currency',
    currency,
    minimumFractionDigits: currency === 'CNY' ? 2 : 0,
  }).format(amount)
}

// 날짜 포맷팅
export function formatDate(dateString: string): string {
  return new Date(dateString).toLocaleDateString('en-US', {
    year: 'numeric',
    month: '2-digit',
    day: '2-digit',
  })
}
```

### Phase 3: Kanban 보드 컴포넌트 생성

**파일:** `components/inventory/inventory-kanban.tsx` (신규 생성)

**구조:**

```tsx
'use client'

import { useState } from 'react'
import { DndContext, DragEndEvent, DragStartEvent, DragOverlay } from '@dnd-kit/core'
import { Accordion } from '@/components/ui/accordion'
import { LocationAccordion } from './location-accordion'
import { BatchCard } from './batch-card'
import { TransferDialog } from './transfer-dialog'
import { groupBatchesByLocation } from '@/lib/inventory-utils'
import { toast } from 'sonner'

interface InventoryKanbanProps {
  stockBatches: StockBatch[]
  locations: Location[]
  userRole: string
}

export function InventoryKanban({
  stockBatches,
  locations,
  userRole
}: InventoryKanbanProps) {
  const [activeBatch, setActiveBatch] = useState<StockBatch | null>(null)
  const [showTransferDialog, setShowTransferDialog] = useState(false)
  const [transferData, setTransferData] = useState<TransferData | null>(null)

  // 데이터 그룹화 (Location별)
  const groupedBatches = groupBatchesByLocation(stockBatches)

  // HQ Location 찾기
  const hqLocation = locations.find(l => l.location_type === 'HQ')

  const handleDragStart = (event: DragStartEvent) => {
    const { active } = event
    setActiveBatch(active.data.current?.batch)
  }

  const handleDragEnd = (event: DragEndEvent) => {
    const { active, over } = event

    if (!over) {
      setActiveBatch(null)
      return
    }

    // Source와 Target location 추출
    const sourceBatch = active.data.current?.batch as StockBatch
    const sourceLocationId = sourceBatch.location_id
    const targetLocationId = over.id.toString()

    // 같은 위치에 드롭 - 아무것도 안 함
    if (sourceLocationId === targetLocationId) {
      setActiveBatch(null)
      return
    }

    // Location 정보 가져오기
    const sourceLocation = locations.find(l => l.id === sourceLocationId)
    const targetLocation = locations.find(l => l.id === targetLocationId)

    if (!sourceLocation || !targetLocation) {
      toast.error('Invalid location')
      setActiveBatch(null)
      return
    }

    // 권한 체크 - HQ Admin만 이동 가능
    if (userRole !== 'HQ_Admin') {
      toast.error('Only HQ Admin can transfer stock')
      setActiveBatch(null)
      return
    }

    // HQ ↔ Branch 이동만 허용 (양방향)
    const isValidTransfer =
      (sourceLocation.location_type === 'HQ' && targetLocation.location_type === 'Branch') ||
      (sourceLocation.location_type === 'Branch' && targetLocation.location_type === 'HQ')

    if (!isValidTransfer) {
      toast.error('Can only transfer between HQ and Branches')
      setActiveBatch(null)
      return
    }

    // Transfer 다이얼로그 표시
    setTransferData({
      batch: sourceBatch,
      fromLocation: sourceLocation,
      toLocation: targetLocation,
      availableQty: sourceBatch.qty_on_hand, // 해당 배치의 수량
    })
    setShowTransferDialog(true)
    setActiveBatch(null)
  }

  const handleTransferSuccess = () => {
    setShowTransferDialog(false)
    setTransferData(null)
    // 페이지 새로고침으로 데이터 업데이트
    window.location.reload()
  }

  return (
    <>
      <DndContext
        onDragStart={handleDragStart}
        onDragEnd={handleDragEnd}
      >
        {/* Accordion 컨테이너 */}
        <Accordion
          type="multiple"
          defaultValue={hqLocation ? [hqLocation.id] : []}  // Korea HQ만 기본 펼침
          className="space-y-4"
        >
          {locations.map((location) => (
            <LocationAccordion
              key={location.id}
              location={location}
              batches={groupedBatches[location.id] || []}
              userRole={userRole}
            />
          ))}
        </Accordion>

        {/* 드래그 중 오버레이 */}
        <DragOverlay>
          {activeBatch ? (
            <BatchCard batch={activeBatch} isDragging />
          ) : null}
        </DragOverlay>
      </DndContext>

      {/* Transfer 확인 다이얼로그 */}
      {showTransferDialog && transferData && (
        <TransferDialog
          open={showTransferDialog}
          onClose={() => setShowTransferDialog(false)}
          transferData={transferData}
          onSuccess={handleTransferSuccess}
        />
      )}
    </>
  )
}

// TransferData 타입
interface TransferData {
  batch: StockBatch
  fromLocation: Location
  toLocation: Location
  availableQty: number
}
```

### Phase 4: Location Accordion 컴포넌트

**파일:** `components/inventory/location-accordion.tsx` (신규 생성)

```tsx
'use client'

import { useDroppable } from '@dnd-kit/core'
import {
  AccordionItem,
  AccordionTrigger,
  AccordionContent,
} from '@/components/ui/accordion'
import { Badge } from '@/components/ui/badge'
import { BatchCard } from './batch-card'
import { calculateLocationStats } from '@/lib/inventory-utils'
import { cn } from '@/lib/utils'

interface LocationAccordionProps {
  location: Location
  batches: StockBatch[]
  userRole: string
}

export function LocationAccordion({
  location,
  batches,
  userRole
}: LocationAccordionProps) {
  // AccordionTrigger를 Droppable 영역으로 설정
  const { setNodeRef, isOver } = useDroppable({
    id: location.id,
  })

  // Location 통계
  const stats = calculateLocationStats(batches)

  return (
    <AccordionItem
      value={location.id}
      className={cn(
        'border rounded-lg',
        isOver && 'ring-2 ring-primary bg-accent/50'  // 드롭 가능 시 하이라이트
      )}
    >
      {/* Header - Droppable 영역 */}
      <AccordionTrigger
        ref={setNodeRef}
        className={cn(
          'px-4 py-3 hover:no-underline',
          isOver && 'bg-accent'
        )}
      >
        <div className="flex items-center justify-between w-full pr-4">
          {/* Left: Location 정보 */}
          <div className="flex items-center gap-3">
            <span className="font-semibold text-lg">{location.name}</span>
            <Badge variant="outline" className="text-xs">
              {location.location_type}
            </Badge>
            <Badge variant="secondary" className="text-xs">
              {location.currency}
            </Badge>
          </div>

          {/* Right: 통계 */}
          <div className="flex items-center gap-4 text-sm text-muted-foreground">
            <span>{stats.productCount} products</span>
            <span className="font-semibold text-foreground">
              {stats.totalUnits} units
            </span>
          </div>
        </div>
      </AccordionTrigger>

      {/* Content - Product Cards */}
      <AccordionContent className="px-4 pb-4 pt-2">
        {batches.length === 0 ? (
          <div className="text-center py-8 text-muted-foreground">
            No stock available
          </div>
        ) : (
          <div className="space-y-2">
            {batches.map((batch) => (
              <BatchCard
                key={batch.id}
                batch={batch}
                locationId={location.id}
                isDraggable={userRole === 'HQ_Admin'}
              />
            ))}
          </div>
        )}
      </AccordionContent>
    </AccordionItem>
  )
}
```

### Phase 5: Batch Card 컴포넌트

**파일:** `components/inventory/batch-card.tsx` (신규 생성)

**가로로 긴 카드 + 반응형:**

```tsx
'use client'

import { useDraggable } from '@dnd-kit/core'
import { CSS } from '@dnd-kit/utilities'
import { Badge } from '@/components/ui/badge'
import { GripVertical } from 'lucide-react'
import {
  getExpiryBadgeVariant,
  getExpiryEmoji,
  formatCurrency,
  formatDate
} from '@/lib/inventory-utils'
import { cn } from '@/lib/utils'

interface BatchCardProps {
  batch: StockBatch
  locationId?: string
  isDraggable?: boolean
  isDragging?: boolean
}

export function BatchCard({
  batch,
  locationId,
  isDraggable = true,
  isDragging = false
}: BatchCardProps) {
  const { attributes, listeners, setNodeRef, transform } = useDraggable({
    id: `batch-${batch.id}`,
    data: { batch, locationId },
    disabled: !isDraggable,
  })

  const style = transform ? {
    transform: CSS.Translate.toString(transform),
  } : undefined

  // 만료일 색상 및 이모지
  const expiryVariant = getExpiryBadgeVariant(batch.expiry_date)
  const expiryEmoji = getExpiryEmoji(batch.expiry_date)

  return (
    <div
      ref={setNodeRef}
      style={style}
      {...(isDraggable ? listeners : {})}
      {...(isDraggable ? attributes : {})}
      className={cn(
        'group relative',
        'bg-card border rounded-lg',
        'transition-all duration-200',
        isDraggable && 'cursor-grab active:cursor-grabbing hover:shadow-md hover:border-primary/50',
        isDragging && 'opacity-50 shadow-lg',
        !isDraggable && 'cursor-default'
      )}
    >
      {/* Card Content - 반응형 레이아웃 */}
      <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-2 md:gap-4 p-3 md:p-4">

        {/* Left Section: 제품 정보 */}
        <div className="flex items-start gap-3 flex-1 min-w-0">
          {/* Drag Handle - Desktop만 표시 */}
          {isDraggable && (
            <GripVertical
              className="hidden md:block w-5 h-5 text-muted-foreground flex-shrink-0 mt-1"
            />
          )}

          {/* 제품명 + SKU */}
          <div className="flex-1 min-w-0">
            <div className="flex items-center gap-2 flex-wrap">
              <span className="font-medium truncate">
                {batch.product?.name || 'Unknown Product'}
              </span>
              <Badge variant="outline" className="text-xs flex-shrink-0">
                {batch.product?.sku}
              </Badge>
            </div>

            {/* 배치 번호 - Mobile에서는 아래로 */}
            <div className="mt-1 text-sm text-muted-foreground">
              📦 Batch: <span className="font-mono">{batch.batch_no}</span>
            </div>
          </div>
        </div>

        {/* Middle Section: 수량 및 날짜 - 반응형 */}
        <div className="flex flex-col md:flex-row md:items-center gap-2 md:gap-6 text-sm">

          {/* 수량 */}
          <div className="flex items-center gap-2">
            <span className="text-muted-foreground">Qty:</span>
            <span className="font-semibold text-base">{batch.qty_on_hand}</span>
            <span className="text-muted-foreground">{batch.product?.unit || 'units'}</span>
          </div>

          {/* 제조일자 */}
          <div className="flex items-center gap-2">
            <span className="text-muted-foreground">Mfg:</span>
            <span className="font-mono text-xs">{formatDate(batch.manufactured_date)}</span>
          </div>

          {/* 단가 */}
          <div className="flex items-center gap-2">
            <span className="text-muted-foreground">Cost:</span>
            <span className="font-semibold">
              {formatCurrency(batch.unit_cost, batch.location?.currency || 'KRW')}
            </span>
          </div>
        </div>

        {/* Right Section: 만료일 Badge */}
        <div className="flex items-center gap-2 flex-shrink-0">
          <span className="text-xl" aria-hidden="true">{expiryEmoji}</span>
          <div className="flex flex-col items-end">
            <span className="text-xs text-muted-foreground">Expiry</span>
            <Badge variant={expiryVariant} className="font-mono text-xs">
              {formatDate(batch.expiry_date)}
            </Badge>
          </div>
        </div>

        {/* Quality Status Badge (OK가 아닐 때만) */}
        {batch.quality_status !== 'OK' && (
          <div className="absolute top-2 right-2 md:relative md:top-0 md:right-0">
            <Badge
              variant={batch.quality_status === 'Damaged' ? 'destructive' : 'secondary'}
              className="text-xs"
            >
              {batch.quality_status}
            </Badge>
          </div>
        )}
      </div>

      {/* Drag Indicator - 드래그 중 표시 */}
      {isDraggable && (
        <div className="absolute inset-0 rounded-lg border-2 border-primary opacity-0 group-hover:opacity-100 pointer-events-none transition-opacity" />
      )}
    </div>
  )
}
```

**반응형 브레이크포인트 설명:**

| 클래스 | 화면 크기 | 효과 |
|--------|----------|------|
| `flex-col md:flex-row` | <768px: 세로, ≥768px: 가로 | 레이아웃 방향 전환 |
| `gap-2 md:gap-4` | <768px: 8px, ≥768px: 16px | 간격 조정 |
| `p-3 md:p-4` | <768px: 12px, ≥768px: 16px | 패딩 조정 |
| `hidden md:block` | <768px: 숨김, ≥768px: 표시 | Drag handle 숨김 |

### Phase 6: Transfer 확인 다이얼로그

**파일:** `components/inventory/transfer-dialog.tsx` (신규 생성)

```tsx
'use client'

import { useState } from 'react'
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogFooter,
  DialogDescription,
} from '@/components/ui/dialog'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { Label } from '@/components/ui/label'
import { Badge } from '@/components/ui/badge'
import { ArrowRight } from 'lucide-react'
import { toast } from 'sonner'
import { formatDate } from '@/lib/inventory-utils'

interface TransferDialogProps {
  open: boolean
  onClose: () => void
  onSuccess: () => void
  transferData: {
    batch: StockBatch
    fromLocation: Location
    toLocation: Location
    availableQty: number
  }
}

export function TransferDialog({
  open,
  onClose,
  onSuccess,
  transferData
}: TransferDialogProps) {
  const [quantity, setQuantity] = useState(transferData.availableQty.toString())
  const [isLoading, setIsLoading] = useState(false)

  const { batch, fromLocation, toLocation, availableQty } = transferData

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault()

    const qty = parseInt(quantity)

    // Validation
    if (isNaN(qty) || qty <= 0) {
      toast.error('Please enter a valid quantity')
      return
    }

    if (qty > availableQty) {
      toast.error(`Maximum available: ${availableQty} units`)
      return
    }

    setIsLoading(true)

    try {
      const response = await fetch('/api/inventory/transfer', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          from_location_id: fromLocation.id,
          to_location_id: toLocation.id,
          product_id: batch.product_id,
          qty,
        }),
      })

      const result = await response.json()

      if (!response.ok) {
        toast.error(result.error || 'Transfer failed')
        return
      }

      toast.success(result.message || 'Transfer completed successfully')
      onSuccess()
    } catch (error) {
      console.error('Transfer error:', error)
      toast.error('Network error. Please try again.')
    } finally {
      setIsLoading(false)
    }
  }

  return (
    <Dialog open={open} onOpenChange={onClose}>
      <DialogContent className="sm:max-w-md">
        <DialogHeader>
          <DialogTitle>Confirm Stock Transfer</DialogTitle>
          <DialogDescription>
            Review the transfer details and enter the quantity to move.
          </DialogDescription>
        </DialogHeader>

        <form onSubmit={handleSubmit}>
          <div className="space-y-4 py-4">

            {/* 제품 정보 */}
            <div className="p-3 bg-muted rounded-lg">
              <div className="flex items-center justify-between mb-1">
                <span className="font-medium">{batch.product?.name}</span>
                <Badge variant="outline">{batch.product?.sku}</Badge>
              </div>
              <div className="text-sm text-muted-foreground space-y-1">
                <div>Batch: {batch.batch_no}</div>
                <div>Expiry: {formatDate(batch.expiry_date)}</div>
              </div>
            </div>

            {/* From → To */}
            <div className="flex items-center justify-between p-3 bg-accent/50 rounded-lg">
              <div className="flex-1">
                <div className="text-xs text-muted-foreground">From</div>
                <div className="font-medium">{fromLocation.name}</div>
                <Badge variant="outline" className="text-xs mt-1">
                  {fromLocation.location_type}
                </Badge>
              </div>

              <ArrowRight className="w-5 h-5 text-muted-foreground mx-4" />

              <div className="flex-1 text-right">
                <div className="text-xs text-muted-foreground">To</div>
                <div className="font-medium">{toLocation.name}</div>
                <Badge variant="outline" className="text-xs mt-1">
                  {toLocation.location_type}
                </Badge>
              </div>
            </div>

            {/* 가용 수량 */}
            <div className="p-3 border rounded-lg">
              <div className="text-sm text-muted-foreground">Available in this batch</div>
              <div className="text-2xl font-bold text-primary">
                {availableQty} <span className="text-base font-normal">{batch.product?.unit || 'units'}</span>
              </div>
            </div>

            {/* 수량 입력 */}
            <div className="space-y-2">
              <Label htmlFor="quantity">Quantity to Transfer *</Label>
              <Input
                id="quantity"
                type="number"
                min="1"
                max={availableQty}
                value={quantity}
                onChange={(e) => setQuantity(e.target.value)}
                placeholder="Enter quantity"
                required
                autoFocus
              />
              <p className="text-xs text-muted-foreground">
                Max: {availableQty} units available
              </p>
            </div>
          </div>

          <DialogFooter className="gap-2">
            <Button
              type="button"
              variant="outline"
              onClick={onClose}
              disabled={isLoading}
            >
              Cancel
            </Button>
            <Button type="submit" disabled={isLoading}>
              {isLoading ? 'Transferring...' : 'Confirm Transfer'}
            </Button>
          </DialogFooter>
        </form>
      </DialogContent>
    </Dialog>
  )
}
```

### Phase 7: Badge Variant 확장

**파일:** `components/ui/badge.tsx` (기존 파일 수정)

shadcn/ui의 Badge 컴포넌트에 `warning` variant 추가 필요:

```tsx
const badgeVariants = cva(
  "inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2",
  {
    variants: {
      variant: {
        default: "border-transparent bg-primary text-primary-foreground hover:bg-primary/80",
        secondary: "border-transparent bg-secondary text-secondary-foreground hover:bg-secondary/80",
        destructive: "border-transparent bg-destructive text-destructive-foreground hover:bg-destructive/80",
        outline: "text-foreground",
        // 추가: warning variant
        warning: "border-transparent bg-yellow-500 text-white hover:bg-yellow-600",
      },
    },
    defaultVariants: {
      variant: "default",
    },
  }
)
```

---

## 권한 제어

### 1. UI 레벨 권한 체크

**Kanban View 접근:**
- HQ Admin만 버튼 표시
- Branch Manager는 Table View만 사용

```tsx
{profile.role === 'HQ_Admin' && (
  <Button variant={viewMode === 'kanban' ? 'default' : 'outline'}>
    Kanban View
  </Button>
)}
```

### 2. 드래그 제한

**조건:**
- HQ Admin만 드래그 가능
- HQ ↔ Branch 양방향 이동 허용
- Branch ↔ Branch 불가
- HQ ↔ HQ 불가

**구현:** `handleDragEnd` 함수에서 validation

```tsx
// 권한 체크
if (userRole !== 'HQ_Admin') {
  toast.error('Only HQ Admin can transfer stock')
  return
}

// Location 타입 체크
const isValidTransfer =
  (sourceLocation.location_type === 'HQ' && targetLocation.location_type === 'Branch') ||
  (sourceLocation.location_type === 'Branch' && targetLocation.location_type === 'HQ')

if (!isValidTransfer) {
  toast.error('Can only transfer between HQ and Branches')
  return
}
```

### 3. API 레벨 권한 체크

**파일:** `app/api/inventory/transfer/route.ts` (기존 파일 수정 필요)

현재 API는 HQ → Branch만 허용하는데, Branch → HQ도 허용하도록 수정:

```typescript
// 기존 체크 제거/수정
// if (fromLocation.location_type !== 'HQ') { ... }

// 새로운 체크
const isValidTransfer =
  (fromLocation.location_type === 'HQ' && toLocation.location_type === 'Branch') ||
  (fromLocation.location_type === 'Branch' && toLocation.location_type === 'HQ')

if (!isValidTransfer) {
  return NextResponse.json(
    { error: 'Can only transfer between HQ and Branches' },
    { status: 400 }
  )
}
```

---

## 사용자 경험 (UX) 개선 사항

### 1. 시각적 피드백

| 상태 | 효과 |
|------|------|
| Hover (카드) | `hover:shadow-md hover:border-primary/50` |
| Hover (Accordion Header) | `group-hover:opacity-100` (border 표시) |
| 드래그 시작 | 카드 투명도 50%, 커서 `grabbing` |
| 드롭 가능 영역 | Target Accordion에 `ring-2 ring-primary` + `bg-accent/50` |
| 드래그 중 | DragOverlay로 원본 카드 표시 (배경 반투명) |
| 드롭 완료 | Toast success + 페이지 새로고침 |

### 2. 만료일 색상 시스템

| 조건 | 색상 | Variant |
|------|------|---------|
| 만료됨 | 🔴 빨강 | `destructive` |
| < 30일 | 🔴 빨강 | `destructive` |
| 30-90일 | 🟡 노랑 | `warning` |
| 90-180일 | ⚪ 회색 | `secondary` |
| 180일+ | ⬜ 흰색 | `outline` |

### 3. 에러 처리

| 시나리오 | 처리 방법 |
|----------|-----------|
| 같은 위치에 드롭 | 조용히 무시 (Toast 없음) |
| 권한 없음 | Toast error: "Only HQ Admin..." |
| 잘못된 이동 (Branch ↔ Branch) | Toast error: "Can only transfer..." |
| API 오류 | Toast error with message |
| 네트워크 오류 | Toast error: "Network error..." |

### 4. 로딩 상태

- Transfer 진행 중 → Dialog 버튼 disabled + "Transferring..." 텍스트
- 완료 후 → Toast success + `window.location.reload()`

### 5. 접근성 (Accessibility)

- `@dnd-kit` 내장 키보드 네비게이션
- ARIA labels 자동 적용
- Screen reader 지원
- Focus 관리 (Dialog 자동 focus)

### 6. 모바일 최적화

**Touch 이벤트:**
- `@dnd-kit`가 자동으로 터치 이벤트 처리
- 길게 눌러서 드래그 시작

**세로 레이아웃:**
- Accordion이 세로로 스택되므로 모바일에 이상적
- 카드 내부 정보가 세로로 재배치

**Drag Handle:**
- Mobile에서는 숨김 (전체 카드가 터치 영역)
- Desktop에서만 GripVertical 아이콘 표시

---

## 데이터 흐름

```
1. Page Component (Client Component)
   └─> Fetch stock_batches + locations from Supabase
   └─> Pass to InventoryKanban

2. InventoryKanban
   └─> Group batches by location_id
   └─> Sort by expiry_date (FIFO)
   └─> Pass to LocationAccordion

3. LocationAccordion
   └─> Render Accordion with Droppable header
   └─> Pass each batch to BatchCard

4. User drags BatchCard
   └─> handleDragStart: Save activeBatch
   └─> handleDragEnd:
       ├─> Validate locations (HQ ↔ Branch)
       ├─> Validate permissions (HQ Admin)
       └─> Show TransferDialog

5. User confirms in TransferDialog
   └─> POST /api/inventory/transfer
       ├─> Validate again (API level)
       ├─> FIFO deduction (existing logic)
       └─> Update stock_batches

6. Success
   └─> Toast message
   └─> window.location.reload()
   └─> Updated data displayed
```

---

## API 수정 사항

### 기존 API 확장

**파일:** `app/api/inventory/transfer/route.ts`

**수정 내용:**

1. **Location 타입 체크 변경** - Branch → HQ도 허용

```typescript
// Before (기존)
if (fromLocation.location_type !== 'HQ') {
  return NextResponse.json(
    { error: 'Can only transfer from HQ' },
    { status: 400 }
  )
}

// After (수정)
const isValidTransfer =
  (fromLocation.location_type === 'HQ' && toLocation.location_type === 'Branch') ||
  (fromLocation.location_type === 'Branch' && toLocation.location_type === 'HQ')

if (!isValidTransfer) {
  return NextResponse.json(
    { error: 'Can only transfer between HQ and Branches (bidirectional)' },
    { status: 400 }
  )
}
```

2. **통화 처리** - Branch → HQ 이동 시 통화 재계산 필요 (선택적)

현재는 `unit_cost`를 그대로 복사하는데, Branch에서 HQ로 돌아올 때 통화가 달라서 문제가 될 수 있음.

**Options:**
- **Option A:** 원래 비용 그대로 유지 (간단)
- **Option B:** 현재 환율로 재계산 (복잡)

**MVP에서는 Option A 사용** (나중에 개선)

3. **기타 로직은 그대로 유지**
   - FIFO 순서 유지
   - 배치 정보 보존
   - Create or Update 로직

---

## 테스트 시나리오

### 1. 정상 시나리오 (HQ → Branch)

| # | 작업 | 기대 결과 |
|---|------|-----------|
| 1 | HQ Admin 로그인 | Kanban View 버튼 표시 |
| 2 | Kanban View 클릭 | Korea HQ 펼쳐짐, VN/CN 접혀짐 |
| 3 | Serum A 카드 드래그 시작 | 카드 투명도 50%, DragOverlay 표시 |
| 4 | Vietnam Branch 헤더로 드래그 | 헤더에 ring + bg-accent 표시 |
| 5 | 드롭 | Transfer Dialog 표시 |
| 6 | 수량 50 입력 후 Confirm | API 호출 → Success toast |
| 7 | 페이지 리로드 | HQ 수량 -50, VN 수량 +50 |

### 2. 정상 시나리오 (Branch → HQ)

| # | 작업 | 기대 결과 |
|---|------|-----------|
| 1 | Vietnam Branch 펼치기 | VN 제품 카드들 표시 |
| 2 | VN의 Cream B 카드 → Korea HQ 헤더로 드래그 | 허용됨 |
| 3 | 수량 입력 후 Confirm | Transfer 성공 |
| 4 | 재고 확인 | VN 감소, HQ 증가 |

### 3. 에러 시나리오

| # | 작업 | 기대 결과 |
|---|------|-----------|
| 1 | Branch Manager 로그인 | Kanban View 버튼 숨김 |
| 2 | VN 카드 → CN 헤더로 드래그 | Error toast: "Only transfer between HQ and Branches" |
| 3 | 가용량 초과 입력 | Error toast: "Maximum available: X" |
| 4 | 네트워크 오류 | Error toast: "Network error" |

### 4. FIFO 검증 (배치별 카드)

| 초기 상태 | 작업 | 기대 결과 |
|----------|------|-----------|
| HQ:<br>- B001 카드: 50 units, Exp 2025-12<br>- B002 카드: 100 units, Exp 2026-03 | B001 카드 전체 (50 units) VN으로 이동 | VN에 B001 카드 생성: 50 units<br>HQ에서 B001 카드 사라짐 |

### 5. 반응형 테스트

| 화면 크기 | 확인 사항 |
|----------|-----------|
| Desktop (1920px) | 가로 긴 카드, 정보 한 줄, Drag handle 표시 |
| Tablet (768px) | 카드 정보 2줄로 분할, 여전히 가로 |
| Mobile (375px) | 카드 정보 세로 스택, Drag handle 숨김 |

### 6. Accordion 동작

| 작업 | 기대 결과 |
|------|-----------|
| 페이지 로드 | Korea HQ만 펼쳐짐 |
| Vietnam 클릭 | Vietnam 펼쳐짐 |
| Korea 클릭 | Korea 접힘 (다른 Accordion과 독립) |
| 여러 개 동시 펼치기 | `type="multiple"`이므로 가능 |

---

## 배포 및 롤백 계획

### 배포 전 체크리스트

- [ ] `@dnd-kit` 패키지 설치 확인
- [ ] shadcn/ui `accordion` 컴포넌트 설치 확인
- [ ] Badge `warning` variant 추가 확인
- [ ] TypeScript 컴파일 에러 없음
- [ ] 기존 Transfer Stock 페이지 정상 작동 확인
- [ ] HQ Admin / Branch Manager 각각 테스트
- [ ] Desktop / Tablet / Mobile 반응형 확인
- [ ] API 양방향 이동 수정 확인

### 설치 명령어

```bash
# @dnd-kit 패키지
npm install @dnd-kit/core @dnd-kit/sortable @dnd-kit/utilities

# shadcn/ui accordion (미설치 시)
npx shadcn@latest add accordion

# sonner (Toast, 이미 설치되어 있을 가능성)
npx shadcn@latest add sonner
```

### 롤백 방법

**만약 문제 발생 시:**
1. Kanban View 버튼만 숨김 (조건부 렌더링)
2. 기존 Table View + Transfer Stock 폼은 영향 없음
3. API는 기존 로직도 유지하므로 문제 없음
4. 점진적 롤백 가능

```tsx
// 긴급 롤백 시
const ENABLE_KANBAN = false  // feature flag

{profile.role === 'HQ_Admin' && ENABLE_KANBAN && (
  <Button>Kanban View</Button>
)}
```

---

## 향후 개선 방향 (Post-MVP)

### Phase 2 개선사항

1. **배치 다중 선택**
   - Shift + Click으로 여러 배치 선택
   - 한 번에 여러 배치 이동

2. **빠른 수량 프리셋**
   - Dialog에 "Half", "All" 버튼 추가
   - 자주 사용하는 수량 저장

3. **이동 히스토리 표시**
   - 최근 이동 내역 패널
   - Undo 기능 (일정 시간 내)

4. **실시간 동기화**
   - Supabase Realtime subscription
   - 다른 사용자 변경 즉시 반영
   - Optimistic UI 업데이트

5. **필터링 & 검색**
   - 제품명 검색
   - 만료일 임박 제품만 표시
   - 카테고리 필터

6. **드래그 애니메이션 개선**
   - 부드러운 Snap 효과
   - Accordion 자동 펼치기 (드래그 중 호버 시)

7. **배치 상세 정보 Popover**
   - 카드 클릭 시 모든 배치 정보
   - Quality status 변경 기능

8. **통화 자동 변환**
   - Branch → HQ 이동 시 환율 적용
   - 실시간 환율 조회

9. **모바일 앱 최적화**
   - Bottom Sheet 스타일 Dialog
   - Swipe 제스처 지원

---

## 예상 작업 시간

| Phase | 작업 내용 | 예상 시간 |
|-------|----------|-----------|
| 1 | 뷰 전환 기능 + Client Component 변환 | 1시간 |
| 2 | 유틸리티 함수 작성 | 1시간 |
| 3 | Kanban 보드 컴포넌트 | 2시간 |
| 4 | Location Accordion 컴포넌트 | 1.5시간 |
| 5 | Batch Card 컴포넌트 (반응형) | 2.5시간 |
| 6 | Transfer Dialog | 1.5시간 |
| 7 | Badge variant 추가 | 30분 |
| 8 | API 양방향 이동 수정 | 1시간 |
| 9 | 권한 제어 및 Validation | 1시간 |
| 10 | 스타일링 및 UX 개선 | 2시간 |
| 11 | 반응형 테스트 (Desktop/Tablet/Mobile) | 2시간 |
| 12 | 통합 테스트 및 버그 수정 | 2시간 |

**총 예상 시간:** 약 18시간 (2.5 작업일)

---

## 요약

### 핵심 기능

✅ **기존 방식 유지:** Transfer Stock 폼 페이지 그대로 사용 가능
✅ **새로운 방식 추가:** 세로 Accordion + 드래그 앤 드롭
✅ **배치별 개별 카드:** 모든 배치 정보 상세 표시
✅ **가로로 긴 카드 디자인:** 한눈에 모든 정보 파악
✅ **반응형 디자인:** Desktop/Tablet/Mobile 모두 최적화
✅ **접을 수 있는 섹션:** 긴 리스트도 편하게 관리
✅ **Branch Header로 드롭:** 제품 리스트가 길어도 쉽게 이동
✅ **양방향 이동:** HQ ↔ Branch 모두 가능 (HQ Admin)
✅ **권한 제어:** HQ Admin만 사용 가능
✅ **FIFO 유지:** 기존 Transfer API 그대로 사용

### 사용자 이점

**HQ Admin:**
- 빠른 재고 이동 (드래그 앤 드롭)
- 시각적 재고 관리 (색상 코드)
- 접을 수 있는 섹션으로 긴 리스트 관리
- 양방향 이동으로 유연한 재고 조정

**Branch Manager:**
- 기존 Table View로 자신의 재고 확인 (변경 없음)

**두 가지 방식 병행:**
- 간단한 이동: 드래그 앤 드롭
- 복잡한 작업: 기존 폼 사용

### 기술적 장점

- `@dnd-kit` 현대적이고 안정적
- shadcn/ui Accordion 재사용
- 기존 코드 재사용 (Transfer API, FIFO 로직)
- 반응형 디자인으로 모든 디바이스 지원
- 점진적 개선 가능 (Phase 2 기능 추가 용이)
- 롤백 안전 (기존 기능에 영향 없음)

### UI/UX 개선점

- 🎨 **시각적:** 만료일 색상 코드로 긴급도 파악
- 📱 **반응형:** 모바일에서도 완벽한 사용성
- 🔽 **Accordion:** 필요한 섹션만 펼쳐서 집중
- 🎯 **직관적:** Branch 헤더로 드래그만 하면 끝
- ⚡ **빠름:** 클릭 2번으로 이동 완료
- ♿ **접근성:** 키보드 네비게이션, Screen reader 지원

---

## 다음 단계

1. ✅ 계획서 검토 및 승인
2. 패키지 설치 (`@dnd-kit`, `accordion`)
3. Phase 1~7 순차 구현
4. API 양방향 이동 수정
5. HQ Admin 계정으로 통합 테스트
6. 반응형 테스트 (Desktop/Tablet/Mobile)
7. 배포 및 사용자 피드백 수집
8. Phase 2 개선사항 기획

---

## 참고 자료

- [@dnd-kit 문서](https://docs.dndkit.com/)
- [shadcn/ui Accordion](https://ui.shadcn.com/docs/components/accordion)
- [Tailwind CSS 반응형 디자인](https://tailwindcss.com/docs/responsive-design)
- [Supabase Client 사용법](https://supabase.com/docs/reference/javascript/introduction)
