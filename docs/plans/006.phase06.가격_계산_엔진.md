# Phase 06: 가격 계산 엔진

**작업 기간**: 4일
**담당자**: 개발팀
**목표**: 원가 기반 가격 계산기 구현 (핵심 비즈니스 로직)

---

## 1. 개요

시스템의 핵심 기능인 **원가 기반 가격 계산 엔진**을 구현합니다. 구매 단가, 이전 비용, 환율, 본사/지사 마진을 고려하여 최종 판매 가격을 자동으로 계산합니다.

### 핵심 목표
- ✅ 가격 계산 UI 구현
- ✅ **가격 계산 공식 적용**
- ✅ 자동 가격 계산 및 수동 조정 가능
- ✅ 제품-지사별 가격 설정 저장
- ✅ 가격 설정 목록 조회

---

## 2. 가격 계산 공식

### 2.1 계산 단계

```
[단계 1] 지사 원가 (Local Cost) 계산
지사 원가 = (구매 단가 + 이전 비용) / 환율

[단계 2] 판매 가격 (Selling Price) 계산
판매 가격 = 지사 원가 / (1 - 본사 마진% - 지사 마진%)

[단계 3] 최종 가격 (Final Price)
- 자동 계산된 가격을 반올림하여 표시
- HQ Admin이 수동으로 조정 가능
```

### 2.2 계산 예시

**베트남 지사 (VND) 예시**:
```
- 구매 단가: 5,000 KRW
- 이전 비용: 500 KRW
- 환율: 1 KRW = 18 VND
- 본사 마진: 10%
- 지사 마진: 30%

→ 지사 원가 = (5,000 + 500) / 18 = 305.56 VND
→ 판매 가격 = 305.56 / (1 - 0.10 - 0.30) = 305.56 / 0.60 = 509.27 VND
→ 최종 가격 = 500 VND (반올림 조정)
```

**중국 지사 (CNY) 예시**:
```
- 구매 단가: 5,000 KRW
- 이전 비용: 500 KRW
- 환율: 1 KRW = 0.0053 CNY
- 본사 마진: 10%
- 지사 마진: 25%

→ 지사 원가 = (5,000 + 500) / 0.0053 = 1,037,735.85 CNY (잘못된 환율)
→ 올바른 환율: 1 CNY = 188.68 KRW이므로, 1 KRW = 0.0053 CNY
→ 지사 원가 = (5,000 + 500) × 0.0053 = 29.15 CNY
→ 판매 가격 = 29.15 / (1 - 0.10 - 0.25) = 29.15 / 0.65 = 44.85 CNY
→ 최종 가격 = 45.00 CNY (반올림 조정)
```

---

## 3. 작업 상세

### 3.1 가격 설정 목록 페이지

**파일**: `app/(dashboard)/pricing/page.tsx`

```typescript
import { createServerClient } from '@/lib/supabase/server'
import { PricingList } from '@/components/pricing/pricing-list'
import { Button } from '@/components/ui/button'
import Link from 'next/link'
import { Plus } from 'lucide-react'

export default async function PricingPage() {
  const supabase = createServerClient()

  const { data: pricingConfigs, error } = await supabase
    .from('pricing_configs')
    .select(`
      *,
      product:products(sku, name, unit),
      from_location:from_location_id(name),
      to_location:to_location_id(name, country_code, currency)
    `)
    .order('updated_at', { ascending: false })

  if (error) {
    return <div>Error loading pricing configs: {error.message}</div>
  }

  return (
    <div>
      <div className="flex justify-between items-center mb-6">
        <h1 className="text-3xl font-bold">Pricing Configuration</h1>
        <Link href="/pricing/new">
          <Button>
            <Plus className="mr-2 h-4 w-4" />
            Add Pricing
          </Button>
        </Link>
      </div>

      <PricingList pricingConfigs={pricingConfigs || []} />
    </div>
  )
}
```

### 3.2 가격 설정 목록 컴포넌트

**파일**: `components/pricing/pricing-list.tsx`

```typescript
'use client'

import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from '@/components/ui/table'
import { Button } from '@/components/ui/button'
import Link from 'next/link'
import { Edit } from 'lucide-react'
import { formatCurrency } from '@/lib/utils'

export function PricingList({ pricingConfigs }: { pricingConfigs: any[] }) {
  return (
    <div className="border rounded-lg">
      <Table>
        <TableHeader>
          <TableRow>
            <TableHead>Product</TableHead>
            <TableHead>Destination</TableHead>
            <TableHead>Purchase Price</TableHead>
            <TableHead>Transfer Cost</TableHead>
            <TableHead>Margins</TableHead>
            <TableHead>Exchange Rate</TableHead>
            <TableHead>Final Price</TableHead>
            <TableHead className="text-right">Actions</TableHead>
          </TableRow>
        </TableHeader>
        <TableBody>
          {pricingConfigs.length === 0 ? (
            <TableRow>
              <TableCell colSpan={8} className="text-center text-gray-500">
                No pricing configurations found. Add your first pricing to get started.
              </TableCell>
            </TableRow>
          ) : (
            pricingConfigs.map((config) => (
              <TableRow key={config.id}>
                <TableCell>
                  <div>
                    <div className="font-medium">{config.product.sku}</div>
                    <div className="text-sm text-gray-500">{config.product.name}</div>
                  </div>
                </TableCell>
                <TableCell>
                  {config.to_location.name} ({config.to_location.country_code})
                </TableCell>
                <TableCell>{formatCurrency(config.purchase_price, 'KRW')}</TableCell>
                <TableCell>{formatCurrency(config.transfer_cost, 'KRW')}</TableCell>
                <TableCell>
                  <div className="text-sm">
                    <div>HQ: {config.hq_margin_percent}%</div>
                    <div>Branch: {config.branch_margin_percent}%</div>
                  </div>
                </TableCell>
                <TableCell>
                  1 KRW = {config.exchange_rate} {config.currency}
                </TableCell>
                <TableCell className="font-bold">
                  {formatCurrency(config.final_price, config.currency)}
                </TableCell>
                <TableCell className="text-right">
                  <Link href={`/pricing/${config.id}/edit`}>
                    <Button variant="ghost" size="sm">
                      <Edit className="h-4 w-4" />
                    </Button>
                  </Link>
                </TableCell>
              </TableRow>
            ))
          )}
        </TableBody>
      </Table>
    </div>
  )
}
```

---

### 3.3 가격 계산 폼

#### 3.3.1 가격 추가 페이지

**파일**: `app/(dashboard)/pricing/new/page.tsx`

```typescript
import { createServerClient } from '@/lib/supabase/server'
import { PricingForm } from '@/components/pricing/pricing-form'

export default async function NewPricingPage() {
  const supabase = createServerClient()

  // HQ 지사 조회
  const { data: hqLocation } = await supabase
    .from('locations')
    .select('id, name')
    .eq('location_type', 'HQ')
    .single()

  // 지사 목록 (Branch만)
  const { data: branches } = await supabase
    .from('locations')
    .select('id, name, country_code, currency')
    .eq('location_type', 'Branch')
    .order('name')

  // 제품 목록
  const { data: products } = await supabase
    .from('products')
    .select('id, sku, name, unit')
    .order('sku')

  return (
    <div>
      <h1 className="text-3xl font-bold mb-6">Add Pricing Configuration</h1>
      <PricingForm
        hqLocation={hqLocation}
        branches={branches || []}
        products={products || []}
        mode="create"
      />
    </div>
  )
}
```

#### 3.3.2 가격 계산 폼 컴포넌트

**파일**: `components/pricing/pricing-form.tsx`

```typescript
'use client'

import { useState, useEffect } from 'react'
import { useRouter } from 'next/navigation'
import { createClient } from '@/lib/supabase/client'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { Label } from '@/components/ui/label'
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from '@/components/ui/card'
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select'
import { useToast } from '@/components/ui/use-toast'
import { ExchangeRateSelector } from '@/components/exchange-rates/exchange-rate-selector'
import { Calculator } from 'lucide-react'

interface PricingFormProps {
  hqLocation: any
  branches: Array<{ id: string; name: string; country_code: string; currency: string }>
  products: Array<{ id: string; sku: string; name: string; unit: string }>
  mode: 'create' | 'edit'
  existingConfig?: any
}

export function PricingForm({
  hqLocation,
  branches,
  products,
  mode,
  existingConfig,
}: PricingFormProps) {
  const [formData, setFormData] = useState({
    product_id: existingConfig?.product_id || '',
    to_location_id: existingConfig?.to_location_id || '',
    purchase_price: existingConfig?.purchase_price || '',
    transfer_cost: existingConfig?.transfer_cost || '',
    hq_margin_percent: existingConfig?.hq_margin_percent || '',
    branch_margin_percent: existingConfig?.branch_margin_percent || '',
    exchange_rate: existingConfig?.exchange_rate || '',
    calculated_price: existingConfig?.calculated_price || '',
    final_price: existingConfig?.final_price || '',
  })
  const [selectedBranch, setSelectedBranch] = useState<any>(null)
  const [loading, setLoading] = useState(false)
  const router = useRouter()
  const { toast } = useToast()
  const supabase = createClient()

  useEffect(() => {
    const branch = branches.find(b => b.id === formData.to_location_id)
    setSelectedBranch(branch || null)
  }, [formData.to_location_id, branches])

  // 최근 PO에서 구매 단가 자동 불러오기
  const fetchLatestPurchasePrice = async (productId: string) => {
    const { data } = await supabase
      .from('purchase_order_items')
      .select('unit_price, po:purchase_orders!inner(status)')
      .eq('product_id', productId)
      .eq('po.status', 'Received')
      .order('created_at', { ascending: false })
      .limit(1)
      .single()

    if (data) {
      setFormData(prev => ({ ...prev, purchase_price: data.unit_price.toString() }))
    }
  }

  const handleProductChange = (productId: string) => {
    setFormData({ ...formData, product_id: productId })
    fetchLatestPurchasePrice(productId)
  }

  const calculatePrice = () => {
    const {
      purchase_price,
      transfer_cost,
      hq_margin_percent,
      branch_margin_percent,
      exchange_rate,
    } = formData

    if (!purchase_price || !exchange_rate) {
      toast({ variant: 'destructive', title: 'Please fill required fields' })
      return
    }

    // 1. 지사 원가 계산
    const totalCostKRW = parseFloat(purchase_price) + parseFloat(transfer_cost || '0')
    const localCost = totalCostKRW * parseFloat(exchange_rate)

    // 2. 판매 가격 계산
    const totalMargin = parseFloat(hq_margin_percent || '0') + parseFloat(branch_margin_percent || '0')
    const sellingPrice = localCost / (1 - totalMargin / 100)

    // 3. 반올림 제안
    const roundedPrice = Math.round(sellingPrice / 100) * 100 // 100단위 반올림

    setFormData(prev => ({
      ...prev,
      calculated_price: sellingPrice.toFixed(2),
      final_price: roundedPrice.toString(),
    }))

    toast({ title: 'Price calculated successfully', description: `Suggested price: ${roundedPrice} ${selectedBranch?.currency}` })
  }

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault()

    if (!formData.final_price) {
      toast({ variant: 'destructive', title: 'Please calculate price first' })
      return
    }

    setLoading(true)

    try {
      const data = {
        product_id: formData.product_id,
        from_location_id: hqLocation.id,
        to_location_id: formData.to_location_id,
        purchase_price: parseFloat(formData.purchase_price),
        transfer_cost: parseFloat(formData.transfer_cost || '0'),
        hq_margin_percent: parseFloat(formData.hq_margin_percent || '0'),
        branch_margin_percent: parseFloat(formData.branch_margin_percent || '0'),
        exchange_rate: parseFloat(formData.exchange_rate),
        calculated_price: parseFloat(formData.calculated_price),
        final_price: parseFloat(formData.final_price),
        currency: selectedBranch?.currency,
      }

      if (mode === 'create') {
        const { error } = await supabase
          .from('pricing_configs')
          .insert([data])

        if (error) throw error

        toast({ title: 'Pricing configuration created successfully' })
      } else {
        const { error } = await supabase
          .from('pricing_configs')
          .update(data)
          .eq('id', existingConfig.id)

        if (error) throw error

        toast({ title: 'Pricing configuration updated successfully' })
      }

      router.push('/pricing')
      router.refresh()
    } catch (error: any) {
      toast({
        variant: 'destructive',
        title: 'Error',
        description: error.message,
      })
    } finally {
      setLoading(false)
    }
  }

  return (
    <Card>
      <CardHeader>
        <CardTitle>{mode === 'create' ? 'Add New' : 'Edit'} Pricing Configuration</CardTitle>
        <CardDescription>
          Calculate selling price based on purchase price, transfer cost, margins, and exchange rate.
        </CardDescription>
      </CardHeader>
      <CardContent>
        <form onSubmit={handleSubmit} className="space-y-6">
          {/* 제품 및 지사 선택 */}
          <div className="grid grid-cols-2 gap-4">
            <div>
              <Label htmlFor="product_id">Product *</Label>
              <Select
                value={formData.product_id}
                onValueChange={handleProductChange}
                disabled={mode === 'edit'}
              >
                <SelectTrigger>
                  <SelectValue placeholder="Select product" />
                </SelectTrigger>
                <SelectContent>
                  {products.map((product) => (
                    <SelectItem key={product.id} value={product.id}>
                      {product.sku} - {product.name}
                    </SelectItem>
                  ))}
                </SelectContent>
              </Select>
            </div>
            <div>
              <Label htmlFor="to_location_id">Destination Branch *</Label>
              <Select
                value={formData.to_location_id}
                onValueChange={(value) => setFormData({ ...formData, to_location_id: value })}
                disabled={mode === 'edit'}
              >
                <SelectTrigger>
                  <SelectValue placeholder="Select branch" />
                </SelectTrigger>
                <SelectContent>
                  {branches.map((branch) => (
                    <SelectItem key={branch.id} value={branch.id}>
                      {branch.name} ({branch.country_code})
                    </SelectItem>
                  ))}
                </SelectContent>
              </Select>
            </div>
          </div>

          {/* 비용 입력 */}
          <div className="grid grid-cols-2 gap-4">
            <div>
              <Label htmlFor="purchase_price">Purchase Price (KRW) *</Label>
              <Input
                id="purchase_price"
                type="number"
                step="0.01"
                min="0"
                value={formData.purchase_price}
                onChange={(e) => setFormData({ ...formData, purchase_price: e.target.value })}
                required
              />
              <p className="text-sm text-gray-600 mt-1">Auto-loaded from recent PO</p>
            </div>
            <div>
              <Label htmlFor="transfer_cost">Transfer Cost (KRW)</Label>
              <Input
                id="transfer_cost"
                type="number"
                step="0.01"
                min="0"
                value={formData.transfer_cost}
                onChange={(e) => setFormData({ ...formData, transfer_cost: e.target.value })}
              />
              <p className="text-sm text-gray-600 mt-1">Shipping, customs, etc.</p>
            </div>
          </div>

          {/* 마진 입력 */}
          <div className="grid grid-cols-2 gap-4">
            <div>
              <Label htmlFor="hq_margin_percent">HQ Margin (%)</Label>
              <Input
                id="hq_margin_percent"
                type="number"
                step="0.01"
                min="0"
                max="99"
                value={formData.hq_margin_percent}
                onChange={(e) => setFormData({ ...formData, hq_margin_percent: e.target.value })}
              />
            </div>
            <div>
              <Label htmlFor="branch_margin_percent">Branch Margin (%)</Label>
              <Input
                id="branch_margin_percent"
                type="number"
                step="0.01"
                min="0"
                max="99"
                value={formData.branch_margin_percent}
                onChange={(e) => setFormData({ ...formData, branch_margin_percent: e.target.value })}
              />
            </div>
          </div>

          {/* 환율 */}
          {selectedBranch && (
            <ExchangeRateSelector
              fromCurrency="KRW"
              toCurrency={selectedBranch.currency}
              value={parseFloat(formData.exchange_rate || '0')}
              onChange={(rate) => setFormData({ ...formData, exchange_rate: rate.toString() })}
            />
          )}

          {/* 가격 계산 버튼 */}
          <div className="flex justify-center">
            <Button type="button" onClick={calculatePrice} variant="secondary">
              <Calculator className="mr-2 h-4 w-4" />
              Calculate Price
            </Button>
          </div>

          {/* 계산 결과 */}
          {formData.calculated_price && (
            <div className="grid grid-cols-2 gap-4 p-4 bg-blue-50 rounded-lg">
              <div>
                <Label>Calculated Price (Auto)</Label>
                <Input
                  value={`${parseFloat(formData.calculated_price).toLocaleString()} ${selectedBranch?.currency}`}
                  disabled
                />
              </div>
              <div>
                <Label htmlFor="final_price">Final Price (Adjustable) *</Label>
                <Input
                  id="final_price"
                  type="number"
                  step="0.01"
                  min="0"
                  value={formData.final_price}
                  onChange={(e) => setFormData({ ...formData, final_price: e.target.value })}
                  required
                />
                <p className="text-sm text-gray-600 mt-1">You can adjust the final price</p>
              </div>
            </div>
          )}

          <div className="flex gap-2">
            <Button type="submit" disabled={loading}>
              {loading ? 'Saving...' : 'Save Pricing'}
            </Button>
            <Button type="button" variant="outline" onClick={() => router.back()}>
              Cancel
            </Button>
          </div>
        </form>
      </CardContent>
    </Card>
  )
}
```

---

## 4. 테스트 체크리스트

### 4.1 가격 계산 테스트
- [ ] 제품 선택 시 최근 PO의 구매 단가 자동 불러오기
- [ ] 지사 선택 시 해당 통화의 최신 환율 자동 불러오기
- [ ] 가격 계산 버튼 클릭 시 공식 적용 정상 작동
- [ ] 계산된 가격과 최종 가격 표시
- [ ] 최종 가격 수동 조정 가능

### 4.2 공식 검증
- [ ] 지사 원가 = (구매 단가 + 이전 비용) × 환율 (정확성)
- [ ] 판매 가격 = 지사 원가 / (1 - 마진%) (정확성)
- [ ] 마진 합계가 100% 이상일 때 에러 처리

### 4.3 저장 테스트
- [ ] pricing_configs 테이블에 저장 확인
- [ ] 제품-지사 조합의 중복 방지 (UNIQUE 제약)
- [ ] 저장 후 가격 목록에 표시

---

## 5. 산출물

### 5.1 완료된 기능
- ✅ 가격 계산 UI
- ✅ **가격 계산 공식 적용** (핵심 비즈니스 로직)
- ✅ 최근 PO 구매 단가 자동 불러오기
- ✅ 최신 환율 자동 불러오기
- ✅ 자동 계산 및 수동 조정
- ✅ 제품-지사별 가격 저장
- ✅ 가격 설정 목록 조회

### 5.2 다음 Phase 준비사항
- Phase 07에서 판매 입력 시 pricing_configs의 final_price 사용
- 가격 테스트 데이터 생성 (제품 10개 × 지사 2개 = 20개 가격 설정)

---

## 6. 작업 이후 체크리스트

- [ ] 가격 계산 공식 정확성 검증
- [ ] 다양한 시나리오 테스트 (다른 마진율, 환율)
- [ ] 가격 설정 저장 및 조회 정상 작동 확인
- [ ] GitHub에 코드 푸시
- [ ] Worklog 문서 작성: `006.phase06.가격_계산_엔진.md`
- [ ] Phase 07 계획 검토
