# 005. Phase 04 Enhanced 2 - Location ìˆœì„œ ë³€ê²½ ê¸°ëŠ¥ êµ¬í˜„ ê³„íš

## ì‘ì—… ê°œìš”

**ëª©í‘œ:** ì‚¬ìš©ìê°€ Inventory Kanban Viewì—ì„œ í‘œì‹œë˜ëŠ” Location ìˆœì„œë¥¼ ììœ ë¡­ê²Œ ë³€ê²½í•  ìˆ˜ ìˆëŠ” ê¸°ëŠ¥ ì¶”ê°€

**í˜„ì¬ ìƒí™©:**
- Kanban Viewì—ì„œ ìˆœì„œê°€ ê³ ì •ë¨: Korea HQ â†’ China â†’ Vietnam
- ë‚˜ì¤‘ì— Branch ì¶”ê°€ ì‹œ ìˆœì„œ ì¡°ì • ì–´ë ¤ì›€
- Location ì¶”ê°€/ì‚­ì œ ì‹œ ìœ ì—°í•œ ìˆœì„œ ê´€ë¦¬ í•„ìš”

**ëª©í‘œ ìˆœì„œ:**
- Korea HQ: 1
- Vietnam Branch: 2
- China Branch: 3

---

## ì¶”ì²œ ë°©ì‹: ì „ìš© ìˆœì„œ ë³€ê²½ í˜ì´ì§€ (Dedicated Reorder Page)

### ì„ íƒ ì´ìœ 

| ê¸°ì¤€ | ì´ìœ  |
|------|------|
| **ë°ì´í„° í¬ê¸°** | 3-5ê°œ locations â†’ ë‹¨ìˆœ ì •ìˆ˜ ìˆœì„œë¡œ ì¶©ë¶„ |
| **ê¸°ìˆ  ìŠ¤íƒ** | ì´ë¯¸ @dnd-kit ì‚¬ìš© ì¤‘ â†’ ì¼ê´€ëœ UX |
| **ì‚¬ìš© ë¹ˆë„** | ë“œë¬¼ê²Œ ë³€ê²½ â†’ ë³„ë„ í˜ì´ì§€ê°€ ì í•© |
| **ì•ˆì „ì„±** | ì‹¤ìˆ˜ë¡œ ìˆœì„œ ë³€ê²½ ë°©ì§€ (ëª…í™•í•œ ì €ì¥ ë‹¨ê³„) |
| **ì ‘ê·¼ì„±** | í‚¤ë³´ë“œ ë„¤ë¹„ê²Œì´ì…˜ + í„°ì¹˜ ë“œë˜ê·¸ ì§€ì› |

### ë¹„êµ: ë‹¤ë¥¸ ë°©ì‹ë“¤

#### ë°©ì‹ A: Kanban Viewì—ì„œ ì§ì ‘ ë“œë˜ê·¸
```
Korea HQ (ë“œë˜ê·¸ ê°€ëŠ¥)
  â†•ï¸
Vietnam Branch (ë“œë˜ê·¸ ê°€ëŠ¥)
  â†•ï¸
China Branch (ë“œë˜ê·¸ ê°€ëŠ¥)
```

**ì¥ì :**
- ë¹ ë¥¸ ì ‘ê·¼ (ë³„ë„ í˜ì´ì§€ ì—†ìŒ)
- ì¦‰ì‹œ ë³€ê²½ ê°€ëŠ¥

**ë‹¨ì :**
- âŒ ì¬ê³  ì´ë™ê³¼ í˜¼ë™ ê°€ëŠ¥
- âŒ ì‹¤ìˆ˜ë¡œ ìˆœì„œ ë³€ê²½ ìœ„í—˜
- âŒ UIê°€ ë³µì¡í•´ì§ (ë‘ ê°€ì§€ ë“œë˜ê·¸ ê¸°ëŠ¥)

**ê²°ë¡ :** ì¶”ì²œí•˜ì§€ ì•ŠìŒ

---

#### ë°©ì‹ B: ì „ìš© ìˆœì„œ ë³€ê²½ í˜ì´ì§€ âœ… **ì¶”ì²œ**
```
/locations í˜ì´ì§€
  [Locations ëª©ë¡]
  [Reorder Locations] ë²„íŠ¼
    â†“
/locations/reorder í˜ì´ì§€
  ë“œë˜ê·¸ ê°€ëŠ¥í•œ ë¦¬ìŠ¤íŠ¸
  [Save Order] / [Cancel]
```

**ì¥ì :**
- âœ… ëª…í™•í•œ ëª©ì  (ìˆœì„œ ë³€ê²½ë§Œ)
- âœ… ì•ˆì „ (ì €ì¥ ì „ê¹Œì§€ ë³€ê²½ ì—†ìŒ)
- âœ… ì¬ê³  ì´ë™ê³¼ ë¶„ë¦¬
- âœ… ê¹”ë”í•œ UI
- âœ… ë¯¸ë¦¬ë³´ê¸° ê°€ëŠ¥

**ë‹¨ì :**
- í•œ ë²ˆ ë” í´ë¦­ í•„ìš”

**ê²°ë¡ :** ìµœì¢… ì„ íƒ âœ…

---

#### ë°©ì‹ C: Table Viewì—ì„œ â†‘â†“ ë²„íŠ¼
```
Korea HQ        [â†‘] [â†“]
Vietnam Branch  [â†‘] [â†“]
China Branch    [â†‘] [â†“]
```

**ì¥ì :**
- ê°„ë‹¨í•œ êµ¬í˜„
- ì ‘ê·¼ì„± ìš°ìˆ˜ (ë²„íŠ¼)

**ë‹¨ì :**
- ë§ì€ í´ë¦­ í•„ìš”
- ì‹œê°ì ìœ¼ë¡œ ëœ ì§ê´€ì 

**ê²°ë¡ :** ë³´ì¡° ìˆ˜ë‹¨ìœ¼ë¡œë§Œ ê³ ë ¤

---

## ë°ì´í„°ë² ì´ìŠ¤ ì„¤ê³„

### ìƒˆ ì»¬ëŸ¼: `display_order`

```sql
-- Type: INTEGER
-- Purpose: Location í‘œì‹œ ìˆœì„œ ì €ì¥
-- Range: 1, 2, 3, ... (1ë¶€í„° ì‹œì‘)
```

**íŠ¹ì§•:**
- NOT NULL ì œì•½
- Index ì¶”ê°€ (ì„±ëŠ¥ ìµœì í™”)
- ê¸°ë³¸ ì •ë ¬ ê¸°ì¤€ìœ¼ë¡œ ì‚¬ìš©

---

## êµ¬í˜„ ê³„íš

### Phase 1: ë°ì´í„°ë² ì´ìŠ¤ ë§ˆì´ê·¸ë ˆì´ì…˜

**íŒŒì¼:** `supabase/migrations/013_add_locations_display_order.sql` (ì‹ ê·œ ìƒì„±)

```sql
-- Step 1: Add display_order column
ALTER TABLE public.locations
ADD COLUMN display_order INTEGER;

-- Step 2: Set initial values
-- Korea HQ: 1, Vietnam Branch: 2, China Branch: 3
UPDATE public.locations
SET display_order = CASE
  WHEN location_type = 'HQ' THEN 1
  WHEN name LIKE '%Vietnam%' THEN 2
  WHEN name LIKE '%China%' THEN 3
  ELSE 99  -- Fallback for future branches
END;

-- Better approach: Update by country_code
UPDATE public.locations
SET display_order = CASE
  WHEN location_type = 'HQ' THEN 1
  WHEN country_code = 'VN' THEN 2
  WHEN country_code = 'CN' THEN 3
  ELSE (
    SELECT COALESCE(MAX(display_order), 0) + 1
    FROM public.locations
    WHERE display_order < 99
  )  -- Auto-increment for new branches
END;

-- Step 3: Make it NOT NULL
ALTER TABLE public.locations
ALTER COLUMN display_order SET NOT NULL;

-- Step 4: Add index for performance
CREATE INDEX idx_locations_display_order
ON public.locations(display_order);

-- Step 5: Add comment
COMMENT ON COLUMN public.locations.display_order
IS 'Display order in UI (1=first, 2=second, etc.)';
```

**ê²€ì¦ ì¿¼ë¦¬:**
```sql
-- Verify order
SELECT id, name, location_type, country_code, display_order
FROM public.locations
ORDER BY display_order;

-- Expected result:
-- 1 | Korea HQ       | HQ     | KR  | 1
-- 2 | Vietnam Branch | Branch | VN  | 2
-- 3 | China Branch   | Branch | CN  | 3
```

---

### Phase 2: íƒ€ì… ì •ì˜ ì—…ë°ì´íŠ¸

**íŒŒì¼:** `types/database.ts` (ìˆ˜ì •)

**í˜„ì¬:**
```typescript
locations: {
  Row: {
    id: string
    name: string
    location_type: string
    country_code: string
    address: string | null
    currency: string
    timezone: string
    created_at: string
    updated_at: string
  }
}
```

**ë³€ê²½ í›„:**
```typescript
locations: {
  Row: {
    id: string
    name: string
    location_type: string
    country_code: string
    address: string | null
    currency: string
    timezone: string
    display_order: number  // â† ADD THIS
    created_at: string
    updated_at: string
  }
  Insert: {
    // ... existing fields
    display_order?: number  // Optional on insert (will auto-calculate)
  }
  Update: {
    // ... existing fields
    display_order?: number  // Optional on update
  }
}
```

---

### Phase 3: Sortable Location Item ì»´í¬ë„ŒíŠ¸

**íŒŒì¼:** `components/locations/sortable-location-item.tsx` (ì‹ ê·œ ìƒì„±)

```tsx
'use client'

import { useSortable } from '@dnd-kit/sortable'
import { CSS } from '@dnd-kit/utilities'
import { GripVertical } from 'lucide-react'
import { Badge } from '@/components/ui/badge'
import { cn } from '@/lib/utils'
import { Location } from '@/types'

interface SortableLocationItemProps {
  location: Location
}

export function SortableLocationItem({ location }: SortableLocationItemProps) {
  const {
    attributes,
    listeners,
    setNodeRef,
    transform,
    transition,
    isDragging,
  } = useSortable({ id: location.id })

  const style = {
    transform: CSS.Transform.toString(transform),
    transition,
  }

  return (
    <div
      ref={setNodeRef}
      style={style}
      className={cn(
        'flex items-center gap-4 p-4 bg-card border rounded-lg',
        'transition-all duration-200',
        isDragging && 'opacity-50 shadow-lg ring-2 ring-primary',
        'hover:shadow-md'
      )}
    >
      {/* Drag Handle */}
      <div
        {...attributes}
        {...listeners}
        className="cursor-grab active:cursor-grabbing touch-none"
      >
        <GripVertical className="h-5 w-5 text-muted-foreground" />
      </div>

      {/* Location Info */}
      <div className="flex-1">
        <div className="flex items-center gap-2 mb-1">
          <span className="font-medium text-lg">{location.name}</span>
          <Badge
            variant={location.location_type === 'HQ' ? 'default' : 'secondary'}
          >
            {location.location_type}
          </Badge>
        </div>
        <div className="flex items-center gap-3 text-sm text-muted-foreground">
          <span>ğŸŒ {location.country_code}</span>
          <span>ğŸ’° {location.currency}</span>
          {location.address && <span>ğŸ“ {location.address}</span>}
        </div>
      </div>

      {/* Order Number (visual indicator) */}
      <div className="text-2xl font-bold text-muted-foreground/30">
        {location.display_order}
      </div>
    </div>
  )
}
```

---

### Phase 4: Reorder í˜ì´ì§€ ìƒì„±

**íŒŒì¼:** `app/(dashboard)/locations/reorder/page.tsx` (ì‹ ê·œ ìƒì„±)

```tsx
import { createClient } from '@/lib/supabase/server'
import { redirect } from 'next/navigation'
import { LocationsReorderClient } from '@/components/locations/locations-reorder-client'

export default async function LocationsReorderPage() {
  const supabase = await createClient()

  // Check authentication
  const {
    data: { user },
  } = await supabase.auth.getUser()

  if (!user) {
    redirect('/login')
  }

  // Get user profile
  const { data: profile } = await supabase
    .from('users')
    .select('role')
    .eq('id', user.id)
    .single()

  // Only HQ Admin can reorder locations
  if (profile?.role !== 'HQ_Admin') {
    redirect('/locations')
  }

  // Fetch locations ordered by display_order
  const { data: locations, error } = await supabase
    .from('locations')
    .select('*')
    .order('display_order', { ascending: true })

  if (error) {
    console.error('Error loading locations:', error)
    return (
      <div className="flex items-center justify-center h-96">
        <p className="text-destructive">Error loading locations</p>
      </div>
    )
  }

  return (
    <div className="space-y-6">
      <div>
        <h1 className="text-3xl font-bold">Reorder Locations</h1>
        <p className="text-muted-foreground mt-1">
          Drag and drop to change the display order of locations
        </p>
      </div>

      <LocationsReorderClient initialLocations={locations || []} />
    </div>
  )
}
```

---

### Phase 5: Reorder Client ì»´í¬ë„ŒíŠ¸

**íŒŒì¼:** `components/locations/locations-reorder-client.tsx` (ì‹ ê·œ ìƒì„±)

```tsx
'use client'

import { useState } from 'react'
import { useRouter } from 'next/navigation'
import {
  DndContext,
  closestCenter,
  KeyboardSensor,
  PointerSensor,
  useSensor,
  useSensors,
  DragEndEvent,
} from '@dnd-kit/core'
import {
  arrayMove,
  SortableContext,
  sortableKeyboardCoordinates,
  verticalListSortingStrategy,
} from '@dnd-kit/sortable'
import { Button } from '@/components/ui/button'
import { SortableLocationItem } from './sortable-location-item'
import { createClient } from '@/lib/supabase/client'
import { toast } from 'sonner'
import { ArrowLeft, Save } from 'lucide-react'
import { Location } from '@/types'

interface LocationsReorderClientProps {
  initialLocations: Location[]
}

export function LocationsReorderClient({
  initialLocations,
}: LocationsReorderClientProps) {
  const [locations, setLocations] = useState(initialLocations)
  const [hasChanges, setHasChanges] = useState(false)
  const [isSaving, setIsSaving] = useState(false)
  const router = useRouter()
  const supabase = createClient()

  // Setup sensors for drag and drop
  const sensors = useSensors(
    useSensor(PointerSensor),
    useSensor(KeyboardSensor, {
      coordinateGetter: sortableKeyboardCoordinates,
    })
  )

  const handleDragEnd = (event: DragEndEvent) => {
    const { active, over } = event

    if (!over || active.id === over.id) {
      return
    }

    setLocations((items) => {
      const oldIndex = items.findIndex((item) => item.id === active.id)
      const newIndex = items.findIndex((item) => item.id === over.id)

      const newItems = arrayMove(items, oldIndex, newIndex)
      setHasChanges(true)
      return newItems
    })
  }

  const handleSave = async () => {
    setIsSaving(true)

    try {
      // Update display_order for all locations
      const updates = locations.map((location, index) => ({
        id: location.id,
        display_order: index + 1, // 1-based indexing
      }))

      // Execute all updates
      const { error } = await supabase
        .from('locations')
        .upsert(
          updates.map((u) => ({
            id: u.id,
            display_order: u.display_order,
          }))
        )

      if (error) {
        throw error
      }

      toast.success('Location order saved successfully')
      router.push('/locations')
      router.refresh()
    } catch (error) {
      console.error('Error saving order:', error)
      toast.error('Failed to save location order')
    } finally {
      setIsSaving(false)
    }
  }

  const handleCancel = () => {
    if (hasChanges) {
      const confirm = window.confirm(
        'You have unsaved changes. Are you sure you want to cancel?'
      )
      if (!confirm) return
    }
    router.push('/locations')
  }

  return (
    <div className="space-y-6">
      {/* Info Banner */}
      <div className="bg-accent/50 border border-accent rounded-lg p-4">
        <p className="text-sm">
          ğŸ’¡ <strong>Tip:</strong> Drag the grip handle (â‹®â‹®) to reorder
          locations. This order will be used in the Inventory Kanban View.
        </p>
      </div>

      {/* Sortable List */}
      <DndContext
        sensors={sensors}
        collisionDetection={closestCenter}
        onDragEnd={handleDragEnd}
      >
        <SortableContext
          items={locations}
          strategy={verticalListSortingStrategy}
        >
          <div className="space-y-2">
            {locations.map((location) => (
              <SortableLocationItem key={location.id} location={location} />
            ))}
          </div>
        </SortableContext>
      </DndContext>

      {/* Action Buttons */}
      <div className="flex items-center justify-between pt-4 border-t">
        <Button variant="outline" onClick={handleCancel}>
          <ArrowLeft className="mr-2 h-4 w-4" />
          Cancel
        </Button>

        <Button onClick={handleSave} disabled={!hasChanges || isSaving}>
          <Save className="mr-2 h-4 w-4" />
          {isSaving ? 'Saving...' : 'Save Order'}
        </Button>
      </div>

      {/* Change Indicator */}
      {hasChanges && (
        <div className="text-sm text-muted-foreground text-center">
          âš ï¸ You have unsaved changes
        </div>
      )}
    </div>
  )
}
```

---

### Phase 6: Locations í˜ì´ì§€ì— Reorder ë²„íŠ¼ ì¶”ê°€

**íŒŒì¼:** `app/(dashboard)/locations/page.tsx` (ìˆ˜ì •)

**ë³€ê²½ ì „:**
```typescript
const { data: locations } = await supabase
  .from('locations')
  .select('*')
  .order('location_type', { ascending: false })
```

**ë³€ê²½ í›„:**
```typescript
const { data: locations } = await supabase
  .from('locations')
  .select('*')
  .order('display_order', { ascending: true })  // â† CHANGED
```

**UI ë³€ê²½:**
```tsx
<div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
  <div>
    <h1 className="text-3xl font-bold">Locations</h1>
    <p className="text-muted-foreground mt-1">
      Manage your warehouse and branch locations
    </p>
  </div>

  {/* Action Buttons */}
  <div className="flex gap-2">
    {userData?.role === 'HQ_Admin' && (
      <>
        {/* Reorder Button - NEW */}
        <Link href="/locations/reorder">
          <Button variant="outline">
            <GripVertical className="mr-2 h-4 w-4" />
            Reorder
          </Button>
        </Link>

        {/* Existing Add Button */}
        <Link href="/locations/new">
          <Button>
            <Plus className="mr-2 h-4 w-4" />
            Add Location
          </Button>
        </Link>
      </>
    )}
  </div>
</div>
```

---

### Phase 7: Inventory í˜ì´ì§€ ì •ë ¬ ì—…ë°ì´íŠ¸

**íŒŒì¼:** `app/(dashboard)/inventory/page.tsx` (ìˆ˜ì •)

**ë³€ê²½ ì „:**
```typescript
// Get all locations for Kanban view
const { data: locations } = await supabase
  .from('locations')
  .select('*')
  .order('location_type', { ascending: false }) // HQ first, then Branches
```

**ë³€ê²½ í›„:**
```typescript
// Get all locations for Kanban view (ordered by display_order)
const { data: locations } = await supabase
  .from('locations')
  .select('*')
  .order('display_order', { ascending: true })  // â† CHANGED
```

---

### Phase 8: ìƒˆ Location ì¶”ê°€ ì‹œ ìë™ ìˆœì„œ í• ë‹¹

**íŒŒì¼:** `app/(dashboard)/locations/new/page.tsx` ë˜ëŠ” API (í•„ìš” ì‹œ ìˆ˜ì •)

```typescript
// When creating a new location, auto-assign display_order
const { data: maxOrder } = await supabase
  .from('locations')
  .select('display_order')
  .order('display_order', { ascending: false })
  .limit(1)
  .single()

const newDisplayOrder = (maxOrder?.display_order || 0) + 1

await supabase.from('locations').insert({
  name: 'New Branch',
  // ... other fields
  display_order: newDisplayOrder,  // Auto-assign to end
})
```

---

## ì‚¬ìš©ì ì‹œë‚˜ë¦¬ì˜¤

### ì‹œë‚˜ë¦¬ì˜¤ 1: ìˆœì„œ ë³€ê²½

**ëª©í‘œ:** Vietnamì„ ë§¨ ì•„ë˜ë¡œ ì´ë™

1. `/locations` í˜ì´ì§€ ì ‘ì†
2. **[Reorder]** ë²„íŠ¼ í´ë¦­
3. `/locations/reorder` í˜ì´ì§€ë¡œ ì´ë™
4. í˜„ì¬ ìˆœì„œ:
   ```
   1. Korea HQ
   2. Vietnam Branch  â† ë“œë˜ê·¸
   3. China Branch
   ```
5. Vietnamì„ ì•„ë˜ë¡œ ë“œë˜ê·¸
6. ìƒˆ ìˆœì„œ:
   ```
   1. Korea HQ
   2. China Branch
   3. Vietnam Branch  â† ì´ë™ë¨
   ```
7. **[Save Order]** í´ë¦­
8. Success toast í‘œì‹œ
9. `/locations`ë¡œ ë¦¬ë””ë ‰íŠ¸

### ì‹œë‚˜ë¦¬ì˜¤ 2: Inventory Kanban Viewì—ì„œ í™•ì¸

1. `/inventory` ì ‘ì†
2. **[Kanban View]** í´ë¦­
3. ìƒˆ ìˆœì„œë¡œ í‘œì‹œ í™•ì¸:
   ```
   ğŸ”½ Korea HQ
   â–¶ China Branch      â† ìˆœì„œ ë³€ê²½ë¨
   â–¶ Vietnam Branch
   ```

### ì‹œë‚˜ë¦¬ì˜¤ 3: ë³€ê²½ ì·¨ì†Œ

1. `/locations/reorder` í˜ì´ì§€ì—ì„œ ìˆœì„œ ë³€ê²½
2. **[Cancel]** í´ë¦­
3. í™•ì¸ ë‹¤ì´ì–¼ë¡œê·¸: "You have unsaved changes..."
4. **[OK]** â†’ `/locations`ë¡œ ëŒì•„ê°, ë³€ê²½ì‚¬í•­ ì—†ìŒ

### ì‹œë‚˜ë¦¬ì˜¤ 4: ìƒˆ Branch ì¶”ê°€

1. `/locations/new` í˜ì´ì§€ì—ì„œ "Thailand Branch" ì¶”ê°€
2. `display_order` ìë™ í• ë‹¹: 4
3. Kanban Viewì—ì„œ ë§¨ ì•„ë˜ì— í‘œì‹œ:
   ```
   1. Korea HQ
   2. Vietnam Branch
   3. China Branch
   4. Thailand Branch  â† ìë™ìœ¼ë¡œ ë§¨ ì•„ë˜ ì¶”ê°€
   ```
4. í•„ìš” ì‹œ `/locations/reorder`ì—ì„œ ìˆœì„œ ì¡°ì •

---

## UI/UX íŠ¹ì§•

### 1. ì‹œê°ì  í”¼ë“œë°±

| ìƒíƒœ | íš¨ê³¼ |
|------|------|
| ê¸°ë³¸ | í°ìƒ‰ ë°°ê²½, ê·¸ë¦¼ì ì—†ìŒ |
| Hover | `hover:shadow-md` (ê·¸ë¦¼ì ì¶”ê°€) |
| ë“œë˜ê·¸ ì‹œì‘ | íˆ¬ëª…ë„ 50%, `ring-2 ring-primary` |
| ë“œë˜ê·¸ ì¤‘ | ì›ë³¸ ìœ„ì¹˜ì—ì„œ ë– ìˆëŠ” íš¨ê³¼ |
| ë“œë¡­ ì™„ë£Œ | ë¶€ë“œëŸ¬ìš´ ì• ë‹ˆë©”ì´ì…˜ìœ¼ë¡œ ìƒˆ ìœ„ì¹˜ ì´ë™ |

### 2. Drag Handle

```
â‹®â‹®  â† GripVertical ì•„ì´ì½˜
```

- í´ë¦­í•˜ê³  ë“œë˜ê·¸
- `cursor-grab` â†’ `cursor-grabbing`
- í„°ì¹˜ ë””ë°”ì´ìŠ¤ì—ì„œë„ ì‘ë™ (`touch-none`)

### 3. ìˆœì„œ ë²ˆí˜¸ í‘œì‹œ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â‹®â‹®  Korea HQ  [HQ]          1   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

- ìš°ì¸¡ì— í° ìˆ«ìë¡œ í˜„ì¬ ìˆœì„œ í‘œì‹œ
- `display_order` ê°’ê³¼ ì¼ì¹˜
- ë°˜íˆ¬ëª… (`text-muted-foreground/30`)

### 4. ì ‘ê·¼ì„± (Accessibility)

**í‚¤ë³´ë“œ ë„¤ë¹„ê²Œì´ì…˜:**
- `Tab`: ë‹¤ìŒ í•­ëª©ìœ¼ë¡œ í¬ì»¤ìŠ¤
- `Space`: ë“œë˜ê·¸ í™œì„±í™”
- `Arrow Up/Down`: ìœ„/ì•„ë˜ë¡œ ì´ë™
- `Space`: ë“œë¡­
- `Escape`: ì·¨ì†Œ

**Screen Reader:**
- @dnd-kit ìë™ ì•Œë¦¼: "Korea HQ moved to position 2"
- ARIA labels: "Drag handle for Korea HQ"

---

## ë°ì´í„° íë¦„

```
1. User visits /locations/reorder
   â†“
2. Server fetches locations ORDER BY display_order
   â†“
3. Pass to LocationsReorderClient (Client Component)
   â†“
4. User drags location
   â†“
5. handleDragEnd â†’ arrayMove â†’ setLocations (local state)
   â†“
6. hasChanges = true
   â†“
7. User clicks [Save Order]
   â†“
8. Update all locations' display_order in database
   â†“
9. Toast success â†’ redirect to /locations
   â†“
10. Inventory Kanban View uses new order
```

---

## ì—ëŸ¬ ì²˜ë¦¬

### 1. ê¶Œí•œ ì²´í¬

```typescript
if (profile?.role !== 'HQ_Admin') {
  redirect('/locations')
}
```

- Branch ManagerëŠ” ì ‘ê·¼ ë¶ˆê°€
- ìë™ìœ¼ë¡œ `/locations`ë¡œ ë¦¬ë””ë ‰íŠ¸

### 2. ì €ì¥ ì‹¤íŒ¨

```typescript
try {
  await supabase.from('locations').upsert(...)
} catch (error) {
  toast.error('Failed to save location order')
  // ì‚¬ìš©ìì—ê²Œ ì¬ì‹œë„ ê¸°íšŒ ì œê³µ
}
```

### 3. ë³€ê²½ì‚¬í•­ í™•ì¸

```typescript
const handleCancel = () => {
  if (hasChanges) {
    const confirm = window.confirm('You have unsaved changes...')
    if (!confirm) return
  }
  router.push('/locations')
}
```

---

## ì„±ëŠ¥ ìµœì í™”

### 1. Index ì¶”ê°€

```sql
CREATE INDEX idx_locations_display_order
ON public.locations(display_order);
```

- `ORDER BY display_order` ì¿¼ë¦¬ ìµœì í™”
- 3-5ê°œ ë ˆì½”ë“œì—ì„œëŠ” ì˜í–¥ ë¯¸ë¯¸í•˜ì§€ë§Œ ë¯¸ë˜ í™•ì¥ì„± ê³ ë ¤

### 2. Optimistic UI (ë¯¸ë˜ ê°œì„ )

í˜„ì¬ëŠ” Save í›„ ìƒˆë¡œê³ ì¹¨, ë‚˜ì¤‘ì— ê°œì„  ê°€ëŠ¥:

```typescript
// ì €ì¥ ì „ì— UI ë¨¼ì € ì—…ë°ì´íŠ¸
setLocations(newOrder)

// ë°±ê·¸ë¼ìš´ë“œì—ì„œ DB ì—…ë°ì´íŠ¸
await updateDatabase()

// ì‹¤íŒ¨ ì‹œ ë¡¤ë°±
if (error) {
  setLocations(oldOrder)
}
```

---

## í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤

### 1. ì •ìƒ ì‹œë‚˜ë¦¬ì˜¤

| # | ì‘ì—… | ê¸°ëŒ€ ê²°ê³¼ |
|---|------|-----------|
| 1 | HQ Adminìœ¼ë¡œ ë¡œê·¸ì¸ | ì„±ê³µ |
| 2 | `/locations` ì ‘ì† | Reorder ë²„íŠ¼ í‘œì‹œ |
| 3 | Reorder ë²„íŠ¼ í´ë¦­ | `/locations/reorder`ë¡œ ì´ë™ |
| 4 | ìˆœì„œ: HQ, VN, CN í™•ì¸ | âœ… |
| 5 | VNì„ ë§¨ ì•„ë˜ë¡œ ë“œë˜ê·¸ | ìˆœì„œ ë³€ê²½: HQ, CN, VN |
| 6 | Save Order í´ë¦­ | Success toast |
| 7 | `/locations`ë¡œ ë¦¬ë””ë ‰íŠ¸ | âœ… |
| 8 | `/inventory` â†’ Kanban View | ìƒˆ ìˆœì„œ ë°˜ì˜ í™•ì¸ |

### 2. ê¶Œí•œ í…ŒìŠ¤íŠ¸

| # | ì‘ì—… | ê¸°ëŒ€ ê²°ê³¼ |
|---|------|-----------|
| 1 | Branch Manager ë¡œê·¸ì¸ | ì„±ê³µ |
| 2 | `/locations` ì ‘ì† | Reorder ë²„íŠ¼ ìˆ¨ê¹€ |
| 3 | ì§ì ‘ `/locations/reorder` ì ‘ì† | `/locations`ë¡œ ë¦¬ë””ë ‰íŠ¸ |

### 3. ë³€ê²½ ì·¨ì†Œ í…ŒìŠ¤íŠ¸

| # | ì‘ì—… | ê¸°ëŒ€ ê²°ê³¼ |
|---|------|-----------|
| 1 | Reorder í˜ì´ì§€ì—ì„œ ìˆœì„œ ë³€ê²½ | hasChanges = true |
| 2 | Cancel ë²„íŠ¼ í´ë¦­ | í™•ì¸ ë‹¤ì´ì–¼ë¡œê·¸ í‘œì‹œ |
| 3 | Cancel ì„ íƒ | ë³€ê²½ì‚¬í•­ ìœ ì§€ (í˜ì´ì§€ ìœ ì§€) |
| 4 | OK ì„ íƒ | `/locations`ë¡œ ì´ë™, ë³€ê²½ ì—†ìŒ |

### 4. í‚¤ë³´ë“œ ë„¤ë¹„ê²Œì´ì…˜

| # | ì‘ì—… | ê¸°ëŒ€ ê²°ê³¼ |
|---|------|-----------|
| 1 | Tab í‚¤ë¡œ ì²« ë²ˆì§¸ í•­ëª© í¬ì»¤ìŠ¤ | í¬ì»¤ìŠ¤ í‘œì‹œ |
| 2 | Space í‚¤ ëˆ„ë¦„ | ë“œë˜ê·¸ í™œì„±í™” |
| 3 | Arrow Down í‚¤ | ì•„ë˜ë¡œ ì´ë™ |
| 4 | Space í‚¤ | ë“œë¡­ ì™„ë£Œ |
| 5 | ìˆœì„œ ë³€ê²½ í™•ì¸ | âœ… |

---

## ë§ˆì´ê·¸ë ˆì´ì…˜ ì „ëµ

### 1. ê¸°ì¡´ ë°ì´í„° ë³´ì¡´

- í˜„ì¬ locations í…Œì´ë¸”ì˜ ëª¨ë“  ë°ì´í„° ìœ ì§€
- `display_order` ì»¬ëŸ¼ë§Œ ì¶”ê°€
- ì´ˆê¸°ê°’ ìë™ í• ë‹¹

### 2. ë¡¤ë°± ê³„íš

```sql
-- Rollback: Remove display_order column
DROP INDEX IF EXISTS idx_locations_display_order;
ALTER TABLE public.locations DROP COLUMN IF EXISTS display_order;
```

### 3. í…ŒìŠ¤íŠ¸ í™˜ê²½ ìš°ì„ 

1. Development í™˜ê²½ì—ì„œ ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰
2. í…ŒìŠ¤íŠ¸ í›„ ë¬¸ì œ ì—†ìœ¼ë©´ Production ì ìš©
3. ë°±ì—… ìƒì„± í›„ ì§„í–‰

---

## í–¥í›„ ê°œì„  ë°©í–¥

### Phase 2 ê°œì„ ì‚¬í•­

1. **ë“œë˜ê·¸ í”„ë¦¬ë·° ê°œì„ **
   - ë“œë˜ê·¸ ì¤‘ ë°˜íˆ¬ëª… ì¹´ë“œ í‘œì‹œ
   - ì‚½ì… ìœ„ì¹˜ ì‹œê°ì  í‘œì‹œ (íŒŒë€ìƒ‰ ì„ )

2. **ì‹¤ì‹œê°„ ë™ê¸°í™”**
   - Supabase Realtime
   - ë‹¤ë¥¸ HQ Adminì´ ë³€ê²½ ì‹œ ìë™ ë°˜ì˜

3. **ëª¨ë°”ì¼ ìµœì í™”**
   - í„°ì¹˜ ë“œë˜ê·¸ ê°œì„ 
   - í–…í‹± í”¼ë“œë°±
   - ë” í° í„°ì¹˜ ì˜ì—­

4. **íˆìŠ¤í† ë¦¬ ì¶”ì **
   - ìˆœì„œ ë³€ê²½ ì´ë ¥ ì €ì¥
   - Audit logì— ê¸°ë¡
   - Undo/Redo ê¸°ëŠ¥

5. **ë“œë˜ê·¸ ì• ë‹ˆë©”ì´ì…˜**
   - Smooth transitions
   - Spring physics
   - Visual polish

---

## ì˜ˆìƒ ì‘ì—… ì‹œê°„

| Phase | ì‘ì—… ë‚´ìš© | ì˜ˆìƒ ì‹œê°„ |
|-------|----------|-----------|
| 1 | DB ë§ˆì´ê·¸ë ˆì´ì…˜ ì‘ì„± ë° ì‹¤í–‰ | 30ë¶„ |
| 2 | íƒ€ì… ì •ì˜ ì—…ë°ì´íŠ¸ | 30ë¶„ |
| 3 | SortableLocationItem ì»´í¬ë„ŒíŠ¸ | 1ì‹œê°„ |
| 4 | Reorder í˜ì´ì§€ (Server) | 1ì‹œê°„ |
| 5 | Reorder Client ì»´í¬ë„ŒíŠ¸ | 2ì‹œê°„ |
| 6 | Locations í˜ì´ì§€ ìˆ˜ì • | 30ë¶„ |
| 7 | Inventory í˜ì´ì§€ ìˆ˜ì • | 30ë¶„ |
| 8 | ìƒˆ Location ì¶”ê°€ ë¡œì§ | 30ë¶„ |
| 9 | í…ŒìŠ¤íŠ¸ (ìˆ˜ë™ + ì‹œë‚˜ë¦¬ì˜¤) | 2ì‹œê°„ |
| 10 | ë²„ê·¸ ìˆ˜ì • ë° UX ê°œì„  | 1ì‹œê°„ |

**ì´ ì˜ˆìƒ ì‹œê°„:** ì•½ 9-10ì‹œê°„ (1.5 ì‘ì—…ì¼)

---

## íŒŒì¼ ìš”ì•½

### ìƒì„±í•  íŒŒì¼ (3ê°œ)

1. `supabase/migrations/013_add_locations_display_order.sql`
   - DB ìŠ¤í‚¤ë§ˆ ë³€ê²½
   - ì´ˆê¸°ê°’ ì„¤ì •: HQ=1, VN=2, CN=3

2. `app/(dashboard)/locations/reorder/page.tsx`
   - Server Component
   - ê¶Œí•œ ì²´í¬ ë° ë°ì´í„° í˜ì¹­

3. `components/locations/locations-reorder-client.tsx`
   - Client Component
   - ë“œë˜ê·¸ ì•¤ ë“œë¡­ ë¡œì§

4. `components/locations/sortable-location-item.tsx`
   - ë“œë˜ê·¸ ê°€ëŠ¥í•œ Location ì¹´ë“œ

### ìˆ˜ì •í•  íŒŒì¼ (3ê°œ)

1. `types/database.ts`
   - `display_order: number` ì¶”ê°€

2. `app/(dashboard)/locations/page.tsx`
   - Reorder ë²„íŠ¼ ì¶”ê°€
   - `.order('display_order')` ë³€ê²½

3. `app/(dashboard)/inventory/page.tsx`
   - `.order('display_order')` ë³€ê²½

---

## ê²°ë¡ 

### âœ… ì¥ì 

1. **ì‚¬ìš©ì ì¹œí™”ì **: ì§ê´€ì ì¸ ë“œë˜ê·¸ ì•¤ ë“œë¡­
2. **ì•ˆì „**: ëª…í™•í•œ ì €ì¥ ë‹¨ê³„, ì‹¤ìˆ˜ ë°©ì§€
3. **í™•ì¥ ê°€ëŠ¥**: ìƒˆ Branch ì¶”ê°€ ì‹œ ì‰½ê²Œ ìˆœì„œ ì¡°ì •
4. **ì¼ê´€ì„±**: ê¸°ì¡´ inventory ë“œë˜ê·¸ì™€ ë™ì¼í•œ UX
5. **ì ‘ê·¼ì„±**: í‚¤ë³´ë“œ ë„¤ë¹„ê²Œì´ì…˜ ì§€ì›
6. **ì„±ëŠ¥**: Index ìµœì í™”
7. **ìœ ì§€ë³´ìˆ˜**: ë‹¨ìˆœí•œ ì •ìˆ˜ ìˆœì„œ, ì´í•´í•˜ê¸° ì‰¬ì›€

### ğŸ“Š ê¸°ìˆ  ìŠ¤íƒ ì¼ê´€ì„±

- âœ… @dnd-kit ì¬ì‚¬ìš© (ì´ë¯¸ ì„¤ì¹˜ë¨)
- âœ… shadcn/ui ì»´í¬ë„ŒíŠ¸ ì‚¬ìš©
- âœ… Supabase ì¿¼ë¦¬ íŒ¨í„´ ë™ì¼
- âœ… Next.js Server/Client Component ë¶„ë¦¬

### ğŸ¯ ë¹„ì¦ˆë‹ˆìŠ¤ ê°€ì¹˜

- Branch ì¶”ê°€/ì‚­ì œ ì‹œ ìœ ì—°í•œ ê´€ë¦¬
- ì‚¬ìš©ì ì„ í˜¸ì— ë”°ë¥¸ ìˆœì„œ ì»¤ìŠ¤í„°ë§ˆì´ì§•
- í–¥í›„ í™•ì¥ì„± í™•ë³´ (10ê°œ ì´ìƒ Branchë„ ëŒ€ì‘ ê°€ëŠ¥)

---

## ë‹¤ìŒ ë‹¨ê³„

1. âœ… ê³„íš ê²€í†  ë° ìŠ¹ì¸
2. DB ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰
3. ì»´í¬ë„ŒíŠ¸ êµ¬í˜„
4. í…ŒìŠ¤íŠ¸
5. ë°°í¬

**ì¤€ë¹„ ì™„ë£Œ! ìŠ¹ì¸ ì‹œ ë°”ë¡œ êµ¬í˜„ ì‹œì‘í•˜ê² ìŠµë‹ˆë‹¤.** ğŸš€
