# Phase 05: 환율 관리

**작업 기간**: 3일
**담당자**: 개발팀
**목표**: 수동 환율 입력 및 조회 기능 구현

---

## 1. 개요

KRW(한국 원화)에서 VND(베트남 동) 및 CNY(중국 위안)로 환전하는 환율을 관리합니다. MVP에서는 자동 환율 업데이트 API를 사용하지 않고, HQ Admin이 수동으로 환율을 입력하고 관리합니다.

### 핵심 목표
- ✅ 환율 입력 UI (KRW → VND, KRW → CNY)
- ✅ 환율 이력 조회
- ✅ 최신 환율 자동 선택
- ✅ 가격 계산에서 환율 참조

---

## 2. 비즈니스 요구사항

### 2.1 환율 관리 규칙

- **기준 통화**: KRW (한국 원화)
- **대상 통화**: VND (베트남 동), CNY (중국 위안)
- **입력 방식**: 수동 입력 (HQ Admin만 가능)
- **환율 유효 날짜**: `effective_date` 기준으로 최신 환율 자동 적용
- **환율 형식**:
  - KRW → VND: 1 KRW = 18 VND (예시)
  - KRW → CNY: 1 KRW = 0.0053 CNY (예시)

### 2.2 환율 사용 시나리오

```
가격 계산 시:
1. 제품 구매 단가 (KRW): 5,000원
2. 이전 비용 (KRW): 500원
3. 총 비용 (KRW): 5,500원
4. 환율 (KRW → VND): 1 KRW = 18 VND
5. 지사 원가 (VND): 5,500 × 18 = 99,000 VND
```

---

## 3. 작업 상세

### 3.1 환율 관리 UI

#### 3.1.1 환율 목록 페이지

**파일**: `app/(dashboard)/exchange-rates/page.tsx`

```typescript
import { createServerClient } from '@/lib/supabase/server'
import { ExchangeRatesList } from '@/components/exchange-rates/exchange-rates-list'
import { Button } from '@/components/ui/button'
import Link from 'next/link'
import { Plus } from 'lucide-react'

export default async function ExchangeRatesPage() {
  const supabase = createServerClient()

  const { data: exchangeRates, error } = await supabase
    .from('exchange_rates')
    .select('*')
    .order('effective_date', { ascending: false })
    .order('from_currency')

  if (error) {
    return <div>Error loading exchange rates: {error.message}</div>
  }

  return (
    <div>
      <div className="flex justify-between items-center mb-6">
        <h1 className="text-3xl font-bold">Exchange Rates</h1>
        <Link href="/exchange-rates/new">
          <Button>
            <Plus className="mr-2 h-4 w-4" />
            Add Exchange Rate
          </Button>
        </Link>
      </div>

      <ExchangeRatesList exchangeRates={exchangeRates || []} />
    </div>
  )
}
```

#### 3.1.2 환율 목록 컴포넌트

**파일**: `components/exchange-rates/exchange-rates-list.tsx`

```typescript
'use client'

import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from '@/components/ui/table'
import { Badge } from '@/components/ui/badge'
import { formatDate } from '@/lib/utils'

export function ExchangeRatesList({ exchangeRates }: { exchangeRates: any[] }) {
  const isLatest = (rate: any, allRates: any[]) => {
    const latest = allRates
      .filter(r => r.from_currency === rate.from_currency && r.to_currency === rate.to_currency)
      .sort((a, b) => new Date(b.effective_date).getTime() - new Date(a.effective_date).getTime())[0]
    return latest?.id === rate.id
  }

  // 통화 쌍별로 그룹화
  const groupedRates = exchangeRates.reduce((acc, rate) => {
    const pair = `${rate.from_currency} → ${rate.to_currency}`
    if (!acc[pair]) {
      acc[pair] = []
    }
    acc[pair].push(rate)
    return acc
  }, {} as Record<string, any[]>)

  return (
    <div className="space-y-6">
      {Object.entries(groupedRates).map(([pair, rates]) => (
        <div key={pair}>
          <h2 className="text-xl font-semibold mb-4">{pair}</h2>
          <div className="border rounded-lg">
            <Table>
              <TableHeader>
                <TableRow>
                  <TableHead>Effective Date</TableHead>
                  <TableHead>Exchange Rate</TableHead>
                  <TableHead>Status</TableHead>
                  <TableHead>Created At</TableHead>
                </TableRow>
              </TableHeader>
              <TableBody>
                {rates.map((rate) => (
                  <TableRow key={rate.id}>
                    <TableCell className="font-medium">
                      {formatDate(rate.effective_date)}
                    </TableCell>
                    <TableCell>
                      1 {rate.from_currency} = {rate.rate.toFixed(4)} {rate.to_currency}
                    </TableCell>
                    <TableCell>
                      {isLatest(rate, exchangeRates) && (
                        <Badge variant="success">Latest</Badge>
                      )}
                    </TableCell>
                    <TableCell className="text-sm text-gray-500">
                      {formatDate(rate.created_at)}
                    </TableCell>
                  </TableRow>
                ))}
              </TableBody>
            </Table>
          </div>
        </div>
      ))}
    </div>
  )
}
```

#### 3.1.3 환율 추가 페이지

**파일**: `app/(dashboard)/exchange-rates/new/page.tsx`

```typescript
import { ExchangeRateForm } from '@/components/exchange-rates/exchange-rate-form'

export default function NewExchangeRatePage() {
  return (
    <div>
      <h1 className="text-3xl font-bold mb-6">Add Exchange Rate</h1>
      <ExchangeRateForm />
    </div>
  )
}
```

#### 3.1.4 환율 추가 폼

**파일**: `components/exchange-rates/exchange-rate-form.tsx`

```typescript
'use client'

import { useState } from 'react'
import { useRouter } from 'next/navigation'
import { createClient } from '@/lib/supabase/client'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { Label } from '@/components/ui/label'
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from '@/components/ui/card'
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select'
import { useToast } from '@/components/ui/use-toast'

const CURRENCY_PAIRS = [
  { from: 'KRW', to: 'VND', label: 'KRW → VND (Korean Won to Vietnamese Dong)' },
  { from: 'KRW', to: 'CNY', label: 'KRW → CNY (Korean Won to Chinese Yuan)' },
]

export function ExchangeRateForm() {
  const [formData, setFormData] = useState({
    from_currency: 'KRW',
    to_currency: '',
    rate: '',
    effective_date: new Date().toISOString().split('T')[0],
  })
  const [loading, setLoading] = useState(false)
  const router = useRouter()
  const { toast } = useToast()
  const supabase = createClient()

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault()

    if (!formData.to_currency || !formData.rate) {
      toast({ variant: 'destructive', title: 'Please fill all fields' })
      return
    }

    if (parseFloat(formData.rate) <= 0) {
      toast({ variant: 'destructive', title: 'Exchange rate must be greater than 0' })
      return
    }

    setLoading(true)

    try {
      const { data: { user } } = await supabase.auth.getUser()

      const { error } = await supabase
        .from('exchange_rates')
        .insert([{
          from_currency: formData.from_currency,
          to_currency: formData.to_currency,
          rate: parseFloat(formData.rate),
          effective_date: formData.effective_date,
          created_by: user?.id,
        }])

      if (error) throw error

      toast({ title: 'Exchange rate added successfully' })
      router.push('/exchange-rates')
      router.refresh()
    } catch (error: any) {
      toast({
        variant: 'destructive',
        title: 'Error',
        description: error.message,
      })
    } finally {
      setLoading(false)
    }
  }

  return (
    <Card>
      <CardHeader>
        <CardTitle>Add New Exchange Rate</CardTitle>
        <CardDescription>
          Enter the exchange rate manually. This will be used for pricing calculations.
        </CardDescription>
      </CardHeader>
      <CardContent>
        <form onSubmit={handleSubmit} className="space-y-4">
          <div>
            <Label htmlFor="currency_pair">Currency Pair *</Label>
            <Select
              value={formData.to_currency}
              onValueChange={(value) => setFormData({ ...formData, to_currency: value })}
            >
              <SelectTrigger>
                <SelectValue placeholder="Select currency pair" />
              </SelectTrigger>
              <SelectContent>
                {CURRENCY_PAIRS.map((pair) => (
                  <SelectItem key={pair.to} value={pair.to}>
                    {pair.label}
                  </SelectItem>
                ))}
              </SelectContent>
            </Select>
          </div>

          <div>
            <Label htmlFor="rate">Exchange Rate *</Label>
            <div className="flex items-center gap-2">
              <span className="text-sm">1 {formData.from_currency} =</span>
              <Input
                id="rate"
                type="number"
                step="0.0001"
                min="0"
                placeholder="0.0000"
                value={formData.rate}
                onChange={(e) => setFormData({ ...formData, rate: e.target.value })}
                required
              />
              <span className="text-sm">{formData.to_currency || '---'}</span>
            </div>
            {formData.to_currency === 'VND' && (
              <p className="text-sm text-gray-600 mt-1">
                Example: If 1 KRW = 18 VND, enter 18
              </p>
            )}
            {formData.to_currency === 'CNY' && (
              <p className="text-sm text-gray-600 mt-1">
                Example: If 1 KRW = 0.0053 CNY, enter 0.0053
              </p>
            )}
          </div>

          <div>
            <Label htmlFor="effective_date">Effective Date *</Label>
            <Input
              id="effective_date"
              type="date"
              value={formData.effective_date}
              onChange={(e) => setFormData({ ...formData, effective_date: e.target.value })}
              required
            />
            <p className="text-sm text-gray-600 mt-1">
              The date from which this exchange rate is valid
            </p>
          </div>

          <div className="flex gap-2">
            <Button type="submit" disabled={loading}>
              {loading ? 'Adding...' : 'Add Exchange Rate'}
            </Button>
            <Button type="button" variant="outline" onClick={() => router.back()}>
              Cancel
            </Button>
          </div>
        </form>
      </CardContent>
    </Card>
  )
}
```

---

### 3.2 최신 환율 조회 API

#### 3.2.1 최신 환율 조회 API Route

**파일**: `app/api/exchange-rates/latest/route.ts`

```typescript
import { createServerClient } from '@/lib/supabase/server'
import { NextResponse } from 'next/server'

export async function GET(request: Request) {
  const { searchParams } = new URL(request.url)
  const from_currency = searchParams.get('from')
  const to_currency = searchParams.get('to')

  if (!from_currency || !to_currency) {
    return NextResponse.json(
      { error: 'Missing from or to currency' },
      { status: 400 }
    )
  }

  const supabase = createServerClient()

  const { data, error } = await supabase
    .from('exchange_rates')
    .select('*')
    .eq('from_currency', from_currency)
    .eq('to_currency', to_currency)
    .lte('effective_date', new Date().toISOString().split('T')[0])
    .order('effective_date', { ascending: false })
    .limit(1)
    .single()

  if (error) {
    return NextResponse.json({ error: error.message }, { status: 404 })
  }

  return NextResponse.json({ exchangeRate: data })
}
```

---

### 3.3 PostgreSQL 함수 (최신 환율 조회)

**Supabase SQL Editor에서 실행**:

```sql
-- 최신 환율 조회 함수
CREATE OR REPLACE FUNCTION get_latest_exchange_rate(
  p_from_currency TEXT,
  p_to_currency TEXT,
  p_date DATE DEFAULT CURRENT_DATE
)
RETURNS DECIMAL(10, 4) AS $$
DECLARE
  v_rate DECIMAL(10, 4);
BEGIN
  SELECT rate INTO v_rate
  FROM exchange_rates
  WHERE from_currency = p_from_currency
    AND to_currency = p_to_currency
    AND effective_date <= p_date
  ORDER BY effective_date DESC
  LIMIT 1;

  RETURN COALESCE(v_rate, 1);
END;
$$ LANGUAGE plpgsql;
```

---

## 4. 환율 컴포넌트 재사용

### 4.1 환율 선택 컴포넌트

**파일**: `components/exchange-rates/exchange-rate-selector.tsx`

```typescript
'use client'

import { useEffect, useState } from 'react'
import { createClient } from '@/lib/supabase/client'
import { Label } from '@/components/ui/label'
import { Input } from '@/components/ui/input'
import { Button } from '@/components/ui/button'
import { RefreshCw } from 'lucide-react'

interface ExchangeRateSelectorProps {
  fromCurrency: string
  toCurrency: string
  value: number
  onChange: (rate: number) => void
  disabled?: boolean
}

export function ExchangeRateSelector({
  fromCurrency,
  toCurrency,
  value,
  onChange,
  disabled = false,
}: ExchangeRateSelectorProps) {
  const [loading, setLoading] = useState(false)
  const supabase = createClient()

  const fetchLatestRate = async () => {
    setLoading(true)
    try {
      const response = await fetch(
        `/api/exchange-rates/latest?from=${fromCurrency}&to=${toCurrency}`
      )
      const data = await response.json()

      if (data.exchangeRate) {
        onChange(data.exchangeRate.rate)
      }
    } catch (error) {
      console.error('Failed to fetch exchange rate:', error)
    } finally {
      setLoading(false)
    }
  }

  useEffect(() => {
    if (fromCurrency && toCurrency) {
      fetchLatestRate()
    }
  }, [fromCurrency, toCurrency])

  return (
    <div>
      <Label>Exchange Rate (1 {fromCurrency} = ? {toCurrency})</Label>
      <div className="flex items-center gap-2">
        <Input
          type="number"
          step="0.0001"
          min="0"
          value={value}
          onChange={(e) => onChange(parseFloat(e.target.value))}
          disabled={disabled}
        />
        <Button
          type="button"
          variant="outline"
          size="sm"
          onClick={fetchLatestRate}
          disabled={loading || disabled}
        >
          <RefreshCw className={`h-4 w-4 ${loading ? 'animate-spin' : ''}`} />
        </Button>
      </div>
      <p className="text-sm text-gray-600 mt-1">
        Click refresh to load the latest rate from {new Date().toLocaleDateString()}
      </p>
    </div>
  )
}
```

---

## 5. 테스트 체크리스트

### 5.1 환율 입력 테스트
- [ ] 환율 추가 폼에서 KRW → VND 입력 가능
- [ ] 환율 추가 폼에서 KRW → CNY 입력 가능
- [ ] 유효성 검사 (환율 > 0)
- [ ] 유효 날짜 선택 가능
- [ ] 환율 저장 성공

### 5.2 환율 조회 테스트
- [ ] 환율 목록에서 통화 쌍별 그룹화 표시
- [ ] 최신 환율에 "Latest" 배지 표시
- [ ] 날짜 순 정렬 (최신순)

### 5.3 최신 환율 API 테스트
- [ ] `/api/exchange-rates/latest?from=KRW&to=VND` 호출 시 최신 환율 반환
- [ ] 해당 통화 쌍이 없을 때 404 에러
- [ ] effective_date가 미래인 환율은 제외됨

### 5.4 통합 테스트
- [ ] 가격 계산 시 최신 환율 자동 불러오기
- [ ] 환율 변경 시 새 가격 계산 정상 작동

---

## 6. 산출물

### 6.1 완료된 기능
- ✅ 환율 입력 UI (KRW → VND, KRW → CNY)
- ✅ 환율 이력 조회
- ✅ 최신 환율 조회 API
- ✅ 환율 선택 재사용 컴포넌트
- ✅ PostgreSQL 환율 조회 함수

### 6.2 다음 Phase 준비사항
- Phase 06에서 가격 계산 엔진에 환율 통합
- 환율 테스트 데이터 생성 (KRW → VND: 18, KRW → CNY: 0.0053)

---

## 7. 참고 자료

- [Exchange Rate API (추후 자동화용)](https://exchangerate.host/)
- [Intl.NumberFormat for Currency](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Intl/NumberFormat)

---

## 8. 작업 이후 체크리스트

- [ ] 환율 입력 UI 정상 작동 확인
- [ ] 최신 환율 조회 API 테스트 완료
- [ ] 환율 선택 컴포넌트 재사용 가능 확인
- [ ] GitHub에 코드 푸시
- [ ] Worklog 문서 작성: `005.phase05.환율_관리.md`
- [ ] Phase 06 계획 검토
