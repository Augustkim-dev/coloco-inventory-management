# Phase 02: 데이터베이스 스키마 및 마스터 데이터

**작업 기간**: 1주 (5일)
**담당자**: 개발팀
**목표**: 10개 핵심 테이블 생성, RLS 정책 설정, 마스터 데이터 CRUD UI 구현

---

## 1. 개요

시스템의 핵심 데이터 모델을 설계하고 데이터베이스 스키마를 구축합니다. 공급업체, 제품, 지사 정보를 관리하는 기본 CRUD 페이지를 구현합니다.

### 핵심 목표
- ✅ 10개 핵심 테이블 생성 (SQL 마이그레이션)
- ✅ Row Level Security (RLS) 정책 설정
- ✅ TypeScript 타입 정의 자동 생성
- ✅ 마스터 데이터 CRUD UI (Suppliers, Products, Locations)
- ✅ 인덱스 및 외래 키 제약 조건 설정

---

## 2. 데이터베이스 스키마

### 2.1 테이블 목록

| 번호 | 테이블명 | 설명 | Phase |
|------|---------|------|-------|
| 1 | users | 사용자 정보 (인증 확장) | Phase 01 |
| 2 | locations | 지사 정보 (HQ, 지사) | **Phase 02** |
| 3 | suppliers | 공급업체 정보 | **Phase 02** |
| 4 | products | 제품 마스터 | **Phase 02** |
| 5 | purchase_orders | 구매 발주 | **Phase 02** |
| 6 | purchase_order_items | 발주 상세 | **Phase 02** |
| 7 | stock_batches | 재고 배치 | **Phase 02** |
| 8 | pricing_configs | 가격 설정 | **Phase 02** |
| 9 | sales | 판매 기록 | **Phase 02** |
| 10 | exchange_rates | 환율 | **Phase 02** |

---

### 2.2 SQL 마이그레이션

#### 2.2.1 locations 테이블

**파일**: Supabase Dashboard SQL Editor 또는 마이그레이션 파일

```sql
-- locations 테이블 생성
CREATE TABLE public.locations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name TEXT NOT NULL,
  location_type TEXT NOT NULL CHECK (location_type IN ('HQ', 'Branch')),
  country_code TEXT NOT NULL, -- 'KR', 'VN', 'CN'
  currency TEXT NOT NULL CHECK (currency IN ('KRW', 'VND', 'CNY')),
  address TEXT,
  contact_person TEXT,
  phone TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- RLS 활성화
ALTER TABLE public.locations ENABLE ROW LEVEL SECURITY;

-- 정책: 모든 인증된 사용자가 조회 가능
CREATE POLICY "Authenticated users can view locations" ON public.locations
  FOR SELECT USING (auth.role() = 'authenticated');

-- 정책: HQ Admin만 수정 가능
CREATE POLICY "HQ Admin can modify locations" ON public.locations
  FOR ALL USING (
    EXISTS (
      SELECT 1 FROM public.users
      WHERE id = auth.uid() AND role = 'HQ_Admin'
    )
  );

-- 인덱스
CREATE INDEX idx_locations_type ON public.locations(location_type);
CREATE INDEX idx_locations_country ON public.locations(country_code);

-- 업데이트 타임스탬프 트리거 (update_updated_at 함수는 Phase 01에서 생성됨)
CREATE TRIGGER locations_updated_at
  BEFORE UPDATE ON public.locations
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at();

-- 초기 데이터 삽입
INSERT INTO public.locations (name, location_type, country_code, currency, address) VALUES
('Korea HQ', 'HQ', 'KR', 'KRW', 'Seoul, South Korea'),
('Vietnam Branch', 'Branch', 'VN', 'VND', 'Ho Chi Minh City, Vietnam'),
('China Branch', 'Branch', 'CN', 'CNY', 'Shanghai, China');
```

---

#### 2.2.2 suppliers 테이블

```sql
-- suppliers 테이블 생성
CREATE TABLE public.suppliers (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name TEXT NOT NULL,
  contact_person TEXT,
  phone TEXT,
  email TEXT,
  address TEXT,
  notes TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- RLS 활성화
ALTER TABLE public.suppliers ENABLE ROW LEVEL SECURITY;

-- 정책: 인증된 사용자 조회 가능
CREATE POLICY "Authenticated users can view suppliers" ON public.suppliers
  FOR SELECT USING (auth.role() = 'authenticated');

-- 정책: HQ Admin만 수정 가능
CREATE POLICY "HQ Admin can modify suppliers" ON public.suppliers
  FOR ALL USING (
    EXISTS (
      SELECT 1 FROM public.users
      WHERE id = auth.uid() AND role = 'HQ_Admin'
    )
  );

-- 인덱스
CREATE INDEX idx_suppliers_name ON public.suppliers(name);

-- 업데이트 타임스탬프 트리거
CREATE TRIGGER suppliers_updated_at
  BEFORE UPDATE ON public.suppliers
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at();
```

---

#### 2.2.3 products 테이블

```sql
-- products 테이블 생성
CREATE TABLE public.products (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  sku TEXT UNIQUE NOT NULL,
  name TEXT NOT NULL,
  name_ko TEXT, -- 한국어 이름 (미래 다국어 지원)
  name_vn TEXT, -- 베트남어 이름
  name_cn TEXT, -- 중국어 이름
  category TEXT,
  unit TEXT NOT NULL DEFAULT 'EA', -- 'EA', 'BOX', 'PACK'
  shelf_life_days INTEGER NOT NULL DEFAULT 730, -- 유통기한 (일)
  description TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- RLS 활성화
ALTER TABLE public.products ENABLE ROW LEVEL SECURITY;

-- 정책: 인증된 사용자 조회 가능
CREATE POLICY "Authenticated users can view products" ON public.products
  FOR SELECT USING (auth.role() = 'authenticated');

-- 정책: HQ Admin만 수정 가능
CREATE POLICY "HQ Admin can modify products" ON public.products
  FOR ALL USING (
    EXISTS (
      SELECT 1 FROM public.users
      WHERE id = auth.uid() AND role = 'HQ_Admin'
    )
  );

-- 인덱스
CREATE INDEX idx_products_sku ON public.products(sku);
CREATE INDEX idx_products_category ON public.products(category);

-- 업데이트 타임스탬프 트리거
CREATE TRIGGER products_updated_at
  BEFORE UPDATE ON public.products
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at();
```

---

#### 2.2.4 purchase_orders 및 purchase_order_items 테이블

```sql
-- purchase_orders 테이블 생성
CREATE TABLE public.purchase_orders (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  po_no TEXT UNIQUE NOT NULL,
  supplier_id UUID NOT NULL REFERENCES public.suppliers(id) ON DELETE RESTRICT,
  order_date DATE NOT NULL DEFAULT CURRENT_DATE,
  status TEXT NOT NULL DEFAULT 'Draft' CHECK (status IN ('Draft', 'Approved', 'Received')),
  total_amount DECIMAL(15, 2) DEFAULT 0,
  currency TEXT NOT NULL DEFAULT 'KRW',
  notes TEXT,
  created_by UUID REFERENCES public.users(id),
  approved_by UUID REFERENCES public.users(id),
  approved_at TIMESTAMPTZ,
  received_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- purchase_order_items 테이블 생성
CREATE TABLE public.purchase_order_items (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  po_id UUID NOT NULL REFERENCES public.purchase_orders(id) ON DELETE CASCADE,
  product_id UUID NOT NULL REFERENCES public.products(id) ON DELETE RESTRICT,
  qty INTEGER NOT NULL CHECK (qty > 0),
  unit_price DECIMAL(12, 2) NOT NULL CHECK (unit_price >= 0),
  total_price DECIMAL(15, 2) GENERATED ALWAYS AS (qty * unit_price) STORED,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(po_id, product_id)
);

-- RLS 활성화
ALTER TABLE public.purchase_orders ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.purchase_order_items ENABLE ROW LEVEL SECURITY;

-- 정책: HQ Admin만 접근 가능
CREATE POLICY "HQ Admin can view purchase orders" ON public.purchase_orders
  FOR SELECT USING (
    EXISTS (
      SELECT 1 FROM public.users
      WHERE id = auth.uid() AND role = 'HQ_Admin'
    )
  );

CREATE POLICY "HQ Admin can modify purchase orders" ON public.purchase_orders
  FOR ALL USING (
    EXISTS (
      SELECT 1 FROM public.users
      WHERE id = auth.uid() AND role = 'HQ_Admin'
    )
  );

CREATE POLICY "HQ Admin can view PO items" ON public.purchase_order_items
  FOR SELECT USING (
    EXISTS (
      SELECT 1 FROM public.users
      WHERE id = auth.uid() AND role = 'HQ_Admin'
    )
  );

CREATE POLICY "HQ Admin can modify PO items" ON public.purchase_order_items
  FOR ALL USING (
    EXISTS (
      SELECT 1 FROM public.users
      WHERE id = auth.uid() AND role = 'HQ_Admin'
    )
  );

-- 인덱스
CREATE INDEX idx_po_supplier ON public.purchase_orders(supplier_id);
CREATE INDEX idx_po_status ON public.purchase_orders(status);
CREATE INDEX idx_po_order_date ON public.purchase_orders(order_date);
CREATE INDEX idx_po_items_po_id ON public.purchase_order_items(po_id);
CREATE INDEX idx_po_items_product_id ON public.purchase_order_items(product_id);

-- 업데이트 타임스탬프 트리거
CREATE TRIGGER purchase_orders_updated_at
  BEFORE UPDATE ON public.purchase_orders
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at();

CREATE TRIGGER purchase_order_items_updated_at
  BEFORE UPDATE ON public.purchase_order_items
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at();
```

---

#### 2.2.5 stock_batches 테이블 (핵심)

```sql
-- stock_batches 테이블 생성
CREATE TABLE public.stock_batches (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  product_id UUID NOT NULL REFERENCES public.products(id) ON DELETE RESTRICT,
  location_id UUID NOT NULL REFERENCES public.locations(id) ON DELETE RESTRICT,
  batch_no TEXT NOT NULL,
  qty_on_hand INTEGER NOT NULL DEFAULT 0 CHECK (qty_on_hand >= 0),
  qty_reserved INTEGER NOT NULL DEFAULT 0 CHECK (qty_reserved >= 0),
  qty_available INTEGER GENERATED ALWAYS AS (qty_on_hand - qty_reserved) STORED,
  unit_cost DECIMAL(12, 2) NOT NULL CHECK (unit_cost >= 0),
  manufactured_date DATE NOT NULL,
  expiry_date DATE NOT NULL,
  quality_status TEXT NOT NULL DEFAULT 'OK' CHECK (quality_status IN ('OK', 'Damaged', 'Quarantine')),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(product_id, location_id, batch_no),
  CHECK (expiry_date > manufactured_date)
);

-- RLS 활성화
ALTER TABLE public.stock_batches ENABLE ROW LEVEL SECURITY;

-- 정책: HQ Admin은 모든 재고 조회 가능
CREATE POLICY "HQ Admin can view all stock" ON public.stock_batches
  FOR SELECT USING (
    EXISTS (
      SELECT 1 FROM public.users
      WHERE id = auth.uid() AND role = 'HQ_Admin'
    )
  );

-- 정책: Branch Manager는 자기 지사 재고만 조회
CREATE POLICY "Branch Manager can view own location stock" ON public.stock_batches
  FOR SELECT USING (
    EXISTS (
      SELECT 1 FROM public.users
      WHERE id = auth.uid()
        AND role = 'Branch_Manager'
        AND location_id = stock_batches.location_id
    )
  );

-- 정책: HQ Admin만 수정 가능
CREATE POLICY "HQ Admin can modify stock" ON public.stock_batches
  FOR ALL USING (
    EXISTS (
      SELECT 1 FROM public.users
      WHERE id = auth.uid() AND role = 'HQ_Admin'
    )
  );

-- 인덱스 (성능 최적화)
CREATE INDEX idx_stock_location_product ON public.stock_batches(location_id, product_id);
CREATE INDEX idx_stock_expiry_date ON public.stock_batches(expiry_date);
CREATE INDEX idx_stock_batch_no ON public.stock_batches(batch_no);
CREATE INDEX idx_stock_quality ON public.stock_batches(quality_status);

-- 업데이트 타임스탬프 트리거
CREATE TRIGGER stock_batches_updated_at
  BEFORE UPDATE ON public.stock_batches
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at();
```

---

#### 2.2.6 pricing_configs 테이블 (가격 설정)

```sql
-- pricing_configs 테이블 생성
CREATE TABLE public.pricing_configs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  product_id UUID NOT NULL REFERENCES public.products(id) ON DELETE CASCADE,
  from_location_id UUID NOT NULL REFERENCES public.locations(id) ON DELETE CASCADE, -- 항상 HQ
  to_location_id UUID NOT NULL REFERENCES public.locations(id) ON DELETE CASCADE, -- 지사
  purchase_price DECIMAL(12, 2) NOT NULL CHECK (purchase_price >= 0), -- 구매 단가 (KRW)
  transfer_cost DECIMAL(12, 2) NOT NULL DEFAULT 0 CHECK (transfer_cost >= 0), -- 이전 비용 (KRW)
  hq_margin_percent DECIMAL(5, 2) NOT NULL DEFAULT 0 CHECK (hq_margin_percent >= 0 AND hq_margin_percent < 100), -- 본사 마진 (%)
  branch_margin_percent DECIMAL(5, 2) NOT NULL DEFAULT 0 CHECK (branch_margin_percent >= 0 AND branch_margin_percent < 100), -- 지사 마진 (%)
  exchange_rate DECIMAL(10, 4) NOT NULL CHECK (exchange_rate > 0), -- 환율
  calculated_price DECIMAL(12, 2), -- 자동 계산된 가격
  final_price DECIMAL(12, 2) NOT NULL CHECK (final_price > 0), -- 최종 판매가 (수동 조정 가능)
  currency TEXT NOT NULL, -- 'VND', 'CNY'
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(product_id, to_location_id)
);

-- RLS 활성화
ALTER TABLE public.pricing_configs ENABLE ROW LEVEL SECURITY;

-- 정책: HQ Admin만 접근 가능
CREATE POLICY "HQ Admin can view pricing configs" ON public.pricing_configs
  FOR SELECT USING (
    EXISTS (
      SELECT 1 FROM public.users
      WHERE id = auth.uid() AND role = 'HQ_Admin'
    )
  );

CREATE POLICY "HQ Admin can modify pricing configs" ON public.pricing_configs
  FOR ALL USING (
    EXISTS (
      SELECT 1 FROM public.users
      WHERE id = auth.uid() AND role = 'HQ_Admin'
    )
  );

-- 인덱스
CREATE INDEX idx_pricing_product_location ON public.pricing_configs(product_id, to_location_id);

-- 업데이트 타임스탬프 트리거
CREATE TRIGGER pricing_configs_updated_at
  BEFORE UPDATE ON public.pricing_configs
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at();
```

---

#### 2.2.7 sales 테이블

```sql
-- sales 테이블 생성
CREATE TABLE public.sales (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  location_id UUID NOT NULL REFERENCES public.locations(id) ON DELETE RESTRICT,
  product_id UUID NOT NULL REFERENCES public.products(id) ON DELETE RESTRICT,
  sale_date DATE NOT NULL DEFAULT CURRENT_DATE,
  qty INTEGER NOT NULL CHECK (qty > 0),
  unit_price DECIMAL(12, 2) NOT NULL CHECK (unit_price > 0),
  total_amount DECIMAL(15, 2) GENERATED ALWAYS AS (qty * unit_price) STORED,
  currency TEXT NOT NULL,
  created_by UUID REFERENCES public.users(id),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- RLS 활성화
ALTER TABLE public.sales ENABLE ROW LEVEL SECURITY;

-- 정책: HQ Admin은 모든 판매 조회 가능
CREATE POLICY "HQ Admin can view all sales" ON public.sales
  FOR SELECT USING (
    EXISTS (
      SELECT 1 FROM public.users
      WHERE id = auth.uid() AND role = 'HQ_Admin'
    )
  );

-- 정책: Branch Manager는 자기 지사 판매만 조회
CREATE POLICY "Branch Manager can view own sales" ON public.sales
  FOR SELECT USING (
    EXISTS (
      SELECT 1 FROM public.users
      WHERE id = auth.uid()
        AND role = 'Branch_Manager'
        AND location_id = sales.location_id
    )
  );

-- 정책: Branch Manager는 자기 지사 판매 입력 가능
CREATE POLICY "Branch Manager can insert own sales" ON public.sales
  FOR INSERT WITH CHECK (
    EXISTS (
      SELECT 1 FROM public.users
      WHERE id = auth.uid()
        AND role = 'Branch_Manager'
        AND location_id = sales.location_id
    )
  );

-- 정책: HQ Admin은 모든 판매 수정 가능
CREATE POLICY "HQ Admin can modify sales" ON public.sales
  FOR ALL USING (
    EXISTS (
      SELECT 1 FROM public.users
      WHERE id = auth.uid() AND role = 'HQ_Admin'
    )
  );

-- 인덱스
CREATE INDEX idx_sales_location_date ON public.sales(location_id, sale_date);
CREATE INDEX idx_sales_product ON public.sales(product_id);

-- 업데이트 타임스탬프 트리거
CREATE TRIGGER sales_updated_at
  BEFORE UPDATE ON public.sales
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at();
```

---

#### 2.2.8 exchange_rates 테이블

```sql
-- exchange_rates 테이블 생성
CREATE TABLE public.exchange_rates (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  from_currency TEXT NOT NULL CHECK (from_currency IN ('KRW', 'VND', 'CNY')),
  to_currency TEXT NOT NULL CHECK (to_currency IN ('KRW', 'VND', 'CNY')),
  rate DECIMAL(10, 4) NOT NULL CHECK (rate > 0),
  effective_date DATE NOT NULL DEFAULT CURRENT_DATE,
  created_by UUID REFERENCES public.users(id),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(from_currency, to_currency, effective_date)
);

-- RLS 활성화
ALTER TABLE public.exchange_rates ENABLE ROW LEVEL SECURITY;

-- 정책: 인증된 사용자 조회 가능
CREATE POLICY "Authenticated users can view exchange rates" ON public.exchange_rates
  FOR SELECT USING (auth.role() = 'authenticated');

-- 정책: HQ Admin만 수정 가능
CREATE POLICY "HQ Admin can modify exchange rates" ON public.exchange_rates
  FOR ALL USING (
    EXISTS (
      SELECT 1 FROM public.users
      WHERE id = auth.uid() AND role = 'HQ_Admin'
    )
  );

-- 인덱스
CREATE INDEX idx_exchange_rates_currencies ON public.exchange_rates(from_currency, to_currency);
CREATE INDEX idx_exchange_rates_date ON public.exchange_rates(effective_date DESC);

-- 초기 데이터 (예시)
INSERT INTO public.exchange_rates (from_currency, to_currency, rate, effective_date) VALUES
('KRW', 'VND', 18.0, CURRENT_DATE),
('KRW', 'CNY', 0.0053, CURRENT_DATE);
```

---

#### 2.2.9 users 테이블 업데이트 (location_id 외래 키 활성화)

```sql
-- users.location_id 외래 키 제약 조건 추가
ALTER TABLE public.users
  ADD CONSTRAINT fk_users_location
  FOREIGN KEY (location_id) REFERENCES public.locations(id) ON DELETE SET NULL;
```

---

### 2.3 TypeScript 타입 생성

Supabase CLI를 사용하여 데이터베이스 스키마에서 TypeScript 타입을 자동 생성합니다.

```bash
# Supabase CLI 설치 (전역)
npm install -g supabase

# 로그인
supabase login

# 타입 생성
supabase gen types typescript --project-id <your-project-id> > types/database.ts
```

또는 Supabase Dashboard에서 직접 타입 정의를 복사할 수 있습니다.

---

## 3. 마스터 데이터 CRUD UI 구현

### 3.1 공급업체 관리 (Suppliers)

#### 필요한 shadcn/ui 컴포넌트 추가
```bash
npx shadcn-ui@latest add table
npx shadcn-ui@latest add textarea
npx shadcn-ui@latest add dialog
```

#### 3.1.1 공급업체 목록 페이지

**파일**: `app/(dashboard)/suppliers/page.tsx`

```typescript
import { createServerClient } from '@/lib/supabase/server'
import { SuppliersList } from '@/components/suppliers/suppliers-list'
import { Button } from '@/components/ui/button'
import Link from 'next/link'
import { Plus } from 'lucide-react'

export default async function SuppliersPage() {
  const supabase = createServerClient()

  const { data: suppliers, error } = await supabase
    .from('suppliers')
    .select('*')
    .order('created_at', { ascending: false })

  if (error) {
    return <div>Error loading suppliers: {error.message}</div>
  }

  return (
    <div>
      <div className="flex justify-between items-center mb-6">
        <h1 className="text-3xl font-bold">Suppliers</h1>
        <Link href="/suppliers/new">
          <Button>
            <Plus className="mr-2 h-4 w-4" />
            Add Supplier
          </Button>
        </Link>
      </div>

      <SuppliersList suppliers={suppliers || []} />
    </div>
  )
}
```

#### 3.1.2 공급업체 목록 컴포넌트

**파일**: `components/suppliers/suppliers-list.tsx`

```typescript
'use client'

import { Database } from '@/types/database'
import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from '@/components/ui/table'
import { Button } from '@/components/ui/button'
import Link from 'next/link'
import { Edit, Trash } from 'lucide-react'

type Supplier = Database['public']['Tables']['suppliers']['Row']

interface SuppliersListProps {
  suppliers: Supplier[]
}

export function SuppliersList({ suppliers }: SuppliersListProps) {
  return (
    <div className="border rounded-lg">
      <Table>
        <TableHeader>
          <TableRow>
            <TableHead>Name</TableHead>
            <TableHead>Contact Person</TableHead>
            <TableHead>Phone</TableHead>
            <TableHead>Email</TableHead>
            <TableHead className="text-right">Actions</TableHead>
          </TableRow>
        </TableHeader>
        <TableBody>
          {suppliers.length === 0 ? (
            <TableRow>
              <TableCell colSpan={5} className="text-center text-gray-500">
                No suppliers found. Add your first supplier to get started.
              </TableCell>
            </TableRow>
          ) : (
            suppliers.map((supplier) => (
              <TableRow key={supplier.id}>
                <TableCell className="font-medium">{supplier.name}</TableCell>
                <TableCell>{supplier.contact_person || '-'}</TableCell>
                <TableCell>{supplier.phone || '-'}</TableCell>
                <TableCell>{supplier.email || '-'}</TableCell>
                <TableCell className="text-right">
                  <div className="flex justify-end gap-2">
                    <Link href={`/suppliers/${supplier.id}/edit`}>
                      <Button variant="ghost" size="sm">
                        <Edit className="h-4 w-4" />
                      </Button>
                    </Link>
                    <Button variant="ghost" size="sm">
                      <Trash className="h-4 w-4 text-red-500" />
                    </Button>
                  </div>
                </TableCell>
              </TableRow>
            ))
          )}
        </TableBody>
      </Table>
    </div>
  )
}
```

#### 3.1.3 공급업체 추가/수정 폼

**파일**: `components/suppliers/supplier-form.tsx`

```typescript
'use client'

import { useState } from 'react'
import { useRouter } from 'next/navigation'
import { createClient } from '@/lib/supabase/client'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { Label } from '@/components/ui/label'
import { Textarea } from '@/components/ui/textarea'
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
import { useToast } from '@/components/ui/use-toast'
import { Database } from '@/types/database'

type Supplier = Database['public']['Tables']['suppliers']['Row']

interface SupplierFormProps {
  supplier?: Supplier
  mode: 'create' | 'edit'
}

export function SupplierForm({ supplier, mode }: SupplierFormProps) {
  const [formData, setFormData] = useState({
    name: supplier?.name || '',
    contact_person: supplier?.contact_person || '',
    phone: supplier?.phone || '',
    email: supplier?.email || '',
    address: supplier?.address || '',
    notes: supplier?.notes || '',
  })
  const [loading, setLoading] = useState(false)
  const router = useRouter()
  const { toast } = useToast()
  const supabase = createClient()

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault()
    setLoading(true)

    try {
      if (mode === 'create') {
        const { error } = await supabase
          .from('suppliers')
          .insert([formData])

        if (error) throw error

        toast({ title: 'Supplier created successfully' })
      } else {
        const { error } = await supabase
          .from('suppliers')
          .update(formData)
          .eq('id', supplier!.id)

        if (error) throw error

        toast({ title: 'Supplier updated successfully' })
      }

      router.push('/suppliers')
      router.refresh()
    } catch (error: any) {
      toast({
        variant: 'destructive',
        title: 'Error',
        description: error.message,
      })
    } finally {
      setLoading(false)
    }
  }

  return (
    <Card>
      <CardHeader>
        <CardTitle>{mode === 'create' ? 'Add New Supplier' : 'Edit Supplier'}</CardTitle>
      </CardHeader>
      <CardContent>
        <form onSubmit={handleSubmit} className="space-y-4">
          <div>
            <Label htmlFor="name">Name *</Label>
            <Input
              id="name"
              value={formData.name}
              onChange={(e) => setFormData({ ...formData, name: e.target.value })}
              required
            />
          </div>

          <div>
            <Label htmlFor="contact_person">Contact Person</Label>
            <Input
              id="contact_person"
              value={formData.contact_person}
              onChange={(e) => setFormData({ ...formData, contact_person: e.target.value })}
            />
          </div>

          <div>
            <Label htmlFor="phone">Phone</Label>
            <Input
              id="phone"
              value={formData.phone}
              onChange={(e) => setFormData({ ...formData, phone: e.target.value })}
            />
          </div>

          <div>
            <Label htmlFor="email">Email</Label>
            <Input
              id="email"
              type="email"
              value={formData.email}
              onChange={(e) => setFormData({ ...formData, email: e.target.value })}
            />
          </div>

          <div>
            <Label htmlFor="address">Address</Label>
            <Textarea
              id="address"
              value={formData.address}
              onChange={(e) => setFormData({ ...formData, address: e.target.value })}
            />
          </div>

          <div>
            <Label htmlFor="notes">Notes</Label>
            <Textarea
              id="notes"
              value={formData.notes}
              onChange={(e) => setFormData({ ...formData, notes: e.target.value })}
            />
          </div>

          <div className="flex gap-2">
            <Button type="submit" disabled={loading}>
              {loading ? 'Saving...' : 'Save'}
            </Button>
            <Button
              type="button"
              variant="outline"
              onClick={() => router.back()}
            >
              Cancel
            </Button>
          </div>
        </form>
      </CardContent>
    </Card>
  )
}
```

#### 3.1.4 공급업체 추가 페이지

**파일**: `app/(dashboard)/suppliers/new/page.tsx`

```typescript
import { SupplierForm } from '@/components/suppliers/supplier-form'

export default function NewSupplierPage() {
  return (
    <div>
      <h1 className="text-3xl font-bold mb-6">Add Supplier</h1>
      <SupplierForm mode="create" />
    </div>
  )
}
```

#### 3.1.5 공급업체 수정 페이지

**파일**: `app/(dashboard)/suppliers/[id]/edit/page.tsx`

```typescript
import { createServerClient } from '@/lib/supabase/server'
import { SupplierForm } from '@/components/suppliers/supplier-form'
import { notFound } from 'next/navigation'

export default async function EditSupplierPage({
  params,
}: {
  params: { id: string }
}) {
  const supabase = createServerClient()

  const { data: supplier, error } = await supabase
    .from('suppliers')
    .select('*')
    .eq('id', params.id)
    .single()

  if (error || !supplier) {
    notFound()
  }

  return (
    <div>
      <h1 className="text-3xl font-bold mb-6">Edit Supplier</h1>
      <SupplierForm supplier={supplier} mode="edit" />
    </div>
  )
}
```

---

### 3.2 제품 관리 (Products)

**제품 관리는 공급업체와 유사한 구조로 구현합니다:**

#### 파일 구조
- `app/(dashboard)/products/page.tsx` - 제품 목록
- `app/(dashboard)/products/new/page.tsx` - 제품 추가
- `app/(dashboard)/products/[id]/edit/page.tsx` - 제품 수정
- `components/products/product-form.tsx` - 제품 폼 컴포넌트
- `components/products/products-list.tsx` - 제품 목록 컴포넌트

#### 주요 필드
- **SKU** (필수, 고유값)
- **Name** (필수)
- **Category** (선택)
- **Unit** (EA, BOX, PACK 중 선택)
- **Shelf Life Days** (유통기한, 기본 730일)
- **Description** (선택)

#### 추가 기능
- SKU 중복 체크
- 유통기한 일수 유효성 검사 (양수)
- 단위 선택 드롭다운

---

### 3.3 지사 관리 (Locations)

**지사 관리는 읽기 전용에 가깝게 구현** (초기 데이터가 이미 삽입됨):

#### 파일 구조
- `app/(dashboard)/locations/page.tsx` - 지사 목록
- `app/(dashboard)/locations/[id]/edit/page.tsx` - 지사 수정 (연락처 정보만)
- `components/locations/locations-list.tsx` - 지사 목록 컴포넌트

#### 주요 필드
- **Name** (필수)
- **Location Type** (HQ / Branch) - 수정 불가
- **Country Code** (KR, VN, CN) - 수정 불가
- **Currency** (KRW, VND, CNY) - 수정 불가
- **Address** (수정 가능)
- **Contact Person** (수정 가능)
- **Phone** (수정 가능)

#### 제약사항
- 새 지사 추가는 MVP에서 제한 (초기 3개만 사용)
- 지사 삭제 불가
- 핵심 필드(type, country, currency) 수정 불가

---

## 4. API Routes (선택사항)

복잡한 비즈니스 로직이 필요한 경우 API Routes를 생성합니다.

**예시**: `app/api/suppliers/route.ts`

```typescript
import { createServerClient } from '@/lib/supabase/server'
import { NextResponse } from 'next/server'

export async function GET() {
  const supabase = createServerClient()

  const { data, error } = await supabase
    .from('suppliers')
    .select('*')
    .order('created_at', { ascending: false })

  if (error) {
    return NextResponse.json({ error: error.message }, { status: 500 })
  }

  return NextResponse.json({ suppliers: data })
}
```

---

## 5. 테스트 체크리스트

### 5.1 데이터베이스 테스트
- [ ] 모든 테이블이 Supabase에 정상 생성됨
- [ ] 외래 키 제약 조건 정상 작동
- [ ] RLS 정책 정상 작동 (HQ Admin vs Branch Manager)
- [ ] 인덱스 생성 확인
- [ ] 초기 데이터 삽입 확인 (locations 3개, exchange_rates 2개)
- [ ] users.location_id 외래 키 정상 작동

### 5.2 CRUD 기능 테스트
- [ ] 공급업체 추가/수정/조회 정상 작동
- [ ] 제품 추가/수정/조회 정상 작동
- [ ] 지사 조회/수정 정상 작동
- [ ] HQ Admin만 마스터 데이터 수정 가능 확인
- [ ] 폼 유효성 검사 (필수 필드, 이메일 형식, SKU 중복 등)
- [ ] 빈 목록 상태 UI 표시 확인

### 5.3 권한 테스트
- [ ] Branch Manager 계정으로 suppliers/products 페이지 접근 불가 확인
- [ ] RLS 정책으로 Branch Manager는 다른 지사 데이터 조회 불가 확인

---

## 6. 산출물

### 6.1 완료된 기능
- ✅ 10개 핵심 테이블 생성 (SQL)
- ✅ RLS 정책 설정 (역할별 접근 제어)
- ✅ TypeScript 타입 자동 생성
- ✅ 공급업체 CRUD UI
- ✅ 제품 CRUD UI
- ✅ 지사 조회/수정 UI
- ✅ 초기 데이터 삽입 (HQ 1개, 지사 2개, 환율 2개)
- ✅ 테이블 인덱스 및 트리거 설정

### 6.2 다음 Phase 준비사항
- Phase 03에서 구매 발주 생성 및 HQ 입고 처리 구현
- 테스트 데이터 생성:
  - 공급업체 2-3개
  - 제품 10-15개 (다양한 카테고리)
  - 테스트 계정 (HQ Admin 1명, Branch Manager 2명)

---

## 7. 참고 자료

- [Supabase Row Level Security](https://supabase.com/docs/guides/auth/row-level-security)
- [PostgreSQL Indexes](https://www.postgresql.org/docs/current/indexes.html)
- [shadcn/ui Table Component](https://ui.shadcn.com/docs/components/table)
- [Next.js Server Components](https://nextjs.org/docs/app/building-your-application/rendering/server-components)

---

## 8. 작업 이후 체크리스트

- [ ] Supabase Dashboard에서 모든 테이블 확인
- [ ] RLS 정책 테스트 완료
- [ ] 마스터 데이터 CRUD 정상 작동 확인
- [ ] TypeScript 타입 생성 및 적용 완료
- [ ] 테스트 데이터 생성 완료
- [ ] GitHub에 코드 푸시
- [ ] Worklog 문서 작성: `002.phase02.데이터베이스_스키마_및_마스터_데이터.md`
- [ ] Phase 03 계획 검토
