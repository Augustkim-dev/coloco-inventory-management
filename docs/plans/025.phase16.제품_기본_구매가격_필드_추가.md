# Phase 16: 제품 기본 구매가격 필드 추가

## 목표
Products 테이블에 기본 구매가격(default_purchase_price) 필드를 추가하여, 템플릿 적용 시 PO 없이도 가격 설정이 가능하도록 개선

## 현재 문제점
1. 템플릿 적용 시 구매가격을 PO(Purchase Order)에서만 가져옴
2. PO가 없는 제품은 템플릿 적용 시 "skip" 처리됨
3. 신규 제품 등록 후 PO 없이는 가격 설정 불가

## 기대 효과
1. 제품 등록 시 기본 구매가격 설정 가능
2. 템플릿 적용 시 PO 없어도 기본 구매가격 사용
3. 가격 설정 프로세스 단순화: **제품 등록 → 템플릿 적용 → 완료**

---

## 구현 계획

### Step 1: DB 마이그레이션 (031_add_product_default_purchase_price.sql)

```sql
-- products 테이블에 default_purchase_price 컬럼 추가
ALTER TABLE public.products
ADD COLUMN IF NOT EXISTS default_purchase_price DECIMAL(12, 2) DEFAULT NULL;

-- 코멘트 추가
COMMENT ON COLUMN public.products.default_purchase_price IS
  'Default purchase price in KRW. Used when no PO price is available.';
```

### Step 2: 타입 정의 업데이트 (types/index.ts)

```typescript
export interface Product {
  // ... 기존 필드들
  default_purchase_price: number | null  // 추가
}
```

### Step 3: Product Form 수정 (components/products/product-form.tsx)

**변경사항:**
- 구매가격 입력 필드 추가
- 단위: KRW
- 선택 사항 (nullable)

```tsx
<div>
  <Label htmlFor="default_purchase_price">Default Purchase Price (KRW)</Label>
  <Input
    id="default_purchase_price"
    type="number"
    min="0"
    step="100"
    value={formData.default_purchase_price || ''}
    onChange={(e) => setFormData({
      ...formData,
      default_purchase_price: e.target.value ? parseFloat(e.target.value) : null
    })}
    placeholder="e.g., 5000"
  />
  <p className="text-xs text-muted-foreground mt-1">
    Used for pricing template when no PO exists
  </p>
</div>
```

### Step 4: Products List에 구매가격 표시 (components/products/products-list.tsx)

테이블에 "Purchase Price" 컬럼 추가:

| SKU | Name | Category | Unit | Shelf Life | **Purchase Price** | Actions |
|-----|------|----------|------|------------|-------------------|---------|
| SKU001 | Serum A | skincare | EA | 730 | **5,000 KRW** | Edit / Delete |
| SKU002 | Cream B | skincare | EA | 365 | **-** | Edit / Delete |

### Step 5: 템플릿 적용 API 수정 (app/api/pricing/templates/apply/route.ts)

**가격 우선순위 변경:**
1. PO에서 가져온 가격 (기존 로직)
2. **제품의 default_purchase_price** (신규 추가)
3. 가격 없음 → skip

```typescript
// 기존: PO에서만 가격 조회
const purchasePriceMap: Record<string, number> = {}
poItems?.forEach(item => {
  if (!purchasePriceMap[item.product_id] ||
      item.unit_price > purchasePriceMap[item.product_id]) {
    purchasePriceMap[item.product_id] = item.unit_price
  }
})

// 변경: PO 가격 없으면 default_purchase_price 사용
products.forEach(product => {
  if (!purchasePriceMap[product.id] && product.default_purchase_price) {
    purchasePriceMap[product.id] = product.default_purchase_price
  }
})
```

---

## 수정 파일 목록

| 순서 | 파일 | 변경 내용 |
|------|------|----------|
| 1 | `supabase/migrations/031_add_product_default_purchase_price.sql` | 신규 컬럼 추가 |
| 2 | `types/index.ts` | Product 타입에 default_purchase_price 추가 |
| 3 | `components/products/product-form.tsx` | 구매가격 입력 필드 추가 |
| 4 | `components/products/products-list.tsx` | 테이블에 구매가격 컬럼 추가 |
| 5 | `app/api/pricing/templates/apply/route.ts` | default_purchase_price 우선순위 로직 추가 |

---

## 예상 사용 시나리오

### Before (현재)
1. 제품 등록 (구매가격 없음)
2. PO 생성 → 수령 (구매가격 확정)
3. 템플릿 적용 → 가격 설정 완료

### After (개선 후)
1. 제품 등록 + **기본 구매가격 입력**
2. 템플릿 적용 → **바로 가격 설정 완료**
3. (선택) PO 생성 시 실제 구매가로 덮어쓰기

---

## 고려사항

1. **기존 데이터 호환성**: default_purchase_price는 nullable이므로 기존 제품에 영향 없음
2. **PO 가격 우선**: PO에서 받은 가격이 있으면 default_purchase_price보다 우선
3. **UI 힌트**: 구매가격 필드에 "템플릿 적용 시 사용됨" 안내 문구 표시
