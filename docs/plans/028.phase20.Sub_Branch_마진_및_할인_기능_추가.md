# Phase 20: Sub Branch 마진 및 할인 기능 추가

## 개요

Pricing Configuration 시스템에 다음 기능을 추가합니다:
1. **Sub Branch 마진**: 기존 HQ 마진 + Branch 마진에 더해 Sub Branch 마진을 추가
2. **할인율(Discount)**: 최종 소비자가격에서 할인을 적용하여 "할인판매가격" 산출

## 새로운 가격 계산 공식

```
소비자가격 = (구매가 + 이송비) × 환율 ÷ (1 - (HQ마진 + Branch마진 + SubBranch마진) / 100)
할인판매가격 = 소비자가격 × (1 - 할인율 / 100)
```

### 예시
- 구매가: 5,000 KRW, 이송비: 500 KRW, 환율: 18.5 VND/KRW
- HQ 마진: 10%, Branch 마진: 20%, SubBranch 마진: 10%, 할인율: 5%

계산:
1. 소비자가격 = (5,000 + 500) × 18.5 ÷ (1 - 0.40) = 169,583 → 170,000 VND
2. 할인판매가격 = 170,000 × 0.95 = 161,500 VND

## 확인된 요구사항

1. **Sub Branch 마진 적용 대상**:
   - Main Branch: HQ 마진 + Branch 마진 (Sub Branch 마진 = 0)
   - Sub Branch: HQ 마진 + Branch 마진 + Sub Branch 마진

2. **할인판매가격 표시**:
   - 할인율이 0%라도 "할인판매가격" 컬럼 항상 표시

3. **Add Pricing Config UI**:
   - 2단계 선택 방식
   - 먼저 Main Branch 선택 → 그 다음 SubBranch 선택
   - SubBranch 미선택 시 Main Branch에 적용

4. **템플릿 적용 시**:
   - Main Branch에 적용 → Sub Branch 마진 무시 (0으로 처리)
   - Sub Branch에 적용 → 템플릿의 Sub Branch 마진 사용

## 수정 대상 파일

### 데이터베이스
- `supabase/migrations/035_add_subbranch_margin_and_discount.sql` (신규)

### 타입 정의
- `types/index.ts`

### 컴포넌트
- `components/pricing/pricing-form.tsx`
- `components/pricing/pricing-list.tsx`
- `components/pricing/template-form.tsx`
- `components/pricing/template-card.tsx`
- `components/pricing/apply-template-dialog.tsx`

### API
- `app/api/pricing/templates/apply/route.ts`
- `app/api/pricing/templates/route.ts`
- `app/api/pricing/templates/[id]/route.ts`

## 구현 순서

1. 데이터베이스 마이그레이션 작성
2. TypeScript 타입 수정
3. pricing-form.tsx 수정 (2단계 선택 UI, Sub Branch 마진, 할인)
4. template-form.tsx 수정 (Sub Branch 마진, 할인 추가)
5. API route 수정
6. pricing-list.tsx 수정 (컬럼 추가)
7. template-card.tsx 수정 (표시 추가)
8. apply-template-dialog.tsx 수정
