# Phase 03: 구매 발주 및 HQ 입고 처리

**작업 기간**: 1주 (5일)
**담당자**: 개발팀
**목표**: 공장 발주 → HQ 입고 → 재고 자동 증가 워크플로우 구현

---

## 1. 개요

공급업체로부터 제품을 구매하는 전체 프로세스를 구현합니다. 구매 발주(PO) 생성, 승인, HQ 입고 처리를 통해 재고가 자동으로 증가하는 워크플로우를 완성합니다.

### 핵심 목표
- ✅ 구매 발주(PO) 생성 UI 및 로직
- ✅ PO 승인 워크플로우 (Draft → Approved)
- ✅ HQ 입고 처리 UI (배치 정보 입력)
- ✅ 입고 시 stock_batches 자동 생성
- ✅ 유통기한 자동 계산
- ✅ 재고 증가 확인

---

## 2. 비즈니스 워크플로우

### 2.1 전체 프로세스

```
1. PO 생성 (Draft)
   ↓
2. PO 승인 (Draft → Approved)
   ↓
3. HQ 입고 처리 (Approved → Received)
   - 수량 확인
   - 배치 정보 입력
   - 품질 체크 (Pass/Fail)
   ↓
4. stock_batches 생성
   - 제품별, 배치별 재고 기록
   - 유통기한 자동 계산
   ↓
5. HQ 재고 증가 완료
```

---

## 3. 작업 상세

### 3.1 구매 발주(PO) 생성

#### 3.1.1 PO 목록 페이지

**파일**: `app/(dashboard)/purchase-orders/page.tsx`

```typescript
import { createServerClient } from '@/lib/supabase/server'
import { POList } from '@/components/purchase-orders/po-list'
import { Button } from '@/components/ui/button'
import Link from 'next/link'
import { Plus } from 'lucide-react'

export default async function PurchaseOrdersPage() {
  const supabase = createServerClient()

  const { data: purchaseOrders, error } = await supabase
    .from('purchase_orders')
    .select(`
      *,
      supplier:suppliers(name),
      items:purchase_order_items(
        id,
        qty,
        unit_price,
        total_price,
        product:products(name, sku)
      )
    `)
    .order('created_at', { ascending: false })

  if (error) {
    return <div>Error loading purchase orders: {error.message}</div>
  }

  return (
    <div>
      <div className="flex justify-between items-center mb-6">
        <h1 className="text-3xl font-bold">Purchase Orders</h1>
        <Link href="/purchase-orders/new">
          <Button>
            <Plus className="mr-2 h-4 w-4" />
            Create PO
          </Button>
        </Link>
      </div>

      <POList purchaseOrders={purchaseOrders || []} />
    </div>
  )
}
```

#### 3.1.2 PO 목록 컴포넌트

**파일**: `components/purchase-orders/po-list.tsx`

```typescript
'use client'

import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from '@/components/ui/table'
import { Badge } from '@/components/ui/badge'
import { Button } from '@/components/ui/button'
import Link from 'next/link'
import { Eye, CheckCircle, Package } from 'lucide-react'
import { formatDate, formatCurrency } from '@/lib/utils'

export function POList({ purchaseOrders }: { purchaseOrders: any[] }) {
  const getStatusBadge = (status: string) => {
    const variants: Record<string, 'default' | 'secondary' | 'success'> = {
      Draft: 'secondary',
      Approved: 'default',
      Received: 'success',
    }
    return <Badge variant={variants[status] || 'default'}>{status}</Badge>
  }

  return (
    <div className="border rounded-lg">
      <Table>
        <TableHeader>
          <TableRow>
            <TableHead>PO No.</TableHead>
            <TableHead>Supplier</TableHead>
            <TableHead>Order Date</TableHead>
            <TableHead>Status</TableHead>
            <TableHead>Total Amount</TableHead>
            <TableHead className="text-right">Actions</TableHead>
          </TableRow>
        </TableHeader>
        <TableBody>
          {purchaseOrders.length === 0 ? (
            <TableRow>
              <TableCell colSpan={6} className="text-center text-gray-500">
                No purchase orders found. Create your first PO to get started.
              </TableCell>
            </TableRow>
          ) : (
            purchaseOrders.map((po) => (
              <TableRow key={po.id}>
                <TableCell className="font-medium">{po.po_no}</TableCell>
                <TableCell>{po.supplier?.name}</TableCell>
                <TableCell>{formatDate(po.order_date)}</TableCell>
                <TableCell>{getStatusBadge(po.status)}</TableCell>
                <TableCell>{formatCurrency(po.total_amount, po.currency)}</TableCell>
                <TableCell className="text-right">
                  <div className="flex justify-end gap-2">
                    <Link href={`/purchase-orders/${po.id}`}>
                      <Button variant="ghost" size="sm">
                        <Eye className="h-4 w-4" />
                      </Button>
                    </Link>
                    {po.status === 'Draft' && (
                      <Link href={`/purchase-orders/${po.id}/approve`}>
                        <Button variant="ghost" size="sm">
                          <CheckCircle className="h-4 w-4 text-green-600" />
                        </Button>
                      </Link>
                    )}
                    {po.status === 'Approved' && (
                      <Link href={`/purchase-orders/${po.id}/receive`}>
                        <Button variant="ghost" size="sm">
                          <Package className="h-4 w-4 text-blue-600" />
                        </Button>
                      </Link>
                    )}
                  </div>
                </TableCell>
              </TableRow>
            ))
          )}
        </TableBody>
      </Table>
    </div>
  )
}
```

#### 3.1.3 PO 생성 폼

**파일**: `app/(dashboard)/purchase-orders/new/page.tsx`

```typescript
import { createServerClient } from '@/lib/supabase/server'
import { POForm } from '@/components/purchase-orders/po-form'

export default async function NewPOPage() {
  const supabase = createServerClient()

  // 공급업체 및 제품 목록 조회
  const { data: suppliers } = await supabase
    .from('suppliers')
    .select('id, name')
    .order('name')

  const { data: products } = await supabase
    .from('products')
    .select('id, sku, name, unit')
    .order('sku')

  return (
    <div>
      <h1 className="text-3xl font-bold mb-6">Create Purchase Order</h1>
      <POForm
        suppliers={suppliers || []}
        products={products || []}
        mode="create"
      />
    </div>
  )
}
```

#### 3.1.4 PO 폼 컴포넌트

**파일**: `components/purchase-orders/po-form.tsx`

```typescript
'use client'

import { useState } from 'react'
import { useRouter } from 'next/navigation'
import { createClient } from '@/lib/supabase/client'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { Label } from '@/components/ui/label'
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select'
import { useToast } from '@/components/ui/use-toast'
import { Plus, Trash2 } from 'lucide-react'

interface POFormProps {
  suppliers: Array<{ id: string; name: string }>
  products: Array<{ id: string; sku: string; name: string; unit: string }>
  mode: 'create' | 'edit'
}

interface POItem {
  product_id: string
  qty: number
  unit_price: number
}

export function POForm({ suppliers, products, mode }: POFormProps) {
  const [formData, setFormData] = useState({
    po_no: `PO-${Date.now()}`,
    supplier_id: '',
    order_date: new Date().toISOString().split('T')[0],
    notes: '',
  })
  const [items, setItems] = useState<POItem[]>([
    { product_id: '', qty: 1, unit_price: 0 },
  ])
  const [loading, setLoading] = useState(false)
  const router = useRouter()
  const { toast } = useToast()
  const supabase = createClient()

  const addItem = () => {
    setItems([...items, { product_id: '', qty: 1, unit_price: 0 }])
  }

  const removeItem = (index: number) => {
    setItems(items.filter((_, i) => i !== index))
  }

  const updateItem = (index: number, field: keyof POItem, value: any) => {
    const newItems = [...items]
    newItems[index] = { ...newItems[index], [field]: value }
    setItems(newItems)
  }

  const calculateTotal = () => {
    return items.reduce((sum, item) => sum + item.qty * item.unit_price, 0)
  }

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault()

    // 유효성 검사
    if (!formData.supplier_id) {
      toast({ variant: 'destructive', title: 'Please select a supplier' })
      return
    }

    if (items.some(item => !item.product_id || item.qty <= 0 || item.unit_price < 0)) {
      toast({ variant: 'destructive', title: 'Please fill all item details correctly' })
      return
    }

    setLoading(true)

    try {
      // 현재 사용자 조회
      const { data: { user } } = await supabase.auth.getUser()

      // PO 생성
      const { data: po, error: poError } = await supabase
        .from('purchase_orders')
        .insert([{
          ...formData,
          total_amount: calculateTotal(),
          currency: 'KRW',
          status: 'Draft',
          created_by: user?.id,
        }])
        .select()
        .single()

      if (poError) throw poError

      // PO 아이템 생성
      const { error: itemsError } = await supabase
        .from('purchase_order_items')
        .insert(
          items.map(item => ({
            po_id: po.id,
            product_id: item.product_id,
            qty: item.qty,
            unit_price: item.unit_price,
          }))
        )

      if (itemsError) throw itemsError

      toast({ title: 'Purchase order created successfully' })
      router.push('/purchase-orders')
      router.refresh()
    } catch (error: any) {
      toast({
        variant: 'destructive',
        title: 'Error',
        description: error.message,
      })
    } finally {
      setLoading(false)
    }
  }

  return (
    <Card>
      <CardHeader>
        <CardTitle>Purchase Order Details</CardTitle>
      </CardHeader>
      <CardContent>
        <form onSubmit={handleSubmit} className="space-y-6">
          {/* PO 헤더 */}
          <div className="grid grid-cols-2 gap-4">
            <div>
              <Label htmlFor="po_no">PO Number *</Label>
              <Input
                id="po_no"
                value={formData.po_no}
                onChange={(e) => setFormData({ ...formData, po_no: e.target.value })}
                required
              />
            </div>
            <div>
              <Label htmlFor="order_date">Order Date *</Label>
              <Input
                id="order_date"
                type="date"
                value={formData.order_date}
                onChange={(e) => setFormData({ ...formData, order_date: e.target.value })}
                required
              />
            </div>
          </div>

          <div>
            <Label htmlFor="supplier_id">Supplier *</Label>
            <Select
              value={formData.supplier_id}
              onValueChange={(value) => setFormData({ ...formData, supplier_id: value })}
            >
              <SelectTrigger>
                <SelectValue placeholder="Select supplier" />
              </SelectTrigger>
              <SelectContent>
                {suppliers.map((supplier) => (
                  <SelectItem key={supplier.id} value={supplier.id}>
                    {supplier.name}
                  </SelectItem>
                ))}
              </SelectContent>
            </Select>
          </div>

          {/* PO 아이템 */}
          <div>
            <div className="flex justify-between items-center mb-4">
              <Label>Items *</Label>
              <Button type="button" variant="outline" size="sm" onClick={addItem}>
                <Plus className="mr-2 h-4 w-4" />
                Add Item
              </Button>
            </div>

            <div className="space-y-4">
              {items.map((item, index) => (
                <div key={index} className="flex gap-4 items-end">
                  <div className="flex-1">
                    <Label>Product</Label>
                    <Select
                      value={item.product_id}
                      onValueChange={(value) => updateItem(index, 'product_id', value)}
                    >
                      <SelectTrigger>
                        <SelectValue placeholder="Select product" />
                      </SelectTrigger>
                      <SelectContent>
                        {products.map((product) => (
                          <SelectItem key={product.id} value={product.id}>
                            {product.sku} - {product.name}
                          </SelectItem>
                        ))}
                      </SelectContent>
                    </Select>
                  </div>
                  <div className="w-24">
                    <Label>Quantity</Label>
                    <Input
                      type="number"
                      min="1"
                      value={item.qty}
                      onChange={(e) => updateItem(index, 'qty', parseInt(e.target.value))}
                    />
                  </div>
                  <div className="w-32">
                    <Label>Unit Price (KRW)</Label>
                    <Input
                      type="number"
                      min="0"
                      step="0.01"
                      value={item.unit_price}
                      onChange={(e) => updateItem(index, 'unit_price', parseFloat(e.target.value))}
                    />
                  </div>
                  <div className="w-32">
                    <Label>Total</Label>
                    <Input
                      value={(item.qty * item.unit_price).toLocaleString()}
                      disabled
                    />
                  </div>
                  <Button
                    type="button"
                    variant="ghost"
                    size="sm"
                    onClick={() => removeItem(index)}
                    disabled={items.length === 1}
                  >
                    <Trash2 className="h-4 w-4 text-red-500" />
                  </Button>
                </div>
              ))}
            </div>

            <div className="mt-4 text-right">
              <span className="text-lg font-bold">
                Total: {calculateTotal().toLocaleString()} KRW
              </span>
            </div>
          </div>

          <div>
            <Label htmlFor="notes">Notes</Label>
            <Input
              id="notes"
              value={formData.notes}
              onChange={(e) => setFormData({ ...formData, notes: e.target.value })}
            />
          </div>

          <div className="flex gap-2">
            <Button type="submit" disabled={loading}>
              {loading ? 'Creating...' : 'Create PO'}
            </Button>
            <Button
              type="button"
              variant="outline"
              onClick={() => router.back()}
            >
              Cancel
            </Button>
          </div>
        </form>
      </CardContent>
    </Card>
  )
}
```

---

### 3.2 PO 승인

#### 3.2.1 승인 API Route

**파일**: `app/api/purchase-orders/[id]/approve/route.ts`

```typescript
import { createServerClient } from '@/lib/supabase/server'
import { NextResponse } from 'next/server'

export async function POST(
  request: Request,
  { params }: { params: { id: string } }
) {
  const supabase = createServerClient()

  // 현재 사용자 조회
  const { data: { user } } = await supabase.auth.getUser()

  if (!user) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
  }

  // PO 승인
  const { error } = await supabase
    .from('purchase_orders')
    .update({
      status: 'Approved',
      approved_by: user.id,
      approved_at: new Date().toISOString(),
    })
    .eq('id', params.id)
    .eq('status', 'Draft') // Draft 상태만 승인 가능

  if (error) {
    return NextResponse.json({ error: error.message }, { status: 500 })
  }

  return NextResponse.json({ success: true })
}
```

#### 3.2.2 승인 페이지

**파일**: `app/(dashboard)/purchase-orders/[id]/approve/page.tsx`

```typescript
'use client'

import { useState } from 'react'
import { useRouter } from 'next/navigation'
import { Button } from '@/components/ui/button'
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
import { useToast } from '@/components/ui/use-toast'

export default function ApprovePOPage({ params }: { params: { id: string } }) {
  const [loading, setLoading] = useState(false)
  const router = useRouter()
  const { toast } = useToast()

  const handleApprove = async () => {
    setLoading(true)

    try {
      const response = await fetch(`/api/purchase-orders/${params.id}/approve`, {
        method: 'POST',
      })

      if (!response.ok) {
        throw new Error('Failed to approve PO')
      }

      toast({ title: 'Purchase order approved successfully' })
      router.push('/purchase-orders')
      router.refresh()
    } catch (error: any) {
      toast({
        variant: 'destructive',
        title: 'Error',
        description: error.message,
      })
    } finally {
      setLoading(false)
    }
  }

  return (
    <div>
      <h1 className="text-3xl font-bold mb-6">Approve Purchase Order</h1>
      <Card>
        <CardHeader>
          <CardTitle>Confirmation</CardTitle>
        </CardHeader>
        <CardContent>
          <p className="mb-4">
            Are you sure you want to approve this purchase order?
            Once approved, the PO can be received at the warehouse.
          </p>
          <div className="flex gap-2">
            <Button onClick={handleApprove} disabled={loading}>
              {loading ? 'Approving...' : 'Approve PO'}
            </Button>
            <Button variant="outline" onClick={() => router.back()}>
              Cancel
            </Button>
          </div>
        </CardContent>
      </Card>
    </div>
  )
}
```

---

### 3.3 HQ 입고 처리

#### 3.3.1 입고 처리 페이지

**파일**: `app/(dashboard)/purchase-orders/[id]/receive/page.tsx`

```typescript
import { createServerClient } from '@/lib/supabase/server'
import { ReceiveForm } from '@/components/purchase-orders/receive-form'
import { notFound } from 'next/navigation'

export default async function ReceivePOPage({ params }: { params: { id: string } }) {
  const supabase = createServerClient()

  // PO 및 아이템 조회
  const { data: po, error } = await supabase
    .from('purchase_orders')
    .select(`
      *,
      supplier:suppliers(name),
      items:purchase_order_items(
        *,
        product:products(id, sku, name, unit, shelf_life_days)
      )
    `)
    .eq('id', params.id)
    .eq('status', 'Approved')
    .single()

  if (error || !po) {
    notFound()
  }

  // HQ 지사 ID 조회
  const { data: hqLocation } = await supabase
    .from('locations')
    .select('id')
    .eq('location_type', 'HQ')
    .single()

  return (
    <div>
      <h1 className="text-3xl font-bold mb-6">Receive Purchase Order</h1>
      <ReceiveForm po={po} hqLocationId={hqLocation?.id || ''} />
    </div>
  )
}
```

#### 3.3.2 입고 처리 폼

**파일**: `components/purchase-orders/receive-form.tsx`

```typescript
'use client'

import { useState } from 'react'
import { useRouter } from 'next/navigation'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { Label } from '@/components/ui/label'
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select'
import { useToast } from '@/components/ui/use-toast'

interface ReceiveItem {
  po_item_id: string
  product_id: string
  product_name: string
  product_sku: string
  shelf_life_days: number
  ordered_qty: number
  received_qty: number
  batch_no: string
  manufactured_date: string
  quality_status: 'OK' | 'Damaged' | 'Quarantine'
}

export function ReceiveForm({ po, hqLocationId }: any) {
  const [items, setItems] = useState<ReceiveItem[]>(
    po.items.map((item: any) => ({
      po_item_id: item.id,
      product_id: item.product.id,
      product_name: item.product.name,
      product_sku: item.product.sku,
      shelf_life_days: item.product.shelf_life_days,
      ordered_qty: item.qty,
      received_qty: item.qty,
      batch_no: `BATCH-${Date.now()}`,
      manufactured_date: new Date().toISOString().split('T')[0],
      quality_status: 'OK' as const,
    }))
  )
  const [loading, setLoading] = useState(false)
  const router = useRouter()
  const { toast } = useToast()

  const updateItem = (index: number, field: keyof ReceiveItem, value: any) => {
    const newItems = [...items]
    newItems[index] = { ...newItems[index], [field]: value }
    setItems(newItems)
  }

  const calculateExpiryDate = (manufacturedDate: string, shelfLifeDays: number) => {
    const date = new Date(manufacturedDate)
    date.setDate(date.getDate() + shelfLifeDays)
    return date.toISOString().split('T')[0]
  }

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault()

    // 유효성 검사
    if (items.some(item => item.received_qty <= 0 || !item.batch_no || !item.manufactured_date)) {
      toast({ variant: 'destructive', title: 'Please fill all fields correctly' })
      return
    }

    setLoading(true)

    try {
      const response = await fetch(`/api/purchase-orders/${po.id}/receive`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          items: items.map(item => ({
            product_id: item.product_id,
            location_id: hqLocationId,
            batch_no: item.batch_no,
            qty_on_hand: item.received_qty,
            unit_cost: po.items.find((i: any) => i.product.id === item.product_id)?.unit_price || 0,
            manufactured_date: item.manufactured_date,
            expiry_date: calculateExpiryDate(item.manufactured_date, item.shelf_life_days),
            quality_status: item.quality_status,
          })),
        }),
      })

      if (!response.ok) {
        throw new Error('Failed to receive PO')
      }

      toast({ title: 'Purchase order received successfully' })
      router.push('/purchase-orders')
      router.refresh()
    } catch (error: any) {
      toast({
        variant: 'destructive',
        title: 'Error',
        description: error.message,
      })
    } finally {
      setLoading(false)
    }
  }

  return (
    <Card>
      <CardHeader>
        <CardTitle>Receive Items - PO: {po.po_no}</CardTitle>
      </CardHeader>
      <CardContent>
        <form onSubmit={handleSubmit} className="space-y-6">
          <div className="space-y-4">
            {items.map((item, index) => (
              <Card key={item.po_item_id}>
                <CardHeader>
                  <CardTitle className="text-base">
                    {item.product_sku} - {item.product_name}
                  </CardTitle>
                </CardHeader>
                <CardContent>
                  <div className="grid grid-cols-3 gap-4">
                    <div>
                      <Label>Ordered Qty</Label>
                      <Input value={item.ordered_qty} disabled />
                    </div>
                    <div>
                      <Label>Received Qty *</Label>
                      <Input
                        type="number"
                        min="1"
                        value={item.received_qty}
                        onChange={(e) => updateItem(index, 'received_qty', parseInt(e.target.value))}
                        required
                      />
                    </div>
                    <div>
                      <Label>Batch No. *</Label>
                      <Input
                        value={item.batch_no}
                        onChange={(e) => updateItem(index, 'batch_no', e.target.value)}
                        required
                      />
                    </div>
                    <div>
                      <Label>Manufactured Date *</Label>
                      <Input
                        type="date"
                        value={item.manufactured_date}
                        onChange={(e) => updateItem(index, 'manufactured_date', e.target.value)}
                        required
                      />
                    </div>
                    <div>
                      <Label>Expiry Date (Auto)</Label>
                      <Input
                        value={calculateExpiryDate(item.manufactured_date, item.shelf_life_days)}
                        disabled
                      />
                    </div>
                    <div>
                      <Label>Quality Status *</Label>
                      <Select
                        value={item.quality_status}
                        onValueChange={(value: any) => updateItem(index, 'quality_status', value)}
                      >
                        <SelectTrigger>
                          <SelectValue />
                        </SelectTrigger>
                        <SelectContent>
                          <SelectItem value="OK">OK</SelectItem>
                          <SelectItem value="Damaged">Damaged</SelectItem>
                          <SelectItem value="Quarantine">Quarantine</SelectItem>
                        </SelectContent>
                      </Select>
                    </div>
                  </div>
                </CardContent>
              </Card>
            ))}
          </div>

          <div className="flex gap-2">
            <Button type="submit" disabled={loading}>
              {loading ? 'Receiving...' : 'Confirm Receipt'}
            </Button>
            <Button type="button" variant="outline" onClick={() => router.back()}>
              Cancel
            </Button>
          </div>
        </form>
      </CardContent>
    </Card>
  )
}
```

#### 3.3.3 입고 처리 API Route

**파일**: `app/api/purchase-orders/[id]/receive/route.ts`

```typescript
import { createServerClient } from '@/lib/supabase/server'
import { NextResponse } from 'next/server'

export async function POST(
  request: Request,
  { params }: { params: { id: string } }
) {
  const supabase = createServerClient()

  const { items } = await request.json()

  try {
    // 트랜잭션 시뮬레이션: stock_batches 생성
    const { error: batchError } = await supabase
      .from('stock_batches')
      .insert(items)

    if (batchError) throw batchError

    // PO 상태 업데이트
    const { error: poError } = await supabase
      .from('purchase_orders')
      .update({
        status: 'Received',
        received_at: new Date().toISOString(),
      })
      .eq('id', params.id)

    if (poError) throw poError

    return NextResponse.json({ success: true })
  } catch (error: any) {
    return NextResponse.json({ error: error.message }, { status: 500 })
  }
}
```

---

## 4. 유틸리티 함수

**파일**: `lib/utils.ts` (추가)

```typescript
export function formatDate(dateString: string) {
  return new Date(dateString).toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'short',
    day: 'numeric',
  })
}

export function formatCurrency(amount: number, currency: string) {
  const formats: Record<string, Intl.NumberFormatOptions> = {
    KRW: { style: 'currency', currency: 'KRW', minimumFractionDigits: 0 },
    VND: { style: 'currency', currency: 'VND', minimumFractionDigits: 0 },
    CNY: { style: 'currency', currency: 'CNY', minimumFractionDigits: 2 },
  }

  return new Intl.NumberFormat('en-US', formats[currency]).format(amount)
}
```

---

## 5. 추가 shadcn/ui 컴포넌트

```bash
npx shadcn-ui@latest add badge
npx shadcn-ui@latest add select
```

---

## 6. 테스트 체크리스트

### 6.1 PO 생성 테스트
- [ ] PO 생성 폼에서 공급업체 및 제품 선택 가능
- [ ] 여러 아이템 추가/삭제 정상 작동
- [ ] 총액 자동 계산 확인
- [ ] Draft 상태로 PO 생성 확인

### 6.2 PO 승인 테스트
- [ ] Draft 상태 PO만 승인 가능
- [ ] 승인 시 상태가 Approved로 변경
- [ ] approved_by 및 approved_at 기록됨

### 6.3 입고 처리 테스트
- [ ] Approved 상태 PO만 입고 처리 가능
- [ ] 배치 정보 입력 (batch_no, manufactured_date)
- [ ] 유통기한 자동 계산 (manufactured_date + shelf_life_days)
- [ ] 품질 상태 선택 (OK, Damaged, Quarantine)
- [ ] 입고 처리 시 stock_batches 생성 확인
- [ ] PO 상태가 Received로 변경 확인
- [ ] HQ 재고 증가 확인

### 6.4 전체 워크플로우 테스트
- [ ] PO 생성 → 승인 → 입고 전체 프로세스 정상 작동
- [ ] 재고 수량이 입고 수량과 일치
- [ ] 배치별 재고 조회 가능

---

## 7. 산출물

### 7.1 완료된 기능
- ✅ 구매 발주(PO) 생성 UI
- ✅ PO 목록 및 상세 조회
- ✅ PO 승인 기능
- ✅ HQ 입고 처리 UI
- ✅ 배치 정보 입력 및 유통기한 자동 계산
- ✅ stock_batches 자동 생성
- ✅ HQ 재고 자동 증가

### 7.2 다음 Phase 준비사항
- Phase 04에서 HQ → 지사 재고 이전 구현
- FIFO 로직 구현 준비 (가장 빠른 유통기한부터 출고)

---

## 8. 작업 이후 체크리스트

- [ ] PO 생성 → 승인 → 입고 전체 프로세스 테스트 완료
- [ ] stock_batches 테이블에 재고 기록 확인
- [ ] 유통기한 자동 계산 정확성 검증
- [ ] GitHub에 코드 푸시
- [ ] Worklog 문서 작성: `003.phase03.구매_발주_및_HQ_입고_처리.md`
- [ ] Phase 04 계획 검토
