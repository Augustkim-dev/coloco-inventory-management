# 024. Phase 15: ì¹´í…Œê³ ë¦¬ ê¸°ë°˜ ê°€ê²© í…œí”Œë¦¿ ì‹œìŠ¤í…œ

## ê°œìš”

### ë¬¸ì œì 
1. í˜„ì¬ ê°€ê²© ì„¤ì •ì€ **ì œí’ˆ Ã— Location** ê°œë³„ ì„¤ì • â†’ ì‹œê°„ ì˜¤ë˜ ê±¸ë¦¼
2. ì œí’ˆ ìˆ˜ ì¦ê°€ ì‹œ ì„¤ì • ì‘ì—…ëŸ‰ì´ ê¸°í•˜ê¸‰ìˆ˜ì ìœ¼ë¡œ ì¦ê°€
3. ì¹´í…Œê³ ë¦¬ë³„ ì¼ê´„ ë§ˆì§„ ì ìš© ê¸°ëŠ¥ ì—†ìŒ

### ëª©í‘œ
1. **ì¹´í…Œê³ ë¦¬ ê¸°ë°˜ í…œí”Œë¦¿**: skincare, makeup ë“± ì¹´í…Œê³ ë¦¬ë³„ ë§ˆì§„ í…œí”Œë¦¿ ìƒì„±
2. **ì¼ê´„ ì ìš©**: í…œí”Œë¦¿ ì„ íƒ â†’ í•´ë‹¹ ì¹´í…Œê³ ë¦¬ ì œí’ˆ ì „ì²´ì— ê°€ê²© ì¼ê´„ ì„¤ì •
3. **ë¯¸ë¦¬ë³´ê¸°**: ì ìš© ì „ ì˜í–¥ë°›ì„ ì œí’ˆ/ê°€ê²© í™•ì¸

---

## í˜„ì¬ ì‹œìŠ¤í…œ ë¶„ì„

### ì¹´í…Œê³ ë¦¬ í˜„í™©
- `products.category`: TEXT ì»¬ëŸ¼ (nullable)
- `lib/constants.ts`ì— 5ê°œ ì •ì˜:
  - skincare, makeup, haircare, bodycare, fragrance
- ë³„ë„ categories í…Œì´ë¸” ì—†ìŒ

### ê°€ê²© ê³„ì‚° ê³µì‹
```
localCost = (purchase_price + transfer_cost) Ã— exchange_rate
finalPrice = localCost / (1 - (hq_margin + branch_margin) / 100)
```

### pricing_configs í…Œì´ë¸” í˜„í™©
- 025_extend_pricing_configs.sqlì—ì„œ `parent_price`, `is_inherited` ì»¬ëŸ¼ ì¶”ê°€ë¨
- ì œí’ˆ-Location ìœ ë‹ˆí¬ ì œì•½ ì¡´ì¬
- RLS ì •ì±… ì™„ë¹„

---

## ì„¤ê³„

### 1. ìƒˆ í…Œì´ë¸”: pricing_templates

```sql
CREATE TABLE public.pricing_templates (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name TEXT NOT NULL,                               -- 'Cosmetic Vietnam Standard'
  description TEXT,                                 -- í…œí”Œë¦¿ ì„¤ëª…

  -- ì ìš© ëŒ€ìƒ í•„í„°
  category TEXT,                                    -- nullable = ì „ì²´ ì¹´í…Œê³ ë¦¬
  target_currency TEXT NOT NULL,                    -- 'VND', 'CNY' (í™˜ìœ¨ ì ìš© ëŒ€ìƒ)

  -- ë§ˆì§„ ì„¤ì •
  hq_margin_percent DECIMAL(5,2) NOT NULL DEFAULT 10,
  branch_margin_percent DECIMAL(5,2) NOT NULL DEFAULT 30,

  -- ë¹„ìš© ì„¤ì •
  default_transfer_cost DECIMAL(12,2) DEFAULT 0,

  -- ë©”íƒ€ë°ì´í„°
  is_active BOOLEAN DEFAULT true,
  created_by UUID REFERENCES auth.users(id),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- ì¸ë±ìŠ¤
CREATE INDEX idx_pricing_templates_category ON pricing_templates(category);
CREATE INDEX idx_pricing_templates_currency ON pricing_templates(target_currency);

-- RLS
ALTER TABLE public.pricing_templates ENABLE ROW LEVEL SECURITY;

CREATE POLICY "HQ Admin full access to templates" ON pricing_templates
  FOR ALL USING (public.get_user_role_from_jwt() = 'HQ_Admin');

CREATE POLICY "All can view active templates" ON pricing_templates
  FOR SELECT USING (is_active = true);
```

### 2. í…œí”Œë¦¿ ì ìš© ë¡œê·¸ í…Œì´ë¸” (ì„ íƒì )

```sql
CREATE TABLE public.pricing_template_applications (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  template_id UUID REFERENCES pricing_templates(id),
  applied_by UUID REFERENCES auth.users(id),
  applied_at TIMESTAMPTZ DEFAULT NOW(),

  -- ì ìš© ë²”ìœ„
  target_location_ids UUID[],
  product_count INTEGER,

  -- ì ìš© ì‹œì  ì„¤ì •ê°’
  exchange_rate DECIMAL(10,4),

  -- ê²°ê³¼
  created_configs INTEGER,
  updated_configs INTEGER
);
```

### 3. API ì„¤ê³„

#### POST /api/pricing/templates
í…œí”Œë¦¿ CRUD

#### POST /api/pricing/templates/apply
í…œí”Œë¦¿ ì¼ê´„ ì ìš©

```typescript
interface ApplyTemplateRequest {
  template_id: string
  target_location_ids: string[]      // ì ìš©í•  Locationë“¤
  product_filter: {
    category?: string               // íŠ¹ì • ì¹´í…Œê³ ë¦¬ë§Œ (í…œí”Œë¦¿ ê¸°ë³¸ê°’ ì‚¬ìš© ì‹œ ìƒëµ)
    product_ids?: string[]          // ë˜ëŠ” íŠ¹ì • ì œí’ˆë“¤ë§Œ
  }
  exchange_rate_id?: string         // í™˜ìœ¨ ID (latest ì‚¬ìš© ì‹œ ìƒëµ)
  action: 'preview' | 'apply'       // ë¯¸ë¦¬ë³´ê¸° ë˜ëŠ” ì‹¤ì œ ì ìš©
}

interface ApplyTemplateResponse {
  success: boolean
  affected_products: number
  created_configs: number
  updated_configs: number
  preview?: Array<{
    product_id: string
    product_sku: string
    product_name: string
    location_id: string
    location_name: string
    purchase_price: number
    calculated_price: number
    final_price: number
    status: 'new' | 'update' | 'skip'
  }>
}
```

### 4. ê°€ê²© ê³„ì‚° ë¡œì§

```typescript
async function calculatePriceFromTemplate(
  template: PricingTemplate,
  product: Product,
  exchangeRate: number
): Promise<number> {
  // 1. ì œí’ˆì˜ ìµœê·¼ êµ¬ë§¤ ê°€ê²© ì¡°íšŒ (POì—ì„œ)
  const purchasePrice = await getLatestPurchasePrice(product.id)

  // 2. ë¡œì»¬ ë¹„ìš© ê³„ì‚°
  const localCost = (purchasePrice + template.default_transfer_cost) * exchangeRate

  // 3. ë§ˆì§„ ì ìš©í•˜ì—¬ ìµœì¢… ê°€ê²© ê³„ì‚°
  const marginFactor = 1 - (template.hq_margin_percent + template.branch_margin_percent) / 100
  const calculatedPrice = localCost / marginFactor

  // 4. ë°˜ì˜¬ë¦¼ (í†µí™”ë³„)
  return roundPrice(calculatedPrice, template.target_currency)
}
```

---

## UI ì„¤ê³„

### 1. í…œí”Œë¦¿ ëª©ë¡ í˜ì´ì§€ (`/pricing/templates`)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Pricing Templates                          [+ New Template] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ Vietnam Skincare Standard                               â”‚ â”‚
â”‚ â”‚ Category: skincare                                      â”‚ â”‚
â”‚ â”‚ Target: VND | HQ: 10% | Branch: 30%                     â”‚ â”‚
â”‚ â”‚ Transfer Cost: 500 KRW                                  â”‚ â”‚
â”‚ â”‚                                                         â”‚ â”‚
â”‚ â”‚ Last applied: 2024-01-15 (23 products)                  â”‚ â”‚
â”‚ â”‚                                    [Edit] [Apply]       â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                             â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ China Makeup Premium                                    â”‚ â”‚
â”‚ â”‚ Category: makeup                                        â”‚ â”‚
â”‚ â”‚ Target: CNY | HQ: 15% | Branch: 35%                     â”‚ â”‚
â”‚ â”‚ Transfer Cost: 1000 KRW                                 â”‚ â”‚
â”‚ â”‚                                                         â”‚ â”‚
â”‚ â”‚ Last applied: Never                                     â”‚ â”‚
â”‚ â”‚                                    [Edit] [Apply]       â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. í…œí”Œë¦¿ ìƒì„±/í¸ì§‘ í¼ (`/pricing/templates/new`)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â† Back to Templates                                         â”‚
â”‚                                                             â”‚
â”‚ Create New Pricing Template                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚ Template Name *                                             â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ Vietnam Skincare Standard                               â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                             â”‚
â”‚ Description                                                 â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ Standard pricing for skincare products in Vietnam      â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                             â”‚
â”‚ Category                                                    â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ â–¼ Skincare                                              â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ â˜ All categories (leave empty to apply to all)             â”‚
â”‚                                                             â”‚
â”‚ Target Currency *                                           â”‚
â”‚ â—‹ VND (Vietnamese Dong)                                     â”‚
â”‚ â—‹ CNY (Chinese Yuan)                                        â”‚
â”‚                                                             â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚                                                             â”‚
â”‚ Margin Settings                                             â”‚
â”‚                                                             â”‚
â”‚ HQ Margin (%)            Branch Margin (%)                  â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚ â”‚ 10.00         â”‚        â”‚ 30.00         â”‚                  â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                                                             â”‚
â”‚ Total Margin: 40.00%                                        â”‚
â”‚                                                             â”‚
â”‚ Default Transfer Cost (KRW)                                 â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ 500                                                     â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                             â”‚
â”‚                              [Cancel]  [Save Template]      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3. í…œí”Œë¦¿ ì ìš© ë‹¤ì´ì–¼ë¡œê·¸

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Apply Template: Vietnam Skincare Standard                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚ Target Locations *                                          â”‚
â”‚ â˜‘ Vietnam (Branch)                                          â”‚
â”‚   â˜‘ Ho Chi Minh (SubBranch)                                 â”‚
â”‚   â˜‘ Vung Tau (SubBranch)                                    â”‚
â”‚   â˜‘ Hanoi (SubBranch)                                       â”‚
â”‚ â˜ China (Branch)                                            â”‚
â”‚                                                             â”‚
â”‚ Products to Apply                                           â”‚
â”‚ â— All skincare products (15 products)                       â”‚
â”‚ â—‹ Select specific products                                  â”‚
â”‚                                                             â”‚
â”‚ Exchange Rate                                               â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ â–¼ Latest: 1 KRW = 18.5000 VND (2024-01-20)              â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                             â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚                                                             â”‚
â”‚ Preview (15 products Ã— 4 locations = 60 configs)            â”‚
â”‚                                                             â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ Product       â”‚ Location      â”‚ Price       â”‚ Status  â”‚   â”‚
â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚ â”‚ SKU001        â”‚ Vietnam       â”‚ 165,000 VND â”‚ Update  â”‚   â”‚
â”‚ â”‚ Hydra Serum   â”‚               â”‚             â”‚         â”‚   â”‚
â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚ â”‚ SKU001        â”‚ Ho Chi Minh   â”‚ 165,000 VND â”‚ New     â”‚   â”‚
â”‚ â”‚ Hydra Serum   â”‚               â”‚ (ìƒì†)       â”‚         â”‚   â”‚
â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚ â”‚ SKU002        â”‚ Vietnam       â”‚ 220,000 VND â”‚ Update  â”‚   â”‚
â”‚ â”‚ Moisture Crm  â”‚               â”‚             â”‚         â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â”‚ Summary:                                                    â”‚
â”‚ - New configs: 45                                           â”‚
â”‚ - Updated configs: 15                                       â”‚
â”‚ - Skipped (no purchase price): 0                            â”‚
â”‚                                                             â”‚
â”‚                         [Cancel]  [Apply 60 Configurations] â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4. Pricing ë©”ì¸ í˜ì´ì§€ì— í…œí”Œë¦¿ ë°”ë¡œê°€ê¸° ì¶”ê°€

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Pricing Configurations                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚ â”‚ ğŸ“‹ Templates      â”‚  â”‚ â• Add Individual â”‚                â”‚
â”‚ â”‚ Bulk apply prices â”‚  â”‚ Set single price  â”‚                â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚                                                             â”‚
â”‚ ... (ê¸°ì¡´ ê°€ê²© ì„¤ì • ëª©ë¡)                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## êµ¬í˜„ ë‹¨ê³„

### Step 1: ë°ì´í„°ë² ì´ìŠ¤ ë§ˆì´ê·¸ë ˆì´ì…˜

**íŒŒì¼:** `supabase/migrations/030_create_pricing_templates.sql`

- pricing_templates í…Œì´ë¸” ìƒì„±
- pricing_template_applications í…Œì´ë¸” ìƒì„± (ì„ íƒì )
- RLS ì •ì±… ì„¤ì •
- ì¸ë±ìŠ¤ ìƒì„±

### Step 2: íƒ€ì… ì •ì˜

**íŒŒì¼:** `types/index.ts`

```typescript
// Pricing Template Types
export interface PricingTemplate {
  id: string
  name: string
  description: string | null
  category: string | null
  target_currency: Currency
  hq_margin_percent: number
  branch_margin_percent: number
  default_transfer_cost: number
  is_active: boolean
  created_by: string | null
  created_at: string
  updated_at: string
}

export interface PricingTemplateInsert {
  name: string
  description?: string
  category?: string
  target_currency: Currency
  hq_margin_percent: number
  branch_margin_percent: number
  default_transfer_cost?: number
}

export interface TemplateApplyPreview {
  product_id: string
  product_sku: string
  product_name: string
  location_id: string
  location_name: string
  purchase_price: number
  calculated_price: number
  final_price: number
  status: 'new' | 'update' | 'skip'
}
```

### Step 3: API êµ¬í˜„

**íŒŒì¼:** `app/api/pricing/templates/route.ts`
- GET: í…œí”Œë¦¿ ëª©ë¡ ì¡°íšŒ
- POST: í…œí”Œë¦¿ ìƒì„±

**íŒŒì¼:** `app/api/pricing/templates/[id]/route.ts`
- GET: ë‹¨ì¼ í…œí”Œë¦¿ ì¡°íšŒ
- PUT: í…œí”Œë¦¿ ìˆ˜ì •
- DELETE: í…œí”Œë¦¿ ì‚­ì œ

**íŒŒì¼:** `app/api/pricing/templates/apply/route.ts`
- POST: í…œí”Œë¦¿ ì ìš© (preview/apply ëª¨ë“œ)

### Step 4: UI ì»´í¬ë„ŒíŠ¸

**íŒŒì¼:** `components/pricing/template-card.tsx`
- í…œí”Œë¦¿ ì¹´ë“œ ì»´í¬ë„ŒíŠ¸

**íŒŒì¼:** `components/pricing/template-form.tsx`
- í…œí”Œë¦¿ ìƒì„±/ìˆ˜ì • í¼

**íŒŒì¼:** `components/pricing/apply-template-dialog.tsx`
- í…œí”Œë¦¿ ì ìš© ë‹¤ì´ì–¼ë¡œê·¸
- Location ì„ íƒ
- ì œí’ˆ í•„í„°
- í™˜ìœ¨ ì„ íƒ
- ë¯¸ë¦¬ë³´ê¸° í…Œì´ë¸”

### Step 5: í˜ì´ì§€ êµ¬í˜„

**íŒŒì¼:** `app/(dashboard)/pricing/templates/page.tsx`
- í…œí”Œë¦¿ ëª©ë¡ í˜ì´ì§€

**íŒŒì¼:** `app/(dashboard)/pricing/templates/new/page.tsx`
- í…œí”Œë¦¿ ìƒì„± í˜ì´ì§€

**íŒŒì¼:** `app/(dashboard)/pricing/templates/[id]/edit/page.tsx`
- í…œí”Œë¦¿ ìˆ˜ì • í˜ì´ì§€

### Step 6: ê¸°ì¡´ Pricing í˜ì´ì§€ ì—°ë™

**íŒŒì¼:** `app/(dashboard)/pricing/page.tsx`
- í…œí”Œë¦¿ ë°”ë¡œê°€ê¸° ë²„íŠ¼ ì¶”ê°€
- í…œí”Œë¦¿ìœ¼ë¡œ ìƒì„±ëœ ê°€ê²© í‘œì‹œ (ì„ íƒì )

### Step 7: ë„¤ë¹„ê²Œì´ì…˜ ì—…ë°ì´íŠ¸

**íŒŒì¼:** `lib/constants.ts`
- í…œí”Œë¦¿ ê´€ë ¨ ìƒìˆ˜ ì¶”ê°€

---

## ìˆ˜ì • íŒŒì¼ ëª©ë¡

| ìˆœì„œ | íŒŒì¼ | ë³€ê²½ ë‚´ìš© | ì‹ ê·œ |
|------|------|----------|------|
| 1 | `supabase/migrations/030_create_pricing_templates.sql` | í…Œì´ë¸” ë° RLS | âœ“ |
| 2 | `types/index.ts` | PricingTemplate íƒ€ì… ì¶”ê°€ | |
| 3 | `lib/constants.ts` | í…œí”Œë¦¿ ê´€ë ¨ ìƒìˆ˜ | |
| 4 | `app/api/pricing/templates/route.ts` | í…œí”Œë¦¿ CRUD API | âœ“ |
| 5 | `app/api/pricing/templates/[id]/route.ts` | ë‹¨ì¼ í…œí”Œë¦¿ API | âœ“ |
| 6 | `app/api/pricing/templates/apply/route.ts` | í…œí”Œë¦¿ ì ìš© API | âœ“ |
| 7 | `components/pricing/template-card.tsx` | í…œí”Œë¦¿ ì¹´ë“œ | âœ“ |
| 8 | `components/pricing/template-form.tsx` | í…œí”Œë¦¿ í¼ | âœ“ |
| 9 | `components/pricing/apply-template-dialog.tsx` | ì ìš© ë‹¤ì´ì–¼ë¡œê·¸ | âœ“ |
| 10 | `app/(dashboard)/pricing/templates/page.tsx` | í…œí”Œë¦¿ ëª©ë¡ | âœ“ |
| 11 | `app/(dashboard)/pricing/templates/new/page.tsx` | í…œí”Œë¦¿ ìƒì„± | âœ“ |
| 12 | `app/(dashboard)/pricing/templates/[id]/edit/page.tsx` | í…œí”Œë¦¿ ìˆ˜ì • | âœ“ |
| 13 | `app/(dashboard)/pricing/page.tsx` | í…œí”Œë¦¿ ë°”ë¡œê°€ê¸° ì¶”ê°€ | |

---

## ì˜ˆìƒ ì‹œë‚˜ë¦¬ì˜¤

### HQ Admin ì‘ì—… íë¦„

1. `/pricing/templates` â†’ "New Template" í´ë¦­
2. í…œí”Œë¦¿ ì •ë³´ ì…ë ¥:
   - Name: "Vietnam Skincare Standard"
   - Category: skincare
   - Target Currency: VND
   - HQ Margin: 10%, Branch Margin: 30%
   - Transfer Cost: 500 KRW
3. ì €ì¥ â†’ í…œí”Œë¦¿ ëª©ë¡ì— í‘œì‹œ

4. "Apply" í´ë¦­ â†’ ì ìš© ë‹¤ì´ì–¼ë¡œê·¸ ì—´ë¦¼
5. Location ì„ íƒ: Vietnam + Ho Chi Minh + Vung Tau
6. í™˜ìœ¨ ì„ íƒ: Latest (1 KRW = 18.5 VND)
7. "Preview" â†’ ì ìš©ë  ê°€ê²© ëª©ë¡ í™•ì¸
8. "Apply" â†’ pricing_configsì— ì¼ê´„ ìƒì„±/ì—…ë°ì´íŠ¸
9. ì™„ë£Œ í† ìŠ¤íŠ¸: "60 pricing configurations applied successfully"

### ê°€ê²© ê³„ì‚° ì˜ˆì‹œ

```
ì œí’ˆ: SKU001 (Hydra Serum)
- ìµœê·¼ êµ¬ë§¤ê°€: 5,000 KRW
- ì´ì†¡ë¹„: 500 KRW
- í™˜ìœ¨: 1 KRW = 18.5 VND
- HQ ë§ˆì§„: 10%
- Branch ë§ˆì§„: 30%

ê³„ì‚°:
1. ë¡œì»¬ ë¹„ìš© = (5,000 + 500) Ã— 18.5 = 101,750 VND
2. ë§ˆì§„ ê³„ìˆ˜ = 1 - (10 + 30) / 100 = 0.6
3. ê³„ì‚° ê°€ê²© = 101,750 / 0.6 = 169,583.33 VND
4. ë°˜ì˜¬ë¦¼ = 170,000 VND (1,000 ë‹¨ìœ„)
```

---

## ê¸°ìˆ ì  ê³ ë ¤ì‚¬í•­

### 1. ì„±ëŠ¥
- ì¼ê´„ ì ìš© ì‹œ íŠ¸ëœì­ì…˜ ì‚¬ìš©
- ëŒ€ëŸ‰ INSERT/UPDATE ì‹œ ë°°ì¹˜ ì²˜ë¦¬ (100ê°œ ë‹¨ìœ„)
- ë¯¸ë¦¬ë³´ê¸°ëŠ” ë³„ë„ ì¿¼ë¦¬ë¡œ ì²˜ë¦¬ (ì‹¤ì œ ë°ì´í„° ë³€ê²½ ì—†ìŒ)

### 2. ë°ì´í„° ì •í•©ì„±
- í…œí”Œë¦¿ ì‚­ì œ ì‹œ ì ìš©ëœ ê°€ê²©ì€ ìœ ì§€ (soft delete)
- í™˜ìœ¨ ë³€ê²½ ì‹œ ìë™ ì¬ì ìš© ì—†ìŒ (ìˆ˜ë™ ì¬ì ìš© í•„ìš”)

### 3. ê¶Œí•œ
- í…œí”Œë¦¿ CRUD: HQ_Adminë§Œ
- í…œí”Œë¦¿ ì ìš©: HQ_Adminë§Œ
- í…œí”Œë¦¿ ì¡°íšŒ: ëª¨ë“  ì‚¬ìš©ì (í™œì„±í™”ëœ í…œí”Œë¦¿ë§Œ)

### 4. ë°˜ì˜¬ë¦¼ ê·œì¹™
- VND: 1,000 ë‹¨ìœ„ ë°˜ì˜¬ë¦¼ (ì˜ˆ: 169,583 â†’ 170,000)
- CNY: 0.01 ë‹¨ìœ„ ë°˜ì˜¬ë¦¼ (ì˜ˆ: 85.127 â†’ 85.13)
- KRW: 100 ë‹¨ìœ„ ë°˜ì˜¬ë¦¼ (ì˜ˆ: 16,583 â†’ 16,600)

### 5. ì—ëŸ¬ ì²˜ë¦¬
- êµ¬ë§¤ ê°€ê²© ì—†ëŠ” ì œí’ˆ: skip ì²˜ë¦¬ (warning í‘œì‹œ)
- í™˜ìœ¨ ì—†ìŒ: ì ìš© ë¶ˆê°€ (error)
- ì¤‘ë³µ í…œí”Œë¦¿ ì´ë¦„: í—ˆìš© (IDë¡œ êµ¬ë¶„)

---

## Phase 3ê³¼ì˜ ì—°ê³„

Phase 3ì—ì„œ êµ¬í˜„í•œ ë¶€ëª¨ ê°€ê²© ìƒì† ê¸°ëŠ¥ê³¼ ì—°ê³„:
- í…œí”Œë¦¿ ì ìš© ì‹œ Branchì—ë§Œ ê°€ê²© ì„¤ì •
- Sub-BranchëŠ” ìë™ìœ¼ë¡œ ë¶€ëª¨ ê°€ê²© ìƒì† (Phase 3 ë¡œì§ í™œìš©)
- í•„ìš”ì‹œ Sub-Branchì—ë„ ì§ì ‘ ì ìš© ê°€ëŠ¥ (ì˜µì…˜)

---

## í–¥í›„ í™•ì¥ ê°€ëŠ¥ì„±

1. **ìŠ¤ì¼€ì¤„ë§**: í™˜ìœ¨ ë³€ê²½ ì‹œ ìë™ ì¬ì ìš©
2. **íˆìŠ¤í† ë¦¬**: ì ìš© ì´ë ¥ ë° ë¡¤ë°± ê¸°ëŠ¥
3. **ë¹„êµ**: í…œí”Œë¦¿ ê°„ ê°€ê²© ë¹„êµ ê¸°ëŠ¥
4. **ì•Œë¦¼**: ë§ˆì§„ ì´ìƒì¹˜ ê²½ê³ 
5. **Excel ë‚´ë³´ë‚´ê¸°**: ì ìš© ê²°ê³¼ ë‹¤ìš´ë¡œë“œ
