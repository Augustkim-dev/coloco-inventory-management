# Phase 17: 한국 브랜치 판매 기능 추가

## 개요

한국 HQ에서도 직접 판매할 수 있도록 Korea Branch와 5개 Sub-branch를 추가합니다.

## 배경

- 기존 시스템은 HQ에서 물건을 입고하고 해외 Branch(Vietnam, China)에 전송하는 역할만 수행
- 한국 내에서도 직접 판매가 필요해짐
- 판매 채널(Naver, Coupang, Instagram)과 오프라인 지역(Seoul, Busan)을 Sub-branch로 관리

## 요구사항

1. **구조**: Korea Branch (HQ 하위) + 5개 Sub-branch
2. **가격 정책**: Parent 가격 상속, 구매가 + 마진만 (환율=1, 이전비용=0)
3. **역할**: Branch_Manager 계정을 Korea Branch에 할당

## 변경 후 Location 계층 구조

```
Korea HQ (Level 1, HQ)
├── Korea (Level 2, Branch) ← 신규
│   ├── Naver (Level 3, SubBranch) - 온라인 채널
│   ├── Coupang (Level 3, SubBranch) - 온라인 채널
│   ├── Instagram (Level 3, SubBranch) - SNS 채널
│   ├── Seoul (Level 3, SubBranch) - 오프라인 지역
│   └── Busan (Level 3, SubBranch) - 오프라인 지역
├── Vietnam (Level 2, Branch)
│   ├── Ho Chi Minh (SubBranch)
│   ├── Vung Tau (SubBranch)
│   └── Hanoi (SubBranch)
└── China (Level 2, Branch)
    ├── Wei Hai (SubBranch)
    └── Guangzhou (SubBranch)
```

## 구현 계획

### Phase 1: 데이터베이스 마이그레이션

**파일**: `supabase/migrations/032_add_korea_branch_hierarchy.sql`

1. KRW → KRW 환율 추가 (rate = 1)
2. Korea Branch 레코드 추가
3. 5개 Sub-branch 레코드 추가 (Naver, Coupang, Instagram, Seoul, Busan)

### Phase 2: UI 수정

**파일**: `components/exchange-rates/exchange-rate-selector.tsx`

- 동일 통화(KRW→KRW)일 때 API 호출 없이 자동으로 환율 1 설정

### Phase 3: 운영 작업

1. Korea Branch Manager 계정 생성 (Supabase Auth)
2. Branch_Manager 역할 할당 및 Korea Branch에 연결
3. 제품별 Korea Branch 가격 설정

## 수정 파일 목록

| 파일 | 작업 유형 | 설명 |
|------|----------|------|
| `supabase/migrations/032_add_korea_branch_hierarchy.sql` | 신규 | Korea Branch + 5 Sub-branches + KRW 환율 |
| `components/exchange-rates/exchange-rate-selector.tsx` | 수정 | 동일 통화 자동 처리 |

## 기존 시스템 활용 (수정 불필요)

- **Transfer API**: parent-child 이전 자동 지원
- **Sales API/Form**: location 기반 동작
- **Pricing Form**: Branch 타입 location 자동 표시
- **가격 상속**: Sub-branch는 parent 가격 자동 상속
- **RLS 정책**: Branch_Manager 권한 완비

## 가격 계산 예시

```
Korea Branch 판매가 계산:

입력:
- purchase_price = 5,000 KRW (구매가)
- transfer_cost = 0 (이전비용 없음)
- exchange_rate = 1 (KRW→KRW)
- branch_margin = 30%

계산:
1. local_cost = (5,000 + 0) * 1 = 5,000 KRW
2. selling_price = 5,000 / (1 - 0.30) = 7,142.86 KRW
3. final_price = 7,100 KRW (100단위 반올림)
```

## 테스트 체크리스트

- [ ] Korea Branch가 location 목록에 표시되는가
- [ ] 5개 Sub-branch가 Korea Branch 하위에 표시되는가
- [ ] HQ → Korea Branch 재고 이전 가능한가
- [ ] Korea Branch → Sub-branch 재고 이전 가능한가
- [ ] KRW→KRW 환율이 자동으로 1로 설정되는가
- [ ] Korea Branch용 pricing_config 생성 가능한가
- [ ] Korea Branch Manager가 판매 기록 생성 가능한가
- [ ] Sub-branch에서 Korea Branch 가격 상속되는가
