# Phase 13: 계층적 Sub-Branch 시스템 구현 계획

## 개요
기존 2단계 구조(HQ → Branch)를 무제한 계층 구조(HQ → Branch → Sub-Branch → Sub-Sub-Branch...)로 확장하여, 각 Branch가 하위 지점을 생성하고 재고를 분배할 수 있는 시스템 구현

## 핵심 요구사항 정리

### 1. 계층 구조
- **무제한 깊이**: HQ → Vietnam → Ho Chi Minh → District 1 → Store A (5단계 이상 가능)
- **역방향 이동 가능**: Sub-Branch → Parent Branch (반품/재배치)
- **직접 이동 불가**: HQ는 Sub-Branch로 직접 이동 불가 (Parent를 거쳐야 함)
- **형제 간 이동 불가**: Sub-Branch ↔ Sub-Branch (Parent 경유 필수)

### 2. 가격 설정
- **연쇄적 마진 계산**: HQ 원가 → Vietnam 마진 → Ho Chi Minh 마진 (누적)
- **개별 마진 설정**: 각 Sub-Branch마다 다른 마진율 적용 가능
- **가격 상속**: Parent의 가격을 기반으로 Sub-Branch 가격 자동 계산

### 3. 권한 체계
- **HQ Admin**: 모든 Branch/Sub-Branch 관리, 생성, 이동, 가격 설정
- **Branch Manager**:
  - 자신의 Branch + 모든 하위 Sub-Branch 관리
  - Sub-Branch 생성 가능
  - 자신의 Branch에서 직접 판매 가능
  - 하위 지점으로 재고 이동 가능
  - 상위 Branch 재고 조회 가능 (읽기 전용)
- **Sub-Branch Manager**:
  - 자신의 Sub-Branch 재고만 관리
  - 판매 입력 가능
  - Parent Branch 재고 조회 가능
  - 재고 이동 요청 가능 (승인 필요 또는 알림)

### 4. 재고 가시성
- 하위 지점은 상위 지점 재고 조회 가능 (읽기 전용)
- 이동 요청 기능 제공 (알림/승인 시스템)

### 5. 대시보드
- Parent Branch 재고 = 본사 재고만 표시
- Sub-Branch 재고 별도 표시
- 계층 구조 시각화 (트리뷰)

---

## Location 구조 (최종)

```
HQ (Korea) - Level 1
├── Vietnam - Level 2
│   ├── Ho Chi Minh - Level 3
│   ├── Vung Tau - Level 3
│   └── Hanoi - Level 3
└── China - Level 2
    ├── Wei Hai - Level 3
    └── Guangzhou - Level 3
```

---

## 구현 계획

### **Step 1: 데이터베이스 스키마 변경**

#### 1.1 Locations 테이블 확장
```sql
ALTER TABLE public.locations
  ADD COLUMN parent_id UUID REFERENCES public.locations(id) ON DELETE CASCADE,
  ADD COLUMN level INTEGER NOT NULL DEFAULT 1,
  ADD COLUMN path TEXT, -- Materialized path: '/HQ/Vietnam/Ho_Chi_Minh'
  ADD COLUMN is_active BOOLEAN DEFAULT true;

-- 인덱스 추가
CREATE INDEX idx_locations_parent_id ON public.locations(parent_id);
CREATE INDEX idx_locations_level ON public.locations(level);
CREATE INDEX idx_locations_path ON public.locations(path);
```

#### 1.2 Location Type 제약 조건 제거
- 'HQ', 'Branch', 'SubBranch' 고정 타입 제거
- `level` 기반 계층 관리 (level 1 = HQ, level 2+ = Branch/SubBranch)

#### 1.3 Pricing Configs 테이블 수정
```sql
-- from_location_id가 항상 HQ라는 제약 제거
-- 이제 Branch → SubBranch 가격도 저장 가능
-- parent_price 컬럼 추가하여 상위 지점 가격 추적
ALTER TABLE public.pricing_configs
  ADD COLUMN parent_price DECIMAL(12, 2),
  ADD COLUMN is_inherited BOOLEAN DEFAULT false;
```

#### 1.4 Stock Transfer Request 테이블 생성 (신규)
```sql
CREATE TABLE public.stock_transfer_requests (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  requested_by UUID REFERENCES public.users(id),
  from_location_id UUID REFERENCES public.locations(id),
  to_location_id UUID REFERENCES public.locations(id),
  product_id UUID REFERENCES public.products(id),
  requested_qty INTEGER NOT NULL,
  status TEXT CHECK (status IN ('Pending', 'Approved', 'Rejected', 'Completed')),
  notes TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW()
);
```

---

### **Step 2: 백엔드 API 개발**

#### 2.1 Location Hierarchy API
```typescript
// GET /api/locations/tree
// 전체 계층 구조 반환 (HQ 기준)

// GET /api/locations/:id/children
// 특정 Location의 직속 하위 지점만 반환

// GET /api/locations/:id/ancestors
// 특정 Location의 상위 계층 경로 반환 (breadcrumb용)

// POST /api/locations/create-child
// parent_id 기반 하위 지점 생성
// 권한: HQ_Admin 또는 Parent의 Branch_Manager

// PUT /api/locations/:id/move
// Location을 다른 Parent 아래로 이동
// 재고가 있으면 이동 불가 (안전장치)
```

#### 2.2 Stock Transfer API 수정
```typescript
// POST /api/inventory/transfer
// 기존 로직 확장:
// 1. HQ → Branch (기존)
// 2. Branch → SubBranch (parent-child 검증)
// 3. SubBranch → Branch (역방향, parent-child 검증)
// 4. HQ → SubBranch 차단 (에러 반환)
// 5. SubBranch ↔ SubBranch 차단 (에러 반환)

// 권한 검증 로직:
// - HQ_Admin: 모든 이동 가능
// - Branch_Manager: 자신의 Location → 하위 지점만 가능
// - Sub-Branch_Manager: 이동 불가 (요청만 가능)
```

#### 2.3 Transfer Request API (신규)
```typescript
// POST /api/inventory/transfer-request
// Sub-Branch Manager가 재고 이동 요청 생성

// GET /api/inventory/transfer-requests
// 본인이 관리하는 Location으로 들어온 요청 목록

// POST /api/inventory/transfer-requests/:id/approve
// Branch Manager가 요청 승인 → 실제 transfer 실행

// POST /api/inventory/transfer-requests/:id/reject
// 요청 거부
```

#### 2.4 Pricing API 확장
```typescript
// POST /api/pricing/calculate-cascade
// Input: product_id, location_id, margin_percent
// Output:
//   - parent_price (상위 지점 가격)
//   - calculated_price (마진 적용 가격)
//   - suggested_final_price (반올림된 가격)
//   - pricing_chain (HQ → Branch → SubBranch 가격 체인)

// GET /api/pricing/:productId/chain/:locationId
// 특정 제품의 전체 가격 체인 조회
// 예: HQ 5000원 → Vietnam 90000 VND → Ho Chi Minh 120000 VND
```

#### 2.5 RLS 정책 수정
```sql
-- stock_batches SELECT 정책
-- Branch Manager는 자신의 Location + 모든 하위 지점 재고 조회 가능
CREATE POLICY stock_batches_select_hierarchy ON stock_batches
FOR SELECT USING (
  auth.uid() IN (
    SELECT id FROM users WHERE role = 'HQ_Admin'
  )
  OR
  location_id IN (
    -- 재귀 CTE로 자신 + 하위 지점 ID 목록 반환
    WITH RECURSIVE children AS (...)
  )
);
```

---

### **Step 3: 프론트엔드 UI 개발**

#### 3.1 Hierarchical Location Selector 컴포넌트
```typescript
// components/locations/location-tree-select.tsx
// - Recursive rendering으로 트리 구조 표시
// - Indentation으로 계층 표현
// - 접기/펼치기 기능
// - 권한에 따라 선택 가능한 Location 필터링
```

#### 3.2 Location Management 페이지 개선
```typescript
// app/(dashboard)/locations/page.tsx
// - 기존 flat list를 tree view로 변경
// - Drag-and-drop으로 순서 변경 (같은 level 내에서만)
// - "Add Child Location" 버튼 (각 Location 옆에)
// - Breadcrumb으로 현재 위치 표시
// - 계층 구조 시각화 (들여쓰기 또는 트리 아이콘)
```

#### 3.3 Transfer Form 대폭 수정
```typescript
// components/inventory/transfer-form.tsx
// 1. Source Location 선택기 추가
//    - HQ_Admin: 모든 Location 선택 가능
//    - Branch_Manager: 자신의 Location만 선택 가능
// 2. Destination Location 동적 필터링
//    - Source 선택 시, 유효한 대상만 표시
//    - Parent → Child만 허용 (또는 Child → Parent)
// 3. 재고 조회 로직 수정
//    - 선택된 Source의 재고만 조회
// 4. 에러 메시지 개선
//    - "HQ에서 Sub-Branch로 직접 이동 불가" 등
```

#### 3.4 Transfer Request UI (신규)
```typescript
// components/inventory/transfer-request-form.tsx
// Sub-Branch Manager가 사용하는 요청 폼

// components/inventory/transfer-request-list.tsx
// Branch Manager가 승인/거부하는 요청 목록

// app/(dashboard)/transfer-requests/page.tsx
// 요청 관리 전용 페이지
```

#### 3.5 Pricing Configuration UI 개선
```typescript
// components/pricing/pricing-form.tsx
// 1. Source Location 선택 (Parent의 가격 가져오기)
// 2. Parent Price 자동 조회 및 표시 (읽기 전용)
// 3. Margin 입력 → Calculated Price 자동 계산
// 4. Price Chain 표시
//    예: HQ 5,000 → Vietnam 90,000 → Ho Chi Minh 120,000
// 5. "Inherit from Parent" 체크박스 (마진만 설정)
```

#### 3.6 Inventory Dashboard 개선
```typescript
// components/dashboard/inventory-summary.tsx
// 1. Location별 재고를 계층 구조로 표시
// 2. Expandable rows (Parent 클릭 시 Children 표시)
// 3. "Total" vs "Own Stock" 구분
//    - Own Stock: 해당 지점 본사 재고만
//    - Total: Own + 모든 하위 지점 합계 (옵션)
```

#### 3.7 Inventory Kanban View 수정
```typescript
// components/inventory/inventory-view.tsx
// 1. Location 카드를 계층 구조로 그룹화
// 2. Parent 카드 내에 Children 카드 표시 (nested)
// 3. 또는 Tabs로 구분 (Vietnam → Ho Chi Minh, Vung Tau, Hanoi 탭)
```

---

### **Step 4: 유틸리티 함수 및 헬퍼**

#### 4.1 Location Hierarchy 헬퍼
```typescript
// lib/hierarchy-utils.ts

export function buildLocationTree(locations: Location[]): TreeNode[]
// Flat array를 Tree structure로 변환

export function getAncestors(locationId: string, locations: Location[]): Location[]
// 상위 계층 경로 반환 (breadcrumb용)

export function getDescendants(locationId: string, locations: Location[]): Location[]
// 하위 모든 지점 반환 (재귀)

export function canTransferBetween(from: Location, to: Location): boolean
// 유효한 이동인지 검증 (Parent-Child 관계)

export function getLocationLevel(location: Location): number
// 계층 깊이 계산

export function buildMaterializedPath(location: Location, locations: Location[]): string
// '/HQ/Vietnam/Ho_Chi_Minh' 형식의 경로 생성
```

#### 4.2 Pricing Chain 헬퍼
```typescript
// lib/pricing-chain.ts

export function calculateCascadePrice(
  baseCost: number,
  marginChain: number[], // [10, 20, 15] (각 단계 마진)
  exchangeRates: number[] // [1, 18, 18] (환율)
): PriceChain[]
// 단계별 가격 계산

export function getPricingChain(
  productId: string,
  locationId: string
): Promise<PriceNode[]>
// HQ부터 해당 Location까지의 가격 체인 조회
```

---

### **Step 5: 데이터 마이그레이션**

#### 5.1 기존 데이터 삭제
- 모든 sales, stock_batches, pricing_configs 삭제
- 기존 locations, users 삭제
- 깨끗한 상태에서 시작 (요구사항 반영)

#### 5.2 Seed 데이터 재생성

**Location 데이터:**
```sql
-- 1. HQ (Korea) - level 1, parent_id = NULL
INSERT INTO locations (name, location_type, country_code, currency, level, parent_id, path, display_order)
VALUES ('Korea HQ', 'HQ', 'KR', 'KRW', 1, NULL, '/HQ', 1);

-- 2. Vietnam Branch - level 2
INSERT INTO locations (name, location_type, country_code, currency, level, parent_id, path, display_order)
VALUES ('Vietnam', 'Branch', 'VN', 'VND', 2, [HQ_ID], '/HQ/Vietnam', 2);

--   2.1 Ho Chi Minh Sub-Branch - level 3
INSERT INTO locations (name, location_type, country_code, currency, level, parent_id, path, display_order)
VALUES ('Ho Chi Minh', 'SubBranch', 'VN', 'VND', 3, [Vietnam_ID], '/HQ/Vietnam/Ho_Chi_Minh', 3);

--   2.2 Vung Tau Sub-Branch - level 3
INSERT INTO locations (name, location_type, country_code, currency, level, parent_id, path, display_order)
VALUES ('Vung Tau', 'SubBranch', 'VN', 'VND', 3, [Vietnam_ID], '/HQ/Vietnam/Vung_Tau', 4);

--   2.3 Hanoi Sub-Branch - level 3
INSERT INTO locations (name, location_type, country_code, currency, level, parent_id, path, display_order)
VALUES ('Hanoi', 'SubBranch', 'VN', 'VND', 3, [Vietnam_ID], '/HQ/Vietnam/Hanoi', 5);

-- 3. China Branch - level 2
INSERT INTO locations (name, location_type, country_code, currency, level, parent_id, path, display_order)
VALUES ('China', 'Branch', 'CN', 'CNY', 2, [HQ_ID], '/HQ/China', 6);

--   3.1 Wei Hai Sub-Branch - level 3
INSERT INTO locations (name, location_type, country_code, currency, level, parent_id, path, display_order)
VALUES ('Wei Hai', 'SubBranch', 'CN', 'CNY', 3, [China_ID], '/HQ/China/Wei_Hai', 7);

--   3.2 Guangzhou Sub-Branch - level 3
INSERT INTO locations (name, location_type, country_code, currency, level, parent_id, path, display_order)
VALUES ('Guangzhou', 'SubBranch', 'CN', 'CNY', 3, [China_ID], '/HQ/China/Guangzhou', 8);
```

**사용자 예시:**
```sql
-- HQ Admin (모든 권한)
INSERT INTO users (email, name, role, location_id)
VALUES ('admin@hq.com', 'HQ Admin', 'HQ_Admin', [HQ_ID]);

-- Vietnam Branch Manager (Vietnam + 모든 Sub-Branch 관리)
INSERT INTO users (email, name, role, location_id)
VALUES ('manager@vietnam.com', 'Vietnam Manager', 'Branch_Manager', [Vietnam_ID]);

-- Ho Chi Minh Sub-Branch Manager (Ho Chi Minh만 관리)
INSERT INTO users (email, name, role, location_id)
VALUES ('manager@hcm.com', 'HCM Manager', 'SubBranch_Manager', [HCM_ID]);

-- Vung Tau Sub-Branch Manager
INSERT INTO users (email, name, role, location_id)
VALUES ('manager@vungtau.com', 'Vung Tau Manager', 'SubBranch_Manager', [VungTau_ID]);

-- Hanoi Sub-Branch Manager
INSERT INTO users (email, name, role, location_id)
VALUES ('manager@hanoi.com', 'Hanoi Manager', 'SubBranch_Manager', [Hanoi_ID]);

-- China Branch Manager (China + Wei Hai + Guangzhou 관리)
INSERT INTO users (email, name, role, location_id)
VALUES ('manager@china.com', 'China Manager', 'Branch_Manager', [China_ID]);

-- Wei Hai Sub-Branch Manager
INSERT INTO users (email, name, role, location_id)
VALUES ('manager@weihai.com', 'Wei Hai Manager', 'SubBranch_Manager', [WeiHai_ID]);

-- Guangzhou Sub-Branch Manager
INSERT INTO users (email, name, role, location_id)
VALUES ('manager@guangzhou.com', 'Guangzhou Manager', 'SubBranch_Manager', [Guangzhou_ID]);
```

---

### **Step 6: 테스트 시나리오**

#### 6.1 계층 생성 테스트
1. HQ Admin이 Vietnam Branch 생성
2. Vietnam Manager가 Ho Chi Minh Sub-Branch 생성
3. HQ Admin이 Ho Chi Minh 하위에 District 1 생성 (4단계)

#### 6.2 재고 이동 테스트
1. HQ → Vietnam 이동 (성공)
2. Vietnam → Ho Chi Minh 이동 (성공)
3. HQ → Ho Chi Minh 직접 이동 (실패, 에러 메시지 확인)
4. Ho Chi Minh → Vung Tau 이동 (실패, Parent 경유 필요)
5. Ho Chi Minh → Vietnam 역방향 이동 (성공)

#### 6.3 가격 설정 테스트
1. HQ에서 제품 A 원가 5,000 KRW 설정
2. Vietnam에서 마진 30% 설정 → 93,000 VND 계산 확인
3. Ho Chi Minh에서 마진 20% 추가 설정 → 116,000 VND 계산 확인
4. Price Chain 표시 확인: HQ 5,000 → VN 93,000 → HCM 116,000

#### 6.4 권한 테스트
1. Vietnam Manager가 Ho Chi Minh, Vung Tau, Hanoi 재고 조회 (성공)
2. Ho Chi Minh Manager가 Vietnam 재고 조회 (성공, 읽기 전용)
3. Ho Chi Minh Manager가 Vung Tau 재고 조회 (실패, 권한 없음)
4. Ho Chi Minh Manager가 재고 이동 시도 (실패) → 요청 생성 (성공)
5. Vietnam Manager가 요청 승인 → 이동 실행 (성공)

#### 6.5 대시보드 테스트
1. HQ Admin 로그인 → 모든 Location 재고 트리뷰로 표시
2. Vietnam Manager 로그인 → Vietnam + Ho Chi Minh + Vung Tau + Hanoi만 표시
3. Ho Chi Minh Manager 로그인 → Ho Chi Minh만 표시, Vietnam 재고는 조회만

---

### **Step 7: 문서화**

#### 7.1 업데이트할 문서
- `CLAUDE.md`: 계층 구조 설명 추가, 새로운 권한 모델 반영
- `docs/database_design/location_hierarchy.md` (신규 작성)
- API 문서 업데이트 (계층 관련 엔드포인트)

#### 7.2 사용자 매뉴얼
- Sub-Branch 생성 가이드
- 재고 이동 가이드 (유효한 경로 설명)
- 가격 설정 가이드 (마진 누적 계산 설명)

---

## 예상 작업 기간

- **Step 1 (DB 스키마)**: 1일
- **Step 2 (백엔드 API)**: 3일
- **Step 3 (프론트엔드 UI)**: 4일
- **Step 4 (유틸리티)**: 1일
- **Step 5 (마이그레이션)**: 0.5일
- **Step 6 (테스트)**: 1.5일
- **Step 7 (문서화)**: 1일

**총 예상 기간: 12일**

---

## 주요 기술적 고려사항

### 1. 재귀 쿼리 성능
- **문제**: PostgreSQL의 `WITH RECURSIVE` 사용, 계층이 깊어지면 성능 저하 가능
- **해결**: Materialized Path 패턴 적용 (`path` 컬럼)으로 조회 최적화
- **구현**: `path LIKE '/HQ/Vietnam/%'` 형태의 단순 문자열 검색으로 하위 노드 조회

### 2. RLS 복잡도
- **문제**: 계층 기반 권한 체크가 복잡해짐
- **해결**:
  - 함수 기반 RLS 정책 작성
  - `get_user_accessible_locations(user_id)` 함수로 접근 가능한 location_id 배열 반환
  - 캐싱 고려 (PostgreSQL 함수 레벨)

### 3. FIFO 무결성
- **문제**: 다단계 이동 시 배치 추적 복잡도 증가
- **해결**:
  - 기존 FIFO 로직 유지 (location별로 독립적으로 동작)
  - Transfer만 계층 검증 추가 (parent-child 관계 확인)

### 4. Price Chain 일관성
- **문제**: Parent 가격 변경 시 Child 가격 자동 업데이트 필요 여부
- **해결**:
  - 옵션 1: 가격 변경 시 알림만 표시 (수동 업데이트)
  - 옵션 2: "Recalculate from Parent" 버튼 제공
  - 옵션 3: 자동 업데이트 (트리거 사용, 복잡도 증가)
  - **권장**: 옵션 2 (명시적 재계산)

### 5. 무한 루프 방지
- **문제**: Location 이동 시 circular reference 발생 가능
- **해결**:
  - Parent 변경 전 ancestors 체크
  - `new_parent_id`가 현재 location의 descendants에 포함되는지 검증
  - 예: Vietnam을 Ho Chi Minh의 하위로 이동 시도 → 거부

### 6. 계층 깊이 제한
- **문제**: 무제한 깊이 허용 시 UI/UX 복잡도 증가
- **해결**:
  - 현재는 제한 없음 (요구사항 반영)
  - 추후 필요 시 `level` 기반 제한 추가 가능 (예: max level 5)

---

## 데이터베이스 스키마 상세 설계

### Locations 테이블 (최종)
```sql
CREATE TABLE public.locations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name TEXT NOT NULL,
  location_type TEXT NOT NULL CHECK (location_type IN ('HQ', 'Branch', 'SubBranch')),
  country_code TEXT NOT NULL,
  currency TEXT NOT NULL CHECK (currency IN ('KRW', 'VND', 'CNY')),
  address TEXT,
  contact_person TEXT,
  phone TEXT,

  -- 계층 구조 필드
  parent_id UUID REFERENCES public.locations(id) ON DELETE CASCADE,
  level INTEGER NOT NULL DEFAULT 1 CHECK (level >= 1),
  path TEXT NOT NULL, -- Materialized path: '/HQ/Vietnam/Ho_Chi_Minh'

  -- 기타
  display_order INTEGER NOT NULL,
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),

  -- 제약 조건
  CONSTRAINT check_hq_no_parent CHECK (
    (location_type = 'HQ' AND parent_id IS NULL AND level = 1) OR
    (location_type != 'HQ' AND parent_id IS NOT NULL AND level > 1)
  ),
  CONSTRAINT check_path_format CHECK (path ~ '^/[A-Za-z0-9_/]+$')
);

-- 인덱스
CREATE INDEX idx_locations_parent_id ON public.locations(parent_id);
CREATE INDEX idx_locations_level ON public.locations(level);
CREATE INDEX idx_locations_path ON public.locations USING btree(path);
CREATE INDEX idx_locations_type ON public.locations(location_type);
CREATE INDEX idx_locations_active ON public.locations(is_active) WHERE is_active = true;
```

### Stock Transfer Requests 테이블 (신규)
```sql
CREATE TABLE public.stock_transfer_requests (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  requested_by UUID NOT NULL REFERENCES public.users(id) ON DELETE CASCADE,
  from_location_id UUID NOT NULL REFERENCES public.locations(id) ON DELETE CASCADE,
  to_location_id UUID NOT NULL REFERENCES public.locations(id) ON DELETE CASCADE,
  product_id UUID NOT NULL REFERENCES public.products(id) ON DELETE CASCADE,
  requested_qty INTEGER NOT NULL CHECK (requested_qty > 0),
  status TEXT NOT NULL DEFAULT 'Pending' CHECK (status IN ('Pending', 'Approved', 'Rejected', 'Completed')),
  notes TEXT,

  -- 승인 정보
  approved_by UUID REFERENCES public.users(id),
  approved_at TIMESTAMPTZ,
  rejection_reason TEXT,

  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- 인덱스
CREATE INDEX idx_transfer_requests_status ON public.stock_transfer_requests(status);
CREATE INDEX idx_transfer_requests_to_location ON public.stock_transfer_requests(to_location_id);
CREATE INDEX idx_transfer_requests_from_location ON public.stock_transfer_requests(from_location_id);
CREATE INDEX idx_transfer_requests_requested_by ON public.stock_transfer_requests(requested_by);
```

---

## API 엔드포인트 상세 설계

### Location Hierarchy APIs

#### `GET /api/locations/tree`
**설명**: 전체 Location 계층 구조 반환

**응답**:
```json
{
  "id": "uuid",
  "name": "Korea HQ",
  "level": 1,
  "children": [
    {
      "id": "uuid",
      "name": "Vietnam",
      "level": 2,
      "children": [
        {
          "id": "uuid",
          "name": "Ho Chi Minh",
          "level": 3,
          "children": []
        }
      ]
    }
  ]
}
```

#### `GET /api/locations/:id/children`
**설명**: 특정 Location의 직속 자식만 반환

**응답**:
```json
{
  "children": [
    {
      "id": "uuid",
      "name": "Ho Chi Minh",
      "level": 3,
      "parent_id": "vietnam_id"
    }
  ]
}
```

#### `POST /api/locations/create-child`
**설명**: 하위 Location 생성

**요청**:
```json
{
  "parent_id": "uuid",
  "name": "District 1",
  "location_type": "SubBranch",
  "country_code": "VN",
  "currency": "VND",
  "address": "...",
  "contact_person": "..."
}
```

**권한**: HQ_Admin 또는 Parent의 Branch_Manager

---

## 구현 우선순위

### Phase 1 (필수 - 2주)
1. DB 스키마 변경 및 마이그레이션
2. Location Hierarchy 헬퍼 함수
3. Transfer API 수정 (계층 검증)
4. Transfer Form UI 수정
5. Location Management 페이지 개선 (트리뷰)

### Phase 2 (중요 - 1주)
6. Pricing 계산 로직 확장
7. Pricing Form UI 개선
8. RLS 정책 업데이트
9. Dashboard 계층 구조 표시

### Phase 3 (추가 기능 - 1주)
10. Transfer Request 시스템 구축
11. Transfer Request UI
12. 알림 시스템 (옵션)
13. 통합 테스트

---

## 롤백 계획

만약 구현 중 문제가 발생할 경우:

1. **DB 롤백**: 마이그레이션 파일에 `DOWN` 스크립트 포함
   ```sql
   -- Rollback
   ALTER TABLE locations DROP COLUMN parent_id;
   ALTER TABLE locations DROP COLUMN level;
   ALTER TABLE locations DROP COLUMN path;
   DROP TABLE stock_transfer_requests;
   ```

2. **Feature Flag**: 환경 변수로 계층 구조 기능 On/Off
   ```typescript
   const HIERARCHY_ENABLED = process.env.NEXT_PUBLIC_ENABLE_HIERARCHY === 'true'
   ```

3. **데이터 백업**: 마이그레이션 전 전체 DB 백업

---

## 성공 기준

- [ ] HQ → Branch → Sub-Branch 3단계 계층 생성 가능
- [ ] Branch Manager가 Sub-Branch 생성 가능
- [ ] Parent-Child 간 재고 이동 성공
- [ ] 잘못된 이동 시 명확한 에러 메시지
- [ ] 계층별 가격 설정 및 Price Chain 표시
- [ ] 권한에 따른 재고 조회 제한 작동
- [ ] 대시보드에서 계층 구조 시각화
- [ ] 모든 테스트 시나리오 통과

---

## 참고 문서

- [PostgreSQL Materialized Path Pattern](https://www.postgresql.org/docs/current/queries-with.html)
- [Tree Structures in SQL](https://www.slideshare.net/billkarwin/models-for-hierarchical-data)
- [React Tree Component Best Practices](https://react-tree-library.com/)
