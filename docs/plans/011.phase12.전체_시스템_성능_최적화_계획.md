# 011.phase12.ì „ì²´_ì‹œìŠ¤í…œ_ì„±ëŠ¥_ìµœì í™”_ê³„íš

## ê°œìš”

**ì‘ì„±ì¼:** 2025-11-11
**Phase:** Phase 12 - ì„±ëŠ¥ ìµœì í™”
**ëª©í‘œ:** ì „ì²´ ì‹œìŠ¤í…œì˜ ë¡œë”© ì†ë„ë¥¼ 50-70% ê°œì„ 

## ë¬¸ì œ ìƒí™©

ëª¨ë“  í˜ì´ì§€(ë¡œê·¸ì¸, ëŒ€ì‹œë³´ë“œ, PO ìƒì„±, ì¬ê³  ì´ë™, íŒë§¤, ë³´ê³ ì„œ ë“±)ì—ì„œ ë¡œë”© ì†ë„ê°€ ëŠë¦¼.

### í˜„ì¬ ì„±ëŠ¥ ìƒíƒœ

| í˜ì´ì§€ | í˜„ì¬ ë¡œë”© ì‹œê°„ |
|--------|---------------|
| Dashboard | 800~1200ms |
| PO List | 400~700ms |
| Inventory | 350~600ms |
| Sales POST | 600~1100ms |
| Reports | 300~500ms |

**ëª¨ë“  í˜ì´ì§€ ê³µí†µ ì˜¤ë²„í—¤ë“œ:** 370~720ms

---

## ê·¼ë³¸ ì›ì¸ ë¶„ì„

### ğŸš¨ í•µì‹¬ ë¬¸ì œ: RLS ì •ì±…ì˜ ë°˜ë³µì ì¸ users í…Œì´ë¸” ì¡°íšŒ

**ë¬¸ì œì :**
- ì´ 25ê°œì˜ RLS ì •ì±… ì¤‘ **18ê°œ**ê°€ ëª¨ë“  ì¿¼ë¦¬ë§ˆë‹¤ `users` í…Œì´ë¸”ì„ ì¡°íšŒ
- ê° í˜ì´ì§€ê°€ 5-10ê°œì˜ ì¿¼ë¦¬ë¥¼ ì‹¤í–‰í•˜ë¯€ë¡œ **í˜ì´ì§€ë‹¹ 10-20ë²ˆì˜ users í…Œì´ë¸” ì¡°íšŒ** ë°œìƒ
- RLS ì²´í¬ë‹¹ +20~50ms ì˜¤ë²„í—¤ë“œ

**í˜„ì¬ RLS ì •ì±… íŒ¨í„´:**
```sql
CREATE POLICY "HQ Admin can view purchase orders"
  ON public.purchase_orders
  FOR SELECT
  USING (
    EXISTS (
      SELECT 1 FROM public.users
      WHERE id = auth.uid() AND role = 'HQ_Admin'
    )
  );
```

**ì˜í–¥ë°›ëŠ” í…Œì´ë¸”:**
1. locations (2ê°œ ì •ì±…)
2. suppliers (2ê°œ)
3. products (2ê°œ)
4. supplier_products (2ê°œ)
5. purchase_orders (2ê°œ)
6. purchase_order_items (2ê°œ)
7. stock_batches (4ê°œ)
8. pricing_configs (2ê°œ)
9. sales (4ê°œ)
10. exchange_rates (2ê°œ)

**ì˜ˆìƒ ì˜¤ë²„í—¤ë“œ:** í˜ì´ì§€ë‹¹ +200~400ms

---

### ğŸ”´ ì¶”ê°€ ë³‘ëª© ì§€ì 

#### 1. Middleware: ëª¨ë“  ìš”ì²­ì—ì„œ ì¸ì¦ ì²´í¬
- **íŒŒì¼:** `middleware.ts`
- **ë¬¸ì œ:** ëª¨ë“  ìš”ì²­ë§ˆë‹¤ `supabase.auth.getUser()` í˜¸ì¶œ
- **ì˜¤ë²„í—¤ë“œ:** +50~100ms

#### 2. Layout: ì¤‘ë³µ users ì¿¼ë¦¬
- **íŒŒì¼:** `app/(dashboard)/layout.tsx`
- **ë¬¸ì œ:**
  - ë§¤ í˜ì´ì§€ë§ˆë‹¤ users í…Œì´ë¸” ì¡°íšŒ
  - `SELECT *` ì‚¬ìš© (5ê°œ ì»¬ëŸ¼ë§Œ í•„ìš”í•œë° ì „ì²´ ì¡°íšŒ)
  - ê°œë³„ í˜ì´ì§€ì—ì„œë„ ë˜ users ì¡°íšŒ ì¤‘ë³µ
- **ì˜¤ë²„í—¤ë“œ:** +80~150ms

#### 3. ë³µì¡í•œ JOIN ì¿¼ë¦¬
- **ì˜ˆì‹œ:** PO Listì˜ 3ë‹¨ê³„ ì¤‘ì²© JOIN
  ```typescript
  .select(`
    *,
    supplier:suppliers(name),
    items:purchase_order_items(
      id, qty, unit_price, total_price,
      product:products(name, sku)  // 3ë‹¨ê³„ JOIN
    )
  `)
  ```
- **ì˜¤ë²„í—¤ë“œ:** +100~200ms

#### 4. APIì˜ N+1 ì¿¼ë¦¬ ë¬¸ì œ
- **íŒŒì¼:** `app/api/sales/route.ts`, `app/api/inventory/transfer/route.ts`
- **ë¬¸ì œ:** FIFO ë¡œì§ì—ì„œ ë°°ì¹˜ë³„ë¡œ ìˆœì°¨ì  UPDATE
  ```typescript
  for (const deduction of deductions) {
    await supabase.from('stock_batches').update(...) // ê°ê° RLS ì²´í¬
  }
  ```
- **ì˜¤ë²„í—¤ë“œ:** +100~300ms (ë°°ì¹˜ ìˆ˜ì— ë¹„ë¡€)

#### 5. JavaScript ì§‘ê³„ ì²˜ë¦¬
- **íŒŒì¼:** `lib/dashboard-data.ts`, Reports í˜ì´ì§€ë“¤
- **ë¬¸ì œ:** DBì—ì„œ ëª¨ë“  ë°ì´í„° ë¡œë“œ í›„ JavaScriptë¡œ ì§‘ê³„
- **ì˜¤ë²„í—¤ë“œ:** +50~150ms

#### 6. SELECT * ë‚¨ìš©
- **ë¬¸ì œ:** ë¶ˆí•„ìš”í•œ ì»¬ëŸ¼ê¹Œì§€ ì¡°íšŒí•˜ì—¬ ë„¤íŠ¸ì›Œí¬ ì „ì†¡ëŸ‰ ì¦ê°€
- **ì˜¤ë²„í—¤ë“œ:** +30~60ms

---

## ìµœì í™” ê³„íš

### **Phase 1: ê·¼ë³¸ ì›ì¸ í•´ê²° (HIGH Priority - ì¦‰ì‹œ ì ìš©)**

ì˜ˆìƒ íš¨ê³¼: **50-70% ì„±ëŠ¥ ê°œì„ ** (-380~550ms)

#### ì‘ì—… 1.1: RLS ì •ì±… ìµœì í™” (ê°€ì¥ í° ì˜í–¥)

**ëª©í‘œ:** users í…Œì´ë¸” ì¡°íšŒ ì œê±° â†’ JWT Claims ê¸°ë°˜ RLSë¡œ ì „í™˜

**ë°©ë²• A: JWT Claims í™œìš© (ê¶Œì¥)**

1. **Supabase Auth ì„¤ì •ì—ì„œ JWTì— user role í¬í•¨**
   - íšŒì›ê°€ì… ì‹œ user_metadataì— role ì €ì¥
   - ë¡œê·¸ì¸ ì‹œ JWTì— role í¬í•¨

2. **RLS ì •ì±… ì¬ì‘ì„± (18ê°œ ì •ì±…)**

   **ë³€ê²½ ì „:**
   ```sql
   CREATE POLICY "HQ Admin can view purchase orders"
     ON public.purchase_orders
     FOR SELECT
     USING (
       EXISTS (
         SELECT 1 FROM public.users
         WHERE id = auth.uid() AND role = 'HQ_Admin'
       )
     );
   ```

   **ë³€ê²½ í›„:**
   ```sql
   CREATE POLICY "HQ Admin can view purchase orders"
     ON public.purchase_orders
     FOR SELECT
     USING (
       (auth.jwt() ->> 'user_metadata')::jsonb ->> 'role' = 'HQ_Admin'
       OR
       (auth.jwt() ->> 'user_metadata')::jsonb ->> 'role' = 'Branch_Manager'
     );
   ```

3. **ì˜í–¥ë°›ëŠ” í…Œì´ë¸”ë³„ ì •ì±… ì—…ë°ì´íŠ¸**
   - locations (2ê°œ ì •ì±…)
   - suppliers (2ê°œ)
   - products (2ê°œ)
   - supplier_products (2ê°œ)
   - purchase_orders (2ê°œ)
   - purchase_order_items (2ê°œ)
   - stock_batches (4ê°œ)
   - pricing_configs (2ê°œ)
   - sales (4ê°œ)
   - exchange_rates (2ê°œ)

4. **ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ ìƒì„±**
   - `supabase/migrations/XXX_optimize_rls_jwt_claims.sql`

**ì˜ˆìƒ ê°œì„ :** -200~300ms

---

#### ì‘ì—… 1.2: Layout ì¤‘ë³µ ì¿¼ë¦¬ ì œê±°

**íŒŒì¼ ìˆ˜ì •:**
- `app/(dashboard)/layout.tsx`

**ë³€ê²½ ë‚´ìš©:**

1. **React Context ìƒì„±**
   ```typescript
   // lib/contexts/user-context.tsx
   export const UserContext = createContext<UserData>()
   ```

2. **Layoutì—ì„œ í•œ ë²ˆë§Œ ì¡°íšŒ**
   ```typescript
   // app/(dashboard)/layout.tsx
   const { data: userData } = await supabase
     .from("users")
     .select("id, role, location_id, email, name")  // í•„ìš”í•œ ì»¬ëŸ¼ë§Œ
     .eq("id", user.id)
     .single()

   return (
     <UserProvider value={userData}>
       {children}
     </UserProvider>
   )
   ```

3. **ê°œë³„ í˜ì´ì§€ì˜ ì¤‘ë³µ ì¿¼ë¦¬ ì œê±°**
   - Dashboard, Sales, Inventory, Reports í˜ì´ì§€ì—ì„œ users ì¿¼ë¦¬ ì œê±°
   - Contextì—ì„œ userData ê°€ì ¸ì˜¤ê¸°

**ì˜ˆìƒ ê°œì„ :** -80~150ms

---

#### ì‘ì—… 1.3: SELECT ì¿¼ë¦¬ ìµœì í™”

**ëŒ€ìƒ íŒŒì¼:**
- ëª¨ë“  í˜ì´ì§€ íŒŒì¼ (ì•½ 15ê°œ)

**ë³€ê²½ ë‚´ìš©:**

**ë³€ê²½ ì „:**
```typescript
.select('*')
```

**ë³€ê²½ í›„:**
```typescript
// Products í…Œì´ë¸”
.select('id, sku, name, category, unit, shelf_life_days')

// Locations í…Œì´ë¸”
.select('id, name, location_type, currency')

// Users í…Œì´ë¸”
.select('id, role, location_id, email, name')
```

**ìµœì í™” ëŒ€ìƒ:**
1. Dashboard: sales, stock_batches ì¿¼ë¦¬
2. Inventory: stock_batches ì¿¼ë¦¬
3. PO List: purchase_orders ì¿¼ë¦¬
4. Sales: sales ì¿¼ë¦¬
5. Products: products ì¿¼ë¦¬
6. Reports: ëª¨ë“  ì¿¼ë¦¬

**ì˜ˆìƒ ê°œì„ :** -100~150ms

---

### **Phase 2: API ë° ì¿¼ë¦¬ ìµœì í™” (MEDIUM Priority)**

ì˜ˆìƒ íš¨ê³¼: ì¶”ê°€ **30-40% ê°œì„ ** (-150~250ms)

#### ì‘ì—… 2.1: APIì˜ N+1 ì¿¼ë¦¬ ë¬¸ì œ í•´ê²°

**ëŒ€ìƒ íŒŒì¼:**
- `app/api/sales/route.ts`
- `app/api/inventory/transfer/route.ts`

**ë°©ë²•: Supabase RPC (PostgreSQL í•¨ìˆ˜) ì‚¬ìš©**

1. **FIFO ì¬ê³  ì°¨ê° í•¨ìˆ˜ ìƒì„±**

   ```sql
   -- supabase/migrations/XXX_create_fifo_functions.sql

   CREATE OR REPLACE FUNCTION deduct_stock_fifo(
     p_location_id UUID,
     p_product_id UUID,
     p_quantity INTEGER
   )
   RETURNS TABLE (
     batch_id UUID,
     deducted_qty INTEGER
   )
   LANGUAGE plpgsql
   SECURITY DEFINER
   AS $$
   DECLARE
     remaining_qty INTEGER := p_quantity;
     batch_record RECORD;
   BEGIN
     FOR batch_record IN
       SELECT id, qty_on_hand
       FROM stock_batches
       WHERE location_id = p_location_id
         AND product_id = p_product_id
         AND qty_on_hand > 0
       ORDER BY expiry_date ASC, created_at ASC
       FOR UPDATE
     LOOP
       IF remaining_qty <= 0 THEN
         EXIT;
       END IF;

       IF batch_record.qty_on_hand >= remaining_qty THEN
         -- ì´ ë°°ì¹˜ì—ì„œ ì „ì²´ ì°¨ê°
         UPDATE stock_batches
         SET qty_on_hand = qty_on_hand - remaining_qty
         WHERE id = batch_record.id;

         batch_id := batch_record.id;
         deducted_qty := remaining_qty;
         remaining_qty := 0;
         RETURN NEXT;
       ELSE
         -- ì´ ë°°ì¹˜ë¥¼ ì „ë¶€ ì°¨ê°í•˜ê³  ë‹¤ìŒ ë°°ì¹˜ë¡œ
         UPDATE stock_batches
         SET qty_on_hand = 0
         WHERE id = batch_record.id;

         batch_id := batch_record.id;
         deducted_qty := batch_record.qty_on_hand;
         remaining_qty := remaining_qty - batch_record.qty_on_hand;
         RETURN NEXT;
       END IF;
     END LOOP;

     IF remaining_qty > 0 THEN
       RAISE EXCEPTION 'Insufficient stock';
     END IF;
   END;
   $$;
   ```

2. **ì¬ê³  ì´ë™ í•¨ìˆ˜ ìƒì„±**

   ```sql
   CREATE OR REPLACE FUNCTION transfer_stock_fifo(
     p_from_location_id UUID,
     p_to_location_id UUID,
     p_product_id UUID,
     p_quantity INTEGER,
     p_unit_cost NUMERIC
   )
   RETURNS VOID
   LANGUAGE plpgsql
   SECURITY DEFINER
   AS $$
   DECLARE
     deduction RECORD;
   BEGIN
     -- Sourceì—ì„œ ì°¨ê°
     FOR deduction IN
       SELECT * FROM deduct_stock_fifo(p_from_location_id, p_product_id, p_quantity)
     LOOP
       -- Targetì— ì¦ê°€
       INSERT INTO stock_batches (
         location_id, product_id, batch_no,
         qty_on_hand, unit_cost, quality_status,
         manufactured_date, expiry_date
       )
       SELECT
         p_to_location_id,
         product_id,
         batch_no || '-TR',
         deduction.deducted_qty,
         p_unit_cost,
         quality_status,
         manufactured_date,
         expiry_date
       FROM stock_batches
       WHERE id = deduction.batch_id;
     END LOOP;
   END;
   $$;
   ```

3. **APIì—ì„œ RPC í˜¸ì¶œ**

   ```typescript
   // app/api/sales/route.ts
   const { data, error } = await supabase.rpc('deduct_stock_fifo', {
     p_location_id: locationId,
     p_product_id: productId,
     p_quantity: quantity
   })
   ```

**ì˜ˆìƒ ê°œì„ :** -100~300ms (POST ìš”ì²­)

---

#### ì‘ì—… 2.2: ë³µì¡í•œ JOIN ì¿¼ë¦¬ ë¶„ë¦¬

**ëŒ€ìƒ:**
- PO Listì˜ 3ë‹¨ê³„ ì¤‘ì²© JOIN

**ë°©ë²• 1: ë³„ë„ ì¿¼ë¦¬ë¡œ ë¶„ë¦¬**

```typescript
// ë³€ê²½ ì „ (ì¤‘ì²© JOIN)
const { data: pos } = await supabase
  .select(`
    *,
    supplier:suppliers(name),
    items:purchase_order_items(
      id, qty, unit_price, total_price,
      product:products(name, sku)
    )
  `)

// ë³€ê²½ í›„ (ë¶„ë¦¬ í›„ ì¡°í•©)
const { data: pos } = await supabase
  .from('purchase_orders')
  .select('id, po_number, status, order_date, supplier_id')

const { data: items } = await supabase
  .from('purchase_order_items')
  .select('po_id, id, qty, unit_price, product_id')
  .in('po_id', pos.map(po => po.id))

const { data: products } = await supabase
  .from('products')
  .select('id, name, sku')
  .in('id', items.map(item => item.product_id))

// ì„œë²„ì—ì„œ ì¡°í•©
```

**ë°©ë²• 2: PostgreSQL View ìƒì„±** (ë” ë‚˜ì€ ë°©ë²•)

```sql
CREATE VIEW v_purchase_orders_with_items AS
SELECT
  po.id,
  po.po_number,
  po.status,
  po.order_date,
  s.name as supplier_name,
  jsonb_agg(
    jsonb_build_object(
      'id', poi.id,
      'qty', poi.qty,
      'unit_price', poi.unit_price,
      'product_name', p.name,
      'product_sku', p.sku
    )
  ) as items
FROM purchase_orders po
JOIN suppliers s ON po.supplier_id = s.id
LEFT JOIN purchase_order_items poi ON po.id = poi.po_id
LEFT JOIN products p ON poi.product_id = p.id
GROUP BY po.id, po.po_number, po.status, po.order_date, s.name;

-- ì‚¬ìš©
SELECT * FROM v_purchase_orders_with_items;
```

**ì˜ˆìƒ ê°œì„ :** -50~100ms

---

#### ì‘ì—… 2.3: ì¸ë±ìŠ¤ ì¶”ê°€

**ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼:**
`supabase/migrations/XXX_add_performance_indexes.sql`

```sql
-- users í…Œì´ë¸” ë³µí•© ì¸ë±ìŠ¤ (RLS ìµœì í™”ìš©, JWT ì „í™˜ í›„ì—ëŠ” ë¶ˆí•„ìš”í•  ìˆ˜ ìˆìŒ)
CREATE INDEX IF NOT EXISTS idx_users_id_role ON users(id, role);

-- sales ë‚ ì§œ ë²”ìœ„ ì¡°íšŒ ìµœì í™”
CREATE INDEX IF NOT EXISTS idx_sales_date_location ON sales(sale_date, location_id);

-- exchange_rates ì¡°íšŒ ìµœì í™”
CREATE INDEX IF NOT EXISTS idx_exchange_rates_lookup
  ON exchange_rates(from_currency, to_currency, effective_date DESC);

-- purchase_order_items ì¡°íšŒ ìµœì í™”
CREATE INDEX IF NOT EXISTS idx_po_items_po_product
  ON purchase_order_items(po_id, product_id);
```

**ì˜ˆìƒ ê°œì„ :** -30~50ms

---

### **Phase 3: ì¥ê¸° ê°œì„  (LOW Priority)**

ì˜ˆìƒ íš¨ê³¼: ì¶”ê°€ **10-20% ê°œì„ **

#### ì‘ì—… 3.1: DB Aggregation í™œìš©

**ëŒ€ìƒ:** Dashboard í†µê³„

**ë³€ê²½ ì „:**
```typescript
// ëª¨ë“  sales ë°ì´í„° ë¡œë“œ í›„ JavaScriptë¡œ ì§‘ê³„
const sales = await supabase.from('sales').select('*')
const totalRevenue = sales.reduce((sum, s) => sum + s.total_price, 0)
```

**ë³€ê²½ í›„:**
```typescript
// DBì—ì„œ ì§ì ‘ ì§‘ê³„
const { data } = await supabase
  .from('sales')
  .select('location_id, sum(total_price) as total_revenue')
  .groupBy('location_id')
```

ë˜ëŠ” **Materialized View ìƒì„±:**

```sql
CREATE MATERIALIZED VIEW mv_daily_sales_summary AS
SELECT
  sale_date,
  location_id,
  COUNT(*) as transaction_count,
  SUM(qty) as total_qty,
  SUM(total_price) as total_revenue
FROM sales
GROUP BY sale_date, location_id;

-- ì¸ë±ìŠ¤ ì¶”ê°€
CREATE INDEX ON mv_daily_sales_summary(sale_date, location_id);

-- ì£¼ê¸°ì  ê°±ì‹  (Supabase í•¨ìˆ˜ ë˜ëŠ” cron)
REFRESH MATERIALIZED VIEW CONCURRENTLY mv_daily_sales_summary;
```

**ì˜ˆìƒ ê°œì„ :** -50~150ms

---

#### ì‘ì—… 3.2: i18n ë²ˆì—­ ìºì‹±

**ëŒ€ìƒ:** `lib/i18n.ts`

**ë³€ê²½ ì „:**
```typescript
export async function getServerTranslations(language: Language) {
  const messages = await import(`@/locales/${language}/dashboard.json`)
  return messages.default
}
```

**ë³€ê²½ í›„:**
```typescript
const translationCache = new Map()

export async function getServerTranslations(language: Language) {
  const cacheKey = `${language}-dashboard`

  if (!translationCache.has(cacheKey)) {
    const messages = await import(`@/locales/${language}/dashboard.json`)
    translationCache.set(cacheKey, messages.default)
  }

  return translationCache.get(cacheKey)
}
```

**ì˜ˆìƒ ê°œì„ :** -10~20ms

---

#### ì‘ì—… 3.3: Server Actions ì ìš©

**ëŒ€ìƒ:** Form ì œì¶œ ë¡œì§

**ë³€ê²½ ì „:** API Routes ì‚¬ìš©
```typescript
// app/api/sales/route.ts
export async function POST(request: Request) { ... }

// í´ë¼ì´ì–¸íŠ¸ì—ì„œ
await fetch('/api/sales', { method: 'POST', body: ... })
```

**ë³€ê²½ í›„:** Server Actions
```typescript
// app/(dashboard)/sales/actions.ts
'use server'

export async function createSale(formData: FormData) {
  // ...
  revalidatePath('/sales')
  return { success: true }
}

// í´ë¼ì´ì–¸íŠ¸ì—ì„œ
import { createSale } from './actions'
await createSale(formData)
```

**ì¥ì :**
- ìë™ revalidation
- Type-safe
- ë” ë‚˜ì€ ì—ëŸ¬ ì²˜ë¦¬

**ì˜ˆìƒ ê°œì„ :** -20~40ms

---

#### ì‘ì—… 3.4: í˜ì´ì§€ë„¤ì´ì…˜ ë„ì…

**ëŒ€ìƒ:**
- Sales ëª©ë¡
- Inventory ëª©ë¡
- PO ëª©ë¡

**êµ¬í˜„:**

```typescript
// ë³€ê²½ ì „
const { data: sales } = await supabase
  .from('sales')
  .select('*')
  .order('sale_date', { ascending: false })

// ë³€ê²½ í›„
const ITEMS_PER_PAGE = 50
const page = searchParams.page || 1
const offset = (page - 1) * ITEMS_PER_PAGE

const { data: sales, count } = await supabase
  .from('sales')
  .select('*', { count: 'exact' })
  .order('sale_date', { ascending: false })
  .range(offset, offset + ITEMS_PER_PAGE - 1)

// ì´ í˜ì´ì§€ ìˆ˜
const totalPages = Math.ceil(count / ITEMS_PER_PAGE)
```

**ì˜ˆìƒ ê°œì„ :** ì´ˆê¸° ë¡œë”© 50-70% ë‹¨ì¶•

---

## ì˜ˆìƒ ì„±ëŠ¥ ê°œì„  íš¨ê³¼

### Phase 1ë§Œ ì ìš© ì‹œ:

| í˜ì´ì§€ | í˜„ì¬ | ìµœì í™” í›„ | ê°œì„ ìœ¨ |
|--------|------|----------|--------|
| **Dashboard** | 800~1200ms | **300~500ms** | **-60%** |
| **PO List** | 400~700ms | **150~250ms** | **-65%** |
| **Inventory** | 350~600ms | **120~200ms** | **-66%** |
| **Sales POST** | 600~1100ms | **200~350ms** | **-70%** |
| **Reports** | 300~500ms | **100~200ms** | **-67%** |

### Phase 1+2 ì ìš© ì‹œ:

| í˜ì´ì§€ | ìµœì¢… ë¡œë”© ì‹œê°„ | ì „ì²´ ê°œì„ ìœ¨ |
|--------|---------------|-------------|
| **Dashboard** | **200~350ms** | **-75%** |
| **PO List** | **100~150ms** | **-78%** |
| **Inventory** | **80~130ms** | **-77%** |
| **Sales POST** | **150~200ms** | **-80%** |
| **Reports** | **70~120ms** | **-77%** |

### Phase 1+2+3 ì ìš© ì‹œ:

- **ì „ì²´ í‰ê·  80% ì„±ëŠ¥ ê°œì„ **
- ë¡œê·¸ì¸ â†’ ëŒ€ì‹œë³´ë“œ: 2ì´ˆ â†’ **0.4ì´ˆ**
- ì¼ë°˜ í˜ì´ì§€: 0.5ì´ˆ â†’ **0.1ì´ˆ**

---

## ì‘ì—… ìˆœì„œ ë° ì˜ˆìƒ ì‹œê°„

### Phase 1 (4-6ì‹œê°„)

1. **JWT Claims ì„¤ì •** (1ì‹œê°„)
   - Supabase Auth ì„¤ì • í™•ì¸
   - íšŒì›ê°€ì…/ë¡œê·¸ì¸ ì‹œ role ì €ì¥

2. **RLS ì •ì±… ì¬ì‘ì„±** (2-3ì‹œê°„)
   - 18ê°œ ì •ì±… ì—…ë°ì´íŠ¸
   - ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ ì‘ì„±
   - í…ŒìŠ¤íŠ¸

3. **Layout ë¦¬íŒ©í† ë§** (1ì‹œê°„)
   - UserContext ìƒì„±
   - Layout ìˆ˜ì •
   - ê°œë³„ í˜ì´ì§€ ìˆ˜ì •

4. **SELECT ì¿¼ë¦¬ ìµœì í™”** (1-2ì‹œê°„)
   - ëª¨ë“  í˜ì´ì§€ íŒŒì¼ ìˆ˜ì • (ì•½ 15ê°œ)

### Phase 2 (3-4ì‹œê°„)

5. **RPC í•¨ìˆ˜ ìƒì„±** (2ì‹œê°„)
   - FIFO í•¨ìˆ˜ ì‘ì„±
   - ì¬ê³  ì´ë™ í•¨ìˆ˜ ì‘ì„±
   - í…ŒìŠ¤íŠ¸

6. **API ìˆ˜ì •** (1ì‹œê°„)
   - Sales API
   - Transfer API

7. **ì¸ë±ìŠ¤ ì¶”ê°€** (30ë¶„)
   - ë§ˆì´ê·¸ë ˆì´ì…˜ ì‘ì„±
   - ì ìš© ë° í™•ì¸

8. **ë³µì¡í•œ JOIN ë¶„ë¦¬** (30ë¶„-1ì‹œê°„)
   - PO List ì¿¼ë¦¬ ìµœì í™”

### Phase 3 (ì„ íƒ ì‚¬í•­, 2-3ì‹œê°„)

9. DB Aggregation, i18n ìºì‹±, Server Actions ë“±

---

## í…ŒìŠ¤íŠ¸ ê³„íš

### ì„±ëŠ¥ ì¸¡ì • ë°©ë²•

1. **Chrome DevTools Network íƒ­**
   - ê° í˜ì´ì§€ì˜ ë¡œë”© ì‹œê°„ ì¸¡ì •
   - API ìš”ì²­ ì‘ë‹µ ì‹œê°„ ì¸¡ì •

2. **Supabase Logs**
   - ì¿¼ë¦¬ ì‹¤í–‰ ì‹œê°„ í™•ì¸
   - RLS ì •ì±… ì˜¤ë²„í—¤ë“œ í™•ì¸

3. **ë¹„êµ í…ŒìŠ¤íŠ¸**
   - ìµœì í™” ì „/í›„ ìŠ¤í¬ë¦°ìƒ·
   - êµ¬ì²´ì  ìˆ˜ì¹˜ ê¸°ë¡

### í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤

1. **ë¡œê·¸ì¸ â†’ ëŒ€ì‹œë³´ë“œ ì´ë™**
   - ì´ ì‹œê°„ ì¸¡ì •

2. **PO ìƒì„±**
   - í¼ ë¡œë”© ì‹œê°„
   - ì œì¶œ í›„ ì‘ë‹µ ì‹œê°„

3. **íŒë§¤ ì…ë ¥**
   - í¼ ë¡œë”© ì‹œê°„
   - ì œì¶œ í›„ ì¬ê³  ì°¨ê° ì‹œê°„

4. **ë³´ê³ ì„œ ì¡°íšŒ**
   - 30ì¼ ë°ì´í„° ë¡œë”© ì‹œê°„

---

## ìœ„í—˜ ìš”ì†Œ ë° ëŒ€ì‘

### ìœ„í—˜ 1: JWT Claims RLS ë³€ê²½ ì‹œ ì¸ì¦ ì˜¤ë¥˜

**ëŒ€ì‘:**
- ë¡œì»¬ í™˜ê²½ì—ì„œ ì¶©ë¶„íˆ í…ŒìŠ¤íŠ¸
- ë¡¤ë°± ê³„íš ì¤€ë¹„ (ì´ì „ RLS ì •ì±… ë°±ì—…)
- ë‹¨ê³„ì  ë°°í¬ (í…Œì´ë¸” í•˜ë‚˜ì”©)

### ìœ„í—˜ 2: RPC í•¨ìˆ˜ì˜ íŠ¸ëœì­ì…˜ ì˜¤ë¥˜

**ëŒ€ì‘:**
- EXCEPTION ì²˜ë¦¬ ë¡œì§ ì¶”ê°€
- í…ŒìŠ¤íŠ¸ ë°ì´í„°ë¡œ ì¶©ë¶„íˆ ê²€ì¦
- ì—ëŸ¬ ë¡œê¹… ì¶”ê°€

### ìœ„í—˜ 3: View/Materialized Viewì˜ ë°ì´í„° ë™ê¸°í™”

**ëŒ€ì‘:**
- Materialized ViewëŠ” Phase 3ì—ì„œ ì„ íƒì  ì ìš©
- Refresh ì „ëµ ëª…í™•íˆ ì„¤ì •

---

## ì„±ê³µ ê¸°ì¤€

1. **ì •ëŸ‰ì  ê¸°ì¤€**
   - ëª¨ë“  í˜ì´ì§€ ë¡œë”© ì‹œê°„ 50% ì´ìƒ ê°œì„ 
   - API ì‘ë‹µ ì‹œê°„ 500ms ì´í•˜

2. **ì •ì„±ì  ê¸°ì¤€**
   - ì‚¬ìš©ìê°€ "ë¹ ë¥´ë‹¤"ê³  ëŠë‚„ ìˆ˜ ìˆëŠ” ìˆ˜ì¤€
   - í˜ì´ì§€ ì „í™˜ì´ ì¦‰ê°ì 

3. **ì•ˆì •ì„±**
   - ê¸°ì¡´ ê¸°ëŠ¥ ì •ìƒ ë™ì‘
   - ì¸ì¦/ê¶Œí•œ ì²´í¬ ì •ìƒ
   - ë°ì´í„° ì •í•©ì„± ìœ ì§€

---

## ì°¸ê³  ìë£Œ

- Supabase RLS ìµœì í™”: https://supabase.com/docs/guides/auth/row-level-security
- PostgreSQL í•¨ìˆ˜: https://www.postgresql.org/docs/current/plpgsql.html
- Next.js ì„±ëŠ¥ ìµœì í™”: https://nextjs.org/docs/app/building-your-application/optimizing

---

## ë‹¤ìŒ ë‹¨ê³„

1. Phase 1 ì‘ì—… ì‹œì‘
2. ê° ë‹¨ê³„ë³„ ì„±ëŠ¥ ì¸¡ì •
3. Worklog ì‘ì„± (ì‘ì—… ì™„ë£Œ í›„)
